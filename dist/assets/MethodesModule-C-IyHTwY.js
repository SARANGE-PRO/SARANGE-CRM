import{p as A,r as y,a as _,b as D,u as z,j as e,B as I}from"./index-DMGdsos9.js";import{r as g,R as G,a7 as B,d as U,u as L,a5 as $,w as q,A as H,af as Q,ag as J}from"./vendor-DQYctaBf.js";import{C as K}from"./CreateVoletFabModal-CVBmWO6-.js";import{R as W}from"./RapportMetrageViewer-CMoDNXi7.js";import"./utils-CKkNC6ps.js";import"./Modal-CBdi9DRh.js";const E="OrdresFabrication",R="OrdresCommande",T=i=>{const h={pvc:[],alu:[],volets:[],autres:[]};for(const a of i)a.deleted||(a.type==="VOLET_ROULANT"?h.volets.push(a):a.matiere==="ALU"?h.alu.push(a):["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE","PORTE_ENTREE","PORTE_SERVICE"].includes(a.type)?a.matiere==="ALU"?h.alu.push(a):h.pvc.push(a):h.autres.push(a));return h},X=async(i,h,a={})=>{const w=new Date().toISOString(),m=T(h),c={},o=[],x=[],N={chantier_id:i.id,client_nom:i.client||"",reference_devis:i.referenceDevis||"",date_creation:w};if(m.volets.length>0){const d=A(y(_,E)).key;c[`${E}/${d}`]={...N,groupe:"VOLET",type_produit:"VOLET_ROULANT",statut:"A_FABRIQUER",produits:m.volets.map(n=>({type:n.type,largeur:n.largeurMm||0,hauteur:n.hauteurMm||0,description:n.description||n.notes||"",couleur:n.couleur||""})),details_volets:a.volets||[],url_pdf_fabrication:null,historique:{demarre_par:null,demarre_le:null,termine_par:null,termine_le:null},anomalie:{signalee:!1,motif:"",date_signalement:null}},o.push(d)}if(m.pvc.length>0){const d=A(y(_,E)).key;c[`${E}/${d}`]={...N,groupe:"PVC",type_produit:"FENETRE_PVC",statut:"ATTENTE_VITRAGE",produits:m.pvc.map(l=>({type:l.type,largeur:l.largeurMm||0,hauteur:l.hauteurMm||0,description:l.description||l.notes||"",couleur:l.couleur||"",matiere:"PVC"})),details_volets:null,url_pdf_fabrication:a.pdfPVC||null,historique:{demarre_par:null,demarre_le:null,termine_par:null,termine_le:null},anomalie:{signalee:!1,motif:"",date_signalement:null}},o.push(d);const j=A(y(_,R)).key;c[`${R}/${j}`]={...N,type_commande:"VITRAGE",description:`Vitrage PVC â€” ${m.pvc.length} menuiserie(s)`,fournisseur:"",statut:"A_COMMANDER",date_commande:null,date_reception:null,of_lie_id:d},x.push(j)}if(m.alu.length>0){const d=A(y(_,E)).key;c[`${E}/${d}`]={...N,groupe:"ALU",type_produit:"FENETRE_ALU",statut:"ATTENTE_VITRAGE",produits:m.alu.map(l=>({type:l.type,largeur:l.largeurMm||0,hauteur:l.hauteurMm||0,description:l.description||l.notes||"",couleur:l.couleur||"",matiere:"ALU"})),details_volets:null,url_pdf_fabrication:a.pdfALU||null,historique:{demarre_par:null,demarre_le:null,termine_par:null,termine_le:null},anomalie:{signalee:!1,motif:"",date_signalement:null}},o.push(d);const j=A(y(_,R)).key;c[`${R}/${j}`]={...N,type_commande:"VITRAGE",description:`Vitrage ALU â€” ${m.alu.length} menuiserie(s)`,fournisseur:"",statut:"A_COMMANDER",date_commande:null,date_reception:null,of_lie_id:d},x.push(j)}for(const f of m.autres){const n=A(y(_,R)).key;c[`${R}/${n}`]={...N,type_commande:"NEGOCE",description:`${f.type} â€” ${f.description||f.notes||""}`.trim(),fournisseur:"",statut:"A_COMMANDER",date_commande:null,date_reception:null,of_lie_id:null},x.push(n)}return Object.keys(c).length>0&&(await D(y(_),c),console.log(`ðŸ­ Production gÃ©nÃ©rÃ©e: ${o.length} OF, ${x.length} OC pour ${i.client}`)),{ofs:o,ocs:x}},le=()=>{const{state:i,updateChantier:h}=z(),[a,w]=g.useState(null),[m,c]=g.useState(!1),[o,x]=g.useState({pdfPVC:null,pdfALU:null,volets:[]}),[N,f]=g.useState(""),[d,n]=g.useState(""),[j,l]=g.useState(!1),[C,M]=g.useState(null),V=g.useMemo(()=>(i.chantiers||[]).filter(s=>!s.deleted&&!s.purged&&s.assignation==="METHODES"),[i.chantiers]),p=V.find(s=>s.id===a),P=g.useMemo(()=>a?(i.products||[]).filter(s=>s.chantierId===a&&!s.deleted):[],[a,i.products]),u=g.useMemo(()=>T(P),[P]),O=(s,b)=>{var k;const r=(k=b.target.files)==null?void 0:k[0];r&&(s==="PVC"?(x(t=>({...t,pdfPVC:r.name})),f(r.name)):(x(t=>({...t,pdfALU:r.name})),n(r.name)))},F=s=>{x(b=>({...b,volets:[...b.volets,s]})),c(!1)},S=async()=>{if(p){l(!0);try{const s=await X(p,P,o);h(a,{assignation:"PRODUCTION"}),M(`âœ… ${s.ofs.length} OF et ${s.ocs.length} OC crÃ©Ã©s pour ${p.client}`),w(null),x({pdfPVC:null,pdfALU:null,volets:[]}),f(""),n("")}catch(s){console.error("Erreur lancement production:",s),M("âŒ Erreur lors de la gÃ©nÃ©ration")}finally{l(!1)}}};if(G.useEffect(()=>{if(C){const s=setTimeout(()=>M(null),4e3);return()=>clearTimeout(s)}},[C]),p){const s=u.pvc.length>0,b=u.alu.length>0,r=u.volets.length>0,k=u.autres.length>0;return e.jsxs("div",{className:"flex flex-col h-full bg-slate-50 dark:bg-slate-900",children:[e.jsx(K,{isOpen:m,onClose:()=>c(!1),onSubmit:F}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-6 pt-[max(1rem,env(safe-area-inset-top))] pb-4 flex-shrink-0 shadow-sm z-20",children:[e.jsxs("button",{onClick:()=>{w(null),x({pdfPVC:null,pdfALU:null,volets:[]}),f(""),n("")},className:"flex items-center gap-2 text-sm text-slate-500 hover:text-slate-700 dark:text-slate-400 mb-2",children:[e.jsx(B,{size:16})," Retour aux dossiers"]}),e.jsxs("h2",{className:"text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2",children:[e.jsx(U,{size:22,className:"text-brand-600"}),p.client]}),e.jsxs("p",{className:"text-sm text-slate-500 dark:text-slate-400 mt-1",children:[P.length," produit(s) â€¢ ",p.referenceDevis&&`Devis ${p.referenceDevis}`]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 md:p-6 space-y-6 pb-40",children:[(p.rapportMetrage||p.rapportMetrageFileId)&&e.jsx(W,{rapportMetrage:p.rapportMetrage,rapportMetrageFileId:p.rapportMetrageFileId,title:"Rapport de MÃ©trage (rÃ©fÃ©rence)",collapsed:!0}),s&&e.jsxs("section",{className:"bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-5 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"font-bold text-slate-800 dark:text-white flex items-center gap-2",children:[e.jsx("span",{className:"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 text-xs font-bold px-2 py-0.5 rounded-full",children:"PVC"}),"Menuiseries PVC",e.jsxs("span",{className:"text-sm text-slate-400 font-normal",children:["(",u.pvc.length,")"]})]}),o.pdfPVC?e.jsxs("span",{className:"text-xs text-green-600 flex items-center gap-1",children:[e.jsx(L,{size:14})," ",N]}):null]}),e.jsx("ul",{className:"space-y-2 mb-4",children:u.pvc.map((t,v)=>e.jsxs("li",{className:"text-sm text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-900/50 px-3 py-2 rounded-lg",children:[e.jsx("strong",{children:t.type})," â€” ",t.largeurMm,"Ã—",t.hauteurMm,"mm ",t.couleur&&`â€¢ ${t.couleur}`]},t.id||v))}),e.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer text-sm font-semibold text-brand-600 bg-brand-50 hover:bg-brand-100 dark:bg-brand-900/20 px-4 py-2.5 rounded-xl transition-colors",children:[e.jsx($,{size:16}),o.pdfPVC?"Remplacer PDF Proges":"Importer PDF Proges",e.jsx("input",{type:"file",accept:".pdf",className:"hidden",onChange:t=>O("PVC",t)})]})]}),b&&e.jsxs("section",{className:"bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-5 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"font-bold text-slate-800 dark:text-white flex items-center gap-2",children:[e.jsx("span",{className:"bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-200 text-xs font-bold px-2 py-0.5 rounded-full",children:"ALU"}),"Menuiseries Alu",e.jsxs("span",{className:"text-sm text-slate-400 font-normal",children:["(",u.alu.length,")"]})]}),o.pdfALU?e.jsxs("span",{className:"text-xs text-green-600 flex items-center gap-1",children:[e.jsx(L,{size:14})," ",d]}):null]}),e.jsx("ul",{className:"space-y-2 mb-4",children:u.alu.map((t,v)=>e.jsxs("li",{className:"text-sm text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-900/50 px-3 py-2 rounded-lg",children:[e.jsx("strong",{children:t.type})," â€” ",t.largeurMm,"Ã—",t.hauteurMm,"mm ",t.couleur&&`â€¢ ${t.couleur}`]},t.id||v))}),e.jsxs("label",{className:"inline-flex items-center gap-2 cursor-pointer text-sm font-semibold text-brand-600 bg-brand-50 hover:bg-brand-100 dark:bg-brand-900/20 px-4 py-2.5 rounded-xl transition-colors",children:[e.jsx($,{size:16}),o.pdfALU?"Remplacer PDF Scal":"Importer PDF Scal",e.jsx("input",{type:"file",accept:".pdf",className:"hidden",onChange:t=>O("ALU",t)})]})]}),r&&e.jsxs("section",{className:"bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-5 shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("h3",{className:"font-bold text-slate-800 dark:text-white flex items-center gap-2",children:[e.jsx("span",{className:"bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300 text-xs font-bold px-2 py-0.5 rounded-full",children:"VR"}),"Volets Roulants",e.jsxs("span",{className:"text-sm text-slate-400 font-normal",children:["(",u.volets.length,")"]})]}),o.volets.length>0&&e.jsxs("span",{className:"text-xs text-green-600 flex items-center gap-1",children:[e.jsx(L,{size:14})," ",o.volets.length," fiche(s)"]})]}),e.jsx("ul",{className:"space-y-2 mb-4",children:u.volets.map((t,v)=>e.jsxs("li",{className:"text-sm text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-900/50 px-3 py-2 rounded-lg",children:[e.jsx("strong",{children:"Volet"})," â€” ",t.largeurMm,"Ã—",t.hauteurMm,"mm ",t.couleur&&`â€¢ ${t.couleur}`]},t.id||v))}),e.jsx(I,{onClick:()=>c(!0),variant:"secondary",icon:q,className:"text-sm",children:"Ajouter une fiche volet"})]}),k&&e.jsxs("section",{className:"bg-white dark:bg-slate-800 rounded-2xl border border-slate-200 dark:border-slate-700 p-5 shadow-sm",children:[e.jsxs("h3",{className:"font-bold text-slate-800 dark:text-white flex items-center gap-2 mb-4",children:[e.jsx("span",{className:"bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300 text-xs font-bold px-2 py-0.5 rounded-full",children:"NÃ©goce"}),"Autres Produits",e.jsxs("span",{className:"text-sm text-slate-400 font-normal",children:["(",u.autres.length,")"]})]}),e.jsx("ul",{className:"space-y-2",children:u.autres.map((t,v)=>e.jsxs("li",{className:"text-sm text-slate-600 dark:text-slate-300 bg-slate-50 dark:bg-slate-900/50 px-3 py-2 rounded-lg flex items-center gap-2",children:[e.jsx(H,{size:14,className:"text-amber-500 shrink-0"}),e.jsx("strong",{children:t.type})," â€” ",t.description||t.notes||"sans description"]},t.id||v))}),e.jsx("p",{className:"text-xs text-slate-400 mt-3 italic",children:"â†’ Sera crÃ©Ã© comme Ordre de Commande (nÃ©goce) automatiquement."})]}),e.jsx("div",{className:"pt-4",children:e.jsx(I,{onClick:S,icon:Q,className:"w-full py-4 text-base shadow-lg hover:scale-[1.01] transition-transform",disabled:j,children:j?"GÃ©nÃ©ration en cours...":"ðŸš€ Lancer Production & Achats"})})]}),C&&e.jsx("div",{className:"fixed bottom-6 left-1/2 -translate-x-1/2 z-50 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl text-sm font-medium animate-fade-in",children:C})]})}return e.jsxs("div",{className:"flex flex-col h-full bg-slate-50 dark:bg-slate-900",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-6 pt-[max(1rem,env(safe-area-inset-top))] pb-4 flex-shrink-0 shadow-sm z-20",children:[e.jsxs("h2",{className:"text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2",children:[e.jsx(U,{size:22,className:"text-brand-600"}),"Bureau des MÃ©thodes"]}),e.jsx("p",{className:"text-sm text-slate-500 dark:text-slate-400 mt-1",children:"Ã‰dition des fiches de fabrication et lancement en production."})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4 md:p-6 pb-40",children:V.length===0?e.jsx("div",{className:"flex h-64 items-center justify-center border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-2xl text-slate-400 text-sm font-medium",children:"Aucun dossier en attente de fiches"}):e.jsx("div",{className:"space-y-3 max-w-2xl",children:V.map(s=>{const b=(i.products||[]).filter(k=>k.chantierId===s.id&&!k.deleted),r=T(b);return e.jsx("button",{onClick:()=>w(s.id),className:"w-full text-left bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-4 shadow-sm hover:shadow-md transition-all hover:border-brand-300 hover:scale-[1.005] group",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-bold text-slate-800 dark:text-white truncate",children:s.client}),e.jsxs("p",{className:"text-xs text-slate-500 dark:text-slate-400 mt-1",children:[b.length," produit(s)",s.referenceDevis&&e.jsxs("span",{className:"ml-2",children:["â€¢ Devis ",s.referenceDevis]})]}),e.jsxs("div",{className:"flex gap-1.5 mt-2",children:[r.pvc.length>0&&e.jsxs("span",{className:"text-[10px] font-bold px-1.5 py-0.5 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300",children:["PVC (",r.pvc.length,")"]}),r.alu.length>0&&e.jsxs("span",{className:"text-[10px] font-bold px-1.5 py-0.5 rounded-full bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-200",children:["ALU (",r.alu.length,")"]}),r.volets.length>0&&e.jsxs("span",{className:"text-[10px] font-bold px-1.5 py-0.5 rounded-full bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300",children:["VR (",r.volets.length,")"]}),r.autres.length>0&&e.jsxs("span",{className:"text-[10px] font-bold px-1.5 py-0.5 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300",children:["Autre (",r.autres.length,")"]})]})]}),e.jsx(J,{size:20,className:"text-slate-400 group-hover:text-brand-500 transition-colors shrink-0"})]})},s.id)})})}),C&&e.jsx("div",{className:"fixed bottom-6 left-1/2 -translate-x-1/2 z-50 bg-slate-800 text-white px-6 py-3 rounded-xl shadow-2xl text-sm font-medium animate-fade-in",children:C})]})};export{le as MethodesModule};
