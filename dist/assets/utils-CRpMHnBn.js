const g={logs:[],add(e,i,s){const r={ts:new Date().toISOString(),level:e,msg:i,data:s};this.logs.push(r),(console[e]?console[e]:console.log)(`[Sarange] ${i}`,s||""),this.logs.length>1e3&&this.logs.shift()},info(e,i){this.add("info",e,i)},warn(e,i){this.add("warn",e,i)},error(e,i){this.add("error",e,i)},getBlob(){return new Blob([JSON.stringify(this.logs,null,2)],{type:"application/json"})}},v="SarangeDB_V2",y=1,O={db:null,async init(){return g.info("Connexion DB..."),new Promise((e,i)=>{const s=setTimeout(()=>i(new Error("Timeout connexion DB")),3e3);try{const r=indexedDB.open(v,y);r.onerror=n=>{clearTimeout(s),i(n.target.error)},r.onsuccess=n=>{clearTimeout(s),this.db=n.target.result,g.info("DB Connect√©e"),e(this.db)},r.onupgradeneeded=n=>{g.info("Migration DB...");const l=n.target.result;l.objectStoreNames.contains("data")||l.createObjectStore("data",{keyPath:"key"})},r.onblocked=()=>g.warn("DB bloqu√©e (autre onglet ?)")}catch(r){clearTimeout(s),i(r)}})},async get(e){return this.db||await this.init(),new Promise((i,s)=>{try{const r=this.db.transaction("data","readonly").objectStore("data").get(e);r.onsuccess=()=>i(r.result?r.result.value:null),r.onerror=()=>s(r.error)}catch(r){s(r)}})},async set(e,i){return this.db||await this.init(),new Promise((s,r)=>{try{const n=this.db.transaction("data","readwrite").objectStore("data").put({key:e,value:i});n.onsuccess=()=>s(),n.onerror=()=>r(n.error)}catch(n){r(n)}})}},M=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const i=Math.random()*16|0;return(e==="x"?i:i&3|8).toString(16)}),A=e=>new Promise(i=>{const s=new FileReader;s.readAsDataURL(e),s.onload=r=>{const n=new Image;n.src=r.target.result,n.onload=()=>{const l=document.createElement("canvas"),m=l.getContext("2d"),u=Math.min(1,1200/n.width);l.width=n.width*u,l.height=n.height*u,m.drawImage(n,0,0,l.width,l.height),i(l.toDataURL("image/jpeg",.6))}}}),E={isMeasureSuspicious:(e,i)=>i?!1:e!==void 0&&e>0&&e<300,hasAdvancedOptions:e=>["FENETRE","PORTE_FENETRE","VOLET_ROULANT","PORTE_ENTREE"].includes(e),validateProduct:e=>{const i=[];if(e.type!=="AUTRE"?(e.largeurMm||i.push("largeurMm"),!e.hauteurMm&&!e.monobloc&&i.push("hauteurMm")):e.description||i.push("description"),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE","PORTE_ENTREE","PORTE_SERVICE"].includes(e.type)){if(e.matiere||i.push("matiere"),e.profil||i.push("profil"),e.couleur||i.push("couleur"),e.couleur==="AUTRE"&&!e.couleurAutre&&i.push("couleurAutre"),e.profil==="ISO"&&!e.isoMm&&i.push("isoMm"),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE"].includes(e.type)){const s=e.vitrageFlags||{};Object.values(s).some(r=>r===!0)||i.push("vitrageFlags")}e.type==="PORTE_ENTREE"&&(e.remplissage||i.push("remplissage"))}return e.type==="VOLET_ROULANT"&&(e.manoeuvre||i.push("manoeuvre"),(e.manoeuvre==="FILAIRE"||e.manoeuvre==="RADIO")&&!e.sortieCable&&e.manoeuvre!=="SOLAIRE"&&i.push("sortieCable"),e.monobloc&&!e.coffreADeduireMm&&i.push("coffreADeduireMm")),{isValid:i.length===0,errors:i}}},I=e=>{const i=[];return e.oscilloBattant&&i.push("Oscillo-battant"),e.grilleVentilation&&i.push("Grille ventilation"),e.poigneeCle&&i.push("Poign√©e √† cl√©"),e.ouvertureExterieure&&i.push("Ouverture ext√©rieure"),e.tierceImposte&&i.push("Tierce/Imposte"),e.tierce&&i.push(`Tierce (passage ${e.cotePassageMm}mm)`),e.monobloc&&i.push(`Monobloc (coffre ${e.coffreADeduireMm}mm)`),e.boxDomotique&&i.push("Box domotique"),e.manoeuvre&&i.push(`Man≈ìuvre ${e.manoeuvre}`),e.sortieCable&&i.push(`Sortie c√¢ble ${e.sortieCable}`),e.coupleMoteur&&i.push(`Couple ${e.coupleMoteur}Nm`),e.pose&&i.push(`Pose ${e.pose}`),e.poigneeHauteur==="AUTRE"&&e.poigneeHauteurMm&&i.push(`Poign√©e ${e.poigneeHauteurMm}mm`),i.join(", ")},$=e=>{if(!e||!e.lines||e.lines.length===0)return"";let i="";return e.lines.forEach(s=>{if(s.length<2)return;let r=`M ${s[0].x} ${s[0].y}`;for(let n=1;n<s.length;n++)r+=` L ${s[n].x} ${s[n].y}`;i+=`<path d="${r}" stroke="#2563EB" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`}),`<svg width="100%" height="100%" viewBox="0 0 350 250" preserveAspectRatio="xMidYMid meet">${i}</svg>`},S=(e,i,s)=>{const r=new Date(s),n=r.toLocaleDateString("fr-FR"),l=r.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),m="@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');@page{margin:15mm}body{font-family:'Inter',sans-serif;max-width:1000px;margin:0 auto;padding:20px;color:#1e293b;line-height:1.4}.header{display:flex;justify-content:space-between;border-bottom:3px solid #2563EB;padding-bottom:20px;margin-bottom:30px}.client-box{background:#f8fafc;padding:20px;border-radius:8px;flex:1;margin-right:20px;border:1px solid #e2e8f0}.meta-box{flex:0 0 300px;text-align:right}.stat-badge{display:inline-block;padding:5px 12px;border-radius:20px;font-weight:bold;font-size:0.9em;margin-bottom:5px}.product-card{border:1px solid #cbd5e1;border-radius:8px;margin-bottom:20px;overflow:hidden;page-break-inside:avoid;box-shadow:0 2px 4px rgba(0,0,0,0.05)}.product-header{background:#f1f5f9;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #cbd5e1;font-weight:700;color:#334155}.product-body{display:grid;grid-template-columns:60% 40%}.specs{padding:15px;font-size:0.9em}.visuals{padding:15px;background:#fcfcfc;border-left:1px solid #e2e8f0;display:flex;flex-direction:column;align-items:center;justify-content:center}table.spec-table{width:100%;border-collapse:collapse}table.spec-table td{padding:4px 0;vertical-align:top}.label{color:#64748b;font-weight:600;width:140px}.value{color:#0f172a;font-weight:500}.drawing-container{border:1px dashed #cbd5e1;width:100%;height:160px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;border-radius:4px}.photo-row{display:flex;gap:5px;flex-wrap:wrap;justify-content:center}.photo-img{width:80px;height:80px;object-fit:cover;border-radius:4px;border:1px solid #eee}.alert-text{color:#d97706;font-weight:bold}.notes-box{margin-top:10px;padding:10px;background:#fffbeb;border:1px solid #fcd34d;border-radius:4px;color:#92400e;font-style:italic}.final-client-box{background:#fffbeb;padding:15px;border:1px solid #fcd34d;border-radius:8px;margin-bottom:30px}@media print{body{padding:0;margin:0}}";let u="",f="";e.typeContrat==="FOURNITURE_ET_POSE"?(u="#dcfce7;color:#166534",f="FOURNITURE ET POSE"):e.typeContrat==="SOUS_TRAITANCE"?(u="#fef3c7;color:#92400e",f="SOUS-TRAITANCE"):(u="#dbeafe;color:#1e40af",f="FOURNITURE SEULE");let h=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Relev√© ${e.client}</title><style>${m}</style></head><body onload="window.print()"><div class="header"><div class="client-box"><h1 style="margin:0 0 10px 0;color:#2563EB;">${e.client}</h1><div>üìç ${e.adresse}</div><div>üìû ${e.telephone} ${e.email?` ‚Ä¢ ‚úâÔ∏è ${e.email}`:""}</div></div><div class="meta-box"><div class="stat-badge" style="background:${u}">${f}</div><br><strong>Date:</strong> ${n} √† ${l}<br><strong>Produits:</strong> ${i.reduce((t,c)=>t+(c.quantity||1),0)}<br></div></div>${e.typeContrat==="SOUS_TRAITANCE"?`<div class="final-client-box"><strong>üë∑ CLIENT FINAL (CHANTIER) :</strong> ${e.clientFinal} - ${e.adresseFinale}</div>`:""}`;return i.forEach(t=>{var b;let c="";const o=(d,a)=>{a!=null&&a!==!1&&a!==""&&(c+=`<tr><td class="label">${d}</td><td class="value">${a===!0?"OUI":a}</td></tr>`)};t.room&&o("Localisation",`<strong>${t.room}</strong>`),o("Quantit√©",`<strong>x ${t.quantity||1}</strong>`);let x=`<strong>L ${t.largeurMm} x H ${t.hauteurMm} mm</strong>`;if(t.monobloc&&t.coffreADeduireMm&&t.hauteurMm&&(x+=`<br><span style="font-size:0.9em;color:#64748b">Passage = <strong>${t.hauteurMm-t.coffreADeduireMm} mm</strong> (Coffre ${t.coffreADeduireMm})</span>`),o("Dimensions",x),(E.isMeasureSuspicious(t.largeurMm,t.monobloc)||E.isMeasureSuspicious(t.hauteurMm,t.monobloc))&&(c+='<tr><td class="label">‚ö†Ô∏è Attention</td><td class="value alert-text">Cote < 300mm</td></tr>'),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE","PORTE_ENTREE","PORTE_SERVICE"].includes(t.type)){if(o("Mati√®re",t.matiere),o("Profil",`${t.profil} ${t.profil==="ISO"?`(${t.isoMm}mm)`:""}`),o("Couleur",`${t.couleur} ${t.couleurAutre||""}`),t.vitrageFlags){const d=t.vitrageFlags,a=[];d.standard&&a.push("4/20/4"),d.g200&&a.push("G200"),d.feuillete1f&&a.push("Feuillet√© (1F)"),d.feuillete2f&&a.push("Feuillet√© (2F)"),a.length&&o("Vitrage",a.join(", "))}(t.type==="FENETRE"||t.type==="PORTE_FENETRE")&&(o("Oscillo-Battant",t.oscilloBattant),o("Grille Vent.",t.grilleVentilation),t.poigneeHauteur==="AUTRE"&&t.poigneeHauteurMm&&o("Hauteur Poign√©e",`${t.poigneeHauteurMm} mm`),o("Poign√©e Cl√©",t.poigneeCle),o("Ouv. Ext.",t.ouvertureExterieure),t.type==="FENETRE"&&t.pieceAppuiDescription&&o("Pi√®ce Appui",t.pieceAppuiDescription),t.type==="PORTE_FENETRE"&&(o("Soubassement",t.soubassement?`${t.soubassementHauteurMm}mm`:!1),o("Serrure",t.serrure),o("Seuil PMR",t.seuilPMR))),t.type==="PORTE_ENTREE"&&(o("Remplissage",t.remplissage==="PANNEAU_DECORATIF_ALU"?"Panneau D√©co Alu":t.remplissage),o("Seuil PMR","OUI"),t.tierceImposte&&o("Tierce/Imposte","OUI"),t.tierce&&o("Tierce",`Passage: ${t.cotePassageMm}mm`),o("Ouv. Ext.",t.ouvertureExterieure)),t.type==="PORTE_SERVICE"&&o("Seuil PMR","OUI")}t.type==="VOLET_ROULANT"&&(o("Manoeuvre",t.manoeuvre),t.sortieCable&&o("Sortie C√¢ble",t.sortieCable),t.manoeuvre!=="FILAIRE"&&t.boxDomotique&&o("Box Domo","OUI"),t.coupleMoteur&&o("Couple",`${t.coupleMoteur}Nm`),t.pose&&o("Pose",t.pose),t.monobloc&&o("Monobloc",`OUI (Coffre: ${t.coffreADeduireMm}mm)`),t.lieAProduitId&&o("Li√© √†",`#${((b=i.find(d=>d.id===t.lieAProduitId))==null?void 0:b.index)||"?"}`)),t.type==="AUTRE"&&o("Description",t.description);const p=t.dessin&&t.dessin.lines.length>0?`<div class="drawing-container">${$(t.dessin)}</div>`:"",T=t.photos&&t.photos.length>0?`<div class="photo-row">${t.photos.map(d=>`<img src="${d}" class="photo-img"/>`).join("")}</div>`:"",R=t.notes?`<div class="notes-box">Note: ${t.notes}</div>`:"";h+=`<div class="product-card" style="${t.isValid?"":"border-color:#ef4444;border-width:2px"}"><div class="product-header"><span>#${String(t.index).padStart(2,"0")} - ${t.type}</span>${t.isValid?"":'<span style="color:#ef4444">‚ö†Ô∏è INCOMPLET</span>'}</div><div class="product-body"><div class="specs"><table class="spec-table">${c}</table>${R}</div><div class="visuals">${p}${T}</div></div></div>`}),h+="</body></html>",h};export{O as D,g as L,E as V,S as a,I as b,A as c,M as g};
