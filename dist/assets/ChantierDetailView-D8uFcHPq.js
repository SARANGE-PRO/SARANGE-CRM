import{c as Ae,j as e,u as ve,B as I,m as tt,d as st,S as Ne,T as rt}from"./index-DMGdsos9.js";import{R as Q,K as Me,L as at,r as x,N as pe,O as Te,l as re,Q as Ie,V as Fe,W as lt,X as fe,Y as se,G as nt,g as ce,A as J,_ as ot,$ as it,a0 as dt,a1 as ct,q as je,a2 as ze,a3 as ut,a4 as Ue,w as ee,a5 as xt,D as mt,C as ae,a6 as bt,a7 as pt,a8 as ht,y as he,a9 as gt,p as ft,u as jt,v as vt,x as Nt,s as Le,t as kt,aa as wt}from"./vendor-DQYctaBf.js";import{I as U,M as le}from"./Modal-CBdi9DRh.js";import{S as Pe}from"./StatusBanner-BmE7-72v.js";import{S as Et}from"./SmartAddress-wU2aEjgv.js";import{V as de,c as Ct,D as G,g as Z,a as yt,b as _e,L as ge,d as St}from"./utils-CKkNC6ps.js";import{S as O,A as Re}from"./AddressInput-Bj7y3_j7.js";import{C as At}from"./Card-BAmCq0CR.js";import{g as Tt,d as It}from"./calendar-CKSkTVT9.js";import{Q as Ft}from"./QuoteParserService-BHsDhh6M.js";import{getChantierQuotes as De,downloadFileAsBlob as Pt,uploadQuoteToDrive as Rt}from"./googleDrive-C87dVihc.js";const ue=({label:d,checked:p,onChange:c,disabled:s})=>Q.createElement("label",{className:Ae("flex items-center gap-3 cursor-pointer group",s&&"opacity-50 cursor-not-allowed")},Q.createElement("div",{className:Ae("w-5 h-5 rounded border flex items-center justify-center transition-all",p?"bg-brand-600 border-brand-600 text-white":"bg-white border-slate-300 group-hover:border-brand-400")},p&&Q.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",className:"w-3.5 h-3.5"},Q.createElement("polyline",{points:"20 6 9 17 4 12"}))),Q.createElement("input",{type:"checkbox",className:"hidden",checked:p,onChange:t=>!s&&c(t.target.checked),disabled:s}),Q.createElement("span",{className:"text-sm text-slate-700 dark:text-slate-300 select-none"},d)),Dt=({currentStep:d,onStepClick:p})=>{const c=[{id:1,label:"Création"},{id:2,label:"Planification"},{id:3,label:"Métrage"},{id:4,label:"Envoyé"}],s=Math.min(100,Math.max(0,(d-1)/(c.length-1)*100));return e.jsx("div",{className:"w-full bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 shadow-sm transition-colors duration-300",children:e.jsx("div",{className:"max-w-2xl mx-auto px-4 py-4",children:e.jsxs("div",{className:"relative flex items-center justify-between",children:[e.jsx("div",{className:"absolute top-[15px] left-0 w-full h-[3px] bg-slate-100 dark:bg-slate-800 rounded-full -z-0"}),e.jsx("div",{className:"absolute top-[15px] left-0 h-[3px] bg-gradient-to-r from-brand-500 to-brand-600 dark:from-brand-600 dark:to-brand-500 transition-all duration-500 ease-out rounded-full -z-0",style:{width:`${s}%`}}),c.map(t=>{const g=t.id<d,j=t.id===d,N=t.id<=d;return e.jsxs("div",{onClick:()=>N&&p&&p(t.id),className:`
                                    relative flex flex-col items-center group
                                    ${N?"cursor-pointer":"cursor-default"}
                                `,children:[e.jsx("div",{className:`
                                        w-8 h-8 rounded-full flex items-center justify-center border-2 text-sm font-bold z-10 transition-all duration-300 transform
                                        ${g?"bg-brand-600 border-brand-600 text-white shadow-md scale-100":j?"bg-white dark:bg-slate-900 border-brand-600 text-brand-600 shadow-lg scale-110 ring-4 ring-brand-50 dark:ring-brand-900/20":"bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-300 dark:text-slate-600 scale-95"}
                                        ${N&&!j?"group-hover:border-brand-300 dark:group-hover:border-brand-700":""}
                                    `,children:g?e.jsx(Me,{className:"w-4 h-4",strokeWidth:3}):j?e.jsx(at,{className:"w-4 h-4 animate-spin text-brand-600"}):e.jsx("span",{children:t.id})}),e.jsx("span",{className:`
                                        mt-2 text-[10px] sm:text-xs font-semibold uppercase tracking-wide transition-colors duration-300 text-center px-1
                                        ${j?"text-brand-600 dark:text-brand-400 translate-y-0 opacity-100":g?"text-slate-600 dark:text-slate-400 translate-y-0 opacity-100":"text-slate-400 dark:text-slate-600 translate-y-0 opacity-100"}
                                    `,children:t.label})]},t.id)})]})})})},Mt=({data:d,onChange:p,disabled:c=!1})=>{const s=x.useRef(null),t=x.useRef(null),[g,j]=x.useState((d==null?void 0:d.lines)||[]),[N,v]=x.useState(!1),[E,u]=x.useState(!1),[l,f]=x.useState("free"),[S,i]=x.useState(null),[w,T]=x.useState(null),D=350,B=250;x.useEffect(()=>{p({lines:g,width:D,height:B})},[g]);const C=(n,b=1,k=0,M=0)=>{if(!n)return;const h=n.getContext("2d");if(h.clearRect(0,0,n.width,n.height),h.save(),h.translate(k,M),h.scale(b,b),h.fillStyle="white",h.fillRect(0,0,D,B),h.lineCap="round",h.lineJoin="round",h.lineWidth=3,h.strokeStyle="#2563EB",g.forEach(F=>{if(!(F.length<1)){h.beginPath(),h.moveTo(F[0].x,F[0].y);for(let $=1;$<F.length;$++)h.lineTo(F[$].x,F[$].y);h.stroke()}}),N&&S&&w){if(h.strokeStyle="#93C5FD",h.beginPath(),l!=="free"){if(l==="line")h.moveTo(S.x,S.y),h.lineTo(w.x,w.y);else if(l==="rect"){const F=w.x-S.x,$=w.y-S.y;h.rect(S.x,S.y,F,$)}}h.stroke()}h.restore()};x.useEffect(()=>{C(s.current)},[g,N,w,l]);const[L,r]=x.useState({s:1,x:0,y:0});x.useEffect(()=>{if(!E||!t.current)return;const n=t.current;n.width=window.innerWidth,n.height=window.innerHeight;const b=Math.min(n.width/D,n.height/B)*.95,k=(n.width-D*b)/2,M=(n.height-B*b)/2;r({s:b,x:k,y:M}),C(n,b,k,M)},[E,g,N,w]);const y=(n,b=1,k=0,M=0)=>{const h=n.target.getBoundingClientRect(),F=n.touches?n.touches[0]:n;return{x:(F.clientX-h.left-k)/b,y:(F.clientY-h.top-M)/b}},A=(n,b)=>{if(c)return;n.cancelable&&n.preventDefault(),b==="fs"?t.current:s.current;const{s:k,x:M,y:h}=b==="fs"?L:{s:1,x:0,y:0},F=y(n,k,M,h);v(!0),i(F),T(F),l==="free"&&j($=>[...$,[F]])},z=(n,b)=>{if(c||!N)return;n.cancelable&&n.preventDefault();const{s:k,x:M,y:h}=b==="fs"?L:{s:1,x:0,y:0},F=y(n,k,M,h);T(F),l==="free"&&j($=>{const W=[...$],te=W[W.length-1];return te&&(W[W.length-1]=[...te,F]),W})},q=()=>{if(N){if(v(!1),S&&w){if(l==="line")j(n=>[...n,[S,w]]);else if(l==="rect"){const n=S,b=w,k={x:b.x,y:n.y},M={x:n.x,y:b.y};j(h=>[...h,[n,k,b,M,n]])}}i(null),T(null)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 relative group ${c?"opacity-70":""}`,children:[e.jsxs("div",{className:"flex flex-col gap-2 mb-2",children:[e.jsxs("div",{className:"flex justify-between items-center text-xs text-slate-500 uppercase font-bold tracking-wide",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(pe,{size:14,className:"mr-1"})," Croquis ",e.jsx("span",{className:"ml-2 text-brand-600 dark:text-brand-400 font-bold",children:"— VUE INTÉRIEUR"})]}),!c&&e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>j(n=>n.slice(0,-1)),className:"p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded text-slate-600 dark:text-slate-400",title:"Annuler",children:e.jsx(Te,{size:16})}),e.jsx("button",{onClick:()=>confirm("Effacer tout ?")&&j([]),className:"p-1 hover:bg-red-100 dark:hover:bg-red-900/30 rounded text-red-500",title:"Effacer",children:e.jsx(re,{size:16})})]})]}),!c&&e.jsxs("div",{className:"flex gap-2 border-b border-slate-200 dark:border-slate-700 pb-2",children:[e.jsxs("button",{onClick:()=>f("free"),className:`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${l==="free"?"bg-brand-600 text-white shadow-sm":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700"}`,children:[e.jsx(pe,{size:14})," Crayon"]}),e.jsxs("button",{onClick:()=>f("line"),className:`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${l==="line"?"bg-brand-600 text-white shadow-sm":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700"}`,children:[e.jsx(Ie,{size:14})," Ligne"]}),e.jsxs("button",{onClick:()=>f("rect"),className:`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${l==="rect"?"bg-brand-600 text-white shadow-sm":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700"}`,children:[e.jsx(Fe,{size:14})," Rect"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("canvas",{ref:s,width:D,height:B,className:`w-full h-48 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded touch-none shadow-inner ${c?"cursor-not-allowed":"cursor-crosshair"}`,onMouseDown:n=>A(n,"sm"),onMouseMove:n=>z(n,"sm"),onMouseUp:q,onMouseLeave:q,onTouchStart:n=>A(n,"sm"),onTouchMove:n=>z(n,"sm"),onTouchEnd:q}),!c&&e.jsx("button",{onClick:()=>u(!0),className:"absolute top-2 right-2 p-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur rounded-full shadow border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:text-brand-600",children:e.jsx(lt,{size:20})})]})]}),E&&!c&&e.jsxs("div",{className:"fixed inset-0 z-[60] bg-slate-950 flex items-center justify-center touch-none",children:[e.jsx("canvas",{ref:t,className:"block cursor-crosshair",onMouseDown:n=>A(n,"fs"),onMouseMove:n=>z(n,"fs"),onMouseUp:q,onMouseLeave:q,onTouchStart:n=>A(n,"fs"),onTouchMove:n=>z(n,"fs"),onTouchEnd:q}),e.jsxs("div",{className:"absolute top-[calc(16px+env(safe-area-inset-top))] left-4 flex gap-2 bg-slate-800/90 backdrop-blur p-2 rounded-lg border border-slate-700 shadow-xl",children:[e.jsx("button",{onClick:()=>f("free"),className:`p-3 rounded-md ${l==="free"?"bg-brand-600 text-white":"text-slate-400 hover:bg-slate-700"}`,children:e.jsx(pe,{size:24})}),e.jsx("button",{onClick:()=>f("line"),className:`p-3 rounded-md ${l==="line"?"bg-brand-600 text-white":"text-slate-400 hover:bg-slate-700"}`,children:e.jsx(Ie,{size:24})}),e.jsx("button",{onClick:()=>f("rect"),className:`p-3 rounded-md ${l==="rect"?"bg-brand-600 text-white":"text-slate-400 hover:bg-slate-700"}`,children:e.jsx(Fe,{size:24})})]}),e.jsx("div",{className:"absolute top-[calc(16px+env(safe-area-inset-top))] right-4",children:e.jsx("button",{onClick:()=>u(!1),className:"p-3 bg-red-600 text-white rounded-full shadow-lg hover:bg-red-500",children:e.jsx(fe,{size:24})})}),e.jsxs("div",{className:"absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-4 bg-slate-800/90 backdrop-blur p-2 rounded-full border border-slate-700 shadow-xl",children:[e.jsxs("button",{onClick:()=>j(n=>n.slice(0,-1)),className:"px-6 py-3 bg-slate-700 text-white rounded-full font-bold hover:bg-slate-600 flex items-center",children:[e.jsx(Te,{size:20,className:"mr-2"})," Annuler"]}),e.jsxs("button",{onClick:()=>confirm("Tout effacer ?")&&j([]),className:"px-6 py-3 bg-red-900/50 text-red-200 rounded-full font-bold hover:bg-red-900/70 flex items-center",children:[e.jsx(re,{size:20,className:"mr-2"})," Effacer"]}),e.jsxs("button",{onClick:()=>u(!1),className:"px-8 py-3 bg-green-600 text-white rounded-full font-bold hover:bg-green-500 flex items-center",children:[e.jsx(Me,{size:20,className:"mr-2"})," OK"]})]})]})]})},zt=({product:d,onSave:p,onCancel:c,isReadOnly:s=!1})=>{const[t,g]=x.useState(d),[j,N]=x.useState([]),[v,E]=x.useState(!1),[u,l]=x.useState(!1),f=x.useRef(null),{state:S}=ve(),i=(r,y)=>{s||g(A=>({...A,[r]:y}))},w=(r,y,A)=>{s||g(z=>({...z,[r]:{...z[r]||{},[y]:A}}))},T=r=>{var y;s||(i("room",r),/sdb|salle\s?de\s?bain|toilette|wc|douche/i.test(r.toLowerCase())&&["FENETRE","BAIE_COULISSANTE"].includes(t.type)&&!((y=t.vitrageFlags)!=null&&y.g200)&&(g(A=>({...A,vitrageFlags:{...A.vitrageFlags,standard:!0,g200:!0}})),l(!0),setTimeout(()=>l(!1),3e3)))};x.useEffect(()=>{t.type==="FENETRE"&&t.hauteurMm>2200&&g(r=>({...r,oscilloBattant:!1}))},[t.hauteurMm]);const D=()=>{if(s)return;const r=de.validateProduct(t);if(!r.isValid){N(r.errors),setTimeout(()=>{const y=document.getElementById(`field-${r.errors[0]}`);y&&y.scrollIntoView({behavior:"smooth",block:"center"})},100);return}p({...t,isValid:!0,validationErrors:[]})},B=async r=>{if(!s&&r.target.files&&r.target.files[0]){const y=await Ct(r.target.files[0]);i("photos",[...t.photos||[],y])}},C=r=>j.includes(r),L=s?"opacity-60 cursor-not-allowed bg-slate-100 dark:bg-slate-800":"";return e.jsxs("div",{className:"fixed inset-0 bg-slate-50 dark:bg-slate-950 z-50 flex flex-col h-full animate-fade-in",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 pb-3 pt-3 safe-top-padding flex justify-between items-center shadow-sm shrink-0",children:[e.jsx("button",{onClick:c,className:"p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800",children:e.jsx(fe,{size:24,className:"text-slate-500"})}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"font-bold dark:text-white",children:["Produit #",String(t.index).padStart(2,"0")]}),s&&e.jsxs("span",{className:"text-xs text-green-600 font-medium flex items-center justify-center gap-1",children:[e.jsx(se,{size:12})," Consultation"]})]}),s?e.jsx("div",{className:"w-[76px]"}):e.jsx(I,{onClick:D,className:"px-5 py-2 rounded-full",icon:nt,children:"Valider"})]}),s&&e.jsx("div",{className:"bg-green-50 dark:bg-green-900/20 border-b border-green-200 dark:border-green-800 px-4 py-2 text-center",children:e.jsxs("span",{className:"text-sm text-green-700 dark:text-green-300 font-medium flex items-center justify-center gap-2",children:[e.jsx(se,{size:14})," Dossier verrouillé — consultation seule"]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 pb-20 max-w-3xl mx-auto w-full",children:[j.length>0&&e.jsxs("div",{className:"mb-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-900/50 text-red-700 dark:text-red-300 p-3 rounded-lg flex items-center",children:[e.jsx(ce,{size:20,className:"mr-2"}),e.jsx("span",{children:"Champs manquants"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${L}`,children:[e.jsx(O,{label:"Type",value:t.type,onChange:r=>i("type",r),disabled:s,options:[{label:"Fenêtre",value:"FENETRE"},{label:"Porte-fenêtre",value:"PORTE_FENETRE"},{label:"Coulissant",value:"BAIE_COULISSANTE"},{label:"Porte Entrée",value:"PORTE_ENTREE"},{label:"Porte Service",value:"PORTE_SERVICE"},{label:"Volet",value:"VOLET_ROULANT"},{label:"Autre",value:"AUTRE"}]}),e.jsxs("div",{className:"flex items-center justify-between bg-slate-50 dark:bg-slate-800 p-3 rounded-lg mb-4 border border-slate-100 dark:border-slate-700",children:[e.jsx("span",{className:"font-medium text-slate-700 dark:text-slate-300",children:"Quantité"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{className:`w-8 h-8 rounded-full bg-white dark:bg-slate-700 shadow text-brand-600 font-bold ${s?"opacity-50 cursor-not-allowed":""}`,onClick:()=>i("quantity",Math.max(1,(t.quantity||1)-1)),disabled:s,children:"-"}),e.jsx("span",{className:"font-bold text-xl w-6 text-center dark:text-white",children:t.quantity||1}),e.jsx("button",{className:`w-8 h-8 rounded-full bg-white dark:bg-slate-700 shadow text-brand-600 font-bold ${s?"opacity-50 cursor-not-allowed":""}`,onClick:()=>i("quantity",(t.quantity||1)+1),disabled:s,children:"+"})]})]}),e.jsx(U,{label:"Localisation",value:t.room,onChange:T,placeholder:"Ex: Cuisine",disabled:s}),t.type==="AUTRE"&&e.jsx(U,{id:"field-description",label:"Description",value:t.description,onChange:r=>i("description",r),error:C("description"),disabled:s}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(U,{id:"field-largeurMm",label:"Largeur (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.largeurMm,onChange:r=>i("largeurMm",parseInt(r)),error:C("largeurMm"),disabled:s}),e.jsx(U,{id:"field-hauteurMm",label:"Hauteur (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.hauteurMm,onChange:r=>i("hauteurMm",parseInt(r)),error:C("hauteurMm"),disabled:s})]}),(de.isMeasureSuspicious(t.largeurMm,t.monobloc)||de.isMeasureSuspicious(t.hauteurMm,t.monobloc))&&e.jsxs("div",{className:"text-orange-500 text-xs flex items-center mt-[-10px] mb-4",children:[e.jsx(J,{size:12,className:"mr-1"})," Attention: Cotes <300mm"]})]}),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE","PORTE_ENTREE","PORTE_SERVICE"].includes(t.type)&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${L}`,children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider",children:"Caractéristiques"}),e.jsx(O,{id:"field-matiere",label:"Matière",value:t.matiere,onChange:r=>i("matiere",r),error:C("matiere"),disabled:s,options:[{label:"PVC",value:"PVC"},{label:"Alu",value:"ALU"}]}),t.matiere&&e.jsx(O,{id:"field-profil",label:"Profil",value:t.profil,onChange:r=>i("profil",r),error:C("profil"),disabled:s,options:t.matiere==="PVC"?[{label:"Réno 40",value:"RENO_40"},{label:"Réno 60",value:"RENO_60"},{label:"Neuf",value:"NEUF"},{label:"ISO",value:"ISO"},{label:"Autre",value:"AUTRE"}]:[{label:"Réno",value:"RENO"},{label:"Neuf",value:"NEUF"},{label:"Autre",value:"AUTRE"}]}),t.profil==="ISO"&&e.jsx(U,{id:"field-isoMm",label:"Aile ISO (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.isoMm,onChange:r=>i("isoMm",parseInt(r)),error:C("isoMm"),disabled:s}),t.profil==="AUTRE"&&e.jsx(U,{id:"field-profilAutre",label:"Profil personnalisé",placeholder:"Préciser le profil...",value:t.profilAutre,onChange:r=>i("profilAutre",r),error:C("profilAutre"),disabled:s}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-100 dark:border-slate-800",children:[e.jsx(O,{id:"field-couleur",label:"Couleur",value:t.couleur,onChange:r=>i("couleur",r),error:C("couleur"),disabled:s,options:t.matiere==="PVC"?[{label:"Blanc",value:"BLANC"},{label:"Bicolor 7016",value:"BICOLOR_7016"},{label:"Autre",value:"AUTRE"}]:[{label:"Blanc",value:"BLANC"},{label:"Gris 7016",value:"GRIS_7016"},{label:"Autre",value:"AUTRE"}]}),t.couleur==="AUTRE"&&e.jsx(U,{id:"field-couleurAutre",placeholder:"Préciser...",value:t.couleurAutre,onChange:r=>i("couleurAutre",r),error:C("couleurAutre"),disabled:s})]})]}),(t.type==="FENETRE"||t.type==="PORTE_FENETRE"||t.type==="BAIE_COULISSANTE")&&e.jsxs("div",{id:"field-vitrageFlags",className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border ${C("vitrageFlags")?"border-red-500 ring-1 ring-red-500":"border-slate-200 dark:border-slate-800"} ${L}`,children:[e.jsxs("h3",{className:`text-xs font-bold uppercase mb-3 tracking-wider ${C("vitrageFlags")?"text-red-500":"text-slate-400"}`,children:["Vitrage ",C("vitrageFlags")&&"*"]}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:[["standard","4/20/4"],["g200","G200"],["feuillete1f","Feuilleté 1F"],["feuillete2f","Feuilleté 2F"]].map(([r,y])=>{var A,z;return e.jsxs("label",{className:`flex items-center p-3 rounded-lg border transition-all ${s?"cursor-not-allowed":"cursor-pointer"} ${(A=t.vitrageFlags)!=null&&A[r]?"bg-brand-50 border-brand-500 text-brand-700 dark:bg-brand-900/30":"border-slate-200 dark:border-slate-700 dark:text-white"}`,children:[e.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded text-brand-600 focus:ring-brand-500",checked:!!((z=t.vitrageFlags)!=null&&z[r]),onChange:q=>w("vitrageFlags",r,q.target.checked),disabled:s}),e.jsx("span",{className:"ml-2 text-sm font-medium",children:y})]},r)})})]}),t.type==="FENETRE"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 space-y-4 ${L}`,children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider",children:"Options"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Oscillo-Battant"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.oscilloBattant,onChange:r=>i("oscilloBattant",r.target.checked),disabled:s||t.hauteurMm>2200})]}),e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Grille Ventil."}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.grilleVentilation,onChange:r=>i("grilleVentilation",r.target.checked),disabled:s})]})]}),e.jsxs("div",{className:"pt-2",children:[e.jsx("label",{className:"text-sm dark:text-slate-300 font-medium mb-2 block",children:"Hauteur Poignée"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>i("poigneeHauteur","CENTREE"),disabled:s,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${s?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur!=="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Centrée"}),e.jsx("button",{onClick:()=>i("poigneeHauteur","AUTRE"),disabled:s,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${s?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur==="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Autre"})]}),t.poigneeHauteur==="AUTRE"&&e.jsx("input",{type:"number",inputMode:"numeric",pattern:"[0-9]*",className:`mt-2 w-full p-3 border rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-700 ${s?"opacity-50 cursor-not-allowed":""}`,placeholder:"mm",value:t.poigneeHauteurMm||"",onChange:r=>i("poigneeHauteurMm",parseInt(r.target.value)),disabled:s})]})]}),t.type==="PORTE_FENETRE"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 space-y-4 ${L}`,children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider",children:"Options Porte-fenêtre"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Grille Ventil."}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.grilleVentilation,onChange:r=>i("grilleVentilation",r.target.checked),disabled:s})]}),e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Serrure"}),t.matiere==="PVC"&&e.jsx("span",{className:"text-xs text-slate-400",children:"(gros profil)"})]}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.serrure,onChange:r=>i("serrure",r.target.checked),disabled:s})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Seuil PMR"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.seuilPMR,onChange:r=>i("seuilPMR",r.target.checked),disabled:s})]}),e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Soubassement"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.soubassement,onChange:r=>i("soubassement",r.target.checked),disabled:s})]})]}),t.soubassement&&e.jsx(U,{id:"field-soubassementHauteurMm",label:"Hauteur Soubassement (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.soubassementHauteurMm,onChange:r=>i("soubassementHauteurMm",parseInt(r)),placeholder:"Ex: 400",disabled:s}),e.jsxs("div",{className:"pt-2",children:[e.jsx("label",{className:"text-sm dark:text-slate-300 font-medium mb-2 block",children:"Hauteur Poignée"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>i("poigneeHauteur","CENTREE"),disabled:s,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${s?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur!=="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Centrée"}),e.jsx("button",{onClick:()=>i("poigneeHauteur","AUTRE"),disabled:s,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${s?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur==="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Autre"})]}),t.poigneeHauteur==="AUTRE"&&e.jsx("input",{type:"number",inputMode:"numeric",pattern:"[0-9]*",className:`mt-2 w-full p-3 border rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-700 ${s?"opacity-50 cursor-not-allowed":""}`,placeholder:"mm",value:t.poigneeHauteurMm||"",onChange:r=>i("poigneeHauteurMm",parseInt(r.target.value)),disabled:s})]})]}),t.type==="VOLET_ROULANT"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${L}`,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300",children:"Lier à "}),e.jsxs("select",{className:`w-full p-3 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 dark:text-white ${s?"opacity-50 cursor-not-allowed":""}`,value:t.lieAProduitId||"",onChange:r=>i("lieAProduitId",r.target.value),disabled:s,children:[e.jsx("option",{value:"",children:"-- Indépendant --"}),S.products.filter(r=>!r.deleted&&t.chantierId&&r.chantierId===t.chantierId&&["FENETRE","BAIE_COULISSANTE"].includes(r.type)).map(r=>e.jsxs("option",{value:r.id,children:["#",String(r.index).padStart(2,"0")," ",r.type," ",r.room?`(${r.room})`:""]},r.id))]})]}),e.jsx(O,{id:"field-manoeuvre",label:"Manoeuvre",value:t.manoeuvre,onChange:r=>i("manoeuvre",r),error:C("manoeuvre"),disabled:s,options:[{label:"Filaire",value:"FILAIRE"},{label:"Radio",value:"RADIO"},{label:"Solaire",value:"SOLAIRE"}]}),t.manoeuvre&&t.manoeuvre!=="SOLAIRE"&&e.jsx(O,{id:"field-sortieCable",label:"Sortie Câble",value:t.sortieCable,onChange:r=>i("sortieCable",r),error:C("sortieCable"),disabled:s,options:[{label:"Gauche",value:"GAUCHE"},{label:"Droite",value:"DROITE"}]}),t.manoeuvre!=="FILAIRE"&&e.jsxs("label",{className:`flex items-center p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 dark:border-slate-700 mt-4 mb-4 ${s?"cursor-not-allowed":""}`,children:[e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.boxDomotique,onChange:r=>i("boxDomotique",r.target.checked),disabled:s}),e.jsx("span",{className:"ml-3 font-medium dark:text-white",children:"Box Domotique"})]}),e.jsxs("div",{className:"my-4",id:"field-coffreADeduireMm",children:[e.jsxs("label",{className:`flex items-center justify-between p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"font-medium dark:text-white",children:"Monobloc ?"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.monobloc,onChange:r=>i("monobloc",r.target.checked),disabled:s})]}),t.monobloc&&e.jsxs("div",{className:"mt-3 bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg",children:[e.jsx(U,{label:"Hauteur Coffre",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.coffreADeduireMm,onChange:r=>i("coffreADeduireMm",parseInt(r)),error:C("coffreADeduireMm"),disabled:s}),e.jsxs("div",{className:"text-right text-sm font-bold text-brand-600",children:["Passage: ",t.hauteurMm&&t.coffreADeduireMm?t.hauteurMm-t.coffreADeduireMm:"-"," mm"]})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-100 dark:border-slate-800",children:[e.jsx(O,{id:"field-couleur",label:"Couleur",value:t.couleur,onChange:r=>i("couleur",r),error:C("couleur"),disabled:s,options:[{label:"Blanc",value:"BLANC"},{label:"Autre",value:"AUTRE"}]}),t.couleur==="AUTRE"&&e.jsx(U,{id:"field-couleurAutre",placeholder:"Préciser...",value:t.couleurAutre,onChange:r=>i("couleurAutre",r),error:C("couleurAutre"),disabled:s})]})]}),de.hasAdvancedOptions(t.type)&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden ${L}`,children:[e.jsxs("button",{onClick:()=>E(!v),className:"w-full flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-800/50 font-medium text-slate-700 dark:text-slate-300",children:[e.jsx("span",{children:"Options Avancées"}),v?e.jsx(ot,{size:18}):e.jsx(it,{size:18})]}),v&&e.jsxs("div",{className:"p-4 border-t border-slate-200 dark:border-slate-800 space-y-4",children:[(t.type.includes("FENETRE")||t.type.includes("PORTE"))&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Ouverture Extérieure"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.ouvertureExterieure,onChange:r=>i("ouvertureExterieure",r.target.checked),disabled:s})]}),t.type==="FENETRE"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Poignée à  clé"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.poigneeCle,onChange:r=>i("poigneeCle",r.target.checked),disabled:s})]}),e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Pièce d'appui"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.pieceAppui,onChange:r=>i("pieceAppui",r.target.checked),disabled:s})]}),t.pieceAppui&&e.jsx(U,{id:"field-pieceAppuiDescription",label:"Description Pièce d'appui",value:t.pieceAppuiDescription,onChange:r=>i("pieceAppuiDescription",r),placeholder:"Préciser...",disabled:s})]}),t.type==="PORTE_FENETRE"&&e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Poignée à  clé"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.poigneeCle,onChange:r=>i("poigneeCle",r.target.checked),disabled:s})]}),t.type==="PORTE_ENTREE"&&e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-bold",children:"Tierce / Imposte ?"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.tierceImposte,onChange:r=>i("tierceImposte",r.target.checked),disabled:s})]})]}),t.type==="VOLET_ROULANT"&&e.jsxs("div",{children:[e.jsx(O,{label:"Couple",value:t.coupleMoteur||10,onChange:r=>i("coupleMoteur",r),disabled:s,options:[{label:"10 Nm",value:10},{label:"20 Nm",value:20}]}),e.jsx(O,{label:"Pose",value:t.pose||"RENO",onChange:r=>i("pose",r),disabled:s,options:[{label:"Rénov",value:"RENO"},{label:"Tradi",value:"TRADI"},{label:"Tunnel",value:"TUNNEL"}]})]})]})]}),t.type==="PORTE_ENTREE"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 p-5 rounded-xl border dark:border-slate-800 ${L}`,children:[e.jsx(O,{id:"field-remplissage",label:"Remplissage",value:t.remplissage,onChange:r=>i("remplissage",r),error:C("remplissage"),disabled:s,options:[{label:"Panneau Déco Alu",value:"PANNEAU_DECORATIF_ALU"},{label:"Sandwich",value:"PANNEAU_SANDWICH"},{label:"Vitrée",value:"VITREE"}]}),t.largeurMm>1e3&&e.jsxs("div",{className:"mt-3 pt-3 border-t dark:border-slate-700",children:[e.jsxs("label",{className:`flex items-center justify-between mb-3 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium",children:"Tierce ?"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.tierce,onChange:r=>i("tierce",r.target.checked),disabled:s})]}),t.tierce&&e.jsx(U,{id:"field-cotePassageMm",label:"Cote Passage (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.cotePassageMm,onChange:r=>i("cotePassageMm",r),error:C("cotePassageMm"),disabled:s})]})]}),e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${L}`,children:[e.jsx(Mt,{data:t.dessin,onChange:r=>i("dessin",r),disabled:s}),e.jsxs("div",{className:"mt-6",children:[e.jsx("label",{className:"block text-sm font-medium mb-3 text-slate-700 dark:text-slate-300",children:"Photos"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[(t.photos||[]).map((r,y)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700 group",children:[e.jsx("img",{src:r,className:"w-full h-full object-cover"}),!s&&e.jsx("button",{onClick:()=>i("photos",t.photos.filter((A,z)=>z!==y)),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 shadow-md opacity-80 hover:opacity-100",children:e.jsx(fe,{size:12})})]},y)),!s&&e.jsxs("button",{onClick:()=>{var r;return(r=f.current)==null?void 0:r.click()},className:"aspect-square rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600 flex flex-col items-center justify-center text-slate-400 hover:text-brand-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors",children:[e.jsx(dt,{size:24}),e.jsx("span",{className:"text-[10px] mt-1",children:"Ajouter"})]}),e.jsx("input",{type:"file",ref:f,accept:"image/*",className:"hidden",onChange:B,disabled:s})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"Notes techniques"}),e.jsx("textarea",{className:`w-full p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-950 dark:text-white h-24 text-sm focus:border-brand-500 outline-none ${s?"opacity-50 cursor-not-allowed":""}`,placeholder:"Contraintes...",value:t.notes||"",onChange:r=>i("notes",r.target.value),disabled:s})]})]})]})]}),u&&e.jsxs("div",{className:"fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-3 rounded-lg shadow-xl flex items-center animate-slide-up",children:[e.jsx(ct,{size:20,className:"text-blue-400 mr-2"})," Vitrage G200 activé (Intimité)"]})]})},Ut=({chantier:d})=>{const[p,c]=x.useState(!1);if(!d||!d.dateIntervention)return null;const s=()=>{window.open(Tt(d),"_blank"),c(!1)},t=()=>{It(d),c(!1)};return e.jsxs("div",{className:"relative inline-block",children:[e.jsxs(I,{variant:"secondary",onClick:()=>c(!p),className:"py-2 px-3 text-sm flex items-center gap-2",title:"Ajouter à l'agenda",children:[e.jsx(je,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:"Agenda"})]}),p&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 z-50 animate-fade-in overflow-hidden flex flex-col p-1",children:[e.jsxs("button",{onClick:s,className:"flex items-center w-full px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 rounded-lg transition-colors text-left",children:[e.jsx(ze,{size:14,className:"mr-2"})," Google Calendar"]}),e.jsxs("button",{onClick:t,className:"flex items-center w-full px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg transition-colors text-left",children:[e.jsx(ut,{size:14,className:"mr-2"})," Outlook / Apple"]})]}),p&&e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>c(!1)})]})},Lt=({chantier:d,onClose:p,onUpdate:c})=>{const[s,t]=x.useState({...d}),[g,j]=x.useState(null),[N,v]=x.useState(!1),E=(l,f="adresse")=>{t(typeof l=="object"?{...s,[f]:l.address,gps:l.gps}:{...s,[f]:l})},u=async()=>{if(!s.client)return alert("Nom requis");if(s.typeContrat==="SOUS_TRAITANCE"&&(!s.clientFinal||!s.adresseFinale))return alert("Client final requis");let l={...s};if(N&&d.quoteFileId&&(await G.deleteFile(d.quoteFileId),l.quoteFileId=null,l.quoteFileName=null,l.quoteFile=null),g){d.quoteFileId&&!N&&await G.deleteFile(d.quoteFileId);const f=Z();await G.storeFile(f,g),l.quoteFileId=f,l.quoteFileName=g.name,l.quoteFile=null}if(c(l),p(),s.dateIntervention)try{const f=await tt(s);f&&f!==s.googleEventId&&c({...l,googleEventId:f})}catch(f){console.error("Silent GCal Sync Fail",f)}else if(s.googleEventId)try{st(s).catch(console.error),c({...l,googleEventId:null})}catch(f){console.error("GCal Delete Fail",f)}};return e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-end md:items-center justify-center p-0 md:p-4 animate-fade-in",children:e.jsxs(At,{className:"w-full max-w-md p-6 shadow-2xl rounded-t-2xl md:rounded-2xl max-h-[95vh] overflow-y-auto animate-slide-up md:animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-start mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold dark:text-white",children:"Modifier le dossier"}),e.jsxs("p",{className:"text-xs text-slate-400 mt-1",children:["ID : ",s.id.slice(0,8)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ut,{chantier:s}),e.jsx("button",{onClick:p,className:"p-2 text-slate-400 hover:text-slate-600 bg-slate-50 dark:bg-slate-800 rounded-full transition-colors",children:"✕"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700",children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-500 mb-2 uppercase tracking-wider",children:"Planification"}),e.jsx(U,{label:"Date d'intervention",type:"datetime-local",value:s.dateIntervention||"",onChange:l=>t({...s,dateIntervention:l})}),e.jsx("p",{className:"text-[10px] font-medium text-slate-400 mt-2",children:s.dateIntervention?"✅ Ce dossier passera en PLANNING":"⚠️ Sans date, ce dossier reste en À PLANIFIER"})]}),e.jsx(U,{label:"Nom Client",value:s.client,onChange:l=>t({...s,client:l})}),e.jsx(Re,{value:s.adresse,onChange:l=>t(typeof l=="object"?{...s,adresse:l.address,gps:l.gps}:{...s,adresse:l})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(U,{label:"Tél",value:s.telephone,onChange:l=>t({...s,telephone:l}),type:"tel",inputMode:"tel",pattern:"[0-9]*"}),e.jsx(U,{label:"Email",value:s.email,onChange:l=>t({...s,email:l}),type:"email",inputMode:"email"})]}),e.jsx(O,{label:"Contrat",value:s.typeContrat,onChange:l=>t({...s,typeContrat:l}),options:[{label:"Fourniture Seule",value:"FOURNITURE_SEULE"},{label:"Fourniture & Pose",value:"FOURNITURE_ET_POSE"},{label:"Sous-traitance",value:"SOUS_TRAITANCE"}]}),s.typeContrat==="SOUS_TRAITANCE"&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg border border-amber-200 dark:border-amber-800 animate-fade-in",children:[e.jsxs("h3",{className:"text-xs font-bold text-amber-600 dark:text-amber-400 mb-2 uppercase flex items-center",children:[e.jsx(Ue,{size:14,className:"mr-1"})," Client Final"]}),e.jsx(U,{label:"Nom Final",value:s.clientFinal,onChange:l=>t({...s,clientFinal:l})}),e.jsx(Re,{value:s.adresseFinale,onChange:l=>E(l,"adresseFinale")})]}),e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700",children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-500 mb-2 uppercase tracking-wider",children:"Devis PDF"}),!N&&(s.quoteFileId||s.quoteFileName)?e.jsxs("div",{className:"flex items-center justify-between bg-white dark:bg-slate-700 p-2 rounded-lg border border-slate-200 dark:border-slate-600",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx("div",{className:"bg-brand-100 dark:bg-brand-900/30 p-1.5 rounded text-brand-600 dark:text-brand-400",children:e.jsx(ee,{size:16})}),e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-200 truncate max-w-[150px]",title:s.quoteFileName,children:s.quoteFileName||"Devis.pdf"})]}),e.jsx("button",{onClick:()=>v(!0),className:"p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors",title:"Supprimer / Remplacer",children:e.jsx(re,{size:16})})]}):e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:".pdf,application/pdf",className:"block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100",onChange:l=>j(l.target.files?l.target.files[0]:null)}),g&&e.jsxs("p",{className:"text-xs text-brand-600 mt-1 flex items-center gap-1",children:[e.jsx(xt,{size:12})," Prêt à envoyer : ",g.name]}),N&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"Le fichier actuel sera supprimé à l'enregistrement."})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-xs font-bold text-slate-500 mb-1 ml-1",children:"Infos supplémentaires"}),e.jsx("textarea",{className:"w-full p-3 bg-slate-100 dark:bg-slate-800 border-0 rounded-xl outline-none focus:ring-2 focus:ring-brand-500 transition-all text-sm min-h-[80px]",placeholder:"Codes d'accès, instructions particulières...",value:s.notes||"",onChange:l=>t({...s,notes:l.target.value})})]})]}),e.jsxs("div",{className:"flex gap-3 mt-8 pb-4",children:[e.jsx(I,{variant:"secondary",onClick:p,className:"flex-1",children:"Annuler"}),e.jsx(I,{onClick:u,className:"flex-1",children:"Enregistrer"})]})]})})},_t=({onClose:d,onImport:p})=>{const[c,s]=x.useState(!1),[t,g]=x.useState([]),[j,N]=x.useState(null),[v,E]=x.useState(null),[u,l]=x.useState(()=>new Set),[f,S]=x.useState(null),[i,w]=x.useState("PARSE"),T=x.useRef(null),D=()=>{s(!1),g([]),N(null),E(null),l(new Set),S(null),T.current&&(T.current.value="")},B=n=>{if(!n)return!1;const b=n.type==="application/pdf",k=typeof n.name=="string"&&n.name.toLowerCase().endsWith(".pdf");return b||k},C=async n=>{const b=n.target.files&&n.target.files[0];if(!b)return;const k=25,M=k*1024*1024;if(!B(b)){S("Le fichier doit être un PDF."),T.current&&(T.current.value="");return}if(b.size>M){S(`PDF trop volumineux (max ${k} MB).`),T.current&&(T.current.value="");return}if(s(!0),S(null),g([]),l(new Set),E(b),i==="STORE"){s(!1);return}try{const h=await Ft.parseQuote(b);g(h.items),N(h.meta),l(new Set(h.items.map(F=>F.id)))}catch(h){console.error(h),S("Erreur lors de l'analyse du PDF. Vérifiez qu'il n'est pas protégé.")}finally{s(!1)}},L=n=>{l(b=>{const k=new Set(b);return k.has(n)?k.delete(n):k.add(n),k})},r=()=>{l(n=>{if(t.length===0)return new Set;const b=t.map(M=>M.id);return n.size===b.length?new Set:new Set(b)})},y=(n,b,k)=>{g(M=>M.map(h=>h.id===n?{...h,[b]:k}:h))},A=()=>{if(i==="STORE")p([],v,null);else{const n=t.filter(b=>u.has(b.id));p(n,v,j)}},z=x.useMemo(()=>t.length>0&&u.size===t.length,[t.length,u.size]),q=x.useMemo(()=>v?i==="STORE"?!0:t.length>0&&u.size>0:!1,[v,i,t.length,u.size]);return e.jsx(le,{isOpen:!0,onClose:d,title:"Importer / Stocker un devis",size:"lg",children:e.jsxs("div",{className:"flex flex-col h-[600px]",children:[!v&&e.jsxs("div",{className:"px-6 pt-4 pb-2",children:[e.jsxs("div",{className:"flex gap-4 p-1 bg-slate-100 dark:bg-slate-800 rounded-lg",children:[e.jsx("button",{onClick:()=>w("PARSE"),className:`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all ${i==="PARSE"?"bg-white dark:bg-slate-700 shadow-sm text-brand-600 dark:text-brand-400":"text-slate-500 hover:text-slate-700 dark:hover:text-slate-300"}`,children:"Analyser & Importer"}),e.jsx("button",{onClick:()=>w("STORE"),className:`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all ${i==="STORE"?"bg-white dark:bg-slate-700 shadow-sm text-brand-600 dark:text-brand-400":"text-slate-500 hover:text-slate-700 dark:hover:text-slate-300"}`,children:"Stocker uniquement"})]}),e.jsx("p",{className:"text-xs text-slate-500 mt-2 px-1",children:i==="PARSE"?"Extrait les menuiseries du PDF pour créer les produits automatiquement.":"Stocke simplement le fichier PDF dans le dossier (Consultable hors-ligne, pas de création de produits)."})]}),!v&&!c&&e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-900 m-4",children:[e.jsx("input",{ref:T,type:"file",accept:".pdf,application/pdf",onChange:C,className:"hidden",id:"pdf-upload"}),e.jsxs("label",{htmlFor:"pdf-upload",className:"flex flex-col items-center cursor-pointer p-10",children:[e.jsx("div",{className:"bg-brand-100 dark:bg-brand-900/30 p-4 rounded-full text-brand-600 dark:text-brand-400 mb-4",children:e.jsx(mt,{size:48})}),e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-2",children:"Cliquez pour sélectionner un devis"}),e.jsxs("p",{className:"text-slate-500 text-sm text-center max-w-xs",children:["Formats supportés : PDF uniquement.",e.jsx("br",{}),i==="PARSE"?"Analyse automatique des menuiseries.":"Stockage sécurisé locale."]})]}),f&&e.jsxs("div",{className:"mt-4 flex items-center gap-2 text-red-600 bg-red-50 dark:bg-red-900/20 px-4 py-2 rounded-lg",children:[e.jsx(ce,{size:20}),e.jsx("span",{children:f})]})]}),c&&e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center","aria-live":"polite",children:[e.jsx(Ne,{size:48}),e.jsx("p",{className:"mt-4 text-slate-600 dark:text-slate-300 font-medium",children:"Analyse du document en cours..."}),e.jsx("p",{className:"text-xs text-slate-400 mt-2",children:"Cela peut prendre quelques secondes."})]}),v&&i==="STORE"&&e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center m-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm text-center",children:[e.jsx(ee,{size:64,className:"text-brand-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-slate-800 dark:text-white mb-1",children:v.name}),e.jsxs("p",{className:"text-slate-500 mb-6",children:[(v.size/1024/1024).toFixed(2)," MB"]}),e.jsx(I,{variant:"ghost",size:"sm",onClick:D,children:"Changer de fichier"})]}),e.jsxs("div",{className:"mt-8 text-center max-w-md text-slate-500 text-sm",children:[e.jsx(ae,{className:"inline-block text-green-500 mr-2",size:16}),"Le fichier sera stocké localement et lié à ce chantier."]})]}),v&&i==="PARSE"&&t.length>0&&e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center px-4 py-3 bg-slate-100 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"text-slate-500",size:20}),e.jsxs("span",{className:"font-bold text-slate-700 dark:text-slate-200",children:[t.length," élément(s) détecté(s)"]})]}),e.jsx(I,{variant:"ghost",size:"sm",onClick:D,children:"Changer de fichier"})]}),e.jsx("div",{className:"overflow-y-auto flex-1 p-4",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"text-xs text-slate-500 uppercase bg-slate-50 dark:bg-slate-900 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 rounded-tl-lg",children:e.jsx(ue,{checked:z,onChange:r})}),e.jsx("th",{className:"px-4 py-3",children:"Qté"}),e.jsx("th",{className:"px-4 py-3",children:"Type"}),e.jsx("th",{className:"px-4 py-3",children:"Dimensions"}),e.jsx("th",{className:"px-4 py-3",children:"Détails"}),e.jsx("th",{className:"px-4 py-3 rounded-tr-lg",children:"Source"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100 dark:divide-slate-800",children:t.map(n=>{const b=u.has(n.id);return e.jsxs("tr",{className:`hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors ${b?"":"opacity-50"}`,children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx(ue,{checked:b,onChange:()=>L(n.id)})}),e.jsxs("td",{className:"px-4 py-3 font-bold text-brand-600 dark:text-brand-400",children:["x",n.quantity||1]}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("select",{value:n.type,onChange:k=>y(n.id,"type",k.target.value),className:"w-full p-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-sm focus:ring-2 focus:ring-brand-500 outline-none",children:[e.jsx("option",{value:"FENETRE",children:"FENETRE"}),e.jsx("option",{value:"PORTE_FENETRE",children:"PORTE_FENETRE"}),e.jsx("option",{value:"BAIE_COULISSANTE",children:"BAIE_COULISSANTE"}),e.jsx("option",{value:"PORTE_ENTREE",children:"PORTE_ENTREE"}),e.jsx("option",{value:"PORTE_SERVICE",children:"PORTE_SERVICE"}),e.jsx("option",{value:"VOLET_ROULANT",children:"VOLET_ROULANT"}),e.jsx("option",{value:"AUTRE",children:"AUTRE"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"number",value:n.width,onChange:k=>y(n.id,"width",parseInt(k.target.value)||0),className:"w-16 p-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-sm text-center focus:ring-2 focus:ring-brand-500 outline-none"}),e.jsx("span",{className:"text-slate-400",children:"x"}),e.jsx("input",{type:"number",value:n.height,onChange:k=>y(n.id,"height",parseInt(k.target.value)||0),className:"w-16 p-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-sm text-center focus:ring-2 focus:ring-brand-500 outline-none"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("input",{type:"text",value:n.label||"",onChange:k=>y(n.id,"label",k.target.value),placeholder:"Désignation...",className:"w-full p-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-sm focus:ring-2 focus:ring-brand-500 outline-none"}),e.jsxs("div",{className:"text-xs text-slate-500 flex gap-2",children:[e.jsx("span",{children:n.material}),e.jsx("span",{children:n.color})]})]})}),e.jsxs("td",{className:"px-4 py-3 text-xs text-slate-400 italic max-w-[150px] truncate",title:n.originalLine,children:['"',n.originalLine,'"']})]},n.id||`${n.repere}-${n.originalLine}`)})})]})})]}),e.jsxs("div",{className:"p-4 border-t border-slate-200 dark:border-slate-800 flex justify-end gap-3 bg-white dark:bg-slate-950",children:[e.jsx(I,{variant:"ghost",onClick:d,children:"Annuler"}),e.jsx(I,{variant:"primary",disabled:!q,onClick:A,icon:ae,children:i==="STORE"?"Stocker le fichier":`Importer ${u.size} produit(s)`})]})]})})},qt=({isOpen:d,onClose:p,blobUrl:c,title:s="Devis"})=>{const t=()=>{c&&URL.revokeObjectURL(c),p()};return d?e.jsx(le,{isOpen:d,onClose:t,title:s,size:"6xl",children:e.jsxs("div",{className:"flex flex-col h-[85vh]",children:[e.jsxs("div",{className:"flex justify-between items-center p-3 border-b border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900",children:[e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:"📄 Aperçu en ligne • Google bloque parfois l'affichage direct"}),e.jsx(I,{variant:"ghost",size:"sm",icon:ze,onClick:()=>window.open(c,"_blank"),className:"text-brand-600 dark:text-brand-400 font-bold",children:"Ouvrir dans un nouvel onglet"})]}),e.jsx("div",{className:"flex-1 w-full bg-slate-100 dark:bg-slate-800 rounded-b-lg overflow-auto",style:{WebkitOverflowScrolling:"touch"},children:e.jsx("iframe",{src:c,className:"w-full h-full border-0",title:"Aperçu du Devis"})})]})}):null},$t=({isOpen:d,onClose:p,onConfirm:c,clientName:s})=>{const[t,g]=x.useState(""),[j,N]=x.useState(""),[v,E]=x.useState(!1),u=t==="Autre"?j.trim():t,l=u.length>0,f=async()=>{if(l){E(!0);try{await c(u)}finally{E(!1)}}};return e.jsx(le,{isOpen:d,onClose:v?void 0:p,title:"↩ Retour Commercial",size:"sm",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg border border-amber-200 dark:border-amber-800 flex gap-3",children:[e.jsx(J,{className:"text-amber-600 shrink-0",size:20}),e.jsxs("p",{className:"text-sm text-amber-800 dark:text-amber-200",children:["Le dossier ",e.jsx("strong",{children:s})," retournera au commercial avec le rapport de métrage et le motif. Le commercial pourra refaire son chiffrage."]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:"Motif du retour"}),e.jsxs("select",{value:t,onChange:S=>g(S.target.value),className:"w-full p-2.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none transition-all text-sm",children:[e.jsx("option",{value:"",disabled:!0,children:"Sélectionnez un motif..."}),e.jsx("option",{value:"Cotes terrain trop différentes du devis",children:"Cotes terrain trop différentes du devis"}),e.jsx("option",{value:"Produit non réalisable",children:"Produit non réalisable"}),e.jsx("option",{value:"Support non conforme",children:"Support non conforme"}),e.jsx("option",{value:"Accès impossible",children:"Accès impossible"}),e.jsx("option",{value:"Client souhaite modification",children:"Client souhaite modification"}),e.jsx("option",{value:"Autre",children:"Autre"})]})]}),t==="Autre"&&e.jsxs("div",{className:"animate-fade-in",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:"Précisez la raison"}),e.jsx(U,{value:j,onChange:N,placeholder:"Ex: Accès trop étroit pour la baie...",autoFocus:!0})]}),e.jsxs("div",{className:"pt-2 flex flex-col gap-2",children:[e.jsx(I,{onClick:f,disabled:!l||v,variant:l?"primary":"secondary",className:"w-full py-3 !bg-amber-600 hover:!bg-amber-700",icon:bt,children:v?"Envoi en cours...":"Confirmer le retour"}),e.jsx(I,{onClick:p,variant:"ghost",className:"w-full",disabled:v,children:"Annuler"})]})]})})},Vt=(d,p)=>{switch(d){case"VOLET_ROULANT":return{type:"VOLET_ROULANT",profil:"ALU"};case"BAIE_COULISSANTE":return{type:"BAIE_COULISSANTE",profil:"ALU"};case"PORTE_ENTREE":return{type:"PORTE_ENTREE",profil:"ALU_80"};case"PORTE_FENETRE":return{type:"PORTE_FENETRE",profil:"RENO_40"};case"FENETRE":return{type:"FENETRE",profil:"RENO_40"};case"PORTE_SERVICE":return{type:"PORTE_SERVICE",profil:"RENO_40"};case"AUTRE":return{type:"AUTRE",profil:"AUTRE"};case"PORTE_INTERIEURE":return{type:"PORTE_ENTREE",notes:"Type : Porte Intérieure détectée"};default:return{type:"FENETRE",notes:"Type inconnu, importé comme fenêtre par défaut"}}},Bt=({history:d})=>{if(!(d!=null&&d.length))return null;const p=[...d].sort((c,s)=>new Date(s.date)-new Date(c.date));return e.jsxs("div",{className:"mt-8 border-t border-slate-200 dark:border-slate-800 pt-6 animate-fade-in",children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(kt,{size:20,className:"text-slate-400"}),"Historique du dossier"]}),e.jsx("div",{className:"space-y-3",children:p.map((c,s)=>e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700 text-sm",children:[e.jsxs("div",{className:"flex justify-between text-slate-500 dark:text-slate-400 text-xs mb-1",children:[e.jsx("span",{children:new Date(c.date).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}),e.jsx("span",{className:"font-medium bg-slate-200 dark:bg-slate-700 px-1.5 rounded",children:c.user||"Système"})]}),e.jsxs("div",{className:"text-slate-800 dark:text-slate-200",children:[e.jsx("span",{className:"font-bold uppercase text-xs mr-2 text-brand-600 dark:text-brand-400",children:c.action==="UNLOCK"?"DÉVERROUILLAGE":c.action}),e.jsx("span",{children:c.reason})]}),c.details&&e.jsxs("div",{className:"mt-1 pl-3 border-l-2 border-slate-300 dark:border-slate-600 italic text-slate-600 dark:text-slate-400 text-xs",children:['"',c.details,'"']})]},s))})]})};async function Ot(d,p,c,s){var E;const t=(E=window.SARANGE_CONFIG)==null?void 0:E.APPS_SCRIPT_URL,g=15e3;if(!t||t.includes("your-script-id"))return ge.warn("URL Google Apps Script non configurée ou invalide"),{success:!1,error:"Configuration email manquante"};const j={timestamp:new Date().toISOString(),metrage_id:Z(),htmlReport:c,chantier:{client:d.client,adresse:d.adresse,telephone:d.telephone||"",email:d.email||"",typeContrat:d.typeContrat},clientFinal:d.typeContrat==="SOUS_TRAITANCE"?{nom:d.clientFinal,adresse:d.adresseFinale}:null,produits:p.map(u=>({numero:u.index,type:u.type,quantite:u.quantity||1,localisation:u.room||"",dimensions:`${u.largeurMm} x ${u.hauteurMm} mm`,matiere:u.matiere||"",profil:u.profil||"",couleur:u.couleur==="AUTRE"?u.couleurAutre:u.couleur||"",vitrage:u.vitrageFlags?Object.entries(u.vitrageFlags).filter(([l,f])=>f).map(([l])=>l==="standard"?"4/20/4":l==="g200"?"G200":l==="feuillete1f"?"Feuilleté 1F":l==="feuillete2f"?"Feuilleté 2F":"").filter(Boolean).join(", "):"",options:St(u),notes:u.notes||"",isValid:u.isValid})),total_produits:p.reduce((u,l)=>u+(l.quantity||1),0),produits_incomplets:p.filter(u=>!u.isValid).length},N=new AbortController,v=setTimeout(()=>N.abort(),g);try{s==null||s({sendStatus:"SENDING",lastError:null});const u=await fetch(t,{method:"POST",mode:"cors",headers:{"Content-Type":"text/plain"},body:JSON.stringify(j),signal:N.signal});if(clearTimeout(v),!u.ok)throw new Error(`Erreur HTTP: ${u.status}`);const l=await u.json();if(l.success===!0){const f=new Date().toISOString();return s==null||s({sendStatus:"SENT",sentAt:f,lastError:null,dateFinalisation:f}),ge.info("✅ Métrage envoyé avec succès",{metrage_id:j.metrage_id,client:d.client}),{success:!0}}else throw new Error(l.error||"Réponse serveur invalide")}catch(u){clearTimeout(v);let l;return u.name==="AbortError"?l="Connexion trop lente (délai 15s dépassé)":u.message.includes("Failed to fetch")||u.message.includes("NetworkError")?l="Pas de connexion réseau":l=u.message,s==null||s({sendStatus:"ERROR",lastError:l}),ge.error("â Œ Échec envoi métrage",{error:l,client:d.client}),{success:!1,error:l}}}const Gt=({chantier:d,products:p,incompleteCount:c,onClose:s,onStatusChange:t,onSuccess:g,onError:j})=>{const[N,v]=x.useState({cotes:!1,options:!1}),[E,u]=x.useState(!1),[l,f]=x.useState(!1),S=N.cotes&&N.options,i=async()=>{u(!0);const w=_e(d,p,new Date().toISOString()),T=await Ot(d,p,w,t);if(T.success){const D={};if(new Blob([w]).size>5e4){const C=d.id+"_rapport";try{await G.storeFile(C,new Blob([w],{type:"text/html"})),D.rapportMetrageFileId=C,D.rapportMetrage=null}catch(L){console.warn("Fallback: stockage inline",L),D.rapportMetrage=w}}else D.rapportMetrage=w;D.assignation="METHODES",t==null||t(D),u(!1),f(!0),setTimeout(()=>{g==null||g()},1500)}else u(!1),j==null||j(T.error)};return e.jsx(le,{isOpen:!0,onClose:E||l?void 0:s,title:l?"✓ Envoyé !":"Êtes-vous sûr ?",size:"md",children:e.jsxs("div",{className:"relative min-h-[360px] flex flex-col",children:[l&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center animate-fade-in z-10",children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-green-100 dark:bg-green-900/30 rounded-full scale-150 animate-pulse"}),e.jsx("div",{className:"bg-green-500 text-white rounded-full p-6 shadow-xl shadow-green-500/40 relative z-10 animate-bounce",children:e.jsx(ae,{size:48,strokeWidth:3})})]}),e.jsx("h3",{className:"text-2xl font-bold text-slate-800 dark:text-white mb-2",children:"Dossier Envoyé !"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-center text-sm",children:"Le métrage a été transmis au bureau"})]}),!l&&e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsx(ue,{checked:N.cotes,onChange:w=>v(T=>({...T,cotes:w})),label:"J'ai vérifié toutes les cotes"}),e.jsx(ue,{checked:N.options,onChange:w=>v(T=>({...T,options:w})),label:"J'ai vérifié les options"})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 mb-4 flex items-start gap-3",children:[e.jsx("div",{className:"bg-red-100 dark:bg-red-900/50 p-2 rounded-lg shrink-0",children:e.jsx(J,{className:"text-red-600 dark:text-red-400",size:20})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-red-700 dark:text-red-300 text-sm",children:"Action irréversible"}),e.jsx("p",{className:"text-red-600 dark:text-red-400 text-xs mt-1 leading-relaxed",children:"Le dossier sera verrouillé après envoi."})]})]}),e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800 rounded-xl p-4 mb-6 border border-slate-100 dark:border-slate-700",children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"Total Produits"}),e.jsx("span",{className:"font-bold text-slate-800 dark:text-white bg-white dark:bg-slate-700 px-2 py-0.5 rounded border border-slate-200 dark:border-slate-600",children:p.reduce((w,T)=>w+(T.quantity||1),0)})]}),c>0&&e.jsxs("div",{className:"flex justify-between text-sm mt-2 pt-2 border-t border-slate-200 dark:border-slate-700",children:[e.jsxs("span",{className:"text-amber-600 dark:text-amber-400 flex items-center gap-2",children:[e.jsx(J,{size:16})," Incomplets"]}),e.jsx("span",{className:"font-bold text-white bg-amber-500 px-2 py-0.5 rounded text-xs",children:c})]})]}),e.jsxs("div",{className:"mt-auto space-y-3",children:[e.jsx(I,{onClick:i,disabled:!S||E,className:`w-full py-4 text-base transition-all duration-300 ${S?"translate-y-0 opacity-100":"opacity-80"}`,icon:E?null:Le,children:E?e.jsxs("span",{className:"flex items-center justify-center gap-3",children:[e.jsx(Ne,{size:20}),e.jsx("span",{children:"Transmission en cours..."})]}):"Confirmer l'envoi"}),e.jsx(I,{onClick:s,variant:"ghost",className:"w-full py-3",disabled:E,children:"Annuler"})]})]})]})})},Ht=({onClose:d,onUnlock:p})=>{const[c,s]=x.useState(""),[t,g]=x.useState(""),{user:j}=ve(),N=c&&(c!=="Autre"||t.trim().length>0),v=()=>{N&&p({reason:c,details:c==="Autre"?t:null,user:(j==null?void 0:j.email)||"Inconnu"})};return e.jsx(le,{isOpen:!0,onClose:d,title:"Déverrouiller le dossier",size:"sm",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg border border-amber-200 dark:border-amber-800 flex gap-3",children:[e.jsx(J,{className:"text-amber-600 shrink-0",size:20}),e.jsx("p",{className:"text-sm text-amber-800 dark:text-amber-200",children:"Cette action sera enregistrée dans l'historique du dossier."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:"Motif du déverrouillage"}),e.jsxs("select",{value:c,onChange:E=>s(E.target.value),className:"w-full p-2.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none transition-all",children:[e.jsx("option",{value:"",disabled:!0,children:"Sélectionnez un motif..."}),e.jsx("option",{value:"Erreur de métrage",children:"Erreur de métrage"}),e.jsx("option",{value:"Changement client",children:"Changement client"}),e.jsx("option",{value:"Ajout oublié",children:"Ajout oublié"}),e.jsx("option",{value:"Autre",children:"Autre"})]})]}),c==="Autre"&&e.jsxs("div",{className:"animate-fade-in",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:"Précisez la raison"}),e.jsx(U,{value:t,onChange:g,placeholder:"Ex: Demande architecte...",autoFocus:!0})]}),e.jsxs("div",{className:"pt-2 flex flex-col gap-2",children:[e.jsx(I,{onClick:v,disabled:!N,variant:N?"danger":"secondary",className:"w-full py-3",icon:wt,children:"Déverrouiller"}),e.jsx(I,{onClick:d,variant:"ghost",className:"w-full",children:"Annuler"})]})]})})},as=()=>{const{state:d,selectChantier:p,deleteProduct:c,saveProduct:s,updateChantier:t,updateChantierDate:g,navigate:j,setReturnView:N}=ve(),[v,E]=x.useState(null),[u,l]=x.useState(!1),[f,S]=x.useState(!1),[i,w]=x.useState(!1),[T,D]=x.useState(!1),[B,C]=x.useState(null),[L,r]=x.useState(!1),[y,A]=x.useState(null),[z,q]=x.useState(!1),[n,b]=x.useState(null),[k,M]=x.useState([]),[h,F]=x.useState(!1),[$,W]=x.useState(!1),[te,ke]=x.useState(null),a=d.chantiers.find(o=>o.id===d.currentChantierId);if(a&&a.deleted)return null;Q.useEffect(()=>{(async()=>{if(a!=null&&a.quoteFileId&&!n)try{const m=await G.getFile(a.quoteFileId);m&&(b(m),console.log("📄 PDF preloaded from IndexedDB"))}catch(m){console.warn("Failed to preload PDF from IndexedDB:",m)}})()},[a==null?void 0:a.id,a==null?void 0:a.quoteFileId]);const V=(d.products||[]).filter(o=>o.chantierId===(a==null?void 0:a.id)&&!o.deleted).sort((o,m)=>o.index-m.index),xe=(a==null?void 0:a.sendStatus)||"DRAFT",_=xe==="SENT",ne=xe==="SENDING",qe=xe==="ERROR",we=!a.dateIntervention&&!_,$e=yt(a,V),Ve=()=>{if(_)return;const o=V[V.length-1],m=o?{matiere:o.matiere,profil:o.profil,couleur:o.couleur,couleurAutre:o.couleurAutre,isoMm:o.isoMm}:{};E({id:Z(),chantierId:a.id,index:V.length+1,type:"FENETRE",quantity:1,dateCreation:new Date().toISOString(),photos:[],isValid:!1,validationErrors:[],...m})},Be=(o,m)=>{o.stopPropagation(),!_&&s({...m,id:Z(),index:V.length+1,dateCreation:new Date().toISOString()})},Oe=o=>t(a.id,o),Ge=()=>{l(!1)},He=o=>{l(!1),A({message:`Échec : ${o}`,type:"error"})};Q.useEffect(()=>{if(z){const o=setTimeout(()=>q(!1),4e3);return()=>clearTimeout(o)}},[z]),Q.useEffect(()=>{a!=null&&a.quoteFileId?G.getFile(a.quoteFileId).then(o=>{o&&b(o)}).catch(console.error):b(null)},[a==null?void 0:a.quoteFileId]);const Qe=({reason:o,details:m,user:P})=>{const H={date:new Date().toISOString(),action:"UNLOCK",reason:o,details:m,user:P};t(a.id,{sendStatus:"DRAFT",sentAt:null,lastError:null,history:[...a.history||[],H],updatedAt:new Date().toISOString()}),w(!1),A({message:"Dossier déverrouillé (Action enregistrée)",type:"info"})},We=async()=>{confirm("Voulez-vous supprimer le devis lié à ce chantier ? Les produits importés seront conservés mais ne seront plus liés au fichier source.")&&(a.quoteFileId&&await G.deleteFile(a.quoteFileId),t(a.id,{quoteFileId:null,quoteFile:null,quoteFileName:null,referenceDevis:null,updatedAt:new Date().toISOString()}),b(null),A({message:"Lien avec le devis supprimé",type:"info"}))},Je=async()=>{try{let o=null;if(a.quoteFileId)try{o=await G.getFile(a.quoteFileId),o&&console.log("📄 PDF loaded from IndexedDB")}catch(m){console.warn("Failed to load from IndexedDB:",m)}if(!o){const m=await De(a);if(m&&m.length>0){const P=m[0].id;console.log(`📥 Downloading PDF from Drive (${P})...`);try{o=await Pt(P),console.log("✅ PDF downloaded from Drive"),a.quoteFileId&&(await G.storeFile(a.quoteFileId,o),console.log("💾 PDF cached locally"))}catch(H){throw console.error("Drive download failed:",H),new Error("Impossible de télécharger le fichier depuis Drive")}}else throw new Error("Fichier non disponible (ni local, ni Drive)")}if(o){const m=URL.createObjectURL(o);ke(m),W(!0)}else throw new Error("Aucun fichier disponible")}catch(o){console.error("Error viewing PDF:",o),A({message:o.message||"Erreur lors de l'ouverture du PDF",type:"error"})}},Ke=async(o,m,P)=>{if((!o||o.length===0)&&!m)return;const H=new Date().toISOString(),X=V.length+1;let K=null;m&&(K=Z(),await G.storeFile(K,m));const Y=(o||[]).map((R,et)=>{const ye=Vt(R.type,R.subtype);let ie="PVC";R.material==="ALU"?ie="ALU":R.material==="BOIS"?ie="BOIS":R.material==="ACIER"&&(ie="ACIER");let be="BLANC",Se="";return R.color==="GRIS_7016"?be="GRIS_7016":R.color!=="BLANC"&&R.color!=="Standard"&&(be="AUTRE",Se=R.color),{id:Z(),chantierId:a.id,index:X+et,type:ye.type,subtype:R.subtype||"",largeurMm:R.width||0,hauteurMm:R.height||0,quantity:R.quantity||1,matiere:ie,profil:ye.profil||"RENO_40",couleur:be,couleurAutre:Se,description:R.label||"",notes:R.label||"",dateCreation:H,updatedAt:H,isValid:R.isValid,source:"QUOTE",isVerified:!1}}),Ce={...a,quoteFileId:K||a.quoteFileId,quoteFileName:(m==null?void 0:m.name)||a.quoteFileName,referenceDevis:(P==null?void 0:P.number)||a.referenceDevis,updatedAt:H};delete Ce.quoteFile,t(a.id,Ce),Y.forEach(R=>s(R)),K&&(b(m),Rt(a,m,m.name).then(R=>{console.log(`✅ Quote auto-uploaded to Drive: ${R.filename}`),Ee()}).catch(R=>{console.error("Drive auto-upload failed:",R)})),D(!1),A({message:`${Y.length} menuiseries importées avec succès !`,type:"success"})},Ee=async()=>{if(a){F(!0);try{const o=await De(a);M(o)}catch(o){console.error("Failed to load Drive quotes:",o)}finally{F(!1)}}};Q.useEffect(()=>{a&&!_&&Ee()},[a==null?void 0:a.id]);const Xe=o=>{let m="";if(o===1?m="step-top":o===2?m=we?"step-planning":"step-top":o===3?m="step-metrage":o===4&&(m="step-envoi"),m){const P=document.getElementById(m);P&&P.scrollIntoView({behavior:"smooth",block:"start"})}};if(!a)return null;if(v)return e.jsx(zt,{product:v,onSave:o=>{const P=o.source==="QUOTE"||v.source==="QUOTE"?{...o,source:"QUOTE",isVerified:!0}:o;s(P),E(null)},onCancel:()=>E(null),isReadOnly:_});const Ye=V.reduce((o,m)=>o+(m.quantity||1),0),Ze=V.filter(o=>!o.isValid).length,me=V.filter(o=>o.source==="QUOTE"&&!o.isVerified).length,oe=me>0;return e.jsxs("div",{className:"flex flex-col h-full bg-slate-50 dark:bg-slate-950",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-30 shadow-sm min-h-[64px] pt-[max(env(safe-area-inset-top),20px)] pb-2 flex flex-col justify-center overflow-hidden",children:[e.jsxs("div",{className:"px-4 flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center flex-1 min-w-0",children:[e.jsx("button",{onClick:()=>{d.returnView?(j(d.returnView),N(null)):p(null)},className:"mr-3 p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-200",children:e.jsx(pt,{size:24})}),e.jsxs("div",{className:"truncate flex-1 cursor-pointer py-1",onClick:()=>!_&&r(!0),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"font-bold text-lg dark:text-white truncate leading-tight",children:a.client}),_?e.jsx(se,{size:16,className:"text-green-600"}):e.jsx(ht,{size:16,className:"text-slate-400"})]}),e.jsxs("div",{className:"text-xs text-slate-500 flex flex-col gap-1 mt-0.5",children:[e.jsx(Et,{address:a.adresse,gps:a.gps,className:"text-slate-500 hover:text-brand-600"}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded",children:[Ye," Produit(s)"]}),e.jsxs("span",{children:["• ",a.typeContrat==="FOURNITURE_ET_POSE"?"Pose":a.typeContrat==="SOUS_TRAITANCE"?"Sous-traitance":"Fourn. Seule"]}),a.referenceDevis&&e.jsxs("span",{className:"flex items-center gap-1 bg-brand-50 dark:bg-brand-900/30 text-brand-700 dark:text-brand-300 px-1.5 py-0.5 rounded font-bold border border-brand-100 dark:border-brand-800",children:[e.jsx(ee,{size:12})," ",a.referenceDevis]})]})]})]})]}),(a.quoteFileId||n||a.quoteFile)&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(I,{variant:"ghost",size:"sm",className:"bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-200",icon:ee,onClick:Je,children:e.jsx("span",{className:"hidden sm:inline",children:"Voir le Devis"})}),!_&&e.jsx(I,{variant:"ghost",size:"sm",className:"text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20",icon:re,onClick:We})]})]}),e.jsx(Dt,{currentStep:$e,onStepClick:Xe})]}),_&&e.jsxs(Pe,{variant:"success",icon:se,action:"Modifier",onAction:()=>w(!0),children:["Dossier verrouillé le ",new Date(a.sentAt).toLocaleDateString("fr-FR")," à  ",new Date(a.sentAt).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})]}),qe&&e.jsxs(Pe,{variant:"error",icon:ce,children:["Échec de l'envoi : ",a.lastError]}),e.jsxs("div",{className:`flex-1 overflow-y-auto p-4 max-w-5xl mx-auto w-full scroll-smooth ${_?"pb-24":oe?"pb-48":"pb-32"}`,children:[e.jsx("div",{id:"step-top"}),a.assignation==="COMMERCIAL"&&a.status==="SIGNED"&&e.jsxs("div",{id:"step-transfert",className:"mb-6 bg-white dark:bg-slate-900 rounded-xl p-6 shadow-lg border-2 border-green-500 animate-fade-in relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 w-24 h-24 bg-green-50 dark:bg-green-900/10 rounded-full -mr-10 -mt-10 blur-xl"}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:items-start gap-4 text-center sm:text-left relative z-10",children:[e.jsx("div",{className:"bg-green-100 dark:bg-green-900/30 p-3 rounded-full text-green-600 dark:text-green-400 shrink-0",children:e.jsx(ae,{size:32})}),e.jsxs("div",{className:"flex-1 w-full",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-1",children:"Deal Gagné ! 🎉"}),e.jsx("p",{className:"text-slate-500 text-sm mb-4",children:"Ce dossier a été signé. Où souhaitez-vous l'envoyer pour la suite ?"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx(I,{variant:"primary",className:"font-bold flex-1",onClick:()=>t(a.id,{assignation:"METRAGE"}),icon:he,children:"Bureau d'Étude (Métrage)"}),e.jsx(I,{variant:"secondary",className:"font-bold border-slate-200 text-slate-700 bg-white hover:bg-slate-50 flex-1",onClick:()=>t(a.id,{assignation:"ATELIER"}),icon:he,children:"Directement à l'Atelier"})]})]})]})]}),a.assignation==="METRAGE"&&a.sendStatus==="SENT"&&e.jsxs("div",{id:"step-transfert-metrage",className:"mb-6 bg-white dark:bg-slate-900 rounded-xl p-6 shadow-lg border-2 border-brand-500 animate-fade-in relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 w-24 h-24 bg-brand-50 dark:bg-brand-900/10 rounded-full -mr-10 -mt-10 blur-xl"}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:items-start gap-4 text-center sm:text-left relative z-10",children:[e.jsx("div",{className:"bg-brand-100 dark:bg-brand-900/30 p-3 rounded-full text-brand-600 dark:text-brand-400 shrink-0",children:e.jsx(ae,{size:32})}),e.jsxs("div",{className:"flex-1 w-full",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-1",children:"Métrage Terminé !"}),e.jsx("p",{className:"text-slate-500 text-sm mb-4",children:"Le dossier de métrage a été validé et envoyé. Transférer à l'équipe de fabrication ?"}),e.jsx("div",{className:"flex flex-col sm:flex-row gap-2",children:e.jsx(I,{variant:"primary",className:"font-bold w-full sm:w-auto px-8",onClick:()=>t(a.id,{assignation:"ATELIER"}),icon:he,children:"Transférer à l'Atelier"})})]})]})]}),we&&e.jsx("div",{id:"step-planning",className:"mb-6 bg-white dark:bg-slate-900 rounded-xl p-6 shadow-lg border-2 border-brand-500 animate-fade-in",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:items-start gap-4 text-center sm:text-left",children:[e.jsx("div",{className:"bg-brand-100 dark:bg-brand-900/30 p-3 rounded-full text-brand-600 dark:text-brand-400 shrink-0",children:e.jsx(je,{size:32})}),e.jsxs("div",{className:"flex-1 w-full",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-1",children:"Ce dossier n'est pas planifié !"}),e.jsx("p",{className:"text-slate-500 text-sm mb-4",children:"Sélectionnez la date d'intervention pour passer à l'étape suivante."}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("input",{type:"datetime-local",className:"flex-1 p-3 rounded-lg border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 dark:text-white focus:border-brand-500 outline-none font-bold text-slate-700 transition-colors",id:`date-picker-${a.id}`}),e.jsx(I,{variant:"primary",className:"font-bold uppercase w-full sm:w-auto",onClick:()=>{const o=document.getElementById(`date-picker-${a.id}`),m=o==null?void 0:o.value;if(!m)return alert("Veuillez sélectionner une date !");g(a.id,m)},children:"Valider"})]})]})]})}),a.dateIntervention&&!_&&e.jsxs("div",{id:"step-planning",className:"mb-6 bg-green-50 dark:bg-green-900/20 rounded-xl p-4 border border-green-200 dark:border-green-800 flex flex-col sm:flex-row items-center justify-between gap-4 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-green-100 dark:bg-green-800 p-2 rounded-full text-green-700 dark:text-green-300",children:e.jsx(je,{size:24})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-bold text-green-800 dark:text-green-200 uppercase tracking-wide",children:"Intervention planifiée"}),e.jsxs("p",{className:"text-lg font-bold text-slate-800 dark:text-white flex flex-col sm:flex-row sm:items-center gap-2",children:[new Date(a.dateIntervention).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",hour:"2-digit",minute:"2-digit"}),a.googleEventId?e.jsxs("span",{className:"bg-white/80 dark:bg-green-800/50 px-2 py-0.5 rounded-full text-xs flex items-center gap-1 border border-green-200 dark:border-green-700 w-fit",children:[e.jsx("img",{src:"https://www.gstatic.com/images/branding/product/1x/calendar_2020q4_48dp.png",alt:"GCal",className:"w-3 h-3"}),"Synchronisé"]}):e.jsxs("button",{onClick:o=>{o.stopPropagation(),g(a.id,a.dateIntervention)},className:"bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 px-2 py-0.5 rounded-full text-xs flex items-center gap-1 animate-pulse border border-orange-200 dark:border-orange-800 hover:bg-orange-200 transition-colors w-fit",children:[e.jsx(J,{size:12}),"Non Synchronisé (Forcer)"]})]})]})]}),e.jsx(I,{variant:"danger",icon:gt,onClick:()=>{confirm("Confirmer l'annulation du rendez-vous ? Le dossier repassera en 'À Planifier'.")&&(g(a.id,null),A({message:"Rendez-vous annulé",type:"info"}))},children:"Annuler le RDV"})]}),a.typeContrat==="SOUS_TRAITANCE"&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 mb-4 flex items-start",children:[e.jsx(Ue,{className:"text-amber-600 mt-1 mr-3 shrink-0",size:20}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-bold text-amber-800 dark:text-amber-200 uppercase",children:"Client Final"}),e.jsx("div",{className:"font-medium text-amber-900 dark:text-amber-100",children:e.jsxs("div",{className:"text-sm text-amber-800 dark:text-amber-300 flex items-center",children:[e.jsx("a",{href:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(a.adresseFinale)}`,target:"_blank",rel:"noopener noreferrer",className:"p-1 -ml-1 mr-1 rounded-full hover:bg-amber-100 dark:hover:bg-amber-800 text-amber-600 dark:text-amber-400 transition-colors",title:"Ouvrir dans Maps",children:e.jsx(ft,{size:12})}),a.adresseFinale]})})]})]}),e.jsxs("div",{id:"step-metrage",className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[V.map(o=>{const m=o.source==="QUOTE",P=m&&!o.isVerified,H=m&&o.isVerified,X=P?"bg-amber-50 dark:bg-amber-900/20":"bg-white dark:bg-slate-900",K=P?"border-l-amber-500":o.type.includes("FENETRE")?"border-l-orange-500":o.type.includes("PORTE")?"border-l-green-500":"border-l-brand-500";return e.jsxs("div",{onClick:()=>E(o),className:`${X} ${K} rounded-xl p-4 shadow-sm border-l-4 cursor-pointer hover:shadow-md transition-all relative group border-t border-r border-b border-slate-200 dark:border-slate-800 ${_?"opacity-75":""}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("span",{className:"font-bold text-lg dark:text-white",children:["#",String(o.index).padStart(2,"0")]}),e.jsxs("div",{className:"flex items-center gap-2",children:[P&&e.jsxs("span",{className:"bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300 text-[10px] font-bold px-1.5 py-0.5 rounded uppercase animate-pulse flex items-center gap-1 border border-amber-200 dark:border-amber-800",children:[e.jsx(J,{size:10})," Cotes Devis"]}),H&&e.jsxs("span",{className:"bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300 text-[10px] font-bold px-1.5 py-0.5 rounded uppercase flex items-center gap-1 border border-green-200 dark:border-green-800",children:[e.jsx(jt,{size:10})," Cotes Validées"]}),o.quantity>1&&e.jsxs("span",{className:"bg-brand-100 text-brand-700 dark:bg-brand-900 dark:text-brand-300 text-xs font-bold px-2 py-1 rounded-full",children:["x",o.quantity]})]})]}),e.jsx("div",{className:"text-slate-800 dark:text-slate-200 font-medium mb-1",children:o.type}),e.jsx("div",{className:"text-sm text-slate-500 mb-2",children:e.jsxs("span",{children:[o.largeurMm," x ",o.hauteurMm," mm ",o.room&&`• ${o.room}`]})}),!o.isValid&&e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-300 px-2 py-1 rounded text-xs inline-flex items-center mb-2",children:[e.jsx(ce,{size:12,className:"mr-1"})," Incomplet"]}),!_&&e.jsxs("div",{className:"flex justify-end gap-3 mt-2 pt-3 border-t border-slate-100 dark:border-slate-800",children:[e.jsx("button",{onClick:Y=>Be(Y,o),className:"text-slate-400 hover:text-brand-600 p-1",children:e.jsx(vt,{size:18})}),e.jsx("button",{onClick:Y=>{Y.stopPropagation(),confirm("Supprimer ?")&&c(o.id)},className:"text-slate-400 hover:text-red-600 p-1",children:e.jsx(re,{size:18})})]})]},o.id)}),!_&&e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("button",{onClick:Ve,className:"flex-1 min-h-[120px] border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 hover:border-brand-400 transition-colors",children:[e.jsx("div",{className:"bg-slate-100 dark:bg-slate-800 p-4 rounded-full mb-2",children:e.jsx(Nt,{size:24})}),e.jsx("span",{className:"font-medium",children:"Ajouter Manuellement"})]}),e.jsxs("button",{onClick:()=>D(!0),className:"h-[60px] border border-slate-200 dark:border-slate-700 rounded-xl flex items-center justify-center gap-2 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors",children:[e.jsx(ee,{size:20}),e.jsx("span",{className:"font-medium text-sm",children:"Importer Devis (PDF)"})]})]})]}),e.jsx(Bt,{history:a.history}),e.jsx("div",{id:"step-envoi"})]}),!_&&e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 p-4 safe-pb z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]",children:[z&&oe&&e.jsxs("div",{className:"mb-4 flex flex-col items-center animate-bounce-short",children:[e.jsxs("div",{className:"bg-amber-100 dark:bg-amber-900/40 text-amber-800 dark:text-amber-200 px-4 py-1.5 rounded-full flex items-center gap-2 border border-amber-200 dark:border-amber-800 shadow-sm transition-all",children:[e.jsx(J,{size:16}),e.jsxs("span",{className:"text-sm font-bold",children:[me," cote",me>1?"s":""," devis à vérifier"]})]}),e.jsx("p",{className:"text-[10px] uppercase tracking-widest text-slate-400 mt-2 font-bold",children:"Action requise avant envoi"})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(I,{onClick:()=>S(!0),disabled:ne,variant:"secondary",className:"flex-1 py-4 text-sm font-bold !bg-amber-50 !text-amber-700 hover:!bg-amber-100 border-amber-200 dark:!bg-amber-900/20 dark:!text-amber-300 dark:border-amber-800",children:"↩ Retour Commercial"}),e.jsx(I,{onClick:()=>{oe?q(!0):l(!0)},disabled:ne,className:`flex-[2] py-4 text-sm font-bold transition-all duration-300 shadow-lg ${oe&&z?"ring-2 ring-amber-500":"bg-brand-600 hover:bg-brand-700 active:scale-[0.98]"}`,icon:ne?null:Le,children:ne?e.jsxs("span",{className:"flex items-center justify-center gap-3",children:[e.jsx(Ne,{size:20}),"Transmission..."]}):"✅ Valider Métrage"})]})]}),_&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-green-50 dark:bg-green-900/20 border-t border-green-200 dark:border-green-800 p-4 safe-pb z-40",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-700 dark:text-green-300",children:[e.jsx(se,{size:16}),e.jsxs("span",{className:"text-sm font-medium",children:["Dossier verrouillé le ",new Date(a.sentAt).toLocaleDateString("fr-FR")]})]})}),u&&e.jsx(Gt,{chantier:a,products:V,incompleteCount:Ze,onClose:()=>l(!1),onStatusChange:Oe,onSuccess:Ge,onError:He}),f&&e.jsx($t,{isOpen:!0,clientName:a.client,onClose:()=>S(!1),onConfirm:async o=>{const m=_e(a,V,new Date().toISOString()),P={motifRetour:o,assignation:"COMMERCIAL"};if(new Blob([m]).size>5e4){const X=a.id+"_rapport";try{await G.storeFile(X,new Blob([m],{type:"text/html"})),P.rapportMetrageFileId=X,P.rapportMetrage=null}catch{P.rapportMetrage=m}}else P.rapportMetrage=m;t(a.id,P),S(!1),A({message:`↩ Dossier retourné au commercial (${o})`,type:"info"})}}),i&&e.jsx(Ht,{onClose:()=>w(!1),onUnlock:Qe}),T&&e.jsx(_t,{onClose:()=>D(!1),onImport:Ke}),L&&e.jsx(Lt,{chantier:a,onClose:()=>r(!1),onUpdate:o=>t(a.id,o)}),$&&te&&e.jsx(qt,{isOpen:$,onClose:()=>{W(!1),ke(null)},blobUrl:te,title:`Devis - ${a.referenceDevis||a.client}`}),y&&e.jsx(rt,{message:y.message,type:y.type,onClose:()=>A(null)})]})};export{as as ChantierDetailView};
