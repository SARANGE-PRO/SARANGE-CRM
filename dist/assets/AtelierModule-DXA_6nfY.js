import{r as h,o as oe,a as f,p as ie,b as T,f as de,u as ce,j as e,B as g}from"./index-DMGdsos9.js";import{r as d,t as D,F as Q,ac as xe,T as me,x as ue,A as M,ad as be,u as pe,a6 as ge,ae as he,l as fe}from"./vendor-DQYctaBf.js";import{M as R,I as k}from"./Modal-CBdi9DRh.js";import{C as Ee}from"./CreateVoletFabModal-CVBmWO6-.js";import"./utils-CKkNC6ps.js";const E="OrdresFabrication",b={VOLET_ROULANT:"VOLET_ROULANT",FENETRE_PVC:"FENETRE_PVC",FENETRE_ALU:"FENETRE_ALU",PORTE_PVC:"PORTE_PVC",PORTE_ALU:"PORTE_ALU"},F={VOLET_ROULANT:"Volet Roulant",FENETRE_PVC:"FenÃªtre / Coulissant PVC",FENETRE_ALU:"FenÃªtre / Coulissant Alu",PORTE_PVC:"Porte d'EntrÃ©e PVC",PORTE_ALU:"Porte d'EntrÃ©e Alu"},i={ATTENTE_VITRAGE:"ATTENTE_VITRAGE",A_FABRIQUER:"A_FABRIQUER",EN_COURS:"EN_COURS",BLOQUE_ANOMALIE:"BLOQUE_ANOMALIE",PRET_POUR_POSE:"PRET_POUR_POSE"},_e=l=>{const n=h(f,E);return oe(n,s=>{const a=s.val();if(!a){l([]);return}const c=Object.entries(a).map(([u,m])=>({id:u,...m}));l(c)},s=>{console.error("âŒ Erreur getOrdresFabrication (onValue):",s),l([])})},B=async l=>{const n=h(f,E),o=ie(n),s={id_projet:l.id_projet||"",client_nom:l.client_nom||"",type_produit:l.type_produit||b.VOLET_ROULANT,statut:i.A_FABRIQUER,date_creation:new Date().toISOString(),url_pdf_fabrication:l.url_pdf_fabrication||null,details_fabrication:l.details_fabrication||null,historique:{demarre_par:null,demarre_le:null,termine_par:null,termine_le:null},anomalie:{signalee:!1,motif:"",date_signalement:null}};try{return await T(o,s),console.log(`ðŸ­ OF crÃ©Ã©: ${o.key} â€” ${s.client_nom} (${s.type_produit})`),o.key}catch(a){throw console.error("âŒ Erreur createOrdreFabrication:",a),a}},S=async(l,n,o)=>{const s=h(f,`${E}/${l}`),a={statut:n};n===i.EN_COURS&&(a["historique/demarre_par"]=o,a["historique/demarre_le"]=new Date().toISOString()),n===i.PRET_POUR_POSE&&(a["historique/termine_par"]=o,a["historique/termine_le"]=new Date().toISOString());try{await T(s,a),console.log(`ðŸ”„ OF ${l} â†’ ${n} (par ${o})`)}catch(c){throw console.error("âŒ Erreur updateStatutOrdre:",c),c}},je=async(l,n)=>{const o=h(f,`${E}/${l}`),s={statut:i.BLOQUE_ANOMALIE,"anomalie/signalee":!0,"anomalie/motif":n,"anomalie/date_signalement":new Date().toISOString()};try{await T(o,s),console.log(`âš ï¸ Anomalie signalÃ©e sur OF ${l}: ${n}`)}catch(a){throw console.error("âŒ Erreur signalerAnomalie:",a),a}},Ne=async l=>{const n=h(f,`${E}/${l}`),o={statut:i.A_FABRIQUER,"anomalie/signalee":!1,"anomalie/motif":"","anomalie/date_signalement":null};try{await T(n,o),console.log(`âœ… Anomalie rÃ©solue sur OF ${l} â†’ A_FABRIQUER`)}catch(s){throw console.error("âŒ Erreur resoudreAnomalie:",s),s}},Oe=async l=>{const n=h(f,`${E}/${l}`);await de(n),console.log(`ðŸ—‘ï¸ OF ${l} supprimÃ©`)},ke=[{id:i.ATTENTE_VITRAGE,title:"Attente Vitrage",shortTitle:"Vitrage",icon:D,color:"bg-purple-50/50 dark:bg-purple-900/10",headerColor:"text-purple-700 dark:text-purple-300",dot:"bg-purple-400",border:"border-purple-200 dark:border-purple-800",ring:"ring-purple-400"},{id:i.A_FABRIQUER,title:"Ã€ Fabriquer",shortTitle:"Ã€ Faire",icon:D,color:"bg-slate-100 dark:bg-slate-800/50",headerColor:"text-slate-700 dark:text-slate-300",dot:"bg-slate-400",border:"border-slate-200 dark:border-slate-700",ring:"ring-slate-400"},{id:i.EN_COURS,title:"En Cours",shortTitle:"En Cours",icon:Q,color:"bg-brand-50/50 dark:bg-brand-900/10",headerColor:"text-brand-700 dark:text-brand-300",dot:"bg-brand-500",border:"border-brand-100 dark:border-brand-900",ring:"ring-brand-400"},{id:i.BLOQUE_ANOMALIE,title:"BloquÃ© (Anomalie)",shortTitle:"BloquÃ©",icon:xe,color:"bg-rose-50/50 dark:bg-rose-900/10",headerColor:"text-rose-700 dark:text-rose-300",dot:"bg-rose-500",border:"border-rose-100 dark:border-rose-900",ring:"ring-rose-400"},{id:i.PRET_POUR_POSE,title:"PrÃªt pour Pose",shortTitle:"PrÃªt",icon:me,color:"bg-green-50/50 dark:bg-emerald-900/10",headerColor:"text-green-700 dark:text-emerald-400",dot:"bg-green-500",border:"border-green-100 dark:border-green-900",ring:"ring-green-400"}],z={VOLET_ROULANT:{label:"VR",bg:"bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300"},FENETRE_PVC:{label:"PVC",bg:"bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300"},FENETRE_ALU:{label:"ALU",bg:"bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300"},PORTE_PVC:{label:"P.PVC",bg:"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300"},PORTE_ALU:{label:"P.ALU",bg:"bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300"}},Te=({isOpen:l,onClose:n,onSelect:o})=>{const s=[{id:b.VOLET_ROULANT,icon:"ðŸªŸ",label:"Volet Roulant",desc:"Fiche fabrication dÃ©taillÃ©e",highlight:!0},{id:b.FENETRE_PVC,icon:"ðŸ ",label:"FenÃªtre / Coulissant PVC",desc:"Import PDF Proges"},{id:b.FENETRE_ALU,icon:"ðŸ”²",label:"FenÃªtre / Coulissant Alu",desc:"Import PDF Scal"},{id:b.PORTE_PVC,icon:"ðŸšª",label:"Porte d'EntrÃ©e PVC",desc:"Import PDF Proges"},{id:b.PORTE_ALU,icon:"ðŸšª",label:"Porte d'EntrÃ©e Alu",desc:"Import PDF Scal"}];return e.jsx(R,{isOpen:l,onClose:n,title:"Nouvel Ordre de Fabrication",size:"md",children:e.jsx("div",{className:"flex flex-col gap-2",children:s.map(a=>e.jsxs("button",{onClick:()=>o(a.id),className:`w-full flex items-center gap-4 p-4 rounded-xl border transition-all text-left hover:scale-[1.01]
                            ${a.highlight?"bg-brand-50 dark:bg-brand-900/20 border-brand-200 dark:border-brand-800 hover:border-brand-400 hover:shadow-md":"bg-slate-50 dark:bg-slate-800/50 border-slate-200 dark:border-slate-700 hover:border-slate-300 hover:shadow-sm"}`,children:[e.jsx("span",{className:"text-2xl",children:a.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-bold text-sm text-slate-800 dark:text-white",children:a.label}),e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:a.desc})]}),a.highlight&&e.jsx("span",{className:"text-[10px] font-bold uppercase bg-brand-500 text-white px-2 py-0.5 rounded-full",children:"Fiche Fab"})]},a.id))})})},Re=({isOpen:l,onClose:n,onSubmit:o,typeProduit:s})=>{const[a,c]=d.useState(""),[u,m]=d.useState(""),A=_=>{if(_.preventDefault(),!a.trim()){alert("Renseignez le nom du client.");return}o({client_nom:a.trim(),id_projet:u.trim(),type_produit:s}),c(""),m("")};return e.jsx(R,{isOpen:l,onClose:n,title:`Nouvel OF â€” ${F[s]||s}`,size:"sm",children:e.jsxs("form",{onSubmit:A,className:"flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 block mb-1",children:["Nom du Client ",e.jsx("span",{className:"text-rose-400",children:"*"})]}),e.jsx(k,{value:a,onChange:c,placeholder:"Ex: Dupont"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-semibold text-slate-500 block mb-1",children:"RÃ©f. Projet / Chantier"}),e.jsx(k,{value:u,onChange:m,placeholder:"Ex: CH-2026-042"})]}),e.jsx("p",{className:"text-xs text-slate-400 bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg",children:"ðŸ’¡ La fiche de fabrication PDF pourra Ãªtre attachÃ©e sur la carte dans le Kanban."}),e.jsxs("div",{className:"flex gap-3 pt-1",children:[e.jsx(g,{type:"button",variant:"secondary",className:"flex-1",onClick:n,children:"Annuler"}),e.jsx(g,{type:"submit",variant:"primary",className:"flex-1",children:"CrÃ©er l'OF"})]})]})})},Ae=({isOpen:l,onClose:n,onSubmit:o,of:s})=>{const[a,c]=d.useState(""),u=m=>{if(m.preventDefault(),!a.trim()){alert("Veuillez saisir le motif du problÃ¨me.");return}o(s.id,a.trim()),c("")};return e.jsx(R,{isOpen:l,onClose:n,title:"âš ï¸ Signaler un ProblÃ¨me",size:"sm",children:e.jsxs("form",{onSubmit:u,className:"flex flex-col gap-4",children:[e.jsxs("p",{className:"text-sm text-slate-600 dark:text-slate-400",children:["OF : ",e.jsx("strong",{children:s==null?void 0:s.client_nom})," â€” ",F[s==null?void 0:s.type_produit]||(s==null?void 0:s.type_produit)]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 block mb-1",children:["Motif du blocage ",e.jsx("span",{className:"text-rose-400",children:"*"})]}),e.jsx("textarea",{value:a,onChange:m=>c(m.target.value),className:"w-full p-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:ring-2 focus:ring-rose-500 text-sm h-24 resize-none",placeholder:"Ex: Mauvaise couleur reÃ§ue, cotes incorrectes...",autoFocus:!0})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx(g,{type:"button",variant:"secondary",className:"flex-1",onClick:n,children:"Annuler"}),e.jsx(g,{type:"submit",variant:"primary",className:"flex-1 !bg-rose-600 hover:!bg-rose-700",children:"Signaler"})]})]})})},Fe=()=>{const{state:l}=ce(),n=l==null?void 0:l.user,[o,s]=d.useState([]),[a,c]=d.useState(i.A_FABRIQUER),[u,m]=d.useState(null),[A,_]=d.useState(!1),[G,v]=d.useState(!1),[w,C]=d.useState(null),[L,y]=d.useState(null),[j,N]=d.useState({client_nom:"",id_projet:""}),[q,O]=d.useState(!1);d.useEffect(()=>{const t=_e(r=>s(r));return()=>{typeof t=="function"&&t()}},[]);const U=d.useMemo(()=>ke.map(t=>({...t,items:o.filter(r=>r.statut===t.id)})),[o]),H=(t,r)=>{m(r),t.dataTransfer.effectAllowed="move"},Y=t=>{t.preventDefault(),t.dataTransfer.dropEffect="move"},K=async(t,r)=>{if(t.preventDefault(),!u)return;const p=o.find(x=>x.id===u);if(p&&p.statut!==r)try{await S(p.id,r,P())}catch(x){console.error("Drop error:",x)}m(null)},J=t=>{_(!1),t===b.VOLET_ROULANT?O(!0):C(t)},W=t=>{if(t.preventDefault(),!j.client_nom.trim()){alert("Renseignez le nom du client.");return}O(!1),v(!0)},X=async t=>{try{await B({client_nom:j.client_nom.trim(),id_projet:j.id_projet.trim(),type_produit:b.VOLET_ROULANT,details_fabrication:t}),v(!1),N({client_nom:"",id_projet:""})}catch(r){console.error("Erreur crÃ©ation OF Volet:",r),alert("Erreur lors de la crÃ©ation de l'OF.")}},Z=async t=>{try{await B(t),C(null)}catch(r){console.error("Erreur crÃ©ation OF:",r),alert("Erreur lors de la crÃ©ation de l'OF.")}},P=()=>(n==null?void 0:n.email)||(n==null?void 0:n.name)||"Atelier",ee=async t=>{try{await S(t.id,i.EN_COURS,P())}catch(r){console.error("Erreur dÃ©marrage:",r)}},te=async t=>{try{await S(t.id,i.PRET_POUR_POSE,P())}catch(r){console.error("Erreur terminaison:",r)}},re=async(t,r)=>{try{await je(t,r),y(null)}catch(p){console.error("Erreur signalement:",p)}},se=async t=>{try{await Ne(t.id)}catch(r){console.error("Erreur rÃ©solution:",r)}},ae=async t=>{if(confirm(`Supprimer l'OF de ${t.client_nom} ?`))try{await Oe(t.id)}catch(r){console.error("Erreur suppression:",r)}},le=t=>{console.log("ðŸ–¨ï¸ Imprimer fiche OF:",t.id,t.client_nom),alert("FonctionnalitÃ© d'impression en cours de dÃ©veloppement.")};return e.jsxs("div",{className:"flex flex-col h-full bg-slate-50 dark:bg-slate-900",children:[e.jsx(Te,{isOpen:A,onClose:()=>_(!1),onSelect:J}),e.jsx(Ee,{isOpen:G,onClose:()=>{v(!1),N({client_nom:"",id_projet:""})},onSubmit:X}),w&&e.jsx(Re,{isOpen:!0,onClose:()=>C(null),onSubmit:Z,typeProduit:w}),L&&e.jsx(Ae,{isOpen:!0,onClose:()=>y(null),onSubmit:re,of:L}),q&&e.jsx(R,{isOpen:!0,onClose:()=>O(!1),title:"ðŸªŸ Nouveau Volet Roulant",size:"sm",children:e.jsxs("form",{onSubmit:W,className:"flex flex-col gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 block mb-1",children:["Nom du Client ",e.jsx("span",{className:"text-rose-400",children:"*"})]}),e.jsx(k,{value:j.client_nom,onChange:t=>N(r=>({...r,client_nom:t})),placeholder:"Ex: Dupont"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-semibold text-slate-500 block mb-1",children:"RÃ©f. Projet / Chantier"}),e.jsx(k,{value:j.id_projet,onChange:t=>N(r=>({...r,id_projet:t})),placeholder:"Ex: CH-2026-042"})]}),e.jsxs("div",{className:"flex gap-3 pt-1",children:[e.jsx(g,{type:"button",variant:"secondary",className:"flex-1",onClick:()=>O(!1),children:"Annuler"}),e.jsx(g,{type:"submit",variant:"primary",className:"flex-1",children:"Suivant â†’"})]})]})}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-6 pt-[max(1rem,env(safe-area-inset-top))] pb-4 flex-shrink-0 flex items-center shadow-sm z-20",children:[e.jsxs("h2",{className:"text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2 mr-auto",children:[e.jsx(Q,{size:22,className:"text-brand-600"}),"Atelier & Fabrication"]}),e.jsx(g,{onClick:()=>_(!0),icon:ue,className:"py-2 text-sm shadow-sm whitespace-nowrap px-4 hover:scale-[1.02] transition-transform",children:"Nouvel OF"})]}),e.jsx("div",{className:"md:hidden flex-none px-2 pt-4 pb-2 bg-slate-50 dark:bg-slate-900 w-full relative z-10 shrink-0",children:e.jsx("div",{className:"grid grid-cols-5 gap-1.5",children:U.map(t=>e.jsxs("button",{onClick:()=>c(t.id),className:`p-2 rounded-xl border transition-all flex flex-col items-center justify-center text-center gap-1
                                ${a===t.id?`ring-2 ring-offset-1 ${t.ring} border-transparent`:`${t.border}/30 opacity-90`}
                                ${t.color}`,children:[e.jsx("div",{className:"text-lg font-bold",children:t.items.length}),e.jsx("div",{className:"text-[9px] leading-tight font-bold uppercase w-full break-words",children:t.shortTitle})]},`tile-${t.id}`))})}),e.jsx("main",{className:"flex-1 min-h-0 overflow-y-auto pb-40 md:pb-0 w-full mx-auto bg-slate-50 dark:bg-slate-900",children:e.jsx("div",{className:"flex-1 min-h-0 grid grid-cols-1 md:grid-cols-5 gap-4 h-auto px-4 md:px-5 md:pt-5 pb-6 w-full mx-auto",children:U.map(t=>(t.icon,e.jsxs("div",{className:`flex flex-col h-full rounded-2xl border ${t.border}/60 ${t.color} ${a===t.id?"block":"hidden md:flex"}`,onDragOver:Y,onDrop:r=>K(r,t.id),children:[e.jsx("div",{className:"hidden md:flex items-center justify-between mb-0 p-3 shrink-0 border-b border-slate-200/50 dark:border-slate-700/50",children:e.jsxs("h3",{className:`font-bold text-sm ${t.headerColor} flex items-center gap-1.5`,children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${t.dot}`}),t.title,e.jsx("span",{className:"bg-white/50 dark:bg-slate-800/50 text-xs px-1.5 py-0.5 rounded-full shadow-sm ml-1",children:t.items.length})]})}),e.jsx("div",{className:"flex-1 p-0 pt-3 md:p-2 pb-0 md:pb-4 space-y-2.5",children:t.items.length===0?e.jsx("div",{className:"h-24 md:h-full flex items-center justify-center border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl text-slate-400 dark:text-slate-500 text-sm font-medium",children:"Aucun OF"}):t.items.map(r=>{var I,$;const p=z[r.type_produit]||z.VOLET_ROULANT,x=r.details_fabrication,V=(I=r.produits)==null?void 0:I.length;return e.jsxs("div",{draggable:!0,onDragStart:ne=>H(ne,r.id),className:`bg-white dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 p-3 shadow-sm hover:shadow-md transition-shadow cursor-grab active:cursor-grabbing ${u===r.id?"opacity-50 scale-95":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-bold text-sm text-slate-800 dark:text-white truncate",children:r.client_nom||"Client inconnu"}),e.jsxs("p",{className:"text-xs text-slate-500 dark:text-slate-400 mt-0.5 truncate",children:[r.groupe||F[r.type_produit]||r.type_produit,V&&e.jsxs("span",{className:"ml-1 text-slate-400",children:["â€¢ ",V," prod."]}),r.id_projet&&e.jsxs("span",{className:"ml-2 text-slate-400",children:["#",r.id_projet]})]})]}),e.jsx("span",{className:`text-[10px] font-bold px-1.5 py-0.5 rounded-full shrink-0 ${p.bg}`,children:p.label})]}),r.type_produit===b.VOLET_ROULANT&&x&&e.jsxs("div",{className:"mb-2 grid grid-cols-3 gap-1 text-[10px] text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-900/50 rounded-lg p-2",children:[e.jsxs("span",{children:["H: ",e.jsx("strong",{className:"text-slate-700 dark:text-slate-300",children:x.hauteur})]}),e.jsxs("span",{children:["L: ",e.jsx("strong",{className:"text-slate-700 dark:text-slate-300",children:x.largeur})]}),e.jsx("span",{children:x.couleur}),e.jsx("span",{children:x.type_manoeuvre}),e.jsx("span",{children:x.sortie}),x.ref_client&&e.jsxs("span",{children:["RÃ©f: ",x.ref_client]})]}),(($=r.anomalie)==null?void 0:$.signalee)&&e.jsxs("div",{className:"mb-2 bg-rose-50 dark:bg-rose-900/20 text-rose-700 dark:text-rose-300 text-xs font-medium p-2 rounded-lg flex items-center gap-1.5",children:[e.jsx(M,{size:12}),r.anomalie.motif||"Anomalie signalÃ©e"]}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[r.statut===i.A_FABRIQUER&&e.jsxs("button",{onClick:()=>ee(r),className:"flex items-center gap-1 text-[11px] font-semibold text-brand-600 bg-brand-50 hover:bg-brand-100 dark:bg-brand-900/20 dark:hover:bg-brand-900/40 px-2 py-1.5 rounded-lg transition-colors",children:[e.jsx(be,{size:11})," DÃ©marrer"]}),r.statut===i.EN_COURS&&e.jsxs("button",{onClick:()=>te(r),className:"flex items-center gap-1 text-[11px] font-semibold text-green-600 bg-green-50 hover:bg-green-100 dark:bg-green-900/20 dark:hover:bg-green-900/40 px-2 py-1.5 rounded-lg transition-colors",children:[e.jsx(pe,{size:11})," Terminer"]}),r.statut===i.BLOQUE_ANOMALIE&&e.jsxs("button",{onClick:()=>se(r),className:"flex items-center gap-1 text-[11px] font-semibold text-green-600 bg-green-50 hover:bg-green-100 dark:bg-green-900/20 dark:hover:bg-green-900/40 px-2 py-1.5 rounded-lg transition-colors",children:[e.jsx(ge,{size:11})," RÃ©soudre"]}),r.statut!==i.BLOQUE_ANOMALIE&&r.statut!==i.ATTENTE_VITRAGE&&e.jsxs("button",{onClick:()=>y(r),className:"flex items-center gap-1 text-[11px] font-semibold text-rose-600 bg-rose-50 hover:bg-rose-100 dark:bg-rose-900/20 dark:hover:bg-rose-900/40 px-2 py-1.5 rounded-lg transition-colors",children:[e.jsx(M,{size:11})," ProblÃ¨me"]}),r.type_produit===b.VOLET_ROULANT&&e.jsxs("button",{onClick:()=>le(r),className:"flex items-center gap-1 text-[11px] font-semibold text-slate-600 bg-slate-100 hover:bg-slate-200 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-300 px-2 py-1.5 rounded-lg transition-colors",children:[e.jsx(he,{size:11})," Fiche"]}),e.jsx("button",{onClick:()=>ae(r),className:"flex items-center gap-1 text-[11px] font-semibold text-slate-400 hover:text-rose-600 bg-slate-50 hover:bg-rose-50 dark:bg-slate-700/50 dark:hover:bg-rose-900/20 px-2 py-1.5 rounded-lg transition-colors ml-auto",children:e.jsx(fe,{size:11})})]})]},r.id)})})]},t.id)))})})]})};export{Fe as AtelierModule};
