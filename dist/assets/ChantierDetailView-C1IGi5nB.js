import{c as ye,j as e,u as je,B as P,m as Ye,d as Ze,S as ve,T as et}from"./index-faf4erw8.js";import{R as G,H as Re,L as tt,r as x,J as be,K as Se,k as te,N as Ae,O as Te,Q as st,X as ge,V as ee,z as rt,f as ne,A as J,W as at,Y as lt,_ as nt,$ as ot,p as fe,a0 as De,a1 as dt,a2 as Me,v as Z,a3 as it,y as ct,C as se,a4 as ut,a5 as xt,a6 as he,a7 as mt,o as bt,t as ht,u as pt,w as gt,q as Ue,s as ft,a8 as jt}from"./vendor-BhKfyhrK.js";import{S as O,I as M,A as Ie,M as de}from"./Modal-CalFg_z_.js";import{S as Fe}from"./StatusBanner-BIbTQqiz.js";import{S as vt}from"./SmartAddress-CarXayvO.js";import{V as le,c as Nt,D as Q,g as Y,a as kt,b as wt,L as pe,d as Et}from"./utils-CKkNC6ps.js";import{C as Ct}from"./Card-SCoU-xcW.js";import{g as yt,d as St}from"./calendar-CKSkTVT9.js";import{Q as At}from"./QuoteParserService-BHsDhh6M.js";import{getChantierQuotes as Pe,downloadFileAsBlob as Tt,uploadQuoteToDrive as It}from"./googleDrive-C2pMY-g8.js";const oe=({label:i,checked:p,onChange:c,disabled:s})=>G.createElement("label",{className:ye("flex items-center gap-3 cursor-pointer group",s&&"opacity-50 cursor-not-allowed")},G.createElement("div",{className:ye("w-5 h-5 rounded border flex items-center justify-center transition-all",p?"bg-brand-600 border-brand-600 text-white":"bg-white border-slate-300 group-hover:border-brand-400")},p&&G.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",className:"w-3.5 h-3.5"},G.createElement("polyline",{points:"20 6 9 17 4 12"}))),G.createElement("input",{type:"checkbox",className:"hidden",checked:p,onChange:t=>!s&&c(t.target.checked),disabled:s}),G.createElement("span",{className:"text-sm text-slate-700 dark:text-slate-300 select-none"},i)),Ft=({currentStep:i,onStepClick:p})=>{const c=[{id:1,label:"Création"},{id:2,label:"Planification"},{id:3,label:"Métrage"},{id:4,label:"Envoyé"}],s=Math.min(100,Math.max(0,(i-1)/(c.length-1)*100));return e.jsx("div",{className:"w-full bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 shadow-sm transition-colors duration-300",children:e.jsx("div",{className:"max-w-2xl mx-auto px-4 py-4",children:e.jsxs("div",{className:"relative flex items-center justify-between",children:[e.jsx("div",{className:"absolute top-[15px] left-0 w-full h-[3px] bg-slate-100 dark:bg-slate-800 rounded-full -z-0"}),e.jsx("div",{className:"absolute top-[15px] left-0 h-[3px] bg-gradient-to-r from-brand-500 to-brand-600 dark:from-brand-600 dark:to-brand-500 transition-all duration-500 ease-out rounded-full -z-0",style:{width:`${s}%`}}),c.map(t=>{const g=t.id<i,v=t.id===i,N=t.id<=i;return e.jsxs("div",{onClick:()=>N&&p&&p(t.id),className:`
                                    relative flex flex-col items-center group
                                    ${N?"cursor-pointer":"cursor-default"}
                                `,children:[e.jsx("div",{className:`
                                        w-8 h-8 rounded-full flex items-center justify-center border-2 text-sm font-bold z-10 transition-all duration-300 transform
                                        ${g?"bg-brand-600 border-brand-600 text-white shadow-md scale-100":v?"bg-white dark:bg-slate-900 border-brand-600 text-brand-600 shadow-lg scale-110 ring-4 ring-brand-50 dark:ring-brand-900/20":"bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-300 dark:text-slate-600 scale-95"}
                                        ${N&&!v?"group-hover:border-brand-300 dark:group-hover:border-brand-700":""}
                                    `,children:g?e.jsx(Re,{className:"w-4 h-4",strokeWidth:3}):v?e.jsx(tt,{className:"w-4 h-4 animate-spin text-brand-600"}):e.jsx("span",{children:t.id})}),e.jsx("span",{className:`
                                        mt-2 text-[10px] sm:text-xs font-semibold uppercase tracking-wide transition-colors duration-300 text-center px-1
                                        ${v?"text-brand-600 dark:text-brand-400 translate-y-0 opacity-100":g?"text-slate-600 dark:text-slate-400 translate-y-0 opacity-100":"text-slate-400 dark:text-slate-600 translate-y-0 opacity-100"}
                                    `,children:t.label})]},t.id)})]})})})},Pt=({data:i,onChange:p,disabled:c=!1})=>{const s=x.useRef(null),t=x.useRef(null),[g,v]=x.useState((i==null?void 0:i.lines)||[]),[N,k]=x.useState(!1),[y,u]=x.useState(!1),[l,f]=x.useState("free"),[S,d]=x.useState(null),[E,A]=x.useState(null),$=350,V=250;x.useEffect(()=>{p({lines:g,width:$,height:V})},[g]);const C=(n,h=1,j=0,F=0)=>{if(!n)return;const b=n.getContext("2d");if(b.clearRect(0,0,n.width,n.height),b.save(),b.translate(j,F),b.scale(h,h),b.fillStyle="white",b.fillRect(0,0,$,V),b.lineCap="round",b.lineJoin="round",b.lineWidth=3,b.strokeStyle="#2563EB",g.forEach(T=>{if(!(T.length<1)){b.beginPath(),b.moveTo(T[0].x,T[0].y);for(let q=1;q<T.length;q++)b.lineTo(T[q].x,T[q].y);b.stroke()}}),N&&S&&E){if(b.strokeStyle="#93C5FD",b.beginPath(),l!=="free"){if(l==="line")b.moveTo(S.x,S.y),b.lineTo(E.x,E.y);else if(l==="rect"){const T=E.x-S.x,q=E.y-S.y;b.rect(S.x,S.y,T,q)}}b.stroke()}b.restore()};x.useEffect(()=>{C(s.current)},[g,N,E,l]);const[D,r]=x.useState({s:1,x:0,y:0});x.useEffect(()=>{if(!y||!t.current)return;const n=t.current;n.width=window.innerWidth,n.height=window.innerHeight;const h=Math.min(n.width/$,n.height/V)*.95,j=(n.width-$*h)/2,F=(n.height-V*h)/2;r({s:h,x:j,y:F}),C(n,h,j,F)},[y,g,N,E]);const w=(n,h=1,j=0,F=0)=>{const b=n.target.getBoundingClientRect(),T=n.touches?n.touches[0]:n;return{x:(T.clientX-b.left-j)/h,y:(T.clientY-b.top-F)/h}},R=(n,h)=>{if(c)return;n.cancelable&&n.preventDefault(),h==="fs"?t.current:s.current;const{s:j,x:F,y:b}=h==="fs"?D:{s:1,x:0,y:0},T=w(n,j,F,b);k(!0),d(T),A(T),l==="free"&&v(q=>[...q,[T]])},U=(n,h)=>{if(c||!N)return;n.cancelable&&n.preventDefault();const{s:j,x:F,y:b}=h==="fs"?D:{s:1,x:0,y:0},T=w(n,j,F,b);A(T),l==="free"&&v(q=>{const W=[...q],a=W[W.length-1];return a&&(W[W.length-1]=[...a,T]),W})},L=()=>{if(N){if(k(!1),S&&E){if(l==="line")v(n=>[...n,[S,E]]);else if(l==="rect"){const n=S,h=E,j={x:h.x,y:n.y},F={x:n.x,y:h.y};v(b=>[...b,[n,j,h,F,n]])}}d(null),A(null)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 relative group ${c?"opacity-70":""}`,children:[e.jsxs("div",{className:"flex flex-col gap-2 mb-2",children:[e.jsxs("div",{className:"flex justify-between items-center text-xs text-slate-500 uppercase font-bold tracking-wide",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(be,{size:14,className:"mr-1"})," Croquis ",e.jsx("span",{className:"ml-2 text-brand-600 dark:text-brand-400 font-bold",children:"— VUE INTÉRIEUR"})]}),!c&&e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>v(n=>n.slice(0,-1)),className:"p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded text-slate-600 dark:text-slate-400",title:"Annuler",children:e.jsx(Se,{size:16})}),e.jsx("button",{onClick:()=>confirm("Effacer tout ?")&&v([]),className:"p-1 hover:bg-red-100 dark:hover:bg-red-900/30 rounded text-red-500",title:"Effacer",children:e.jsx(te,{size:16})})]})]}),!c&&e.jsxs("div",{className:"flex gap-2 border-b border-slate-200 dark:border-slate-700 pb-2",children:[e.jsxs("button",{onClick:()=>f("free"),className:`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${l==="free"?"bg-brand-600 text-white shadow-sm":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700"}`,children:[e.jsx(be,{size:14})," Crayon"]}),e.jsxs("button",{onClick:()=>f("line"),className:`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${l==="line"?"bg-brand-600 text-white shadow-sm":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700"}`,children:[e.jsx(Ae,{size:14})," Ligne"]}),e.jsxs("button",{onClick:()=>f("rect"),className:`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${l==="rect"?"bg-brand-600 text-white shadow-sm":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700"}`,children:[e.jsx(Te,{size:14})," Rect"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("canvas",{ref:s,width:$,height:V,className:`w-full h-48 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded touch-none shadow-inner ${c?"cursor-not-allowed":"cursor-crosshair"}`,onMouseDown:n=>R(n,"sm"),onMouseMove:n=>U(n,"sm"),onMouseUp:L,onMouseLeave:L,onTouchStart:n=>R(n,"sm"),onTouchMove:n=>U(n,"sm"),onTouchEnd:L}),!c&&e.jsx("button",{onClick:()=>u(!0),className:"absolute top-2 right-2 p-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur rounded-full shadow border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:text-brand-600",children:e.jsx(st,{size:20})})]})]}),y&&!c&&e.jsxs("div",{className:"fixed inset-0 z-[60] bg-slate-950 flex items-center justify-center touch-none",children:[e.jsx("canvas",{ref:t,className:"block cursor-crosshair",onMouseDown:n=>R(n,"fs"),onMouseMove:n=>U(n,"fs"),onMouseUp:L,onMouseLeave:L,onTouchStart:n=>R(n,"fs"),onTouchMove:n=>U(n,"fs"),onTouchEnd:L}),e.jsxs("div",{className:"absolute top-[calc(16px+env(safe-area-inset-top))] left-4 flex gap-2 bg-slate-800/90 backdrop-blur p-2 rounded-lg border border-slate-700 shadow-xl",children:[e.jsx("button",{onClick:()=>f("free"),className:`p-3 rounded-md ${l==="free"?"bg-brand-600 text-white":"text-slate-400 hover:bg-slate-700"}`,children:e.jsx(be,{size:24})}),e.jsx("button",{onClick:()=>f("line"),className:`p-3 rounded-md ${l==="line"?"bg-brand-600 text-white":"text-slate-400 hover:bg-slate-700"}`,children:e.jsx(Ae,{size:24})}),e.jsx("button",{onClick:()=>f("rect"),className:`p-3 rounded-md ${l==="rect"?"bg-brand-600 text-white":"text-slate-400 hover:bg-slate-700"}`,children:e.jsx(Te,{size:24})})]}),e.jsx("div",{className:"absolute top-[calc(16px+env(safe-area-inset-top))] right-4",children:e.jsx("button",{onClick:()=>u(!1),className:"p-3 bg-red-600 text-white rounded-full shadow-lg hover:bg-red-500",children:e.jsx(ge,{size:24})})}),e.jsxs("div",{className:"absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-4 bg-slate-800/90 backdrop-blur p-2 rounded-full border border-slate-700 shadow-xl",children:[e.jsxs("button",{onClick:()=>v(n=>n.slice(0,-1)),className:"px-6 py-3 bg-slate-700 text-white rounded-full font-bold hover:bg-slate-600 flex items-center",children:[e.jsx(Se,{size:20,className:"mr-2"})," Annuler"]}),e.jsxs("button",{onClick:()=>confirm("Tout effacer ?")&&v([]),className:"px-6 py-3 bg-red-900/50 text-red-200 rounded-full font-bold hover:bg-red-900/70 flex items-center",children:[e.jsx(te,{size:20,className:"mr-2"})," Effacer"]}),e.jsxs("button",{onClick:()=>u(!1),className:"px-8 py-3 bg-green-600 text-white rounded-full font-bold hover:bg-green-500 flex items-center",children:[e.jsx(Re,{size:20,className:"mr-2"})," OK"]})]})]})]})},Rt=({product:i,onSave:p,onCancel:c,isReadOnly:s=!1})=>{const[t,g]=x.useState(i),[v,N]=x.useState([]),[k,y]=x.useState(!1),[u,l]=x.useState(!1),f=x.useRef(null),{state:S}=je(),d=(r,w)=>{s||g(R=>({...R,[r]:w}))},E=(r,w,R)=>{s||g(U=>({...U,[r]:{...U[r]||{},[w]:R}}))},A=r=>{var w;s||(d("room",r),/sdb|salle\s?de\s?bain|toilette|wc|douche/i.test(r.toLowerCase())&&["FENETRE","BAIE_COULISSANTE"].includes(t.type)&&!((w=t.vitrageFlags)!=null&&w.g200)&&(g(R=>({...R,vitrageFlags:{...R.vitrageFlags,standard:!0,g200:!0}})),l(!0),setTimeout(()=>l(!1),3e3)))};x.useEffect(()=>{t.type==="FENETRE"&&t.hauteurMm>2200&&g(r=>({...r,oscilloBattant:!1}))},[t.hauteurMm]);const $=()=>{if(s)return;const r=le.validateProduct(t);if(!r.isValid){N(r.errors),setTimeout(()=>{const w=document.getElementById(`field-${r.errors[0]}`);w&&w.scrollIntoView({behavior:"smooth",block:"center"})},100);return}p({...t,isValid:!0,validationErrors:[]})},V=async r=>{if(!s&&r.target.files&&r.target.files[0]){const w=await Nt(r.target.files[0]);d("photos",[...t.photos||[],w])}},C=r=>v.includes(r),D=s?"opacity-60 cursor-not-allowed bg-slate-100 dark:bg-slate-800":"";return e.jsxs("div",{className:"fixed inset-0 bg-slate-50 dark:bg-slate-950 z-50 flex flex-col h-full animate-fade-in",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 pb-3 pt-3 safe-top-padding flex justify-between items-center shadow-sm shrink-0",children:[e.jsx("button",{onClick:c,className:"p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800",children:e.jsx(ge,{size:24,className:"text-slate-500"})}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"font-bold dark:text-white",children:["Produit #",String(t.index).padStart(2,"0")]}),s&&e.jsxs("span",{className:"text-xs text-green-600 font-medium flex items-center justify-center gap-1",children:[e.jsx(ee,{size:12})," Consultation"]})]}),s?e.jsx("div",{className:"w-[76px]"}):e.jsx(P,{onClick:$,className:"px-5 py-2 rounded-full",icon:rt,children:"Valider"})]}),s&&e.jsx("div",{className:"bg-green-50 dark:bg-green-900/20 border-b border-green-200 dark:border-green-800 px-4 py-2 text-center",children:e.jsxs("span",{className:"text-sm text-green-700 dark:text-green-300 font-medium flex items-center justify-center gap-2",children:[e.jsx(ee,{size:14})," Dossier verrouillé — consultation seule"]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 pb-20 max-w-3xl mx-auto w-full",children:[v.length>0&&e.jsxs("div",{className:"mb-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-900/50 text-red-700 dark:text-red-300 p-3 rounded-lg flex items-center",children:[e.jsx(ne,{size:20,className:"mr-2"}),e.jsx("span",{children:"Champs manquants"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${D}`,children:[e.jsx(O,{label:"Type",value:t.type,onChange:r=>d("type",r),disabled:s,options:[{label:"Fenêtre",value:"FENETRE"},{label:"Porte-fenêtre",value:"PORTE_FENETRE"},{label:"Coulissant",value:"BAIE_COULISSANTE"},{label:"Porte Entrée",value:"PORTE_ENTREE"},{label:"Porte Service",value:"PORTE_SERVICE"},{label:"Volet",value:"VOLET_ROULANT"},{label:"Autre",value:"AUTRE"}]}),e.jsxs("div",{className:"flex items-center justify-between bg-slate-50 dark:bg-slate-800 p-3 rounded-lg mb-4 border border-slate-100 dark:border-slate-700",children:[e.jsx("span",{className:"font-medium text-slate-700 dark:text-slate-300",children:"Quantité"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{className:`w-8 h-8 rounded-full bg-white dark:bg-slate-700 shadow text-brand-600 font-bold ${s?"opacity-50 cursor-not-allowed":""}`,onClick:()=>d("quantity",Math.max(1,(t.quantity||1)-1)),disabled:s,children:"-"}),e.jsx("span",{className:"font-bold text-xl w-6 text-center dark:text-white",children:t.quantity||1}),e.jsx("button",{className:`w-8 h-8 rounded-full bg-white dark:bg-slate-700 shadow text-brand-600 font-bold ${s?"opacity-50 cursor-not-allowed":""}`,onClick:()=>d("quantity",(t.quantity||1)+1),disabled:s,children:"+"})]})]}),e.jsx(M,{label:"Localisation",value:t.room,onChange:A,placeholder:"Ex: Cuisine",disabled:s}),t.type==="AUTRE"&&e.jsx(M,{id:"field-description",label:"Description",value:t.description,onChange:r=>d("description",r),error:C("description"),disabled:s}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(M,{id:"field-largeurMm",label:"Largeur (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.largeurMm,onChange:r=>d("largeurMm",parseInt(r)),error:C("largeurMm"),disabled:s}),e.jsx(M,{id:"field-hauteurMm",label:"Hauteur (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.hauteurMm,onChange:r=>d("hauteurMm",parseInt(r)),error:C("hauteurMm"),disabled:s})]}),(le.isMeasureSuspicious(t.largeurMm,t.monobloc)||le.isMeasureSuspicious(t.hauteurMm,t.monobloc))&&e.jsxs("div",{className:"text-orange-500 text-xs flex items-center mt-[-10px] mb-4",children:[e.jsx(J,{size:12,className:"mr-1"})," Attention: Cotes <300mm"]})]}),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE","PORTE_ENTREE","PORTE_SERVICE"].includes(t.type)&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${D}`,children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider",children:"Caractéristiques"}),e.jsx(O,{id:"field-matiere",label:"Matière",value:t.matiere,onChange:r=>d("matiere",r),error:C("matiere"),disabled:s,options:[{label:"PVC",value:"PVC"},{label:"Alu",value:"ALU"}]}),t.matiere&&e.jsx(O,{id:"field-profil",label:"Profil",value:t.profil,onChange:r=>d("profil",r),error:C("profil"),disabled:s,options:t.matiere==="PVC"?[{label:"Réno 40",value:"RENO_40"},{label:"Réno 60",value:"RENO_60"},{label:"Neuf",value:"NEUF"},{label:"ISO",value:"ISO"},{label:"Autre",value:"AUTRE"}]:[{label:"Réno",value:"RENO"},{label:"Neuf",value:"NEUF"},{label:"Autre",value:"AUTRE"}]}),t.profil==="ISO"&&e.jsx(M,{id:"field-isoMm",label:"Aile ISO (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.isoMm,onChange:r=>d("isoMm",parseInt(r)),error:C("isoMm"),disabled:s}),t.profil==="AUTRE"&&e.jsx(M,{id:"field-profilAutre",label:"Profil personnalisé",placeholder:"Préciser le profil...",value:t.profilAutre,onChange:r=>d("profilAutre",r),error:C("profilAutre"),disabled:s}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-100 dark:border-slate-800",children:[e.jsx(O,{id:"field-couleur",label:"Couleur",value:t.couleur,onChange:r=>d("couleur",r),error:C("couleur"),disabled:s,options:t.matiere==="PVC"?[{label:"Blanc",value:"BLANC"},{label:"Bicolor 7016",value:"BICOLOR_7016"},{label:"Autre",value:"AUTRE"}]:[{label:"Blanc",value:"BLANC"},{label:"Gris 7016",value:"GRIS_7016"},{label:"Autre",value:"AUTRE"}]}),t.couleur==="AUTRE"&&e.jsx(M,{id:"field-couleurAutre",placeholder:"Préciser...",value:t.couleurAutre,onChange:r=>d("couleurAutre",r),error:C("couleurAutre"),disabled:s})]})]}),(t.type==="FENETRE"||t.type==="PORTE_FENETRE"||t.type==="BAIE_COULISSANTE")&&e.jsxs("div",{id:"field-vitrageFlags",className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border ${C("vitrageFlags")?"border-red-500 ring-1 ring-red-500":"border-slate-200 dark:border-slate-800"} ${D}`,children:[e.jsxs("h3",{className:`text-xs font-bold uppercase mb-3 tracking-wider ${C("vitrageFlags")?"text-red-500":"text-slate-400"}`,children:["Vitrage ",C("vitrageFlags")&&"*"]}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:[["standard","4/20/4"],["g200","G200"],["feuillete1f","Feuilleté 1F"],["feuillete2f","Feuilleté 2F"]].map(([r,w])=>{var R,U;return e.jsxs("label",{className:`flex items-center p-3 rounded-lg border transition-all ${s?"cursor-not-allowed":"cursor-pointer"} ${(R=t.vitrageFlags)!=null&&R[r]?"bg-brand-50 border-brand-500 text-brand-700 dark:bg-brand-900/30":"border-slate-200 dark:border-slate-700 dark:text-white"}`,children:[e.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded text-brand-600 focus:ring-brand-500",checked:!!((U=t.vitrageFlags)!=null&&U[r]),onChange:L=>E("vitrageFlags",r,L.target.checked),disabled:s}),e.jsx("span",{className:"ml-2 text-sm font-medium",children:w})]},r)})})]}),t.type==="FENETRE"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 space-y-4 ${D}`,children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider",children:"Options"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Oscillo-Battant"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.oscilloBattant,onChange:r=>d("oscilloBattant",r.target.checked),disabled:s||t.hauteurMm>2200})]}),e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Grille Ventil."}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.grilleVentilation,onChange:r=>d("grilleVentilation",r.target.checked),disabled:s})]})]}),e.jsxs("div",{className:"pt-2",children:[e.jsx("label",{className:"text-sm dark:text-slate-300 font-medium mb-2 block",children:"Hauteur Poignée"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>d("poigneeHauteur","CENTREE"),disabled:s,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${s?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur!=="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Centrée"}),e.jsx("button",{onClick:()=>d("poigneeHauteur","AUTRE"),disabled:s,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${s?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur==="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Autre"})]}),t.poigneeHauteur==="AUTRE"&&e.jsx("input",{type:"number",inputMode:"numeric",pattern:"[0-9]*",className:`mt-2 w-full p-3 border rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-700 ${s?"opacity-50 cursor-not-allowed":""}`,placeholder:"mm",value:t.poigneeHauteurMm||"",onChange:r=>d("poigneeHauteurMm",parseInt(r.target.value)),disabled:s})]})]}),t.type==="PORTE_FENETRE"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 space-y-4 ${D}`,children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider",children:"Options Porte-fenêtre"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Grille Ventil."}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.grilleVentilation,onChange:r=>d("grilleVentilation",r.target.checked),disabled:s})]}),e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Serrure"}),t.matiere==="PVC"&&e.jsx("span",{className:"text-xs text-slate-400",children:"(gros profil)"})]}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.serrure,onChange:r=>d("serrure",r.target.checked),disabled:s})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Seuil PMR"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.seuilPMR,onChange:r=>d("seuilPMR",r.target.checked),disabled:s})]}),e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Soubassement"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.soubassement,onChange:r=>d("soubassement",r.target.checked),disabled:s})]})]}),t.soubassement&&e.jsx(M,{id:"field-soubassementHauteurMm",label:"Hauteur Soubassement (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.soubassementHauteurMm,onChange:r=>d("soubassementHauteurMm",parseInt(r)),placeholder:"Ex: 400",disabled:s}),e.jsxs("div",{className:"pt-2",children:[e.jsx("label",{className:"text-sm dark:text-slate-300 font-medium mb-2 block",children:"Hauteur Poignée"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>d("poigneeHauteur","CENTREE"),disabled:s,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${s?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur!=="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Centrée"}),e.jsx("button",{onClick:()=>d("poigneeHauteur","AUTRE"),disabled:s,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${s?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur==="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Autre"})]}),t.poigneeHauteur==="AUTRE"&&e.jsx("input",{type:"number",inputMode:"numeric",pattern:"[0-9]*",className:`mt-2 w-full p-3 border rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-700 ${s?"opacity-50 cursor-not-allowed":""}`,placeholder:"mm",value:t.poigneeHauteurMm||"",onChange:r=>d("poigneeHauteurMm",parseInt(r.target.value)),disabled:s})]})]}),t.type==="VOLET_ROULANT"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${D}`,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300",children:"Lier à "}),e.jsxs("select",{className:`w-full p-3 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 dark:text-white ${s?"opacity-50 cursor-not-allowed":""}`,value:t.lieAProduitId||"",onChange:r=>d("lieAProduitId",r.target.value),disabled:s,children:[e.jsx("option",{value:"",children:"-- Indépendant --"}),S.products.filter(r=>!r.deleted&&t.chantierId&&r.chantierId===t.chantierId&&["FENETRE","BAIE_COULISSANTE"].includes(r.type)).map(r=>e.jsxs("option",{value:r.id,children:["#",String(r.index).padStart(2,"0")," ",r.type," ",r.room?`(${r.room})`:""]},r.id))]})]}),e.jsx(O,{id:"field-manoeuvre",label:"Manoeuvre",value:t.manoeuvre,onChange:r=>d("manoeuvre",r),error:C("manoeuvre"),disabled:s,options:[{label:"Filaire",value:"FILAIRE"},{label:"Radio",value:"RADIO"},{label:"Solaire",value:"SOLAIRE"}]}),t.manoeuvre&&t.manoeuvre!=="SOLAIRE"&&e.jsx(O,{id:"field-sortieCable",label:"Sortie Câble",value:t.sortieCable,onChange:r=>d("sortieCable",r),error:C("sortieCable"),disabled:s,options:[{label:"Gauche",value:"GAUCHE"},{label:"Droite",value:"DROITE"}]}),t.manoeuvre!=="FILAIRE"&&e.jsxs("label",{className:`flex items-center p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 dark:border-slate-700 mt-4 mb-4 ${s?"cursor-not-allowed":""}`,children:[e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.boxDomotique,onChange:r=>d("boxDomotique",r.target.checked),disabled:s}),e.jsx("span",{className:"ml-3 font-medium dark:text-white",children:"Box Domotique"})]}),e.jsxs("div",{className:"my-4",id:"field-coffreADeduireMm",children:[e.jsxs("label",{className:`flex items-center justify-between p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"font-medium dark:text-white",children:"Monobloc ?"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.monobloc,onChange:r=>d("monobloc",r.target.checked),disabled:s})]}),t.monobloc&&e.jsxs("div",{className:"mt-3 bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg",children:[e.jsx(M,{label:"Hauteur Coffre",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.coffreADeduireMm,onChange:r=>d("coffreADeduireMm",parseInt(r)),error:C("coffreADeduireMm"),disabled:s}),e.jsxs("div",{className:"text-right text-sm font-bold text-brand-600",children:["Passage: ",t.hauteurMm&&t.coffreADeduireMm?t.hauteurMm-t.coffreADeduireMm:"-"," mm"]})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-100 dark:border-slate-800",children:[e.jsx(O,{id:"field-couleur",label:"Couleur",value:t.couleur,onChange:r=>d("couleur",r),error:C("couleur"),disabled:s,options:[{label:"Blanc",value:"BLANC"},{label:"Autre",value:"AUTRE"}]}),t.couleur==="AUTRE"&&e.jsx(M,{id:"field-couleurAutre",placeholder:"Préciser...",value:t.couleurAutre,onChange:r=>d("couleurAutre",r),error:C("couleurAutre"),disabled:s})]})]}),le.hasAdvancedOptions(t.type)&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden ${D}`,children:[e.jsxs("button",{onClick:()=>y(!k),className:"w-full flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-800/50 font-medium text-slate-700 dark:text-slate-300",children:[e.jsx("span",{children:"Options Avancées"}),k?e.jsx(at,{size:18}):e.jsx(lt,{size:18})]}),k&&e.jsxs("div",{className:"p-4 border-t border-slate-200 dark:border-slate-800 space-y-4",children:[(t.type.includes("FENETRE")||t.type.includes("PORTE"))&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Ouverture Extérieure"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.ouvertureExterieure,onChange:r=>d("ouvertureExterieure",r.target.checked),disabled:s})]}),t.type==="FENETRE"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Poignée à  clé"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.poigneeCle,onChange:r=>d("poigneeCle",r.target.checked),disabled:s})]}),e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Pièce d'appui"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.pieceAppui,onChange:r=>d("pieceAppui",r.target.checked),disabled:s})]}),t.pieceAppui&&e.jsx(M,{id:"field-pieceAppuiDescription",label:"Description Pièce d'appui",value:t.pieceAppuiDescription,onChange:r=>d("pieceAppuiDescription",r),placeholder:"Préciser...",disabled:s})]}),t.type==="PORTE_FENETRE"&&e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Poignée à  clé"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.poigneeCle,onChange:r=>d("poigneeCle",r.target.checked),disabled:s})]}),t.type==="PORTE_ENTREE"&&e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-bold",children:"Tierce / Imposte ?"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.tierceImposte,onChange:r=>d("tierceImposte",r.target.checked),disabled:s})]})]}),t.type==="VOLET_ROULANT"&&e.jsxs("div",{children:[e.jsx(O,{label:"Couple",value:t.coupleMoteur||10,onChange:r=>d("coupleMoteur",r),disabled:s,options:[{label:"10 Nm",value:10},{label:"20 Nm",value:20}]}),e.jsx(O,{label:"Pose",value:t.pose||"RENO",onChange:r=>d("pose",r),disabled:s,options:[{label:"Rénov",value:"RENO"},{label:"Tradi",value:"TRADI"},{label:"Tunnel",value:"TUNNEL"}]})]})]})]}),t.type==="PORTE_ENTREE"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 p-5 rounded-xl border dark:border-slate-800 ${D}`,children:[e.jsx(O,{id:"field-remplissage",label:"Remplissage",value:t.remplissage,onChange:r=>d("remplissage",r),error:C("remplissage"),disabled:s,options:[{label:"Panneau Déco Alu",value:"PANNEAU_DECORATIF_ALU"},{label:"Sandwich",value:"PANNEAU_SANDWICH"},{label:"Vitrée",value:"VITREE"}]}),t.largeurMm>1e3&&e.jsxs("div",{className:"mt-3 pt-3 border-t dark:border-slate-700",children:[e.jsxs("label",{className:`flex items-center justify-between mb-3 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium",children:"Tierce ?"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.tierce,onChange:r=>d("tierce",r.target.checked),disabled:s})]}),t.tierce&&e.jsx(M,{id:"field-cotePassageMm",label:"Cote Passage (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.cotePassageMm,onChange:r=>d("cotePassageMm",r),error:C("cotePassageMm"),disabled:s})]})]}),e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${D}`,children:[e.jsx(Pt,{data:t.dessin,onChange:r=>d("dessin",r),disabled:s}),e.jsxs("div",{className:"mt-6",children:[e.jsx("label",{className:"block text-sm font-medium mb-3 text-slate-700 dark:text-slate-300",children:"Photos"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[(t.photos||[]).map((r,w)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700 group",children:[e.jsx("img",{src:r,className:"w-full h-full object-cover"}),!s&&e.jsx("button",{onClick:()=>d("photos",t.photos.filter((R,U)=>U!==w)),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 shadow-md opacity-80 hover:opacity-100",children:e.jsx(ge,{size:12})})]},w)),!s&&e.jsxs("button",{onClick:()=>{var r;return(r=f.current)==null?void 0:r.click()},className:"aspect-square rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600 flex flex-col items-center justify-center text-slate-400 hover:text-brand-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors",children:[e.jsx(nt,{size:24}),e.jsx("span",{className:"text-[10px] mt-1",children:"Ajouter"})]}),e.jsx("input",{type:"file",ref:f,accept:"image/*",className:"hidden",onChange:V,disabled:s})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"Notes techniques"}),e.jsx("textarea",{className:`w-full p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-950 dark:text-white h-24 text-sm focus:border-brand-500 outline-none ${s?"opacity-50 cursor-not-allowed":""}`,placeholder:"Contraintes...",value:t.notes||"",onChange:r=>d("notes",r.target.value),disabled:s})]})]})]})]}),u&&e.jsxs("div",{className:"fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-3 rounded-lg shadow-xl flex items-center animate-slide-up",children:[e.jsx(ot,{size:20,className:"text-blue-400 mr-2"})," Vitrage G200 activé (Intimité)"]})]})},Dt=({chantier:i})=>{const[p,c]=x.useState(!1);if(!i||!i.dateIntervention)return null;const s=()=>{window.open(yt(i),"_blank"),c(!1)},t=()=>{St(i),c(!1)};return e.jsxs("div",{className:"relative inline-block",children:[e.jsxs(P,{variant:"secondary",onClick:()=>c(!p),className:"py-2 px-3 text-sm flex items-center gap-2",title:"Ajouter à l'agenda",children:[e.jsx(fe,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:"Agenda"})]}),p&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 z-50 animate-fade-in overflow-hidden flex flex-col p-1",children:[e.jsxs("button",{onClick:s,className:"flex items-center w-full px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 rounded-lg transition-colors text-left",children:[e.jsx(De,{size:14,className:"mr-2"})," Google Calendar"]}),e.jsxs("button",{onClick:t,className:"flex items-center w-full px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg transition-colors text-left",children:[e.jsx(dt,{size:14,className:"mr-2"})," Outlook / Apple"]})]}),p&&e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>c(!1)})]})},Mt=({chantier:i,onClose:p,onUpdate:c})=>{const[s,t]=x.useState({...i}),[g,v]=x.useState(null),[N,k]=x.useState(!1),y=(l,f="adresse")=>{t(typeof l=="object"?{...s,[f]:l.address,gps:l.gps}:{...s,[f]:l})},u=async()=>{if(!s.client)return alert("Nom requis");if(s.typeContrat==="SOUS_TRAITANCE"&&(!s.clientFinal||!s.adresseFinale))return alert("Client final requis");let l={...s};if(N&&i.quoteFileId&&(await Q.deleteFile(i.quoteFileId),l.quoteFileId=null,l.quoteFileName=null,l.quoteFile=null),g){i.quoteFileId&&!N&&await Q.deleteFile(i.quoteFileId);const f=Y();await Q.storeFile(f,g),l.quoteFileId=f,l.quoteFileName=g.name,l.quoteFile=null}if(c(l),p(),s.dateIntervention)try{const f=await Ye(s);f&&f!==s.googleEventId&&c({...l,googleEventId:f})}catch(f){console.error("Silent GCal Sync Fail",f)}else if(s.googleEventId)try{Ze(s).catch(console.error),c({...l,googleEventId:null})}catch(f){console.error("GCal Delete Fail",f)}};return e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-end md:items-center justify-center p-0 md:p-4 animate-fade-in",children:e.jsxs(Ct,{className:"w-full max-w-md p-6 shadow-2xl rounded-t-2xl md:rounded-2xl max-h-[95vh] overflow-y-auto animate-slide-up md:animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-start mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold dark:text-white",children:"Modifier le dossier"}),e.jsxs("p",{className:"text-xs text-slate-400 mt-1",children:["ID : ",s.id.slice(0,8)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Dt,{chantier:s}),e.jsx("button",{onClick:p,className:"p-2 text-slate-400 hover:text-slate-600 bg-slate-50 dark:bg-slate-800 rounded-full transition-colors",children:"✕"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700",children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-500 mb-2 uppercase tracking-wider",children:"Planification"}),e.jsx(M,{label:"Date d'intervention",type:"datetime-local",value:s.dateIntervention||"",onChange:l=>t({...s,dateIntervention:l})}),e.jsx("p",{className:"text-[10px] font-medium text-slate-400 mt-2",children:s.dateIntervention?"✅ Ce dossier passera en PLANNING":"⚠️ Sans date, ce dossier reste en À PLANIFIER"})]}),e.jsx(M,{label:"Nom Client",value:s.client,onChange:l=>t({...s,client:l})}),e.jsx(Ie,{value:s.adresse,onChange:l=>t(typeof l=="object"?{...s,adresse:l.address,gps:l.gps}:{...s,adresse:l})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(M,{label:"Tél",value:s.telephone,onChange:l=>t({...s,telephone:l}),type:"tel",inputMode:"tel",pattern:"[0-9]*"}),e.jsx(M,{label:"Email",value:s.email,onChange:l=>t({...s,email:l}),type:"email",inputMode:"email"})]}),e.jsx(O,{label:"Contrat",value:s.typeContrat,onChange:l=>t({...s,typeContrat:l}),options:[{label:"Fourniture Seule",value:"FOURNITURE_SEULE"},{label:"Fourniture & Pose",value:"FOURNITURE_ET_POSE"},{label:"Sous-traitance",value:"SOUS_TRAITANCE"}]}),s.typeContrat==="SOUS_TRAITANCE"&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg border border-amber-200 dark:border-amber-800 animate-fade-in",children:[e.jsxs("h3",{className:"text-xs font-bold text-amber-600 dark:text-amber-400 mb-2 uppercase flex items-center",children:[e.jsx(Me,{size:14,className:"mr-1"})," Client Final"]}),e.jsx(M,{label:"Nom Final",value:s.clientFinal,onChange:l=>t({...s,clientFinal:l})}),e.jsx(Ie,{value:s.adresseFinale,onChange:l=>y(l,"adresseFinale")})]}),e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700",children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-500 mb-2 uppercase tracking-wider",children:"Devis PDF"}),!N&&(s.quoteFileId||s.quoteFileName)?e.jsxs("div",{className:"flex items-center justify-between bg-white dark:bg-slate-700 p-2 rounded-lg border border-slate-200 dark:border-slate-600",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx("div",{className:"bg-brand-100 dark:bg-brand-900/30 p-1.5 rounded text-brand-600 dark:text-brand-400",children:e.jsx(Z,{size:16})}),e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-200 truncate max-w-[150px]",title:s.quoteFileName,children:s.quoteFileName||"Devis.pdf"})]}),e.jsx("button",{onClick:()=>k(!0),className:"p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors",title:"Supprimer / Remplacer",children:e.jsx(te,{size:16})})]}):e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:".pdf,application/pdf",className:"block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100",onChange:l=>v(l.target.files?l.target.files[0]:null)}),g&&e.jsxs("p",{className:"text-xs text-brand-600 mt-1 flex items-center gap-1",children:[e.jsx(it,{size:12})," Prêt à envoyer : ",g.name]}),N&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"Le fichier actuel sera supprimé à l'enregistrement."})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-xs font-bold text-slate-500 mb-1 ml-1",children:"Infos supplémentaires"}),e.jsx("textarea",{className:"w-full p-3 bg-slate-100 dark:bg-slate-800 border-0 rounded-xl outline-none focus:ring-2 focus:ring-brand-500 transition-all text-sm min-h-[80px]",placeholder:"Codes d'accès, instructions particulières...",value:s.notes||"",onChange:l=>t({...s,notes:l.target.value})})]})]}),e.jsxs("div",{className:"flex gap-3 mt-8 pb-4",children:[e.jsx(P,{variant:"secondary",onClick:p,className:"flex-1",children:"Annuler"}),e.jsx(P,{onClick:u,className:"flex-1",children:"Enregistrer"})]})]})})},Ut=({onClose:i,onImport:p})=>{const[c,s]=x.useState(!1),[t,g]=x.useState([]),[v,N]=x.useState(null),[k,y]=x.useState(null),[u,l]=x.useState(()=>new Set),[f,S]=x.useState(null),[d,E]=x.useState("PARSE"),A=x.useRef(null),$=()=>{s(!1),g([]),N(null),y(null),l(new Set),S(null),A.current&&(A.current.value="")},V=n=>{if(!n)return!1;const h=n.type==="application/pdf",j=typeof n.name=="string"&&n.name.toLowerCase().endsWith(".pdf");return h||j},C=async n=>{const h=n.target.files&&n.target.files[0];if(!h)return;const j=25,F=j*1024*1024;if(!V(h)){S("Le fichier doit être un PDF."),A.current&&(A.current.value="");return}if(h.size>F){S(`PDF trop volumineux (max ${j} MB).`),A.current&&(A.current.value="");return}if(s(!0),S(null),g([]),l(new Set),y(h),d==="STORE"){s(!1);return}try{const b=await At.parseQuote(h);g(b.items),N(b.meta),l(new Set(b.items.map(T=>T.id)))}catch(b){console.error(b),S("Erreur lors de l'analyse du PDF. Vérifiez qu'il n'est pas protégé.")}finally{s(!1)}},D=n=>{l(h=>{const j=new Set(h);return j.has(n)?j.delete(n):j.add(n),j})},r=()=>{l(n=>{if(t.length===0)return new Set;const h=t.map(F=>F.id);return n.size===h.length?new Set:new Set(h)})},w=(n,h,j)=>{g(F=>F.map(b=>b.id===n?{...b,[h]:j}:b))},R=()=>{if(d==="STORE")p([],k,null);else{const n=t.filter(h=>u.has(h.id));p(n,k,v)}},U=x.useMemo(()=>t.length>0&&u.size===t.length,[t.length,u.size]),L=x.useMemo(()=>k?d==="STORE"?!0:t.length>0&&u.size>0:!1,[k,d,t.length,u.size]);return e.jsx(de,{isOpen:!0,onClose:i,title:"Importer / Stocker un devis",size:"lg",children:e.jsxs("div",{className:"flex flex-col h-[600px]",children:[!k&&e.jsxs("div",{className:"px-6 pt-4 pb-2",children:[e.jsxs("div",{className:"flex gap-4 p-1 bg-slate-100 dark:bg-slate-800 rounded-lg",children:[e.jsx("button",{onClick:()=>E("PARSE"),className:`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all ${d==="PARSE"?"bg-white dark:bg-slate-700 shadow-sm text-brand-600 dark:text-brand-400":"text-slate-500 hover:text-slate-700 dark:hover:text-slate-300"}`,children:"Analyser & Importer"}),e.jsx("button",{onClick:()=>E("STORE"),className:`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all ${d==="STORE"?"bg-white dark:bg-slate-700 shadow-sm text-brand-600 dark:text-brand-400":"text-slate-500 hover:text-slate-700 dark:hover:text-slate-300"}`,children:"Stocker uniquement"})]}),e.jsx("p",{className:"text-xs text-slate-500 mt-2 px-1",children:d==="PARSE"?"Extrait les menuiseries du PDF pour créer les produits automatiquement.":"Stocke simplement le fichier PDF dans le dossier (Consultable hors-ligne, pas de création de produits)."})]}),!k&&!c&&e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-900 m-4",children:[e.jsx("input",{ref:A,type:"file",accept:".pdf,application/pdf",onChange:C,className:"hidden",id:"pdf-upload"}),e.jsxs("label",{htmlFor:"pdf-upload",className:"flex flex-col items-center cursor-pointer p-10",children:[e.jsx("div",{className:"bg-brand-100 dark:bg-brand-900/30 p-4 rounded-full text-brand-600 dark:text-brand-400 mb-4",children:e.jsx(ct,{size:48})}),e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-2",children:"Cliquez pour sélectionner un devis"}),e.jsxs("p",{className:"text-slate-500 text-sm text-center max-w-xs",children:["Formats supportés : PDF uniquement.",e.jsx("br",{}),d==="PARSE"?"Analyse automatique des menuiseries.":"Stockage sécurisé locale."]})]}),f&&e.jsxs("div",{className:"mt-4 flex items-center gap-2 text-red-600 bg-red-50 dark:bg-red-900/20 px-4 py-2 rounded-lg",children:[e.jsx(ne,{size:20}),e.jsx("span",{children:f})]})]}),c&&e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center","aria-live":"polite",children:[e.jsx(ve,{size:48}),e.jsx("p",{className:"mt-4 text-slate-600 dark:text-slate-300 font-medium",children:"Analyse du document en cours..."}),e.jsx("p",{className:"text-xs text-slate-400 mt-2",children:"Cela peut prendre quelques secondes."})]}),k&&d==="STORE"&&e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center m-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm text-center",children:[e.jsx(Z,{size:64,className:"text-brand-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-slate-800 dark:text-white mb-1",children:k.name}),e.jsxs("p",{className:"text-slate-500 mb-6",children:[(k.size/1024/1024).toFixed(2)," MB"]}),e.jsx(P,{variant:"ghost",size:"sm",onClick:$,children:"Changer de fichier"})]}),e.jsxs("div",{className:"mt-8 text-center max-w-md text-slate-500 text-sm",children:[e.jsx(se,{className:"inline-block text-green-500 mr-2",size:16}),"Le fichier sera stocké localement et lié à ce chantier."]})]}),k&&d==="PARSE"&&t.length>0&&e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center px-4 py-3 bg-slate-100 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Z,{className:"text-slate-500",size:20}),e.jsxs("span",{className:"font-bold text-slate-700 dark:text-slate-200",children:[t.length," élément(s) détecté(s)"]})]}),e.jsx(P,{variant:"ghost",size:"sm",onClick:$,children:"Changer de fichier"})]}),e.jsx("div",{className:"overflow-y-auto flex-1 p-4",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"text-xs text-slate-500 uppercase bg-slate-50 dark:bg-slate-900 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 rounded-tl-lg",children:e.jsx(oe,{checked:U,onChange:r})}),e.jsx("th",{className:"px-4 py-3",children:"Qté"}),e.jsx("th",{className:"px-4 py-3",children:"Type"}),e.jsx("th",{className:"px-4 py-3",children:"Dimensions"}),e.jsx("th",{className:"px-4 py-3",children:"Détails"}),e.jsx("th",{className:"px-4 py-3 rounded-tr-lg",children:"Source"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100 dark:divide-slate-800",children:t.map(n=>{const h=u.has(n.id);return e.jsxs("tr",{className:`hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors ${h?"":"opacity-50"}`,children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx(oe,{checked:h,onChange:()=>D(n.id)})}),e.jsxs("td",{className:"px-4 py-3 font-bold text-brand-600 dark:text-brand-400",children:["x",n.quantity||1]}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("select",{value:n.type,onChange:j=>w(n.id,"type",j.target.value),className:"w-full p-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-sm focus:ring-2 focus:ring-brand-500 outline-none",children:[e.jsx("option",{value:"FENETRE",children:"FENETRE"}),e.jsx("option",{value:"PORTE_FENETRE",children:"PORTE_FENETRE"}),e.jsx("option",{value:"BAIE_COULISSANTE",children:"BAIE_COULISSANTE"}),e.jsx("option",{value:"PORTE_ENTREE",children:"PORTE_ENTREE"}),e.jsx("option",{value:"PORTE_SERVICE",children:"PORTE_SERVICE"}),e.jsx("option",{value:"VOLET_ROULANT",children:"VOLET_ROULANT"}),e.jsx("option",{value:"AUTRE",children:"AUTRE"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"number",value:n.width,onChange:j=>w(n.id,"width",parseInt(j.target.value)||0),className:"w-16 p-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-sm text-center focus:ring-2 focus:ring-brand-500 outline-none"}),e.jsx("span",{className:"text-slate-400",children:"x"}),e.jsx("input",{type:"number",value:n.height,onChange:j=>w(n.id,"height",parseInt(j.target.value)||0),className:"w-16 p-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-sm text-center focus:ring-2 focus:ring-brand-500 outline-none"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("input",{type:"text",value:n.label||"",onChange:j=>w(n.id,"label",j.target.value),placeholder:"Désignation...",className:"w-full p-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-sm focus:ring-2 focus:ring-brand-500 outline-none"}),e.jsxs("div",{className:"text-xs text-slate-500 flex gap-2",children:[e.jsx("span",{children:n.material}),e.jsx("span",{children:n.color})]})]})}),e.jsxs("td",{className:"px-4 py-3 text-xs text-slate-400 italic max-w-[150px] truncate",title:n.originalLine,children:['"',n.originalLine,'"']})]},n.id||`${n.repere}-${n.originalLine}`)})})]})})]}),e.jsxs("div",{className:"p-4 border-t border-slate-200 dark:border-slate-800 flex justify-end gap-3 bg-white dark:bg-slate-950",children:[e.jsx(P,{variant:"ghost",onClick:i,children:"Annuler"}),e.jsx(P,{variant:"primary",disabled:!L,onClick:R,icon:se,children:d==="STORE"?"Stocker le fichier":`Importer ${u.size} produit(s)`})]})]})})},zt=({isOpen:i,onClose:p,blobUrl:c,title:s="Devis"})=>{const t=()=>{c&&URL.revokeObjectURL(c),p()};return i?e.jsx(de,{isOpen:i,onClose:t,title:s,size:"6xl",children:e.jsxs("div",{className:"flex flex-col h-[85vh]",children:[e.jsxs("div",{className:"flex justify-between items-center p-3 border-b border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900",children:[e.jsx("p",{className:"text-xs text-slate-500 dark:text-slate-400",children:"📄 Aperçu en ligne • Google bloque parfois l'affichage direct"}),e.jsx(P,{variant:"ghost",size:"sm",icon:De,onClick:()=>window.open(c,"_blank"),className:"text-brand-600 dark:text-brand-400 font-bold",children:"Ouvrir dans un nouvel onglet"})]}),e.jsx("div",{className:"flex-1 w-full bg-slate-100 dark:bg-slate-800 rounded-b-lg overflow-auto",style:{WebkitOverflowScrolling:"touch"},children:e.jsx("iframe",{src:c,className:"w-full h-full border-0",title:"Aperçu du Devis"})})]})}):null},Lt=(i,p)=>{switch(i){case"VOLET_ROULANT":return{type:"VOLET_ROULANT",profil:"ALU"};case"BAIE_COULISSANTE":return{type:"BAIE_COULISSANTE",profil:"ALU"};case"PORTE_ENTREE":return{type:"PORTE_ENTREE",profil:"ALU_80"};case"PORTE_FENETRE":return{type:"PORTE_FENETRE",profil:"RENO_40"};case"FENETRE":return{type:"FENETRE",profil:"RENO_40"};case"PORTE_SERVICE":return{type:"PORTE_SERVICE",profil:"RENO_40"};case"AUTRE":return{type:"AUTRE",profil:"AUTRE"};case"PORTE_INTERIEURE":return{type:"PORTE_ENTREE",notes:"Type : Porte Intérieure détectée"};default:return{type:"FENETRE",notes:"Type inconnu, importé comme fenêtre par défaut"}}},_t=({history:i})=>{if(!(i!=null&&i.length))return null;const p=[...i].sort((c,s)=>new Date(s.date)-new Date(c.date));return e.jsxs("div",{className:"mt-8 border-t border-slate-200 dark:border-slate-800 pt-6 animate-fade-in",children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(ft,{size:20,className:"text-slate-400"}),"Historique du dossier"]}),e.jsx("div",{className:"space-y-3",children:p.map((c,s)=>e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700 text-sm",children:[e.jsxs("div",{className:"flex justify-between text-slate-500 dark:text-slate-400 text-xs mb-1",children:[e.jsx("span",{children:new Date(c.date).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}),e.jsx("span",{className:"font-medium bg-slate-200 dark:bg-slate-700 px-1.5 rounded",children:c.user||"Système"})]}),e.jsxs("div",{className:"text-slate-800 dark:text-slate-200",children:[e.jsx("span",{className:"font-bold uppercase text-xs mr-2 text-brand-600 dark:text-brand-400",children:c.action==="UNLOCK"?"DÉVERROUILLAGE":c.action}),e.jsx("span",{children:c.reason})]}),c.details&&e.jsxs("div",{className:"mt-1 pl-3 border-l-2 border-slate-300 dark:border-slate-600 italic text-slate-600 dark:text-slate-400 text-xs",children:['"',c.details,'"']})]},s))})]})};async function qt(i,p,c,s){var y;const t=(y=window.SARANGE_CONFIG)==null?void 0:y.APPS_SCRIPT_URL,g=15e3;if(!t||t.includes("your-script-id"))return pe.warn("URL Google Apps Script non configurée ou invalide"),{success:!1,error:"Configuration email manquante"};const v={timestamp:new Date().toISOString(),metrage_id:Y(),htmlReport:c,chantier:{client:i.client,adresse:i.adresse,telephone:i.telephone||"",email:i.email||"",typeContrat:i.typeContrat},clientFinal:i.typeContrat==="SOUS_TRAITANCE"?{nom:i.clientFinal,adresse:i.adresseFinale}:null,produits:p.map(u=>({numero:u.index,type:u.type,quantite:u.quantity||1,localisation:u.room||"",dimensions:`${u.largeurMm} x ${u.hauteurMm} mm`,matiere:u.matiere||"",profil:u.profil||"",couleur:u.couleur==="AUTRE"?u.couleurAutre:u.couleur||"",vitrage:u.vitrageFlags?Object.entries(u.vitrageFlags).filter(([l,f])=>f).map(([l])=>l==="standard"?"4/20/4":l==="g200"?"G200":l==="feuillete1f"?"Feuilleté 1F":l==="feuillete2f"?"Feuilleté 2F":"").filter(Boolean).join(", "):"",options:Et(u),notes:u.notes||"",isValid:u.isValid})),total_produits:p.reduce((u,l)=>u+(l.quantity||1),0),produits_incomplets:p.filter(u=>!u.isValid).length},N=new AbortController,k=setTimeout(()=>N.abort(),g);try{s==null||s({sendStatus:"SENDING",lastError:null});const u=await fetch(t,{method:"POST",mode:"cors",headers:{"Content-Type":"text/plain"},body:JSON.stringify(v),signal:N.signal});if(clearTimeout(k),!u.ok)throw new Error(`Erreur HTTP: ${u.status}`);const l=await u.json();if(l.success===!0){const f=new Date().toISOString();return s==null||s({sendStatus:"SENT",sentAt:f,lastError:null,dateFinalisation:f}),pe.info("✅ Métrage envoyé avec succès",{metrage_id:v.metrage_id,client:i.client}),{success:!0}}else throw new Error(l.error||"Réponse serveur invalide")}catch(u){clearTimeout(k);let l;return u.name==="AbortError"?l="Connexion trop lente (délai 15s dépassé)":u.message.includes("Failed to fetch")||u.message.includes("NetworkError")?l="Pas de connexion réseau":l=u.message,s==null||s({sendStatus:"ERROR",lastError:l}),pe.error("â Œ Échec envoi métrage",{error:l,client:i.client}),{success:!1,error:l}}}const $t=({chantier:i,products:p,incompleteCount:c,onClose:s,onStatusChange:t,onSuccess:g,onError:v})=>{const[N,k]=x.useState({cotes:!1,options:!1}),[y,u]=x.useState(!1),[l,f]=x.useState(!1),S=N.cotes&&N.options,d=async()=>{u(!0);const E=wt(i,p,new Date().toISOString()),A=await qt(i,p,E,t);A.success?(u(!1),f(!0),setTimeout(()=>{g==null||g()},1500)):(u(!1),v==null||v(A.error))};return e.jsx(de,{isOpen:!0,onClose:y||l?void 0:s,title:l?"✓ Envoyé !":"Êtes-vous sûr ?",size:"md",children:e.jsxs("div",{className:"relative min-h-[360px] flex flex-col",children:[l&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center animate-fade-in z-10",children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-green-100 dark:bg-green-900/30 rounded-full scale-150 animate-pulse"}),e.jsx("div",{className:"bg-green-500 text-white rounded-full p-6 shadow-xl shadow-green-500/40 relative z-10 animate-bounce",children:e.jsx(se,{size:48,strokeWidth:3})})]}),e.jsx("h3",{className:"text-2xl font-bold text-slate-800 dark:text-white mb-2",children:"Dossier Envoyé !"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-center text-sm",children:"Le métrage a été transmis au bureau"})]}),!l&&e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsx(oe,{checked:N.cotes,onChange:E=>k(A=>({...A,cotes:E})),label:"J'ai vérifié toutes les cotes"}),e.jsx(oe,{checked:N.options,onChange:E=>k(A=>({...A,options:E})),label:"J'ai vérifié les options"})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 mb-4 flex items-start gap-3",children:[e.jsx("div",{className:"bg-red-100 dark:bg-red-900/50 p-2 rounded-lg shrink-0",children:e.jsx(J,{className:"text-red-600 dark:text-red-400",size:20})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-red-700 dark:text-red-300 text-sm",children:"Action irréversible"}),e.jsx("p",{className:"text-red-600 dark:text-red-400 text-xs mt-1 leading-relaxed",children:"Le dossier sera verrouillé après envoi."})]})]}),e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800 rounded-xl p-4 mb-6 border border-slate-100 dark:border-slate-700",children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"Total Produits"}),e.jsx("span",{className:"font-bold text-slate-800 dark:text-white bg-white dark:bg-slate-700 px-2 py-0.5 rounded border border-slate-200 dark:border-slate-600",children:p.reduce((E,A)=>E+(A.quantity||1),0)})]}),c>0&&e.jsxs("div",{className:"flex justify-between text-sm mt-2 pt-2 border-t border-slate-200 dark:border-slate-700",children:[e.jsxs("span",{className:"text-amber-600 dark:text-amber-400 flex items-center gap-2",children:[e.jsx(J,{size:16})," Incomplets"]}),e.jsx("span",{className:"font-bold text-white bg-amber-500 px-2 py-0.5 rounded text-xs",children:c})]})]}),e.jsxs("div",{className:"mt-auto space-y-3",children:[e.jsx(P,{onClick:d,disabled:!S||y,className:`w-full py-4 text-base transition-all duration-300 ${S?"translate-y-0 opacity-100":"opacity-80"}`,icon:y?null:Ue,children:y?e.jsxs("span",{className:"flex items-center justify-center gap-3",children:[e.jsx(ve,{size:20}),e.jsx("span",{children:"Transmission en cours..."})]}):"Confirmer l'envoi"}),e.jsx(P,{onClick:s,variant:"ghost",className:"w-full py-3",disabled:y,children:"Annuler"})]})]})]})})},Vt=({onClose:i,onUnlock:p})=>{const[c,s]=x.useState(""),[t,g]=x.useState(""),{user:v}=je(),N=c&&(c!=="Autre"||t.trim().length>0),k=()=>{N&&p({reason:c,details:c==="Autre"?t:null,user:(v==null?void 0:v.email)||"Inconnu"})};return e.jsx(de,{isOpen:!0,onClose:i,title:"Déverrouiller le dossier",size:"sm",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg border border-amber-200 dark:border-amber-800 flex gap-3",children:[e.jsx(J,{className:"text-amber-600 shrink-0",size:20}),e.jsx("p",{className:"text-sm text-amber-800 dark:text-amber-200",children:"Cette action sera enregistrée dans l'historique du dossier."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:"Motif du déverrouillage"}),e.jsxs("select",{value:c,onChange:y=>s(y.target.value),className:"w-full p-2.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none transition-all",children:[e.jsx("option",{value:"",disabled:!0,children:"Sélectionnez un motif..."}),e.jsx("option",{value:"Erreur de métrage",children:"Erreur de métrage"}),e.jsx("option",{value:"Changement client",children:"Changement client"}),e.jsx("option",{value:"Ajout oublié",children:"Ajout oublié"}),e.jsx("option",{value:"Autre",children:"Autre"})]})]}),c==="Autre"&&e.jsxs("div",{className:"animate-fade-in",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:"Précisez la raison"}),e.jsx(M,{value:t,onChange:g,placeholder:"Ex: Demande architecte...",autoFocus:!0})]}),e.jsxs("div",{className:"pt-2 flex flex-col gap-2",children:[e.jsx(P,{onClick:k,disabled:!N,variant:N?"danger":"secondary",className:"w-full py-3",icon:jt,children:"Déverrouiller"}),e.jsx(P,{onClick:i,variant:"ghost",className:"w-full",children:"Annuler"})]})]})})},Zt=()=>{const{state:i,selectChantier:p,deleteProduct:c,saveProduct:s,updateChantier:t,updateChantierDate:g,navigate:v,setReturnView:N}=je(),[k,y]=x.useState(null),[u,l]=x.useState(!1),[f,S]=x.useState(!1),[d,E]=x.useState(!1),[A,$]=x.useState(null),[V,C]=x.useState(!1),[D,r]=x.useState(null),[w,R]=x.useState(!1),[U,L]=x.useState(null),[n,h]=x.useState([]),[j,F]=x.useState(!1),[b,T]=x.useState(!1),[q,W]=x.useState(null),a=i.chantiers.find(o=>o.id===i.currentChantierId);if(a&&a.deleted)return null;G.useEffect(()=>{(async()=>{if(a!=null&&a.quoteFileId&&!U)try{const m=await Q.getFile(a.quoteFileId);m&&(L(m),console.log("📄 PDF preloaded from IndexedDB"))}catch(m){console.warn("Failed to preload PDF from IndexedDB:",m)}})()},[a==null?void 0:a.id,a==null?void 0:a.quoteFileId]);const B=(i.products||[]).filter(o=>o.chantierId===(a==null?void 0:a.id)&&!o.deleted).sort((o,m)=>o.index-m.index),ie=(a==null?void 0:a.sendStatus)||"DRAFT",_=ie==="SENT",ce=ie==="SENDING",ze=ie==="ERROR",Ne=!a.dateIntervention&&!_,Le=kt(a,B),_e=()=>{if(_)return;const o=B[B.length-1],m=o?{matiere:o.matiere,profil:o.profil,couleur:o.couleur,couleurAutre:o.couleurAutre,isoMm:o.isoMm}:{};y({id:Y(),chantierId:a.id,index:B.length+1,type:"FENETRE",quantity:1,dateCreation:new Date().toISOString(),photos:[],isValid:!1,validationErrors:[],...m})},qe=(o,m)=>{o.stopPropagation(),!_&&s({...m,id:Y(),index:B.length+1,dateCreation:new Date().toISOString()})},$e=o=>t(a.id,o),Ve=()=>{l(!1)},Be=o=>{l(!1),r({message:`Échec : ${o}`,type:"error"})};G.useEffect(()=>{if(w){const o=setTimeout(()=>R(!1),4e3);return()=>clearTimeout(o)}},[w]),G.useEffect(()=>{a!=null&&a.quoteFileId?Q.getFile(a.quoteFileId).then(o=>{o&&L(o)}).catch(console.error):L(null)},[a==null?void 0:a.quoteFileId]);const Oe=({reason:o,details:m,user:z})=>{const H={date:new Date().toISOString(),action:"UNLOCK",reason:o,details:m,user:z};t(a.id,{sendStatus:"DRAFT",sentAt:null,lastError:null,history:[...a.history||[],H],updatedAt:new Date().toISOString()}),S(!1),r({message:"Dossier déverrouillé (Action enregistrée)",type:"info"})},Ge=async()=>{confirm("Voulez-vous supprimer le devis lié à ce chantier ? Les produits importés seront conservés mais ne seront plus liés au fichier source.")&&(a.quoteFileId&&await Q.deleteFile(a.quoteFileId),t(a.id,{quoteFileId:null,quoteFile:null,quoteFileName:null,referenceDevis:null,updatedAt:new Date().toISOString()}),L(null),r({message:"Lien avec le devis supprimé",type:"info"}))},He=async()=>{try{let o=null;if(a.quoteFileId)try{o=await Q.getFile(a.quoteFileId),o&&console.log("📄 PDF loaded from IndexedDB")}catch(m){console.warn("Failed to load from IndexedDB:",m)}if(!o){const m=await Pe(a);if(m&&m.length>0){const z=m[0].id;console.log(`📥 Downloading PDF from Drive (${z})...`);try{o=await Tt(z),console.log("✅ PDF downloaded from Drive"),a.quoteFileId&&(await Q.storeFile(a.quoteFileId,o),console.log("💾 PDF cached locally"))}catch(H){throw console.error("Drive download failed:",H),new Error("Impossible de télécharger le fichier depuis Drive")}}else throw new Error("Fichier non disponible (ni local, ni Drive)")}if(o){const m=URL.createObjectURL(o);W(m),T(!0)}else throw new Error("Aucun fichier disponible")}catch(o){console.error("Error viewing PDF:",o),r({message:o.message||"Erreur lors de l'ouverture du PDF",type:"error"})}},Qe=async(o,m,z)=>{if((!o||o.length===0)&&!m)return;const H=new Date().toISOString(),xe=B.length+1;let K=null;m&&(K=Y(),await Q.storeFile(K,m));const X=(o||[]).map((I,Xe)=>{const Ee=Lt(I.type,I.subtype);let ae="PVC";I.material==="ALU"?ae="ALU":I.material==="BOIS"?ae="BOIS":I.material==="ACIER"&&(ae="ACIER");let me="BLANC",Ce="";return I.color==="GRIS_7016"?me="GRIS_7016":I.color!=="BLANC"&&I.color!=="Standard"&&(me="AUTRE",Ce=I.color),{id:Y(),chantierId:a.id,index:xe+Xe,type:Ee.type,subtype:I.subtype||"",largeurMm:I.width||0,hauteurMm:I.height||0,quantity:I.quantity||1,matiere:ae,profil:Ee.profil||"RENO_40",couleur:me,couleurAutre:Ce,description:I.label||"",notes:I.label||"",dateCreation:H,updatedAt:H,isValid:I.isValid,source:"QUOTE",isVerified:!1}}),we={...a,quoteFileId:K||a.quoteFileId,quoteFileName:(m==null?void 0:m.name)||a.quoteFileName,referenceDevis:(z==null?void 0:z.number)||a.referenceDevis,updatedAt:H};delete we.quoteFile,t(a.id,we),X.forEach(I=>s(I)),K&&(L(m),It(a,m,m.name).then(I=>{console.log(`✅ Quote auto-uploaded to Drive: ${I.filename}`),ke()}).catch(I=>{console.error("Drive auto-upload failed:",I)})),E(!1),r({message:`${X.length} menuiseries importées avec succès !`,type:"success"})},ke=async()=>{if(a){F(!0);try{const o=await Pe(a);h(o)}catch(o){console.error("Failed to load Drive quotes:",o)}finally{F(!1)}}};G.useEffect(()=>{a&&!_&&ke()},[a==null?void 0:a.id]);const We=o=>{let m="";if(o===1?m="step-top":o===2?m=Ne?"step-planning":"step-top":o===3?m="step-metrage":o===4&&(m="step-envoi"),m){const z=document.getElementById(m);z&&z.scrollIntoView({behavior:"smooth",block:"start"})}};if(!a)return null;if(k)return e.jsx(Rt,{product:k,onSave:o=>{const z=o.source==="QUOTE"||k.source==="QUOTE"?{...o,source:"QUOTE",isVerified:!0}:o;s(z),y(null)},onCancel:()=>y(null),isReadOnly:_});const Je=B.reduce((o,m)=>o+(m.quantity||1),0),Ke=B.filter(o=>!o.isValid).length,ue=B.filter(o=>o.source==="QUOTE"&&!o.isVerified).length,re=ue>0;return e.jsxs("div",{className:"flex flex-col h-full bg-slate-50 dark:bg-slate-950",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-30 shadow-sm min-h-[64px] pt-[max(env(safe-area-inset-top),20px)] pb-2 flex flex-col justify-center overflow-hidden",children:[e.jsxs("div",{className:"px-4 flex items-center justify-between w-full",children:[e.jsxs("div",{className:"flex items-center flex-1 min-w-0",children:[e.jsx("button",{onClick:()=>{i.returnView?(v(i.returnView),N(null)):p(null)},className:"mr-3 p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-200",children:e.jsx(ut,{size:24})}),e.jsxs("div",{className:"truncate flex-1 cursor-pointer py-1",onClick:()=>!_&&C(!0),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"font-bold text-lg dark:text-white truncate leading-tight",children:a.client}),_?e.jsx(ee,{size:16,className:"text-green-600"}):e.jsx(xt,{size:16,className:"text-slate-400"})]}),e.jsxs("div",{className:"text-xs text-slate-500 flex flex-col gap-1 mt-0.5",children:[e.jsx(vt,{address:a.adresse,gps:a.gps,className:"text-slate-500 hover:text-brand-600"}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded",children:[Je," Produit(s)"]}),e.jsxs("span",{children:["• ",a.typeContrat==="FOURNITURE_ET_POSE"?"Pose":a.typeContrat==="SOUS_TRAITANCE"?"Sous-traitance":"Fourn. Seule"]}),a.referenceDevis&&e.jsxs("span",{className:"flex items-center gap-1 bg-brand-50 dark:bg-brand-900/30 text-brand-700 dark:text-brand-300 px-1.5 py-0.5 rounded font-bold border border-brand-100 dark:border-brand-800",children:[e.jsx(Z,{size:12})," ",a.referenceDevis]})]})]})]})]}),(a.quoteFileId||U||a.quoteFile)&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(P,{variant:"ghost",size:"sm",className:"bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-200",icon:Z,onClick:He,children:e.jsx("span",{className:"hidden sm:inline",children:"Voir le Devis"})}),!_&&e.jsx(P,{variant:"ghost",size:"sm",className:"text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20",icon:te,onClick:Ge})]})]}),e.jsx(Ft,{currentStep:Le,onStepClick:We})]}),_&&e.jsxs(Fe,{variant:"success",icon:ee,action:"Modifier",onAction:()=>S(!0),children:["Dossier verrouillé le ",new Date(a.sentAt).toLocaleDateString("fr-FR")," à  ",new Date(a.sentAt).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})]}),ze&&e.jsxs(Fe,{variant:"error",icon:ne,children:["Échec de l'envoi : ",a.lastError]}),e.jsxs("div",{className:`flex-1 overflow-y-auto p-4 max-w-5xl mx-auto w-full scroll-smooth ${_?"pb-24":re?"pb-48":"pb-32"}`,children:[e.jsx("div",{id:"step-top"}),a.assignation==="COMMERCIAL"&&a.status==="SIGNED"&&e.jsxs("div",{id:"step-transfert",className:"mb-6 bg-white dark:bg-slate-900 rounded-xl p-6 shadow-lg border-2 border-green-500 animate-fade-in relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 w-24 h-24 bg-green-50 dark:bg-green-900/10 rounded-full -mr-10 -mt-10 blur-xl"}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:items-start gap-4 text-center sm:text-left relative z-10",children:[e.jsx("div",{className:"bg-green-100 dark:bg-green-900/30 p-3 rounded-full text-green-600 dark:text-green-400 shrink-0",children:e.jsx(se,{size:32})}),e.jsxs("div",{className:"flex-1 w-full",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-1",children:"Deal Gagné ! 🎉"}),e.jsx("p",{className:"text-slate-500 text-sm mb-4",children:"Ce dossier a été signé. Où souhaitez-vous l'envoyer pour la suite ?"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx(P,{variant:"primary",className:"font-bold flex-1",onClick:()=>t(a.id,{assignation:"METRAGE"}),icon:he,children:"Bureau d'Étude (Métrage)"}),e.jsx(P,{variant:"secondary",className:"font-bold border-slate-200 text-slate-700 bg-white hover:bg-slate-50 flex-1",onClick:()=>t(a.id,{assignation:"ATELIER"}),icon:he,children:"Directement à l'Atelier"})]})]})]})]}),a.assignation==="METRAGE"&&a.sendStatus==="SENT"&&e.jsxs("div",{id:"step-transfert-metrage",className:"mb-6 bg-white dark:bg-slate-900 rounded-xl p-6 shadow-lg border-2 border-brand-500 animate-fade-in relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 right-0 w-24 h-24 bg-brand-50 dark:bg-brand-900/10 rounded-full -mr-10 -mt-10 blur-xl"}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:items-start gap-4 text-center sm:text-left relative z-10",children:[e.jsx("div",{className:"bg-brand-100 dark:bg-brand-900/30 p-3 rounded-full text-brand-600 dark:text-brand-400 shrink-0",children:e.jsx(se,{size:32})}),e.jsxs("div",{className:"flex-1 w-full",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-1",children:"Métrage Terminé !"}),e.jsx("p",{className:"text-slate-500 text-sm mb-4",children:"Le dossier de métrage a été validé et envoyé. Transférer à l'équipe de fabrication ?"}),e.jsx("div",{className:"flex flex-col sm:flex-row gap-2",children:e.jsx(P,{variant:"primary",className:"font-bold w-full sm:w-auto px-8",onClick:()=>t(a.id,{assignation:"ATELIER"}),icon:he,children:"Transférer à l'Atelier"})})]})]})]}),Ne&&e.jsx("div",{id:"step-planning",className:"mb-6 bg-white dark:bg-slate-900 rounded-xl p-6 shadow-lg border-2 border-brand-500 animate-fade-in",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:items-start gap-4 text-center sm:text-left",children:[e.jsx("div",{className:"bg-brand-100 dark:bg-brand-900/30 p-3 rounded-full text-brand-600 dark:text-brand-400 shrink-0",children:e.jsx(fe,{size:32})}),e.jsxs("div",{className:"flex-1 w-full",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-1",children:"Ce dossier n'est pas planifié !"}),e.jsx("p",{className:"text-slate-500 text-sm mb-4",children:"Sélectionnez la date d'intervention pour passer à l'étape suivante."}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("input",{type:"datetime-local",className:"flex-1 p-3 rounded-lg border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 dark:text-white focus:border-brand-500 outline-none font-bold text-slate-700 transition-colors",id:`date-picker-${a.id}`}),e.jsx(P,{variant:"primary",className:"font-bold uppercase w-full sm:w-auto",onClick:()=>{const o=document.getElementById(`date-picker-${a.id}`),m=o==null?void 0:o.value;if(!m)return alert("Veuillez sélectionner une date !");g(a.id,m)},children:"Valider"})]})]})]})}),a.dateIntervention&&!_&&e.jsxs("div",{id:"step-planning",className:"mb-6 bg-green-50 dark:bg-green-900/20 rounded-xl p-4 border border-green-200 dark:border-green-800 flex flex-col sm:flex-row items-center justify-between gap-4 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-green-100 dark:bg-green-800 p-2 rounded-full text-green-700 dark:text-green-300",children:e.jsx(fe,{size:24})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-bold text-green-800 dark:text-green-200 uppercase tracking-wide",children:"Intervention planifiée"}),e.jsxs("p",{className:"text-lg font-bold text-slate-800 dark:text-white flex flex-col sm:flex-row sm:items-center gap-2",children:[new Date(a.dateIntervention).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",hour:"2-digit",minute:"2-digit"}),a.googleEventId?e.jsxs("span",{className:"bg-white/80 dark:bg-green-800/50 px-2 py-0.5 rounded-full text-xs flex items-center gap-1 border border-green-200 dark:border-green-700 w-fit",children:[e.jsx("img",{src:"https://www.gstatic.com/images/branding/product/1x/calendar_2020q4_48dp.png",alt:"GCal",className:"w-3 h-3"}),"Synchronisé"]}):e.jsxs("button",{onClick:o=>{o.stopPropagation(),g(a.id,a.dateIntervention)},className:"bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 px-2 py-0.5 rounded-full text-xs flex items-center gap-1 animate-pulse border border-orange-200 dark:border-orange-800 hover:bg-orange-200 transition-colors w-fit",children:[e.jsx(J,{size:12}),"Non Synchronisé (Forcer)"]})]})]})]}),e.jsx(P,{variant:"danger",icon:mt,onClick:()=>{confirm("Confirmer l'annulation du rendez-vous ? Le dossier repassera en 'À Planifier'.")&&(g(a.id,null),r({message:"Rendez-vous annulé",type:"info"}))},children:"Annuler le RDV"})]}),a.typeContrat==="SOUS_TRAITANCE"&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 mb-4 flex items-start",children:[e.jsx(Me,{className:"text-amber-600 mt-1 mr-3 shrink-0",size:20}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-bold text-amber-800 dark:text-amber-200 uppercase",children:"Client Final"}),e.jsx("div",{className:"font-medium text-amber-900 dark:text-amber-100",children:e.jsxs("div",{className:"text-sm text-amber-800 dark:text-amber-300 flex items-center",children:[e.jsx("a",{href:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(a.adresseFinale)}`,target:"_blank",rel:"noopener noreferrer",className:"p-1 -ml-1 mr-1 rounded-full hover:bg-amber-100 dark:hover:bg-amber-800 text-amber-600 dark:text-amber-400 transition-colors",title:"Ouvrir dans Maps",children:e.jsx(bt,{size:12})}),a.adresseFinale]})})]})]}),e.jsxs("div",{id:"step-metrage",className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[B.map(o=>{const m=o.source==="QUOTE",z=m&&!o.isVerified,H=m&&o.isVerified,xe=z?"bg-amber-50 dark:bg-amber-900/20":"bg-white dark:bg-slate-900",K=z?"border-l-amber-500":o.type.includes("FENETRE")?"border-l-orange-500":o.type.includes("PORTE")?"border-l-green-500":"border-l-brand-500";return e.jsxs("div",{onClick:()=>y(o),className:`${xe} ${K} rounded-xl p-4 shadow-sm border-l-4 cursor-pointer hover:shadow-md transition-all relative group border-t border-r border-b border-slate-200 dark:border-slate-800 ${_?"opacity-75":""}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("span",{className:"font-bold text-lg dark:text-white",children:["#",String(o.index).padStart(2,"0")]}),e.jsxs("div",{className:"flex items-center gap-2",children:[z&&e.jsxs("span",{className:"bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300 text-[10px] font-bold px-1.5 py-0.5 rounded uppercase animate-pulse flex items-center gap-1 border border-amber-200 dark:border-amber-800",children:[e.jsx(J,{size:10})," Cotes Devis"]}),H&&e.jsxs("span",{className:"bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300 text-[10px] font-bold px-1.5 py-0.5 rounded uppercase flex items-center gap-1 border border-green-200 dark:border-green-800",children:[e.jsx(ht,{size:10})," Cotes Validées"]}),o.quantity>1&&e.jsxs("span",{className:"bg-brand-100 text-brand-700 dark:bg-brand-900 dark:text-brand-300 text-xs font-bold px-2 py-1 rounded-full",children:["x",o.quantity]})]})]}),e.jsx("div",{className:"text-slate-800 dark:text-slate-200 font-medium mb-1",children:o.type}),e.jsx("div",{className:"text-sm text-slate-500 mb-2",children:e.jsxs("span",{children:[o.largeurMm," x ",o.hauteurMm," mm ",o.room&&`• ${o.room}`]})}),!o.isValid&&e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-300 px-2 py-1 rounded text-xs inline-flex items-center mb-2",children:[e.jsx(ne,{size:12,className:"mr-1"})," Incomplet"]}),!_&&e.jsxs("div",{className:"flex justify-end gap-3 mt-2 pt-3 border-t border-slate-100 dark:border-slate-800",children:[e.jsx("button",{onClick:X=>qe(X,o),className:"text-slate-400 hover:text-brand-600 p-1",children:e.jsx(pt,{size:18})}),e.jsx("button",{onClick:X=>{X.stopPropagation(),confirm("Supprimer ?")&&c(o.id)},className:"text-slate-400 hover:text-red-600 p-1",children:e.jsx(te,{size:18})})]})]},o.id)}),!_&&e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("button",{onClick:_e,className:"flex-1 min-h-[120px] border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 hover:border-brand-400 transition-colors",children:[e.jsx("div",{className:"bg-slate-100 dark:bg-slate-800 p-4 rounded-full mb-2",children:e.jsx(gt,{size:24})}),e.jsx("span",{className:"font-medium",children:"Ajouter Manuellement"})]}),e.jsxs("button",{onClick:()=>E(!0),className:"h-[60px] border border-slate-200 dark:border-slate-700 rounded-xl flex items-center justify-center gap-2 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors",children:[e.jsx(Z,{size:20}),e.jsx("span",{className:"font-medium text-sm",children:"Importer Devis (PDF)"})]})]})]}),e.jsx(_t,{history:a.history}),e.jsx("div",{id:"step-envoi"})]}),!_&&e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 p-4 safe-pb z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]",children:[w&&re&&e.jsxs("div",{className:"mb-4 flex flex-col items-center animate-bounce-short",children:[e.jsxs("div",{className:"bg-amber-100 dark:bg-amber-900/40 text-amber-800 dark:text-amber-200 px-4 py-1.5 rounded-full flex items-center gap-2 border border-amber-200 dark:border-amber-800 shadow-sm transition-all",children:[e.jsx(J,{size:16}),e.jsxs("span",{className:"text-sm font-bold",children:[ue," cote",ue>1?"s":""," devis à vérifier"]})]}),e.jsx("p",{className:"text-[10px] uppercase tracking-widest text-slate-400 mt-2 font-bold",children:"Action requise avant envoi"})]}),e.jsx(P,{onClick:()=>{re?R(!0):l(!0)},disabled:ce,className:`w-full py-4 text-base font-bold transition-all duration-300 shadow-lg ${re&&w?"ring-2 ring-amber-500":"bg-brand-600 hover:bg-brand-700 active:scale-[0.98]"}`,icon:ce?null:Ue,children:ce?e.jsxs("span",{className:"flex items-center justify-center gap-3",children:[e.jsx(ve,{size:20}),"Transmission..."]}):"ENVOYER AU BUREAU"})]}),_&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-green-50 dark:bg-green-900/20 border-t border-green-200 dark:border-green-800 p-4 safe-pb z-40",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-700 dark:text-green-300",children:[e.jsx(ee,{size:16}),e.jsxs("span",{className:"text-sm font-medium",children:["Dossier verrouillé le ",new Date(a.sentAt).toLocaleDateString("fr-FR")]})]})}),u&&e.jsx($t,{chantier:a,products:B,incompleteCount:Ke,onClose:()=>l(!1),onStatusChange:$e,onSuccess:Ve,onError:Be}),f&&e.jsx(Vt,{onClose:()=>S(!1),onUnlock:Oe}),d&&e.jsx(Ut,{onClose:()=>E(!1),onImport:Qe}),V&&e.jsx(Mt,{chantier:a,onClose:()=>C(!1),onUpdate:o=>t(a.id,o)}),b&&q&&e.jsx(zt,{isOpen:b,onClose:()=>{T(!1),W(null)},blobUrl:q,title:`Devis - ${a.referenceDevis||a.client}`}),D&&e.jsx(et,{message:D.message,type:D.type,onClose:()=>r(null)})]})};export{Zt as ChantierDetailView};
