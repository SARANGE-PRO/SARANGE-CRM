const I="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",C="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";class _{constructor(){this.pdfjsLib=null,this.isInitialized=!1}async init(){this.isInitialized||(typeof window.pdfjsLib>"u"&&await this._loadScript(I),this.pdfjsLib=window.pdfjsLib,this.pdfjsLib.GlobalWorkerOptions.workerSrc=C,this.isInitialized=!0)}_loadScript(r){return new Promise((s,c)=>{const i=document.createElement("script");i.src=r,i.onload=s,i.onerror=c,document.head.appendChild(i)})}_generateId(){try{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID()}catch{}return`id_${Date.now()}_${Math.random().toString(16).slice(2)}`}async parseQuote(r){await this.init();const s=await r.arrayBuffer(),c=await this.pdfjsLib.getDocument({data:s}).promise;let i="";for(let t=1;t<=c.numPages;t++){const u=(await(await c.getPage(t)).getTextContent()).items.map(m=>({str:m.str,transform:m.transform,x:m.transform[4],y:m.transform[5]}));u.sort((m,y)=>{const E=y.y-m.y;return Math.abs(E)>5?E:m.x-y.x});let b="",g=u.length>0?u[0].y:0;for(const m of u)(Math.abs(m.y-g)>50||Math.abs(m.y-g)>5)&&(b+=`
`),b+=m.str+" ",g=m.y;i+=b+`
`}const a=/(?:Rep[eè]re)\s*(?:[:°\-]|\s|N°|No|N[°o])?\s*0*(\d+)/gi,o=i.split(a),h=o[0]||"",f=this.extractClientInfo(h),e=[];for(let t=1;t<o.length;t+=2){const n=(o[t]||"").trim(),d=o[t+1];if(!n||!d)continue;const u=this._analyzeBlock(n,d);u&&e.push(u)}return{items:e.map(t=>({...t,id:this._generateId()})),meta:{number:f.number||null,client:f.name||null}}}_cleanLabelFromTableLine(r){if(!r)return"";let s=String(r).trim();return s=s.replace(/^\s*\d+\s+/,"").trim(),s=s.replace(/\s+\d{1,6}(?:[\s\.]\d{3})*,\d{2}(?:\s+\d{1,6}(?:[\s\.]\d{3})*,\d{2})?\s*$/,"").trim(),s=s.replace(/\s+\d{3,4}\s*(?:[xX]|\s)\s*\d{3,4}\s*$/,"").trim(),s=s.replace(/\s+\d{3,4}\s*$/,"").trim(),s||String(r).trim()}_findBestLabel(r,s){if(!Array.isArray(r)||r.length===0)return`Repère ${s}`;const c=a=>/déchet|benne|recyclage|main\s*d['’]?oeuvre|mo\b|pose\s+seule|dépose/i.test(a),i=a=>/(porte|fenet|volet|baie|garage|portail|velux|pergola|v[ée]randa|veranda|chassis|châssis)/i.test(a);for(const a of r){const o=a.trim();if(!(o.length<8)&&!c(o)&&i(o))return o}return r[0].trim()||`Repère ${s}`}_analyzeBlock(r,s){const c=s.split(`
`).map(l=>l.trim()).filter(l=>l);let i=0,a=null,o=null,h=null;const f=/^\s*(\d+)\s+(?:.*?\s+)?(\d{3,4})\s+(?:x|X)?\s*(\d{3,4})\s+.*?(\d{1,3}(?:[\s\.]\d{3})*,\d{2})/;for(const l of c){const p=l.match(f);if(p){h=l,a={qty:parseInt(p[1],10),dim1:parseInt(p[2],10),dim2:parseInt(p[3],10),price:p[4]},i+=.35;break}}if(a){let l=a.dim1,p=a.dim2;l<300||l>4e3||p<300||p>4e3?i-=.1:i+=.15;const T=Math.max(l,p),R=Math.min(l,p);T>=2e3&&R<=1600?(l=R,p=T):(l=a.dim1,p=a.dim2),o={width:l,height:p}}else i-=.4;const e=c.join(" ");let t=null;/porte\s+de\s+garage/i.test(e)?t="PORTE_GARAGE":/portail/i.test(e)?t="PORTAIL":/velux/i.test(e)?t="VELUX":/pergola|v[ée]randa|veranda/i.test(e)&&(t="PERGOLA_VERANDA");let n="AUTRE",d=!1;/\bcompos[ée]e?|\bensemble\s+compos[ée]e?|\bch[âa]ssis\s+compos[ée]e?|\bchassis\s+compos[ée]e?|\bensemble\s+compos[ée]e?/i.test(e)?(n="FENETRE",d=!0):/volet|vr|tablier/i.test(e)?(n="VOLET_ROULANT",d=!0):/coulissant|baie/i.test(e)?(n="BAIE_COULISSANTE",d=!0):/porte\s+d['’ ]entr[ée]e|porte\s+entree/i.test(e)?(n="PORTE_ENTREE",d=!0):/porte[- ]?fen[êe]tre|porte\s+fenetre/i.test(e)?(n="PORTE_FENETRE",d=!0):/porte\s+de\s+service/i.test(e)?(n="PORTE_SERVICE",d=!0):/fen[êe]tre|fenetre|chassis|ch[âa]ssis|fixe|soufflet|imposte/i.test(e)?(n="FENETRE",d=!0):/porte/i.test(e)&&(n="AUTRE",d=!0,t||(t="PORTE")),d&&(i+=.2);let b="PVC",g="BLANC";const m=(c[0]||"").trim(),y=/porte/i.test(m)&&/\b(alu|aluminium)\b/i.test(m);n==="PORTE_ENTREE"?(b=y?"ALU":"PVC",y&&(i+=.05)):/\bALU\b|\bALUMINIUM\b/i.test(e)?(b="ALU",i+=.05):/\bPVC\b/i.test(e)?(b="PVC",i+=.05):(!t&&/\bBOIS\b/i.test(e)&&(t="BOIS"),!t&&/\bACIER\b/i.test(e)&&(t="ACIER"));const E=e.match(/Finition\s*:\s*([^:.,\n]+)/i)||e.match(/Coloris\s*:\s*([^:.,\n]+)/i);if(E){const l=E[1].trim();/bicolore/i.test(l)&&/7016/i.test(l)?g="BICOLOR_7016":/blanc/i.test(l)?g="BLANC":/7016/i.test(l)?g="GRIS_7016":g="AUTRE",i+=.1}let L=`Repère ${r}`;h?L=this._cleanLabelFromTableLine(h):L=this._findBestLabel(c,r);const A=/déchet|benne|recyclage|main\s*d['’]?oeuvre|pose\s+seule|dépose/i.test(e);if(!a&&A)return null;const w=i>=.6&&!!o;return{repere:r,type:n,kindHint:t,quantity:a?a.qty:1,width:o?o.width:0,height:o?o.height:0,material:b,color:g,label:L,originalLine:h||c.slice(0,3).join(" "),confidence:parseFloat(i.toFixed(2)),warning:i<.6||!o,isValid:w}}async extractQuoteData(r){await this.init();const s=await r.arrayBuffer(),c=await this.pdfjsLib.getDocument({data:s}).promise;let i="";for(let a=1;a<=c.numPages;a++){const f=(await(await c.getPage(a)).getTextContent()).items.map(n=>({str:n.str,x:n.transform[4],y:n.transform[5]}));f.sort((n,d)=>{const u=d.y-n.y;return Math.abs(u)>5?u:n.x-d.x});let e="",t=f.length>0?f[0].y:0;for(const n of f)Math.abs(n.y-t)>5&&(e+=`
`),e+=n.str+" ",t=n.y;i+=e+`
`}return this.extractClientInfo(i)}extractClientInfo(r){const s={name:"",address:"",number:"",email:"",totalTTC:null,tvaReduced:!1},c=r.match(/(?:Devis|Offre)\s*(?:N[°o.]?)?\s*[:#]?\s*0*(\d{4,6})/i);c&&(s.number=c[1]);const i=r.match(/Mail\s+client\s*:\s*([a-zA-Z0-9._\-+]+@[a-zA-Z0-9._-]+\.[a-zA-Z]{2,6})/i);if(i)s.email=i[1].trim();else{const e=(r.match(/[a-zA-Z0-9._\-+]+@[a-zA-Z0-9._-]+\.[a-zA-Z]{2,6}/g)||[]).find(t=>!/contact@(?:sarange|artertia)/i.test(t));e&&(s.email=e)}const a=r.split(`
`).map(f=>f.trim()).filter(f=>f.length>0),o=a.findIndex(f=>/(?:Devis|Offre)\s*(?:N[°o.\s]*)\s*\d/i.test(f));if(o>0){const e=a.slice(0,o).filter(t=>t.toLowerCase()!=="client :");if(e.length>0){let t=0;e[0].includes("@")&&e.length>1&&(t=1),s.name=e[t].replace(/^Client\s*:\s*/i,"").trim(),e.length>t+1&&(s.address=e.slice(t+1).filter(n=>!n.includes("@")).join(", "))}}const h=r.match(/MONTANT\s+TOTAL\s+T\.?T\.?C\.?\s*([\d\s]+,\d{2})\s*€?/i);return h&&(s.totalTTC=parseFloat(h[1].replace(/\s/g,"").replace(",","."))),/T\.V\.A\.\s*à\s*(5,50?|10,00?)\s*%/i.test(r)&&(s.tvaReduced=!0),s}}const O=new _;export{O as Q};
