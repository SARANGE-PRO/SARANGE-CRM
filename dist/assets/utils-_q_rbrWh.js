const m={logs:[],add(e,i,r){const o={ts:new Date().toISOString(),level:e,msg:i,data:r};this.logs.push(o),(console[e]?console[e]:console.log)(`[Sarange] ${i}`,r||""),this.logs.length>1e3&&this.logs.shift()},info(e,i){this.add("info",e,i)},warn(e,i){this.add("warn",e,i)},error(e,i){this.add("error",e,i)},getBlob(){return new Blob([JSON.stringify(this.logs,null,2)],{type:"application/json"})}},v="SarangeDB_V2",$=1,A={db:null,async init(){return m.info("Connexion DB..."),new Promise((e,i)=>{const r=setTimeout(()=>i(new Error("Timeout connexion DB")),3e3);try{const o=indexedDB.open(v,$);o.onerror=s=>{clearTimeout(r),i(s.target.error)},o.onsuccess=s=>{clearTimeout(r),this.db=s.target.result,m.info("DB Connect√©e"),e(this.db)},o.onupgradeneeded=s=>{m.info("Migration DB...");const a=s.target.result;a.objectStoreNames.contains("data")||a.createObjectStore("data",{keyPath:"key"})},o.onblocked=()=>m.warn("DB bloqu√©e (autre onglet ?)")}catch(o){clearTimeout(r),i(o)}})},async get(e){return this.db||await this.init(),new Promise((i,r)=>{try{const o=this.db.transaction("data","readonly").objectStore("data").get(e);o.onsuccess=()=>i(o.result?o.result.value:null),o.onerror=()=>r(o.error)}catch(o){r(o)}})},async set(e,i){return this.db||await this.init(),new Promise((r,o)=>{try{const s=this.db.transaction("data","readwrite").objectStore("data").put({key:e,value:i});s.onsuccess=()=>r(),s.onerror=()=>{s.error&&s.error.name==="QuotaExceededError"&&m.error("CRITICAL: IndexedDB Quota Exceeded! Storage is full."),o(s.error)}}catch(s){o(s)}})}},M=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const i=Math.random()*16|0;return(e==="x"?i:i&3|8).toString(16)}),d=e=>!e||typeof e!="string"?e:e.replace(/[&<>"']/g,i=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[i]),w=e=>new Promise(i=>{const r=new FileReader;r.readAsDataURL(e),r.onload=o=>{const s=new Image;s.src=o.target.result,s.onload=()=>{const a=document.createElement("canvas"),f=a.getContext("2d"),c=Math.min(1,1200/s.width);a.width=s.width*c,a.height=s.height*c,f.drawImage(s,0,0,a.width,a.height),i(a.toDataURL("image/jpeg",.6))}}}),p={isMeasureSuspicious:(e,i)=>i?!1:e!==void 0&&e>0&&e<300,hasAdvancedOptions:e=>["FENETRE","PORTE_FENETRE","VOLET_ROULANT","PORTE_ENTREE"].includes(e),validateProduct:e=>{const i=[];if(e.type!=="AUTRE"?(e.largeurMm||i.push("largeurMm"),!e.hauteurMm&&!e.monobloc&&i.push("hauteurMm")):e.description||i.push("description"),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE","PORTE_ENTREE","PORTE_SERVICE"].includes(e.type)){if(e.matiere||i.push("matiere"),e.profil||i.push("profil"),e.couleur||i.push("couleur"),e.couleur==="AUTRE"&&!e.couleurAutre&&i.push("couleurAutre"),e.profil==="ISO"&&!e.isoMm&&i.push("isoMm"),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE"].includes(e.type)){const r=e.vitrageFlags||{};Object.values(r).some(o=>o===!0)||i.push("vitrageFlags")}e.type==="PORTE_ENTREE"&&(e.remplissage||i.push("remplissage"))}return e.type==="VOLET_ROULANT"&&(e.manoeuvre||i.push("manoeuvre"),(e.manoeuvre==="FILAIRE"||e.manoeuvre==="RADIO")&&!e.sortieCable&&e.manoeuvre!=="SOLAIRE"&&i.push("sortieCable"),e.monobloc&&!e.coffreADeduireMm&&i.push("coffreADeduireMm")),{isValid:i.length===0,errors:i}}},S=e=>{const i=[];return e.oscilloBattant&&i.push("Oscillo-battant"),e.grilleVentilation&&i.push("Grille ventilation"),e.poigneeCle&&i.push("Poign√©e √† cl√©"),e.ouvertureExterieure&&i.push("Ouverture ext√©rieure"),e.tierceImposte&&i.push("Tierce/Imposte"),e.tierce&&i.push(`Tierce (passage ${e.cotePassageMm}mm)`),e.monobloc&&i.push(`Monobloc (coffre ${e.coffreADeduireMm}mm)`),e.boxDomotique&&i.push("Box domotique"),e.manoeuvre&&i.push(`Man≈ìuvre ${e.manoeuvre}`),e.sortieCable&&i.push(`Sortie c√¢ble ${e.sortieCable}`),e.coupleMoteur&&i.push(`Couple ${e.coupleMoteur}Nm`),e.pose&&i.push(`Pose ${e.pose}`),e.poigneeHauteur==="AUTRE"&&e.poigneeHauteurMm&&i.push(`Poign√©e ${e.poigneeHauteurMm}mm`),i.join(", ")},I=(e=[],i=[])=>{const r=new Map;return e.forEach(o=>{r.set(o.id,o)}),i.forEach(o=>{const s=r.get(o.id);if(!s)r.set(o.id,o);else{const a=new Date(o.updatedAt||0).getTime(),f=new Date(s.updatedAt||0).getTime();a>f&&r.set(o.id,o)}}),Array.from(r.values())},O=e=>{if(!e||!e.lines||e.lines.length===0)return"";let i="";return e.lines.forEach(r=>{if(r.length<2)return;let o=`M ${r[0].x} ${r[0].y}`;for(let s=1;s<r.length;s++)o+=` L ${r[s].x} ${r[s].y}`;i+=`<path d="${o}" stroke="#2563EB" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`}),`<svg width="100%" height="100%" viewBox="0 0 350 250" preserveAspectRatio="xMidYMid meet">${i}</svg>`},P=(e,i,r)=>{const o=new Date(r),s=o.toLocaleDateString("fr-FR"),a=o.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),f="@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');@page{margin:15mm}body{font-family:'Inter',sans-serif;max-width:1000px;margin:0 auto;padding:20px;color:#1e293b;line-height:1.4}.header{display:flex;justify-content:space-between;border-bottom:3px solid #2563EB;padding-bottom:20px;margin-bottom:30px}.client-box{background:#f8fafc;padding:20px;border-radius:8px;flex:1;margin-right:20px;border:1px solid #e2e8f0}.meta-box{flex:0 0 300px;text-align:right}.stat-badge{display:inline-block;padding:5px 12px;border-radius:20px;font-weight:bold;font-size:0.9em;margin-bottom:5px}.product-card{border:1px solid #cbd5e1;border-radius:8px;margin-bottom:20px;overflow:hidden;page-break-inside:avoid;box-shadow:0 2px 4px rgba(0,0,0,0.05)}.product-header{background:#f1f5f9;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #cbd5e1;font-weight:700;color:#334155}.product-body{display:grid;grid-template-columns:60% 40%}.specs{padding:15px;font-size:0.9em}.visuals{padding:15px;background:#fcfcfc;border-left:1px solid #e2e8f0;display:flex;flex-direction:column;align-items:center;justify-content:center}table.spec-table{width:100%;border-collapse:collapse}table.spec-table td{padding:4px 0;vertical-align:top}.label{color:#64748b;font-weight:600;width:140px}.value{color:#0f172a;font-weight:500}.drawing-container{border:1px dashed #cbd5e1;width:100%;height:160px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;border-radius:4px}.photo-row{display:flex;gap:5px;flex-wrap:wrap;justify-content:center}.photo-img{width:80px;height:80px;object-fit:cover;border-radius:4px;border:1px solid #eee}.alert-text{color:#d97706;font-weight:bold}.notes-box{margin-top:10px;padding:10px;background:#fffbeb;border:1px solid #fcd34d;border-radius:4px;color:#92400e;font-style:italic}.final-client-box{background:#fffbeb;padding:15px;border:1px solid #fcd34d;border-radius:8px;margin-bottom:30px}@media print{body{padding:0;margin:0}}";let c="",h="";e.typeContrat==="FOURNITURE_ET_POSE"?(c="#dcfce7;color:#166534",h="FOURNITURE ET POSE"):e.typeContrat==="SOUS_TRAITANCE"?(c="#fef3c7;color:#92400e",h="SOUS-TRAITANCE"):(c="#dbeafe;color:#1e40af",h="FOURNITURE SEULE");const x=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Relev√© ${d(e.client)}</title><style>${f}</style></head><body onload="window.print()"><div class="header"><div class="client-box"><h1 style="margin:0 0 10px 0;color:#2563EB;">${d(e.client)}</h1><div>üìç ${d(e.adresse)}</div><div>üìû ${d(e.telephone)} ${e.email?` ‚Ä¢ ‚úâÔ∏è ${d(e.email)}`:""}</div></div><div class="meta-box"><div class="stat-badge" style="background:${c}">${h}</div><br><strong>Date:</strong> ${s} √† ${a}<br><strong>Produits:</strong> ${i.reduce((t,g)=>t+(g.quantity||1),0)}<br></div></div>${e.typeContrat==="SOUS_TRAITANCE"?`<div class="final-client-box"><strong>üë∑ CLIENT FINAL (CHANTIER) :</strong> ${d(e.clientFinal)} - ${d(e.adresseFinale)}</div>`:""}`;return i.forEach(t=>{var E;let g="";const n=(u,l)=>{l!=null&&l!==!1&&l!==""&&(g+=`<tr><td class="label">${u}</td><td class="value">${l===!0?"OUI":l}</td></tr>`)};t.room&&n("Localisation",`<strong>${d(t.room)}</strong>`),n("Quantit√©",`<strong>x ${t.quantity||1}</strong>`);let b=`<strong>L ${t.largeurMm} x H ${t.hauteurMm} mm</strong>`;if(t.monobloc&&t.coffreADeduireMm&&t.hauteurMm&&(b+=`<br><span style="font-size:0.9em;color:#64748b">Passage = <strong>${t.hauteurMm-t.coffreADeduireMm} mm</strong> (Coffre ${t.coffreADeduireMm})</span>`),n("Dimensions",b),(p.isMeasureSuspicious(t.largeurMm,t.monobloc)||p.isMeasureSuspicious(t.hauteurMm,t.monobloc))&&(g+='<tr><td class="label">‚ö†Ô∏è Attention</td><td class="value alert-text">Cote < 300mm</td></tr>'),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE","PORTE_ENTREE","PORTE_SERVICE"].includes(t.type)){if(n("Mati√®re",t.matiere),n("Profil",`${t.profil} ${t.profil==="ISO"?`(${t.isoMm}mm)`:""}`),n("Couleur",`${t.couleur} ${d(t.couleurAutre||"")}`),t.vitrageFlags){const u=t.vitrageFlags,l=[];u.standard&&l.push("4/20/4"),u.g200&&l.push("G200"),u.feuillete1f&&l.push("Feuillet√© (1F)"),u.feuillete2f&&l.push("Feuillet√© (2F)"),l.length&&n("Vitrage",l.join(", "))}(t.type==="FENETRE"||t.type==="PORTE_FENETRE")&&(n("Oscillo-Battant",t.oscilloBattant),n("Grille Vent.",t.grilleVentilation),t.poigneeHauteur==="AUTRE"&&t.poigneeHauteurMm&&n("Hauteur Poign√©e",`${t.poigneeHauteurMm} mm`),n("Poign√©e Cl√©",t.poigneeCle),n("Ouv. Ext.",t.ouvertureExterieure),t.type==="FENETRE"&&t.pieceAppuiDescription&&n("Pi√®ce Appui",t.pieceAppuiDescription),t.type==="PORTE_FENETRE"&&(n("Soubassement",t.soubassement?`${t.soubassementHauteurMm}mm`:!1),n("Serrure",t.serrure),n("Seuil PMR",t.seuilPMR))),t.type==="PORTE_ENTREE"&&(n("Remplissage",t.remplissage==="PANNEAU_DECORATIF_ALU"?"Panneau D√©co Alu":t.remplissage),n("Seuil PMR","OUI"),t.tierceImposte&&n("Tierce/Imposte","OUI"),t.tierce&&n("Tierce",`Passage: ${t.cotePassageMm}mm`),n("Ouv. Ext.",t.ouvertureExterieure)),t.type==="PORTE_SERVICE"&&n("Seuil PMR","OUI")}t.type==="VOLET_ROULANT"&&(n("Manoeuvre",t.manoeuvre),t.sortieCable&&n("Sortie C√¢ble",t.sortieCable),t.manoeuvre!=="FILAIRE"&&t.boxDomotique&&n("Box Domo","OUI"),t.coupleMoteur&&n("Couple",`${t.coupleMoteur}Nm`),t.pose&&n("Pose",t.pose),t.monobloc&&n("Monobloc",`OUI (Coffre: ${t.coffreADeduireMm}mm)`),t.lieAProduitId&&n("Li√© √†",`#${((E=i.find(u=>u.id===t.lieAProduitId))==null?void 0:E.index)||"?"}`)),t.type==="AUTRE"&&n("Description",d(t.description));const T=t.dessin&&t.dessin.lines.length>0?`<div class="drawing-container">${O(t.dessin)}</div>`:"",R=t.photos&&t.photos.length>0?`<div class="photo-row">${t.photos.map(u=>`<img src="${u}" class="photo-img"/>`).join("")}</div>`:"",y=t.notes?`<div class="notes-box">Note: ${d(t.notes)}</div>`:"";x+=`<div class="product-card" style="${t.isValid?"":"border-color:#ef4444;border-width:2px"}"><div class="product-header"><span>#${String(t.index).padStart(2,"0")} - ${t.type}</span>${t.isValid?"":'<span style="color:#ef4444">‚ö†Ô∏è INCOMPLET</span>'}</div><div class="product-body"><div class="specs"><table class="spec-table">${g}</table>${y}</div><div class="visuals">${T}${R}</div></div></div>`}),x+="</body></html>",x};export{A as D,m as L,p as V,P as a,S as b,w as c,M as g,I as m};
