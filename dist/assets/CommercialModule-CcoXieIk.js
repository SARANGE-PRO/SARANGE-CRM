import{j as e,B as j,u as ce,i as xe,e as ue}from"./index-DMGdsos9.js";import{n as pe,o as X,p as re,q as be,E as le,g as me,l as ee,s as ne,t as ge,u as te,v as ke,r as m,Z as ye,L as de,w as ae,U as he,x as fe,y as Ce,z as De,D as Se,I as Ee,G as Te,T as Re,B as ze,h as Ae,i as Le,M as Ie,S as Fe,j as Me,m as Pe,H as Oe,J as $e}from"./vendor-DQYctaBf.js";import{C as c,D as W}from"./utils-CKkNC6ps.js";import{I as A,M as ve}from"./Modal-CBdi9DRh.js";import{A as je,S as Qe}from"./AddressInput-Bj7y3_j7.js";import{C as Ue}from"./Card-BAmCq0CR.js";import{Q as Ne}from"./QuoteParserService-BHsDhh6M.js";import{R as Ge}from"./RapportMetrageViewer-CMoDNXi7.js";const Je=({c:r,onClick:w,onDuplicate:x,onDelete:g,onPromoteToSent:F,onMarkForRelance:E,onMarkAsSigned:o,onTriggerRelanceAction:L})=>{const p=(()=>{let i=r.date,k="CrÃ©Ã© le";switch(r.status){case c.LEAD:i=r.dateCreation||r.date,k="CrÃ©Ã© le";break;case c.SENT:i=r.dateEnvoi||r.updatedAt,k="EnvoyÃ© le";break;case c.RELANCE:i=r.dateRelance||r.updatedAt,k="RelancÃ© le";break;case c.SIGNED:i=r.dateSignature||r.updatedAt,k="SignÃ© le";break}const f=i?new Date(i).toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric"}):"N/A";return{prefix:k,formattedDate:f}})(),D={[c.LEAD]:{color:"bg-slate-100 text-slate-600",dot:"bg-slate-400",label:"Nouveau"},[c.SENT]:{color:"bg-blue-50 text-blue-700 border-blue-200",dot:"bg-blue-500",label:"EnvoyÃ©"},[c.RELANCE]:{color:"bg-orange-50 text-orange-700 border-orange-200",dot:"bg-orange-500",label:"Ã€ Relancer"},[c.SIGNED]:{color:"bg-green-50 text-green-700 border-green-200",dot:"bg-green-500",label:"GagnÃ©"}},S=D[r.status]||D[c.LEAD],b=(()=>{if(r.status!==c.SENT&&r.status!==c.RELANCE)return null;const i=new Date(r.dateEnvoi||r.updatedAt),k=Math.abs(new Date-i),f=Math.floor(k/(1e3*60*60*24)),u=r.relanceLevel||0;return f>=30&&u===2?{type:"R3",label:"Relance 3 (ClÃ´ture) requise",days:f,color:"text-red-600",bg:"bg-red-50",border:"border-red-400",shadow:"shadow-red-100"}:f>=10&&u===1?{type:"R2",label:"Relance 2 (Urgence) requise",days:f,color:"text-orange-600",bg:"bg-orange-50",border:"border-orange-400",shadow:"shadow-orange-100"}:f>=3&&u===0?{type:"R1",label:"Relance 1 requise",days:f,color:"text-amber-600",bg:"bg-amber-50",border:"border-amber-400",shadow:"shadow-amber-100"}:null})();return e.jsxs("div",{className:`bg-white dark:bg-slate-800 rounded-xl shadow-sm border ${b?`border-2 ${b.border} ${b.shadow}`:"border-slate-200 dark:border-slate-700"} p-4 transition-all hover:shadow-md cursor-pointer group hover:border-brand-300 dark:hover:border-brand-700`,onClick:()=>w(r.id),children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsx("div",{className:"flex flex-col",children:e.jsx("span",{className:"font-bold text-slate-800 dark:text-white line-clamp-1",children:r.client})}),e.jsxs("div",{className:`text-xs px-2 py-1 rounded-full border border-transparent font-medium flex items-center gap-1.5 whitespace-nowrap ${S.color}`,children:[e.jsx("div",{className:`w-1.5 h-1.5 rounded-full ${S.dot}`}),S.label]})]}),e.jsxs("div",{className:"space-y-2 mb-4 text-sm text-slate-600 dark:text-slate-400",children:[r.telephone&&e.jsxs("a",{href:`tel:${r.telephone}`,className:"flex items-center gap-2 hover:text-brand-600 transition-colors",onClick:i=>i.stopPropagation(),children:[e.jsx(pe,{size:14,className:"text-slate-400"}),r.telephone]}),r.email&&e.jsxs("a",{href:`mailto:${r.email}`,className:"flex items-center gap-2 hover:text-brand-600 transition-colors line-clamp-1",onClick:i=>i.stopPropagation(),children:[e.jsx(X,{size:14,className:"text-slate-400 shrink-0"}),e.jsx("span",{className:"truncate",children:r.email})]}),r.adresse&&e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(re,{size:14,className:"text-slate-400 shrink-0 mt-0.5"}),e.jsx("span",{className:"line-clamp-2 text-xs leading-tight",children:r.adresse})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-xs text-slate-500 font-medium mb-3 bg-slate-50 dark:bg-slate-900/50 p-2 rounded-lg border border-slate-100 dark:border-slate-800",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(be,{size:12,className:"text-slate-400"}),e.jsxs("span",{children:[p.prefix," ",p.formattedDate]})]}),r.montantTTC&&r.status!==c.LEAD&&e.jsxs("div",{className:"flex items-center gap-1 font-bold text-slate-700 dark:text-slate-200",children:[e.jsx(le,{size:13,className:"text-slate-400"}),parseFloat(r.montantTTC).toLocaleString("fr-FR",{style:"currency",currency:"EUR"})]})]}),e.jsxs("div",{className:"pt-3 mt-2 border-t border-slate-100 dark:border-slate-800 flex flex-col gap-2",children:[b&&e.jsxs("div",{className:`w-full rounded-lg border ${b.border} ${b.bg} p-2 mb-1`,children:[e.jsxs("div",{className:`text-xs font-bold mb-2 flex items-center gap-1.5 ${b.color}`,children:[e.jsx(me,{size:14,className:"animate-pulse"})," ",b.label," (J+",b.days,")"]}),e.jsxs("div",{className:"flex flex-col gap-1.5 w-full",children:[b.type==="R1"&&e.jsxs(e.Fragment,{children:[e.jsx(j,{variant:"secondary",className:"w-full text-xs py-1.5 bg-white border border-amber-200 text-amber-700 hover:bg-amber-100 flex justify-center !px-2",onClick:i=>{i.stopPropagation(),L(r,1,"phone")},children:"ðŸ“ž AppelÃ© (Sans SuccÃ¨s)"}),e.jsx(j,{variant:"primary",className:"w-full text-[11px] py-1.5 bg-amber-500 hover:bg-amber-600 border-none flex justify-center !px-2",icon:X,onClick:i=>{i.stopPropagation(),L(r,1,"email")},children:"Envoyer Email R1"})]}),b.type==="R2"&&e.jsx(j,{variant:"primary",className:"w-full text-[11px] py-1.5 bg-orange-500 hover:bg-orange-600 border-none flex justify-center !px-2",icon:X,onClick:i=>{i.stopPropagation(),L(r,2,"email")},children:"Envoyer Email R2 (Urgence)"}),b.type==="R3"&&e.jsx(j,{variant:"primary",className:"w-full text-[11px] py-1.5 bg-red-600 hover:bg-red-700 border-none flex justify-center !px-2",icon:ee,onClick:i=>{i.stopPropagation(),L(r,3,"email_archive")},children:"Email de ClÃ´ture & Archiver"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 w-full",children:[e.jsxs("div",{className:"flex-1",children:[r.status===c.LEAD&&e.jsx(j,{variant:"primary",className:"w-full text-xs py-1.5 h-auto rounded-lg shadow-sm",icon:ne,onClick:i=>{i.stopPropagation(),F(r.id)},children:"Chiffrer / Envoyer"}),!b&&r.status===c.SENT&&e.jsx(j,{variant:"secondary",className:"w-full text-[11px] py-1.5 h-auto rounded-lg shadow-sm bg-orange-100/50 text-orange-700 hover:bg-orange-100 border-none font-medium px-2",icon:ge,onClick:i=>{i.stopPropagation(),E(r.id)},children:"Forcer en Relance"}),!b&&r.status===c.RELANCE&&e.jsx(j,{variant:"secondary",className:"w-full text-xs py-1.5 h-auto rounded-lg shadow-sm bg-green-100/50 text-green-700 hover:bg-green-100 border-none font-bold",icon:te,onClick:i=>{i.stopPropagation(),o(r.id),w(r.id)},children:"GagnÃ© / SignÃ©"}),r.status===c.SIGNED&&e.jsxs("div",{className:"w-full text-xs py-1.5 text-center font-bold text-green-600 bg-green-50 rounded-lg flex justify-center items-center gap-1",children:[e.jsx(te,{size:14})," SignÃ©"]})]}),e.jsxs("div",{className:"flex items-center gap-1 border-l border-slate-200 dark:border-slate-700 pl-2 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{onClick:i=>{i.stopPropagation(),x(r.id)},className:"p-1 text-slate-400 hover:text-brand-600 hover:bg-brand-50 rounded-md transition-colors",title:"Dupliquer",children:e.jsx(ke,{size:16})}),e.jsx("button",{onClick:i=>{i.stopPropagation(),g(r.id)},className:"p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-md transition-colors",title:"Supprimer",children:e.jsx(ee,{size:16})})]})]})]})]})},Ve=({onClose:r,onSubmit:w})=>{const[x,g]=m.useState({client:"",telephone:"",email:"",adresse:"",source:"Site Web",notes:""}),F=o=>{g(typeof o=="object"?{...x,adresse:o.address}:{...x,adresse:o})},E=()=>{if(!x.client.trim())return alert("Le nom du client est requis pour un lead.");w(x)};return e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] flex items-end md:items-center justify-center p-0 md:p-4 animate-fade-in",children:e.jsxs(Ue,{className:"w-full max-w-md p-6 shadow-2xl rounded-t-2xl md:rounded-2xl max-h-[95vh] overflow-y-auto animate-slide-up md:animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-start mb-6",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-xl font-bold dark:text-white flex items-center gap-2",children:[e.jsx(ye,{className:"text-brand-500",size:24}),"Nouveau Lead"]}),e.jsx("p",{className:"text-xs text-slate-400 mt-1",children:"Saisie rapide pour un premier contact"})]}),e.jsx("button",{onClick:r,className:"p-2 text-slate-400 hover:text-slate-600 bg-slate-50 dark:bg-slate-800 rounded-full transition-colors",children:"âœ•"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(A,{label:"Nom / PrÃ©nom Client *",value:x.client,onChange:o=>g({...x,client:o}),autoFocus:!0}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(A,{label:"TÃ©l",value:x.telephone,onChange:o=>g({...x,telephone:o}),type:"tel",inputMode:"tel",pattern:"[0-9]*"}),e.jsx(A,{label:"Email",value:x.email,onChange:o=>g({...x,email:o}),type:"email",inputMode:"email"})]}),e.jsx(je,{value:x.adresse,onChange:F}),e.jsx(Qe,{label:"Source du Lead",value:x.source,onChange:o=>g({...x,source:o}),options:[{label:"Site Web",value:"Site Web"},{label:"TÃ©lÃ©phone",value:"TÃ©lÃ©phone"},{label:"Bouche-a-oreille",value:"Bouche-Ã -oreille"},{label:"Autre",value:"Autre"}]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-xs font-bold text-slate-500 mb-1 ml-1",children:"Description / Projet"}),e.jsx("textarea",{className:"w-full p-3 bg-slate-50 dark:bg-slate-800 border-2 border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:border-brand-500 transition-colors text-sm min-h-[100px] resize-none text-slate-800 dark:text-slate-200",placeholder:"Quels sont les besoins du client ?",value:x.notes,onChange:o=>g({...x,notes:o.target.value})})]})]}),e.jsxs("div",{className:"flex gap-3 mt-8 pb-4",children:[e.jsx(j,{variant:"secondary",onClick:r,className:"flex-1 py-3 text-base",children:"Annuler"}),e.jsx(j,{onClick:E,variant:"primary",className:"flex-1 py-3 text-base",children:"CrÃ©er le Lead"})]})]})})},_e=({file:r,chantierId:w,onClose:x,onSuccess:g})=>{const{state:F,updateChantier:E}=ce(),o=F.chantiers.find(t=>t.id===w),[L,l]=m.useState(!0),[p,D]=m.useState(!1),[S,T]=m.useState(null),[b,i]=m.useState(!1),[k,f]=m.useState(""),[u,V]=m.useState(""),[R,Q]=m.useState(""),[I,U]=m.useState(""),[M,P]=m.useState(""),[_,q]=m.useState(!1),[G,z]=m.useState(""),[J,O]=m.useState(""),[$,B]=m.useState(!1);m.useEffect(()=>{if(!r||!o)return;(async()=>{try{l(!0);const s=await Ne.extractQuoteData(r),n=s.number||o.extractedQuoteNumber||"",d=s.name||o.client||"",a=s.email||o.email||"",v=s.totalTTC?s.totalTTC.toString():o.montantTTC||"",y=s.address||o.adresse||"",h=s.tvaReduced||o.tvaReduced||!1;V(n),Q(d),U(a),z(v),O(y),B(h);const N={};let C=!1;!o.extractedQuoteNumber&&n&&(N.extractedQuoteNumber=n,C=!0),!o.client&&d&&(N.client=d,C=!0),!o.email&&a&&(N.email=a,C=!0),!o.adresse&&y&&(N.adresse=y,C=!0),!o.montantTTC&&v&&(N.montantTTC=v,C=!0),o.tvaReduced===void 0&&h!==void 0&&(N.tvaReduced=h,C=!0),C&&E(o.id,N)}catch(s){console.error("Erreur parsing PDF",s),T("Impossible de lire le PDF. Veuillez vÃ©rifier le fichier.")}finally{l(!1)}})()},[r,o]);const H=async()=>{if(!u||!R){T("Les champs NÂ° Devis et Client sont obligatoires pour un simple enregistrement.");return}D(!0),T(null);try{await xe(),await ue();const s=window.gapi.client.getToken().access_token,n={name:r.name,parents:["1TslssfhTFaJ_I2-Hr2mqgtT8a7plnXZCt9_K00Zc8Nur6kjnEr8zJlC5nc8vSz-wZoBML0jb"],mimeType:"application/pdf"},d=new FormData;d.append("metadata",new Blob([JSON.stringify(n)],{type:"application/json"})),d.append("file",r,r.name);const a=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink",{method:"POST",headers:{Authorization:"Bearer "+s},body:d});if(!a.ok){const oe=await a.text();throw new Error("Erreur upload Drive: "+a.status+" "+oe)}const v=await a.json(),y=v.id,h=v.webViewLink;await fetch(`https://www.googleapis.com/drive/v3/files/${y}/permissions`,{method:"POST",headers:{Authorization:"Bearer "+s,"Content-Type":"application/json"},body:JSON.stringify({role:"reader",type:"anyone"})});const N=crypto.randomUUID();await W.storeFile(N,r);const C=[...o.attachments||[],{id:N,name:r.name,type:r.type,date:new Date().toISOString(),driveFileId:y,driveUrl:h}];let Z=o.notes||"";Z.includes(u)||(Z=Z?`${Z}
Devis NÂ° ${u}`:`Devis NÂ° ${u}`),E(o.id,{extractedQuoteNumber:u,tvaReduced:$,montantTTC:parseFloat(G)||o.montantTTC,client:R,email:I,adresse:J,notes:Z,attachments:C,updatedAt:new Date().toISOString()}),i({type:"local",message:"Devis sauvegardÃ© sur Drive sans email !"}),setTimeout(()=>{g&&g(),x()},2e3)}catch(t){console.error("Erreur enregistrement Drive local",t),T(t.message)}finally{D(!1)}},K=async()=>{if(!u||!R||!I){T("Les champs NÂ° Devis, Client et Email sont obligatoires.");return}D(!0),T(null);try{await xe(),await ue();const s=window.gapi.client.getToken().access_token,n={name:r.name,parents:["1TslssfhTFaJ_I2-Hr2mqgtT8a7plnXZCt9_K00Zc8Nur6kjnEr8zJlC5nc8vSz-wZoBML0jb"],mimeType:"application/pdf"},d=new FormData;d.append("metadata",new Blob([JSON.stringify(n)],{type:"application/json"})),d.append("file",r,r.name);const a=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink",{method:"POST",headers:{Authorization:"Bearer "+s},body:d});if(!a.ok){const se=await a.text();throw new Error("Erreur upload Drive: "+a.status+" "+se)}const v=await a.json(),y=v.id,h=v.webViewLink;await fetch(`https://www.googleapis.com/drive/v3/files/${y}/permissions`,{method:"POST",headers:{Authorization:"Bearer "+s,"Content-Type":"application/json"},body:JSON.stringify({role:"reader",type:"anyone"})});const N="https://script.google.com/macros/s/AKfycbzTS1SgE9Lg3WlFHrC5q-jsfVUXMlk0fGStJQOw2yQGM1AIssJ8-hEtKls5cJTiEvxw/exec",C={action:"admin_devis",horodateur:new Date().toLocaleString("fr-FR"),devis:u.trim(),client:R.trim(),email:I.trim(),cc:M.trim(),fileId:y,driveUrl:h,totalTTC:parseFloat(G)||0,tvaReduced:$},oe=await(await fetch(N,{method:"POST",headers:{"Content-Type":"text/plain;charset=utf-8"},redirect:"follow",body:JSON.stringify(C)})).text();let ie;try{ie=JSON.parse(oe)}catch{throw new Error("RÃ©ponse inattendue du serveur.")}if(ie.status==="success"){const se=crypto.randomUUID();await W.storeFile(se,r);const we=[...o.attachments||[],{id:se,name:r.name,type:r.type,date:new Date().toISOString(),driveFileId:y,driveUrl:h}];let Y=o.notes||"";Y.includes(u)||(Y=Y?`${Y}
Devis NÂ° ${u}`:`Devis NÂ° ${u}`),E(o.id,{status:c.SENT,dateEnvoi:new Date().toISOString(),extractedQuoteNumber:u,tvaReduced:$,montantTTC:C.totalTTC,client:R,email:I,notes:Y,attachments:we,updatedAt:new Date().toISOString()}),i({type:"remote",message:"Devis envoyÃ© avec succÃ¨s !"}),f(h),setTimeout(()=>{g&&g(),x()},2500)}else throw new Error(ie.message||"Erreur serveur inconnue.")}catch(t){console.error("Erreur envoi devis admin",t),T(t.message)}finally{D(!1)}};return o?e.jsx(ve,{isOpen:!0,onClose:x,title:"Extraction & Envoi Devis",size:"md",children:L?e.jsxs("div",{className:"py-12 flex flex-col items-center justify-center text-slate-500",children:[e.jsx(de,{size:32,className:"animate-spin text-brand-500 mb-4"}),e.jsx("p",{className:"font-medium text-sm",children:"Analyse du PDF en cours..."})]}):b?e.jsxs("div",{className:"py-8 flex flex-col items-center text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4",children:e.jsx(te,{size:32})}),e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-slate-100 mb-2",children:b.message}),e.jsx("p",{className:"text-sm text-slate-500 max-w-sm mb-6",children:b.type==="local"?"Le devis a bien Ã©tÃ© rattachÃ© Ã  ce dossier.":"Le PDF est sur Drive, la ligne est dans le Sheet interne et le mail de demande de signature a Ã©tÃ© envoyÃ© au client."}),b.type==="remote"&&k&&e.jsx("a",{href:k,target:"_blank",rel:"noopener noreferrer",className:"text-sm font-semibold text-brand-600 hover:text-brand-700 underline",children:"Voir le PDF sur Google Drive"})]}):e.jsxs("div",{className:"flex flex-col gap-5",children:[S&&e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm flex items-start gap-3",children:[e.jsx(me,{size:16,className:"mt-0.5 shrink-0"}),e.jsx("p",{children:S})]}),e.jsxs("div",{className:"flex items-center justify-between border-b border-slate-100 dark:border-slate-800 pb-3",children:[e.jsxs("h4",{className:"text-sm font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2",children:[e.jsx(te,{size:16,className:"text-green-500"}),"DonnÃ©es extraites"]}),$&&e.jsx("span",{className:"bg-orange-500 text-white text-[10px] font-bold px-2 py-1 rounded-full uppercase tracking-wide",children:"TVA RÃ©duite"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 flex items-center gap-1.5 mb-1.5",children:[e.jsx(ae,{size:12})," NÂ° Devis"]}),e.jsx(A,{value:u,onChange:V,placeholder:"001804"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 flex items-center gap-1.5 mb-1.5",children:[e.jsx(he,{size:12})," Nom du client"]}),e.jsx(A,{value:R,onChange:Q,placeholder:"DA TRAVAUX"})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-1.5",children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 flex items-center gap-1.5",children:[e.jsx(X,{size:12})," Email du client"]}),!_&&e.jsxs("button",{onClick:()=>q(!0),className:"text-[11px] font-medium text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 flex items-center gap-1 transition-colors",children:[e.jsx(fe,{size:10})," Ajouter CC"]})]}),e.jsx(A,{value:I,onChange:U,type:"email",placeholder:"client@example.com"})]}),_&&e.jsxs("div",{className:"animate-in fade-in slide-in-from-top-2 duration-200",children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 flex items-center gap-1.5 mb-1.5",children:[e.jsx(X,{size:12})," Email en copie (CC)"]}),e.jsx(A,{value:M,onChange:P,type:"email",placeholder:"architecte@example.com"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 flex items-center gap-1.5 mb-1.5",children:[e.jsx(re,{size:12})," Adresse"]}),e.jsx(A,{value:J,onChange:O,placeholder:"Adresse du client"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 flex items-center gap-1.5 mb-1.5",children:[e.jsx(le,{size:12})," Total TTC"]}),e.jsx(A,{value:G,onChange:z,placeholder:"35207.10",type:"number",step:"0.01"})]})]}),e.jsxs("div",{className:"bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300 p-3 rounded-lg text-xs flex items-center gap-2 mt-2",children:[e.jsx(de,{size:14,className:"text-blue-500"}),e.jsx("span",{children:"Le PDF sera uploadÃ© automatiquement sur Google Drive si vous choisissez d'envoyer au client."})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row justify-end gap-3 mt-4 pt-4 border-t border-slate-100 dark:border-slate-800",children:[e.jsx(j,{variant:"secondary",onClick:x,disabled:p,children:"Annuler"}),e.jsx(j,{variant:"secondary",onClick:H,disabled:p,className:"text-brand-600 border-brand-200 hover:bg-brand-50",children:"Uploader sur Drive (sans email)"}),e.jsx(j,{variant:"primary",onClick:K,disabled:p,isLoading:p,icon:ne,className:p?"opacity-80":"",children:"Envoyer vers Sheet + Mail"})]})]})}):null},qe=({chantierId:r,onClose:w})=>{var B,H,K;const{state:x,updateChantier:g,deleteChantier:F,promoteLeadToSent:E,markForRelance:o,markAsSigned:L}=ce(),[l,p]=m.useState(null),[D,S]=m.useState(!1),[T,b]=m.useState(!1),[i,k]=m.useState(!1),[f,u]=m.useState(null);if(m.useEffect(()=>{if(r){const t=x.chantiers.find(s=>s.id===r);t&&p({...t})}},[r,x.chantiers]),!l)return null;const V=()=>{g(l.id,{client:l.client,telephone:l.telephone,email:l.email,adresse:l.adresse,montantTTC:l.montantTTC,notes:l.notes,dateEnvoi:l.dateEnvoi,updatedAt:new Date().toISOString()}),w()},R=async t=>{if(!t||t.length===0)return;b(!0);const s=[...l.attachments||[]];let n={};for(let d=0;d<t.length;d++){const a=t[d],v=crypto.randomUUID(),y={id:v,name:a.name,type:a.type,date:new Date().toISOString()};try{if(await W.storeFile(v,a),s.push(y),a.type==="application/pdf"&&!n.number)try{const h=await Ne.extractQuoteData(a);h&&(n=h)}catch(h){console.error("Erreur parsing PDF",h)}}catch(h){console.error("Erreur lors de l'enregistrement du fichier",h),alert("Erreur lors de l'enregistrement de "+a.name)}}p(d=>{const a={...d,attachments:s,montantTTC:n.totalTTC||d.montantTTC,tvaReduced:n.tvaReduced!==void 0?n.tvaReduced:d.tvaReduced,extractedQuoteNumber:n.number||d.extractedQuoteNumber};return n.number&&(!a.notes||!a.notes.includes(n.number))&&(a.notes=a.notes?`${a.notes}
Devis NÂ° ${n.number}`:`Devis NÂ° ${n.number}`),g(a.id,{attachments:s,montantTTC:a.montantTTC,tvaReduced:a.tvaReduced,extractedQuoteNumber:a.extractedQuoteNumber,notes:a.notes,updatedAt:new Date().toISOString()}),a}),b(!1),S(!1)},Q=t=>{t.preventDefault(),t.stopPropagation(),S(!1),R(t.dataTransfer.files)},I=t=>{t.preventDefault(),t.stopPropagation(),S(!0)},U=t=>{t.preventDefault(),t.stopPropagation(),S(!1)},M=t=>R(t.target.files),P=async t=>{try{const s=await W.getFile(t.id);if(!s){alert("Ce fichier est introuvable sur cet appareil.");return}const n=URL.createObjectURL(s);window.open(n,"_blank"),setTimeout(()=>URL.revokeObjectURL(n),1e4)}catch(s){console.error("Download error",s)}},_=async t=>{if(!window.confirm(`Voulez-vous vraiment supprimer "${t.name}" ?`))return;try{await W.deleteFile(t.id)}catch(n){console.error("Delete DB file error",n)}const s=(l.attachments||[]).filter(n=>n.id!==t.id);p(n=>{const d={...n,attachments:s};return g(d.id,{attachments:s,updatedAt:new Date().toISOString()}),d})},q=()=>{window.confirm("ÃŠtes-vous sÃ»r de vouloir supprimer ce dossier ?")&&(F(l.id),w())},G=async()=>{const t=(l.attachments||[]).filter(n=>n.type==="application/pdf");if(t.length===0){alert("Aucun devis PDF enregistrÃ©.");return}t.sort((n,d)=>new Date(d.date)-new Date(n.date));const s=t[0];try{const n=await W.getFile(s.id);if(!n){alert("Fichier introuvable sur l'appareil local. Veuillez importer de nouveau le fichier.");return}const d=new File([n],s.name,{type:"application/pdf"});u(d)}catch(n){console.error("Erreur lecture PDF local",n),alert("Impossible de lire le fichier PDF local.")}},z=t=>{t.preventDefault(),t.stopPropagation(),k(!1);const s=t.dataTransfer.files;s&&s.length>0&&(s[0].type==="application/pdf"?u(s[0]):alert("Veuillez sÃ©lectionner un fichier PDF valide."))},J=t=>{t.preventDefault(),t.stopPropagation(),k(!0)},O=t=>{t.preventDefault(),t.stopPropagation(),k(!1)},$=t=>{const s=t.target.files;s&&s.length>0&&u(s[0])};return e.jsxs(e.Fragment,{children:[e.jsx(ve,{isOpen:!f,onClose:w,title:"DÃ©tails du Dossier Commercial",size:"lg",children:e.jsxs("div",{className:"flex flex-col gap-5 md:flex-row md:gap-6",children:[l.motifRetour&&e.jsxs("div",{className:"w-full md:col-span-2 flex flex-col gap-4",children:[e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-300 dark:border-amber-700 rounded-xl p-4 flex gap-3",children:[e.jsx("div",{className:"bg-amber-100 dark:bg-amber-800 p-2 rounded-lg shrink-0 h-fit",children:e.jsx(Ce,{className:"text-amber-600 dark:text-amber-300 rotate-180",size:18})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-amber-800 dark:text-amber-200 text-sm",children:"â†© Retour du MÃ©trage"}),e.jsxs("p",{className:"text-sm text-amber-700 dark:text-amber-300 mt-1",children:["Motif : ",e.jsx("strong",{children:l.motifRetour})]}),e.jsx("p",{className:"text-xs text-amber-600 dark:text-amber-400 mt-1",children:"Consultez le rapport ci-dessous pour ajuster le devis."})]})]}),(l.rapportMetrage||l.rapportMetrageFileId)&&e.jsx(Ge,{rapportMetrage:l.rapportMetrage,rapportMetrageFileId:l.rapportMetrageFileId,title:"Rapport de MÃ©trage â€” Cotes terrain"})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4",children:[e.jsxs("section",{className:"bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800 p-4",children:[e.jsxs("h4",{className:"text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2",children:[e.jsx(he,{size:14})," Contact & CoordonnÃ©es"]}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-semibold text-slate-500 block mb-1",children:"Nom du Client / SociÃ©tÃ©"}),e.jsx(A,{value:l.client,onChange:t=>p({...l,client:t}),placeholder:"Ex: Jean Dupont",className:"font-bold text-slate-800"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 flex items-center gap-1 mb-1",children:[e.jsx(pe,{size:11})," TÃ©lÃ©phone"]}),e.jsx(A,{value:l.telephone||"",onChange:t=>p({...l,telephone:t}),placeholder:"06...",type:"tel"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 flex items-center gap-1 mb-1",children:[e.jsx(X,{size:11})," Email"]}),e.jsx(A,{value:l.email||"",onChange:t=>p({...l,email:t}),placeholder:"contact@...",type:"email"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 flex items-center gap-1 mb-1",children:[e.jsx(re,{size:11})," Adresse"]}),e.jsx(je,{value:l.adresse||"",onChange:(t,s,n,d,a)=>p({...l,adresse:t,gps:{lat:d,lng:a}})})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 flex items-center gap-1 mb-1",children:[e.jsx(ae,{size:11})," Notes internes"]}),e.jsx("textarea",{value:l.notes||"",onChange:t=>p({...l,notes:t.target.value}),className:"w-full p-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl outline-none focus:ring-2 focus:ring-brand-500 text-sm h-28 resize-none",placeholder:"Budget approximatif, horaires pour appeler, compte-rendu..."})]})]})]}),e.jsxs("section",{className:"bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800 p-4",children:[e.jsxs("h4",{className:"text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2",children:[e.jsx(De,{size:14})," PiÃ¨ces jointes",((B=l.attachments)==null?void 0:B.length)>0&&e.jsx("span",{className:"ml-auto bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 text-xs font-semibold px-2 py-0.5 rounded-full",children:l.attachments.length})]}),e.jsxs("div",{className:`relative border-2 border-dashed rounded-xl p-5 text-center transition-all ${D?"border-brand-500 bg-brand-50 dark:bg-brand-900/20 scale-[1.01]":"border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:border-slate-300 dark:hover:border-slate-600"}`,onDrop:Q,onDragOver:I,onDragLeave:U,children:[e.jsx("input",{type:"file",multiple:!0,accept:"image/*,.pdf",onChange:M,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",title:"Cliquez ou glissez vos fichiers ici"}),T?e.jsx(de,{size:28,className:"mx-auto text-brand-500 mb-2 animate-spin"}):e.jsx(Se,{size:28,className:`mx-auto mb-2 transition-colors ${D?"text-brand-500":"text-slate-300"}`}),e.jsx("p",{className:"text-sm font-semibold text-slate-600 dark:text-slate-300",children:D?"RelÃ¢chez pour ajouter":"Glissez ou cliquez pour ajouter"}),e.jsx("p",{className:"text-xs text-slate-400 mt-0.5",children:"Photos du chantier, plans, PDFâ€¦"})]}),l.attachments&&l.attachments.length>0&&e.jsx("ul",{className:"mt-3 flex flex-col gap-2",children:l.attachments.map(t=>e.jsxs("li",{className:"group flex items-center justify-between gap-2 p-2.5 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm hover:border-slate-300 dark:hover:border-slate-600 transition-all",children:[e.jsxs("button",{onClick:()=>P(t),className:"flex items-center gap-2.5 flex-1 text-left hover:text-brand-600 dark:hover:text-brand-400 transition-colors overflow-hidden",children:[e.jsx("div",{className:"bg-slate-100 dark:bg-slate-800 p-2 rounded-md shrink-0",children:t.type.startsWith("image/")?e.jsx(Ee,{size:14,className:"text-blue-500"}):e.jsx(ae,{size:14,className:"text-orange-500"})}),e.jsxs("div",{className:"overflow-hidden",children:[e.jsx("p",{className:"text-sm font-semibold truncate",title:t.name,children:t.name}),e.jsx("p",{className:"text-xs text-slate-400",children:new Date(t.date).toLocaleDateString("fr-FR")})]})]}),e.jsx("button",{onClick:()=>_(t),className:"p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-md transition-colors shrink-0 opacity-0 group-hover:opacity-100 focus:opacity-100",title:"Supprimer",children:e.jsx(ee,{size:14})})]},t.id))})]}),e.jsxs(j,{variant:"secondary",className:"w-full gap-2 text-sm font-semibold text-brand-700 bg-brand-50 border-brand-100 hover:bg-brand-100",onClick:V,children:[e.jsx(Te,{size:15})," Enregistrer les modifications"]})]}),e.jsxs("div",{className:"flex-1 flex flex-col gap-4",children:[e.jsxs("section",{className:"bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800 p-4",children:[e.jsxs("h4",{className:"text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2",children:[e.jsx(le,{size:14})," Chiffrage & Devis"]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"text-xs font-semibold text-slate-500 block mb-1",children:"Montant EstimÃ© ou Final (TTC)"}),e.jsxs("div",{className:"relative",children:[e.jsx(le,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-brand-500 pointer-events-none",size:17}),e.jsx("input",{type:"number",value:l.montantTTC||"",onChange:t=>p({...l,montantTTC:t.target.value}),className:"w-full pl-9 pr-4 py-2.5 text-lg font-bold bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-brand-500 outline-none",placeholder:"0,00"})]})]}),l.status!==c.LEAD&&e.jsxs("div",{className:"mb-5 bg-blue-50/50 hover:bg-blue-50 dark:bg-blue-900/10 dark:hover:bg-blue-900/20 transition-colors border border-blue-100 dark:border-blue-800/50 p-3 rounded-xl",children:[e.jsxs("label",{className:"text-xs font-semibold text-blue-700 dark:text-blue-400 block mb-1 flex items-center gap-1.5",children:[e.jsx(be,{size:13})," Date d'envoi (DÃ©clenche les relances)"]}),e.jsx("input",{type:"date",value:l.dateEnvoi?l.dateEnvoi.substring(0,10):"",onChange:t=>{const s=t.target.value;p({...l,dateEnvoi:s?new Date(s).toISOString():null})},className:"w-full p-2 text-sm font-medium bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:ring-2 focus:ring-blue-500 text-slate-700 dark:text-slate-300"}),e.jsx("p",{className:"text-[10px] text-slate-500 mt-1.5 leading-tight",children:"Modifiez cette date si vous avez envoyÃ© le devis Ã  la main sans utiliser le bouton d'envoi du CRM. Les relances (J+3, 10, 30) se basent sur ce jour."})]}),e.jsxs("div",{className:`relative border-2 border-dashed rounded-xl p-5 text-center transition-all cursor-pointer ${i?"border-brand-500 bg-brand-50 dark:bg-brand-900/20 scale-[1.01]":"border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 hover:border-slate-300 dark:hover:border-slate-600"}`,onDrop:z,onDragOver:J,onDragLeave:O,children:[e.jsx("input",{type:"file",accept:"application/pdf",onChange:$,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer",title:"Cliquez ou glissez le devis PDF ici"}),e.jsx(ae,{size:28,className:`mx-auto mb-2 transition-colors ${i?"text-brand-500":"text-slate-300"}`}),e.jsx("p",{className:"text-sm font-semibold text-slate-600 dark:text-slate-300",children:i?"RelÃ¢chez le devis ici":"Aucun devis liÃ©. Glissez un PDF ici"}),e.jsx("p",{className:"text-xs text-slate-400 mt-0.5",children:"ou cliquez pour importer"}),e.jsx(j,{variant:"secondary",className:"mt-3 text-xs pointer-events-none",children:"Importer un devis"})]})]}),l.status!==c.SIGNED&&e.jsxs("section",{className:"bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-800 p-4",children:[e.jsx("h4",{className:"text-xs font-bold text-slate-400 uppercase tracking-widest mb-4",children:"Faire avancer le dossier"}),e.jsxs("div",{className:"flex flex-col gap-2",children:[l.status===c.LEAD&&e.jsxs("div",{className:"flex flex-col gap-2",children:[((H=l.attachments)==null?void 0:H.some(t=>t.type==="application/pdf"))&&e.jsx(j,{variant:"primary",className:"w-full text-sm shadow-sm",icon:ne,onClick:G,children:"Envoyer le devis (Email + Drive)"}),e.jsx(j,{variant:(K=l.attachments)!=null&&K.some(t=>t.type==="application/pdf")?"secondary":"primary",className:"w-full text-sm",icon:ne,onClick:()=>E(l.id,l.montantTTC),children:'Passer en "Devis EnvoyÃ©" (Manuel)'})]}),l.status===c.SENT&&e.jsx(j,{variant:"secondary",className:"w-full text-sm bg-orange-50 text-orange-700 hover:bg-orange-100 border-orange-100 font-medium",icon:ge,onClick:()=>o(l.id),children:'Passer en "Relance"'}),(l.status===c.SENT||l.status===c.RELANCE)&&e.jsx(j,{variant:"secondary",className:"w-full text-sm bg-green-50 text-green-700 hover:bg-green-100 border-green-100 font-bold",icon:te,onClick:()=>L(l.id),children:'âœ¨ Marquer comme "GagnÃ© / SignÃ©"'})]})]}),l.status===c.SIGNED&&e.jsxs("section",{className:"relative overflow-hidden bg-green-50 dark:bg-green-900/20 rounded-xl border-2 border-green-400 dark:border-green-600 p-5",children:[e.jsx("div",{className:"absolute top-0 right-0 w-36 h-36 bg-green-100 dark:bg-green-800/20 rounded-full blur-3xl -mr-12 -mt-12 pointer-events-none"}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-2",children:[e.jsx("h4",{className:"text-lg font-bold text-green-800 dark:text-green-300",children:"ðŸŽ‰ Deal GagnÃ© !"}),e.jsx("span",{className:"shrink-0 bg-green-200 dark:bg-green-800 text-green-800 dark:text-green-200 text-xs font-bold px-2 py-0.5 rounded-full uppercase tracking-wide",children:"SignÃ©"})]}),e.jsx("p",{className:"text-sm text-green-700 dark:text-green-400 mb-4",children:"Le devis est signÃ©. OÃ¹ souhaitez-vous envoyer ce dossier ?"}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(j,{variant:"primary",className:"w-full justify-start h-auto py-3 px-4",onClick:()=>{g(l.id,{assignation:"METRAGE"}),w()},children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-white/20 p-2 rounded-full shrink-0",children:e.jsx(re,{size:17})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"font-bold text-white text-sm",children:"Envoyer en MÃ©trage"}),e.jsx("p",{className:"text-xs text-green-100 font-normal",children:"Un mÃ©treur doit se rendre sur place pour prendre les cotes."})]})]})}),e.jsx(j,{variant:"secondary",className:"w-full justify-start h-auto py-3 px-4 bg-white border-slate-200 dark:border-slate-600",onClick:()=>{g(l.id,{assignation:"METHODES"}),w()},children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-slate-100 dark:bg-slate-800 p-2 rounded-full shrink-0",children:e.jsx(Re,{size:17,className:"text-slate-500"})}),e.jsxs("div",{className:"text-left",children:[e.jsx("p",{className:"font-bold text-slate-700 dark:text-slate-200 text-sm",children:"Envoyer aux MÃ©thodes"}),e.jsx("p",{className:"text-xs text-slate-500 font-normal",children:"Les cotes sont dÃ©jÃ  fournies. PrÃªt pour l'Ã©dition des fiches fab."})]})]})})]})]})]}),e.jsx("div",{className:"mt-auto pt-2 border-t border-slate-100 dark:border-slate-800 flex justify-end",children:e.jsxs("button",{onClick:q,className:"flex items-center gap-1.5 text-xs text-slate-400 hover:text-red-500 transition-colors py-1 px-2 rounded-md hover:bg-red-50 dark:hover:bg-red-900/20",children:[e.jsx(ee,{size:12})," Supprimer ce dossier"]})})]})]})}),f&&e.jsx(_e,{file:f,chantierId:l.id,onClose:()=>u(null),onSuccess:()=>{u(null),w()}})]})},tt=({onNew:r,isDark:w,toggleDark:x,onOpenSettings:g,onOpenTrash:F,isOnline:E,firebaseConnected:o})=>{const{state:L,selectChantier:l,updateChantier:p,promoteLeadToSent:D,markForRelance:S,markAsSigned:T,createNewLead:b,duplicateChantier:i,deleteChantier:k}=ce(),[f,u]=m.useState(null),[V,R]=m.useState(!1),[Q,I]=m.useState(null),[U,M]=m.useState(!1),[P,_]=m.useState(""),[q,G]=m.useState("leads"),z=m.useMemo(()=>(L.chantiers||[]).filter(t=>{var s,n,d,a;return!t.deleted&&!t.purged&&t.assignation==="COMMERCIAL"&&(((s=t.client)==null?void 0:s.toLowerCase().includes(P.toLowerCase()))||((n=t.adresse)==null?void 0:n.toLowerCase().includes(P.toLowerCase()))||((d=t.telephone)==null?void 0:d.includes(P))||((a=t.email)==null?void 0:a.toLowerCase().includes(P.toLowerCase())))}),[L.chantiers,P]),J=m.useMemo(()=>{const t=z.filter(a=>(!a.status||a.status===c.LEAD||a.status==="DRAFT")&&a.status!==c.SENT&&a.status!==c.SIGNED&&!a.commercialRelance),s=z.filter(a=>a.status===c.SENT&&!a.commercialRelance),n=z.filter(a=>a.status===c.RELANCE||a.status===c.SENT&&a.commercialRelance===!0),d=z.filter(a=>a.status===c.SIGNED);return[{id:"leads",title:"Nouveaux Leads",shortTitle:"Leads",items:t,color:"bg-slate-100 dark:bg-slate-800/50",headerColor:"text-slate-700 dark:text-slate-300",dot:"bg-slate-400",border:"border-slate-200 dark:border-slate-700",ring:"ring-slate-400"},{id:"envoyes",title:"Devis EnvoyÃ©s",shortTitle:"EnvoyÃ©s",items:s,color:"bg-brand-50/50 dark:bg-brand-900/10",headerColor:"text-brand-700 dark:text-brand-300",dot:"bg-brand-500",border:"border-brand-100 dark:border-brand-900",ring:"ring-brand-400"},{id:"relance",title:"En Relance",shortTitle:"Relances",items:n,color:"bg-rose-50/50 dark:bg-rose-900/10",headerColor:"text-rose-700 dark:text-rose-300",dot:"bg-rose-500",border:"border-rose-100 dark:border-rose-900",ring:"ring-rose-400"},{id:"signes",title:"GagnÃ©s / SignÃ©s",shortTitle:"GagnÃ©s",items:d,color:"bg-green-50/50 dark:bg-emerald-900/10",headerColor:"text-green-700 dark:text-emerald-400",dot:"bg-green-500",border:"border-green-100 dark:border-green-900",ring:"ring-green-400"}]},[z]),O=m.useRef(!1);m.useEffect(()=>{const t=async()=>{if(!(O.current||!E)){O.current=!0;try{const n=z.filter(a=>(a.status===c.SENT||a.status===c.RELANCE)&&a.extractedQuoteNumber);if(n.length===0){O.current=!1;return}const d="https://script.google.com/macros/s/AKfycbzTS1SgE9Lg3WlFHrC5q-jsfVUXMlk0fGStJQOw2yQGM1AIssJ8-hEtKls5cJTiEvxw/exec";for(const a of n){try{console.log(`[Auto-Sync] VÃ©rification du devis ${a.extractedQuoteNumber}...`);const v=String(a.extractedQuoteNumber).trim(),y=await fetch(`${d}?check=${v}`);if(y.ok){const h=await y.json();console.log(`[Auto-Sync] RÃ©ponse pour devis ${v}:`,JSON.stringify(h)),(h.signed===!0||h.signed==="true")&&(console.log(`[Auto-Sync] ðŸŽ‰ Devis ${a.extractedQuoteNumber} dÃ©tectÃ© comme signÃ© ! Mise Ã  jour...`),p(a.id,{status:c.SIGNED,dateSignature:new Date().toISOString()}))}}catch(v){console.error("Erreur vÃ©rification signature auto pour",a.extractedQuoteNumber,v)}await new Promise(v=>setTimeout(v,500))}}finally{O.current=!1}}};t();const s=setInterval(t,18e4);return()=>clearInterval(s)},[z,p,E]);const $=(t,s)=>{u(s),t.dataTransfer.setData("text/plain",s),t.dataTransfer.effectAllowed="move"},B=t=>{t.preventDefault(),t.dataTransfer.dropEffect="move"},H=(t,s)=>{if(t.preventDefault(),!!f){switch(s){case"leads":p(f,{status:c.LEAD,commercialRelance:!1});break;case"envoyes":D(f,null);break;case"relance":S(f);break;case"signes":T(f),I(f);break}u(null)}},K=async(t,s,n)=>{if(!t)return;const d="https://script.google.com/macros/s/AKfycbzTS1SgE9Lg3WlFHrC5q-jsfVUXMlk0fGStJQOw2yQGM1AIssJ8-hEtKls5cJTiEvxw/exec";try{if(n==="phone"){p(t.id,{relanceLevel:s,status:c.RELANCE,dateRelance:new Date().toISOString()});return}if(n==="email"||n==="email_archive"){let a="";if(t.attachments&&t.attachments.length>0){const N=t.attachments.filter(C=>C.type==="application/pdf"&&C.driveFileId);N.length>0&&(a=N[N.length-1].driveFileId)}const v={action:"relance_devis",devis:t.extractedQuoteNumber||"",client:t.client||"",email:t.email||"",fileId:a,relanceLevel:s},h=await(await fetch(d,{method:"POST",body:JSON.stringify(v)})).json();if(h.status==="success"){const N={relanceLevel:s,dateRelance:new Date().toISOString()};n==="email_archive"?N.status="ARCHIVED":N.status=c.RELANCE,p(t.id,N)}else alert("Erreur lors de l'envoi de l'email de relance : "+(h.message||"Erreur inconnue"))}}catch(a){console.error("Erreur handleRelanceAction:",a),alert("Impossible de joindre le serveur pour la relance.")}};return e.jsxs("div",{className:"flex flex-col h-full bg-slate-50 dark:bg-slate-900",children:[V&&e.jsx(Ve,{onClose:()=>R(!1),onSubmit:t=>{b(t),R(!1)}}),Q&&e.jsx(qe,{chantierId:Q,onClose:()=>I(null)}),e.jsxs("div",{className:"bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 px-6 pt-[max(1rem,env(safe-area-inset-top))] pb-4 flex-shrink-0 flex items-center shadow-sm z-20",children:[e.jsxs("h2",{className:"text-xl font-bold text-slate-800 dark:text-white mr-auto flex items-center gap-2",children:[e.jsx(ze,{size:22,className:"text-brand-600"}),"Commercial"]}),e.jsxs("div",{className:"flex gap-2 relative",children:[E?o?e.jsx("div",{className:"p-2 bg-green-50 dark:bg-green-900/20 rounded-full",title:"ConnectÃ© au Cloud",children:e.jsx(Ae,{size:20,className:"text-green-500"})}):e.jsx("div",{className:"p-2 bg-orange-50 dark:bg-orange-900/20 rounded-full animate-pulse",title:"ProblÃ¨me de connexion Firebase (Quota/RÃ©seau)",children:e.jsx(me,{size:20,className:"text-orange-500"})}):e.jsx("div",{className:"p-2 bg-slate-100 dark:bg-slate-800 rounded-full",title:"Hors Connexion",children:e.jsx(Le,{size:20,className:"text-slate-400"})}),e.jsx("button",{onClick:()=>M(!U),className:"flex items-center justify-center min-w-[44px] min-h-[44px] bg-slate-100 dark:bg-slate-800 rounded-xl text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors",children:e.jsx(Ie,{size:20})}),U&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>M(!1)}),e.jsx("div",{className:"absolute right-0 top-full mt-2 w-56 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden z-50 animate-fade-in origin-top-right",children:e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsxs("button",{onClick:()=>{x(),M(!1)},className:"w-full flex items-center px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg transition-colors",children:[w?e.jsx(Fe,{size:16,className:"mr-3 text-orange-400"}):e.jsx(Me,{size:16,className:"mr-3 text-brand-600"}),w?"Mode Clair":"Mode Sombre"]}),e.jsx("div",{className:"h-px bg-slate-100 dark:bg-slate-700 my-1"}),F&&e.jsxs("button",{onClick:()=>{F(),M(!1)},className:"w-full flex items-center px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg",children:[e.jsx(ee,{size:16,className:"mr-3 text-red-500"}),"Corbeille"]}),g&&e.jsxs("button",{onClick:()=>{g(),M(!1)},className:"w-full flex items-center px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg",children:[e.jsx(Pe,{size:16,className:"mr-3 text-slate-400"}),"ParamÃ¨tres..."]})]})})]})]})]}),e.jsx("div",{className:"flex-none bg-white dark:bg-slate-900 px-4 pt-3 pb-3 border-b border-slate-200 dark:border-slate-800",children:e.jsxs("div",{className:"w-full mx-auto relative flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(Oe,{className:"absolute left-3 top-3 text-slate-400",size:20}),e.jsx("input",{className:"w-full pl-10 p-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-xl outline-none focus:ring-2 focus:ring-brand-500 dark:text-white transition-all shadow-inner",placeholder:"Rechercher un dossier...",value:P,onChange:t=>_(t.target.value)})]}),e.jsx(j,{onClick:()=>R(!0),icon:fe,className:"py-2 text-sm shadow-sm whitespace-nowrap px-4 hover:scale-[1.02] transition-transform",children:"Nouveau Lead"})]})}),e.jsx("div",{className:"md:hidden flex-none px-2 pt-4 pb-2 bg-slate-50 dark:bg-slate-900 w-full relative z-10 shrink-0",children:e.jsx("div",{className:"grid grid-cols-4 gap-2 lg:gap-3",children:J.map(t=>e.jsxs("button",{onClick:()=>G(t.id),className:`p-3 lg:p-4 rounded-xl border transition-all flex flex-col items-center justify-center text-center gap-1.5
                                ${q===t.id?`ring-2 ring-offset-1 ${t.ring} border-transparent scale-100`:`${t.border.replace("border-","border-")}/30 opacity-90`}
                                ${t.color}`,children:[e.jsx("div",{className:"text-2xl font-bold",children:t.items.length}),e.jsx("div",{className:"text-[11px] leading-tight font-bold uppercase w-full break-words",children:t.shortTitle})]},`tile-${t.id}`))})}),e.jsx("main",{className:"flex-1 min-h-0 overflow-y-auto pb-40 md:pb-0 w-full mx-auto bg-slate-50 dark:bg-slate-900",children:e.jsx("div",{className:"flex-1 min-h-0 grid grid-cols-1 md:grid-cols-4 gap-6 h-auto px-4 md:px-6 md:pt-6 pb-6 w-full mx-auto",children:J.map(t=>e.jsxs("div",{className:`flex flex-col h-full rounded-2xl border ${t.border}/60 ${t.color} ${q===t.id?"block":"hidden md:flex"}`,onDragOver:B,onDrop:s=>H(s,t.id),children:[e.jsx("div",{className:"hidden md:flex items-center justify-between mb-4 md:mb-0 md:p-4 shrink-0 border-b border-transparent md:border-slate-200/50 dark:md:border-slate-700/50",children:e.jsxs("h3",{className:`font-bold ${t.headerColor} flex items-center gap-2`,children:[e.jsx("div",{className:`hidden md:block w-2.5 h-2.5 rounded-full ${t.dot}`}),t.title,e.jsx("span",{className:"bg-white/50 dark:bg-slate-800/50 text-xs px-2 py-0.5 rounded-full shadow-sm ml-2",children:t.items.length})]})}),e.jsx("div",{className:"flex-1 p-0 pt-4 md:p-3 pb-0 md:pb-6 space-y-3",children:t.items.length===0?e.jsx("div",{className:"h-24 md:h-full flex items-center justify-center border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl text-slate-400 dark:text-slate-500 text-sm font-medium",children:"Vide"}):t.items.map(s=>e.jsxs("div",{className:`group relative ${f===s.id?"opacity-50":""}`,draggable:"true",onDragStart:n=>$(n,s.id),onDragEnd:()=>u(null),children:[e.jsx("div",{className:"hidden md:block absolute left-1 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity z-10 cursor-grab active:cursor-grabbing text-slate-300 dark:text-slate-600",children:e.jsx($e,{size:16})}),e.jsx("div",{className:"md:group-hover:translate-x-3 transition-transform duration-200",children:e.jsx(Je,{c:s,onClick:n=>I(n),onDuplicate:n=>i(n),onDelete:n=>{window.confirm("Supprimer ce lead ?")&&k(n)},onPromoteToSent:D,onMarkForRelance:S,onMarkAsSigned:T,onTriggerRelanceAction:K})})]},s.id))})]},t.id))})})]})};export{tt as CommercialModule};
