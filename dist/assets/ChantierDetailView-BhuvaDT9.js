import{c as je,j as e,B as $,u as be,m as $e,d as ze,S as pe,T as _e}from"./index-DoWnPC-X.js";import{R as V,r as N,d as ue,E as Ce,D as Oe,o as ye,L as Ve,p as de,q as Ne,T as K,s as ve,t as ke,u as qe,X as xe,v as Y,w as Be,c as re,A as G,x as Ge,y as He,z as Qe,B as We,U as Ae,F as X,G as Xe,H as Je,C as me,I as Ye,J as Ke,K as Ze,N as et,O as tt,n as st,P as rt,Q as Se,e as at,V as lt}from"./vendor-zB6w3uSG.js";import{S as O,I as M,A as we,M as le,a as nt}from"./Modal-DPFR0SQK.js";import{S as Ee}from"./StatusBanner-D37UXxYv.js";import{V as se,c as it,D as J,g as W,a as ot,b as dt,L as ce,d as ct}from"./utils-DbF2Uwnc.js";import{C as ut}from"./Card-B5__snbX.js";const ae=({label:n,checked:x,onChange:i,disabled:s})=>V.createElement("label",{className:je("flex items-center gap-3 cursor-pointer group",s&&"opacity-50 cursor-not-allowed")},V.createElement("div",{className:je("w-5 h-5 rounded border flex items-center justify-center transition-all",x?"bg-brand-600 border-brand-600 text-white":"bg-white border-slate-300 group-hover:border-brand-400")},x&&V.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",className:"w-3.5 h-3.5"},V.createElement("polyline",{points:"20 6 9 17 4 12"}))),V.createElement("input",{type:"checkbox",className:"hidden",checked:x,onChange:t=>!s&&i(t.target.checked),disabled:s}),V.createElement("span",{className:"text-sm text-slate-700 dark:text-slate-300 select-none"},n)),xt=n=>{if(!n.dateIntervention)return null;const x=c=>new Date(c).toISOString().replace(/[-:]/g,"").split(".")[0]+"Z",i=x(n.dateIntervention),s=x(new Date(new Date(n.dateIntervention).getTime()+60*6e4)),t=x(new Date);let m=n.adresse,b="",j="";n.gps&&n.gps.lat&&(b=`GEO:${n.gps.lat};${n.gps.lon}`,j=`X-APPLE-STRUCTURED-LOCATION;VALUE=URI;X-APPLE-RADIUS=100;X-TITLE="${n.adresse}":geo:${n.gps.lat},${n.gps.lon}`);const E=`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//SarangePro//Métrage//FR
CALSCALE:GREGORIAN
BEGIN:VEVENT
UID:${n.id}@app.sarange.fr
DTSTAMP:${t}
DTSTART:${i}
DTEND:${s}
SUMMARY:Métré : ${n.client}
DESCRIPTION:Client: ${n.client}\\nTéléphone: ${n.telephone}\\nAdresse: ${n.adresse}
LOCATION:${m}
${b}
${j}
STATUS:CONFIRMED
BEGIN:VALARM
TRIGGER:-P1D
ACTION:DISPLAY
DESCRIPTION:Rappel J-1 : Métré demain (${n.client})
END:VALARM
BEGIN:VALARM
TRIGGER:-PT2H
ACTION:DISPLAY
DESCRIPTION:Rappel H-2 : Départ imminent ? Vérifiez le trafic.
END:VALARM
BEGIN:VALARM
TRIGGER:-PT0M
ACTION:DISPLAY
DESCRIPTION:C'est l'heure du métré !
END:VALARM
END:VEVENT
END:VCALENDAR`,h=new Blob([E],{type:"text/calendar;charset=utf-8"});return URL.createObjectURL(h)},mt=n=>{const x=xt(n);if(!x)return;const i=document.createElement("a");i.href=x,i.setAttribute("download",`Metre_${n.client.replace(/\s+/g,"_")}.ics`),document.body.appendChild(i),i.click(),document.body.removeChild(i)},bt=n=>{if(!n.dateIntervention)return"";const x=encodeURIComponent(`Métré : ${n.client}`),i=encodeURIComponent(`Client: ${n.client}
Téléphone: ${n.telephone||""}
Adresse: ${n.adresse}

${n.gps?`GPS: ${n.gps.lat}, ${n.gps.lon}`:""}`),s=encodeURIComponent(n.adresse),t=new Date(n.dateIntervention),m=t.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z",b=new Date(t.getTime()+60*6e4).toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";return`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${x}&dates=${m}/${b}&details=${i}&location=${s}`},pt=({chantier:n})=>{const[x,i]=N.useState(!1);if(!n||!n.dateIntervention)return null;const s=()=>{window.open(bt(n),"_blank"),i(!1)},t=()=>{mt(n),i(!1)};return e.jsxs("div",{className:"relative inline-block",children:[e.jsxs($,{variant:"secondary",onClick:()=>i(!x),className:"py-2 px-3 text-sm flex items-center gap-2",title:"Ajouter à l'agenda",children:[e.jsx(ue,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:"Agenda"})]}),x&&e.jsxs("div",{className:"absolute top-full right-0 mt-2 w-48 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 z-50 animate-fade-in overflow-hidden flex flex-col p-1",children:[e.jsxs("button",{onClick:s,className:"flex items-center w-full px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-blue-50 dark:hover:bg-blue-900/20 hover:text-blue-600 rounded-lg transition-colors text-left",children:[e.jsx(Ce,{size:14,className:"mr-2"})," Google Calendar"]}),e.jsxs("button",{onClick:t,className:"flex items-center w-full px-3 py-2 text-sm text-slate-700 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg transition-colors text-left",children:[e.jsx(Oe,{size:14,className:"mr-2"})," Outlook / Apple"]})]}),x&&e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>i(!1)})]})},ht=({currentStep:n,onStepClick:x})=>{const i=[{id:1,label:"Création"},{id:2,label:"Planification"},{id:3,label:"Métrage"},{id:4,label:"Envoyé"}],s=Math.min(100,Math.max(0,(n-1)/(i.length-1)*100));return e.jsx("div",{className:"w-full bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 shadow-sm transition-colors duration-300",children:e.jsx("div",{className:"max-w-2xl mx-auto px-4 py-4",children:e.jsxs("div",{className:"relative flex items-center justify-between",children:[e.jsx("div",{className:"absolute top-[15px] left-0 w-full h-[3px] bg-slate-100 dark:bg-slate-800 rounded-full -z-0"}),e.jsx("div",{className:"absolute top-[15px] left-0 h-[3px] bg-gradient-to-r from-brand-500 to-brand-600 dark:from-brand-600 dark:to-brand-500 transition-all duration-500 ease-out rounded-full -z-0",style:{width:`${s}%`}}),i.map(t=>{const m=t.id<n,b=t.id===n,j=t.id<=n;return e.jsxs("div",{onClick:()=>j&&x&&x(t.id),className:`
                                    relative flex flex-col items-center group
                                    ${j?"cursor-pointer":"cursor-default"}
                                `,children:[e.jsx("div",{className:`
                                        w-8 h-8 rounded-full flex items-center justify-center border-2 text-sm font-bold z-10 transition-all duration-300 transform
                                        ${m?"bg-brand-600 border-brand-600 text-white shadow-md scale-100":b?"bg-white dark:bg-slate-900 border-brand-600 text-brand-600 shadow-lg scale-110 ring-4 ring-brand-50 dark:ring-brand-900/20":"bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-300 dark:text-slate-600 scale-95"}
                                        ${j&&!b?"group-hover:border-brand-300 dark:group-hover:border-brand-700":""}
                                    `,children:m?e.jsx(ye,{className:"w-4 h-4",strokeWidth:3}):b?e.jsx(Ve,{className:"w-4 h-4 animate-spin text-brand-600"}):e.jsx("span",{children:t.id})}),e.jsx("span",{className:`
                                        mt-2 text-[10px] sm:text-xs font-semibold uppercase tracking-wide transition-colors duration-300 text-center px-1
                                        ${b?"text-brand-600 dark:text-brand-400 translate-y-0 opacity-100":m?"text-slate-600 dark:text-slate-400 translate-y-0 opacity-100":"text-slate-400 dark:text-slate-600 translate-y-0 opacity-100"}
                                    `,children:t.label})]},t.id)})]})})})},ft=({data:n,onChange:x,disabled:i=!1})=>{const s=N.useRef(null),t=N.useRef(null),[m,b]=N.useState((n==null?void 0:n.lines)||[]),[j,E]=N.useState(!1),[h,c]=N.useState(!1),[a,f]=N.useState("free"),[S,o]=N.useState(null),[C,k]=N.useState(null),L=350,D=250;N.useEffect(()=>{x({lines:m,width:L,height:D})},[m]);const y=(l,p=1,w=0,F=0)=>{if(!l)return;const v=l.getContext("2d");if(v.clearRect(0,0,l.width,l.height),v.save(),v.translate(w,F),v.scale(p,p),v.fillStyle="white",v.fillRect(0,0,L,D),v.lineCap="round",v.lineJoin="round",v.lineWidth=3,v.strokeStyle="#2563EB",m.forEach(R=>{if(!(R.length<1)){v.beginPath(),v.moveTo(R[0].x,R[0].y);for(let _=1;_<R.length;_++)v.lineTo(R[_].x,R[_].y);v.stroke()}}),j&&S&&C){if(v.strokeStyle="#93C5FD",v.beginPath(),a!=="free"){if(a==="line")v.moveTo(S.x,S.y),v.lineTo(C.x,C.y);else if(a==="rect"){const R=C.x-S.x,_=C.y-S.y;v.rect(S.x,S.y,R,_)}}v.stroke()}v.restore()};N.useEffect(()=>{y(s.current)},[m,j,C,a]);const[P,r]=N.useState({s:1,x:0,y:0});N.useEffect(()=>{if(!h||!t.current)return;const l=t.current;l.width=window.innerWidth,l.height=window.innerHeight;const p=Math.min(l.width/L,l.height/D)*.95,w=(l.width-L*p)/2,F=(l.height-D*p)/2;r({s:p,x:w,y:F}),y(l,p,w,F)},[h,m,j,C]);const g=(l,p=1,w=0,F=0)=>{const v=l.target.getBoundingClientRect(),R=l.touches?l.touches[0]:l;return{x:(R.clientX-v.left-w)/p,y:(R.clientY-v.top-F)/p}},A=(l,p)=>{if(i)return;l.cancelable&&l.preventDefault(),p==="fs"?t.current:s.current;const{s:w,x:F,y:v}=p==="fs"?P:{s:1,x:0,y:0},R=g(l,w,F,v);E(!0),o(R),k(R),a==="free"&&b(_=>[..._,[R]])},d=(l,p)=>{if(i||!j)return;l.cancelable&&l.preventDefault();const{s:w,x:F,y:v}=p==="fs"?P:{s:1,x:0,y:0},R=g(l,w,F,v);k(R),a==="free"&&b(_=>{const q=[..._],Z=q[q.length-1];return Z&&(q[q.length-1]=[...Z,R]),q})},I=()=>{if(j){if(E(!1),S&&C){if(a==="line")b(l=>[...l,[S,C]]);else if(a==="rect"){const l=S,p=C,w={x:p.x,y:l.y},F={x:l.x,y:p.y};b(v=>[...v,[l,w,p,F,l]])}}o(null),k(null)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 relative group ${i?"opacity-70":""}`,children:[e.jsxs("div",{className:"flex flex-col gap-2 mb-2",children:[e.jsxs("div",{className:"flex justify-between items-center text-xs text-slate-500 uppercase font-bold tracking-wide",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(de,{size:14,className:"mr-1"})," Croquis ",e.jsx("span",{className:"ml-2 text-brand-600 dark:text-brand-400 font-bold",children:"— VUE INTÉRIEUR"})]}),!i&&e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>b(l=>l.slice(0,-1)),className:"p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded text-slate-600 dark:text-slate-400",title:"Annuler",children:e.jsx(Ne,{size:16})}),e.jsx("button",{onClick:()=>confirm("Effacer tout ?")&&b([]),className:"p-1 hover:bg-red-100 dark:hover:bg-red-900/30 rounded text-red-500",title:"Effacer",children:e.jsx(K,{size:16})})]})]}),!i&&e.jsxs("div",{className:"flex gap-2 border-b border-slate-200 dark:border-slate-700 pb-2",children:[e.jsxs("button",{onClick:()=>f("free"),className:`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${a==="free"?"bg-brand-600 text-white shadow-sm":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700"}`,children:[e.jsx(de,{size:14})," Crayon"]}),e.jsxs("button",{onClick:()=>f("line"),className:`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${a==="line"?"bg-brand-600 text-white shadow-sm":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700"}`,children:[e.jsx(ve,{size:14})," Ligne"]}),e.jsxs("button",{onClick:()=>f("rect"),className:`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${a==="rect"?"bg-brand-600 text-white shadow-sm":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700"}`,children:[e.jsx(ke,{size:14})," Rect"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("canvas",{ref:s,width:L,height:D,className:`w-full h-48 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded touch-none shadow-inner ${i?"cursor-not-allowed":"cursor-crosshair"}`,onMouseDown:l=>A(l,"sm"),onMouseMove:l=>d(l,"sm"),onMouseUp:I,onMouseLeave:I,onTouchStart:l=>A(l,"sm"),onTouchMove:l=>d(l,"sm"),onTouchEnd:I}),!i&&e.jsx("button",{onClick:()=>c(!0),className:"absolute top-2 right-2 p-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur rounded-full shadow border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:text-brand-600",children:e.jsx(qe,{size:20})})]})]}),h&&!i&&e.jsxs("div",{className:"fixed inset-0 z-[60] bg-slate-950 flex items-center justify-center touch-none",children:[e.jsx("canvas",{ref:t,className:"block cursor-crosshair",onMouseDown:l=>A(l,"fs"),onMouseMove:l=>d(l,"fs"),onMouseUp:I,onMouseLeave:I,onTouchStart:l=>A(l,"fs"),onTouchMove:l=>d(l,"fs"),onTouchEnd:I}),e.jsxs("div",{className:"absolute top-4 left-4 flex gap-2 bg-slate-800/90 backdrop-blur p-2 rounded-lg border border-slate-700 shadow-xl",children:[e.jsx("button",{onClick:()=>f("free"),className:`p-3 rounded-md ${a==="free"?"bg-brand-600 text-white":"text-slate-400 hover:bg-slate-700"}`,children:e.jsx(de,{size:24})}),e.jsx("button",{onClick:()=>f("line"),className:`p-3 rounded-md ${a==="line"?"bg-brand-600 text-white":"text-slate-400 hover:bg-slate-700"}`,children:e.jsx(ve,{size:24})}),e.jsx("button",{onClick:()=>f("rect"),className:`p-3 rounded-md ${a==="rect"?"bg-brand-600 text-white":"text-slate-400 hover:bg-slate-700"}`,children:e.jsx(ke,{size:24})})]}),e.jsx("div",{className:"absolute top-4 right-4",children:e.jsx("button",{onClick:()=>c(!1),className:"p-3 bg-red-600 text-white rounded-full shadow-lg hover:bg-red-500",children:e.jsx(xe,{size:24})})}),e.jsxs("div",{className:"absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-4 bg-slate-800/90 backdrop-blur p-2 rounded-full border border-slate-700 shadow-xl",children:[e.jsxs("button",{onClick:()=>b(l=>l.slice(0,-1)),className:"px-6 py-3 bg-slate-700 text-white rounded-full font-bold hover:bg-slate-600 flex items-center",children:[e.jsx(Ne,{size:20,className:"mr-2"})," Annuler"]}),e.jsxs("button",{onClick:()=>confirm("Tout effacer ?")&&b([]),className:"px-6 py-3 bg-red-900/50 text-red-200 rounded-full font-bold hover:bg-red-900/70 flex items-center",children:[e.jsx(K,{size:20,className:"mr-2"})," Effacer"]}),e.jsxs("button",{onClick:()=>c(!1),className:"px-8 py-3 bg-green-600 text-white rounded-full font-bold hover:bg-green-500 flex items-center",children:[e.jsx(ye,{size:20,className:"mr-2"})," OK"]})]})]})]})},gt=({product:n,onSave:x,onCancel:i,isReadOnly:s=!1})=>{const[t,m]=N.useState(n),[b,j]=N.useState([]),[E,h]=N.useState(!1),[c,a]=N.useState(!1),f=N.useRef(null),{state:S}=be(),o=(r,g)=>{s||m(A=>({...A,[r]:g}))},C=(r,g,A)=>{s||m(d=>({...d,[r]:{...d[r]||{},[g]:A}}))},k=r=>{var g;s||(o("room",r),/sdb|salle\s?de\s?bain|toilette|wc|douche/i.test(r.toLowerCase())&&["FENETRE","BAIE_COULISSANTE"].includes(t.type)&&!((g=t.vitrageFlags)!=null&&g.g200)&&(m(A=>({...A,vitrageFlags:{...A.vitrageFlags,standard:!0,g200:!0}})),a(!0),setTimeout(()=>a(!1),3e3)))};N.useEffect(()=>{t.type==="FENETRE"&&t.hauteurMm>2200&&m(r=>({...r,oscilloBattant:!1}))},[t.hauteurMm]);const L=()=>{if(s)return;const r=se.validateProduct(t);if(!r.isValid){j(r.errors),setTimeout(()=>{const g=document.getElementById(`field-${r.errors[0]}`);g&&g.scrollIntoView({behavior:"smooth",block:"center"})},100);return}x({...t,isValid:!0,validationErrors:[]})},D=async r=>{if(!s&&r.target.files&&r.target.files[0]){const g=await it(r.target.files[0]);o("photos",[...t.photos||[],g])}},y=r=>b.includes(r),P=s?"opacity-60 cursor-not-allowed bg-slate-100 dark:bg-slate-800":"";return e.jsxs("div",{className:"fixed inset-0 bg-slate-50 dark:bg-slate-950 z-50 flex flex-col h-full animate-fade-in",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 pb-3 pt-3 safe-top-padding flex justify-between items-center shadow-sm shrink-0",children:[e.jsx("button",{onClick:i,className:"p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800",children:e.jsx(xe,{size:24,className:"text-slate-500"})}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"font-bold dark:text-white",children:["Produit #",String(t.index).padStart(2,"0")]}),s&&e.jsxs("span",{className:"text-xs text-green-600 font-medium flex items-center justify-center gap-1",children:[e.jsx(Y,{size:12})," Consultation"]})]}),s?e.jsx("div",{className:"w-[76px]"}):e.jsx($,{onClick:L,className:"px-5 py-2 rounded-full",icon:Be,children:"Valider"})]}),s&&e.jsx("div",{className:"bg-green-50 dark:bg-green-900/20 border-b border-green-200 dark:border-green-800 px-4 py-2 text-center",children:e.jsxs("span",{className:"text-sm text-green-700 dark:text-green-300 font-medium flex items-center justify-center gap-2",children:[e.jsx(Y,{size:14})," Dossier verrouillé — consultation seule"]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 pb-20 max-w-3xl mx-auto w-full",children:[b.length>0&&e.jsxs("div",{className:"mb-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-900/50 text-red-700 dark:text-red-300 p-3 rounded-lg flex items-center",children:[e.jsx(re,{size:20,className:"mr-2"}),e.jsx("span",{children:"Champs manquants"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${P}`,children:[e.jsx(O,{label:"Type",value:t.type,onChange:r=>o("type",r),disabled:s,options:[{label:"Fenêtre",value:"FENETRE"},{label:"Porte-fenêtre",value:"PORTE_FENETRE"},{label:"Coulissant",value:"BAIE_COULISSANTE"},{label:"Porte Entrée",value:"PORTE_ENTREE"},{label:"Porte Service",value:"PORTE_SERVICE"},{label:"Volet",value:"VOLET_ROULANT"},{label:"Autre",value:"AUTRE"}]}),e.jsxs("div",{className:"flex items-center justify-between bg-slate-50 dark:bg-slate-800 p-3 rounded-lg mb-4 border border-slate-100 dark:border-slate-700",children:[e.jsx("span",{className:"font-medium text-slate-700 dark:text-slate-300",children:"Quantité"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{className:`w-8 h-8 rounded-full bg-white dark:bg-slate-700 shadow text-brand-600 font-bold ${s?"opacity-50 cursor-not-allowed":""}`,onClick:()=>o("quantity",Math.max(1,(t.quantity||1)-1)),disabled:s,children:"-"}),e.jsx("span",{className:"font-bold text-xl w-6 text-center dark:text-white",children:t.quantity||1}),e.jsx("button",{className:`w-8 h-8 rounded-full bg-white dark:bg-slate-700 shadow text-brand-600 font-bold ${s?"opacity-50 cursor-not-allowed":""}`,onClick:()=>o("quantity",(t.quantity||1)+1),disabled:s,children:"+"})]})]}),e.jsx(M,{label:"Localisation",value:t.room,onChange:k,placeholder:"Ex: Cuisine",disabled:s}),t.type==="AUTRE"&&e.jsx(M,{id:"field-description",label:"Description",value:t.description,onChange:r=>o("description",r),error:y("description"),disabled:s}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(M,{id:"field-largeurMm",label:"Largeur (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.largeurMm,onChange:r=>o("largeurMm",parseInt(r)),error:y("largeurMm"),disabled:s}),e.jsx(M,{id:"field-hauteurMm",label:"Hauteur (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.hauteurMm,onChange:r=>o("hauteurMm",parseInt(r)),error:y("hauteurMm"),disabled:s})]}),(se.isMeasureSuspicious(t.largeurMm,t.monobloc)||se.isMeasureSuspicious(t.hauteurMm,t.monobloc))&&e.jsxs("div",{className:"text-orange-500 text-xs flex items-center mt-[-10px] mb-4",children:[e.jsx(G,{size:12,className:"mr-1"})," Attention: Cotes <300mm"]})]}),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE","PORTE_ENTREE","PORTE_SERVICE"].includes(t.type)&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${P}`,children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider",children:"Caractéristiques"}),e.jsx(O,{id:"field-matiere",label:"Matière",value:t.matiere,onChange:r=>o("matiere",r),error:y("matiere"),disabled:s,options:[{label:"PVC",value:"PVC"},{label:"Alu",value:"ALU"}]}),t.matiere&&e.jsx(O,{id:"field-profil",label:"Profil",value:t.profil,onChange:r=>o("profil",r),error:y("profil"),disabled:s,options:t.matiere==="PVC"?[{label:"Réno 40",value:"RENO_40"},{label:"Réno 60",value:"RENO_60"},{label:"Neuf",value:"NEUF"},{label:"ISO",value:"ISO"},{label:"Autre",value:"AUTRE"}]:[{label:"Réno",value:"RENO"},{label:"Neuf",value:"NEUF"},{label:"Autre",value:"AUTRE"}]}),t.profil==="ISO"&&e.jsx(M,{id:"field-isoMm",label:"Aile ISO (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.isoMm,onChange:r=>o("isoMm",parseInt(r)),error:y("isoMm"),disabled:s}),t.profil==="AUTRE"&&e.jsx(M,{id:"field-profilAutre",label:"Profil personnalisé",placeholder:"Préciser le profil...",value:t.profilAutre,onChange:r=>o("profilAutre",r),error:y("profilAutre"),disabled:s}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-100 dark:border-slate-800",children:[e.jsx(O,{id:"field-couleur",label:"Couleur",value:t.couleur,onChange:r=>o("couleur",r),error:y("couleur"),disabled:s,options:t.matiere==="PVC"?[{label:"Blanc",value:"BLANC"},{label:"Bicolor 7016",value:"BICOLOR_7016"},{label:"Autre",value:"AUTRE"}]:[{label:"Blanc",value:"BLANC"},{label:"Gris 7016",value:"GRIS_7016"},{label:"Autre",value:"AUTRE"}]}),t.couleur==="AUTRE"&&e.jsx(M,{id:"field-couleurAutre",placeholder:"Préciser...",value:t.couleurAutre,onChange:r=>o("couleurAutre",r),error:y("couleurAutre"),disabled:s})]})]}),(t.type==="FENETRE"||t.type==="PORTE_FENETRE"||t.type==="BAIE_COULISSANTE")&&e.jsxs("div",{id:"field-vitrageFlags",className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border ${y("vitrageFlags")?"border-red-500 ring-1 ring-red-500":"border-slate-200 dark:border-slate-800"} ${P}`,children:[e.jsxs("h3",{className:`text-xs font-bold uppercase mb-3 tracking-wider ${y("vitrageFlags")?"text-red-500":"text-slate-400"}`,children:["Vitrage ",y("vitrageFlags")&&"*"]}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:[["standard","4/20/4"],["g200","G200"],["feuillete1f","Feuilleté 1F"],["feuillete2f","Feuilleté 2F"]].map(([r,g])=>{var A,d;return e.jsxs("label",{className:`flex items-center p-3 rounded-lg border transition-all ${s?"cursor-not-allowed":"cursor-pointer"} ${(A=t.vitrageFlags)!=null&&A[r]?"bg-brand-50 border-brand-500 text-brand-700 dark:bg-brand-900/30":"border-slate-200 dark:border-slate-700 dark:text-white"}`,children:[e.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded text-brand-600 focus:ring-brand-500",checked:!!((d=t.vitrageFlags)!=null&&d[r]),onChange:I=>C("vitrageFlags",r,I.target.checked),disabled:s}),e.jsx("span",{className:"ml-2 text-sm font-medium",children:g})]},r)})})]}),t.type==="FENETRE"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 space-y-4 ${P}`,children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider",children:"Options"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Oscillo-Battant"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.oscilloBattant,onChange:r=>o("oscilloBattant",r.target.checked),disabled:s||t.hauteurMm>2200})]}),e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Grille Ventil."}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.grilleVentilation,onChange:r=>o("grilleVentilation",r.target.checked),disabled:s})]})]}),e.jsxs("div",{className:"pt-2",children:[e.jsx("label",{className:"text-sm dark:text-slate-300 font-medium mb-2 block",children:"Hauteur Poignée"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>o("poigneeHauteur","CENTREE"),disabled:s,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${s?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur!=="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Centrée"}),e.jsx("button",{onClick:()=>o("poigneeHauteur","AUTRE"),disabled:s,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${s?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur==="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Autre"})]}),t.poigneeHauteur==="AUTRE"&&e.jsx("input",{type:"number",inputMode:"numeric",pattern:"[0-9]*",className:`mt-2 w-full p-3 border rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-700 ${s?"opacity-50 cursor-not-allowed":""}`,placeholder:"mm",value:t.poigneeHauteurMm||"",onChange:r=>o("poigneeHauteurMm",parseInt(r.target.value)),disabled:s})]})]}),t.type==="PORTE_FENETRE"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 space-y-4 ${P}`,children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider",children:"Options Porte-fenêtre"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Grille Ventil."}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.grilleVentilation,onChange:r=>o("grilleVentilation",r.target.checked),disabled:s})]}),e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Serrure"}),t.matiere==="PVC"&&e.jsx("span",{className:"text-xs text-slate-400",children:"(gros profil)"})]}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.serrure,onChange:r=>o("serrure",r.target.checked),disabled:s})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Seuil PMR"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.seuilPMR,onChange:r=>o("seuilPMR",r.target.checked),disabled:s})]}),e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Soubassement"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.soubassement,onChange:r=>o("soubassement",r.target.checked),disabled:s})]})]}),t.soubassement&&e.jsx(M,{id:"field-soubassementHauteurMm",label:"Hauteur Soubassement (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.soubassementHauteurMm,onChange:r=>o("soubassementHauteurMm",parseInt(r)),placeholder:"Ex: 400",disabled:s}),e.jsxs("div",{className:"pt-2",children:[e.jsx("label",{className:"text-sm dark:text-slate-300 font-medium mb-2 block",children:"Hauteur Poignée"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>o("poigneeHauteur","CENTREE"),disabled:s,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${s?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur!=="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Centrée"}),e.jsx("button",{onClick:()=>o("poigneeHauteur","AUTRE"),disabled:s,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${s?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur==="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Autre"})]}),t.poigneeHauteur==="AUTRE"&&e.jsx("input",{type:"number",inputMode:"numeric",pattern:"[0-9]*",className:`mt-2 w-full p-3 border rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-700 ${s?"opacity-50 cursor-not-allowed":""}`,placeholder:"mm",value:t.poigneeHauteurMm||"",onChange:r=>o("poigneeHauteurMm",parseInt(r.target.value)),disabled:s})]})]}),t.type==="VOLET_ROULANT"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${P}`,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300",children:"Lier à "}),e.jsxs("select",{className:`w-full p-3 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 dark:text-white ${s?"opacity-50 cursor-not-allowed":""}`,value:t.lieAProduitId||"",onChange:r=>o("lieAProduitId",r.target.value),disabled:s,children:[e.jsx("option",{value:"",children:"-- Indépendant --"}),S.products.filter(r=>!r.deleted&&t.chantierId&&r.chantierId===t.chantierId&&["FENETRE","BAIE_COULISSANTE"].includes(r.type)).map(r=>e.jsxs("option",{value:r.id,children:["#",String(r.index).padStart(2,"0")," ",r.type," ",r.room?`(${r.room})`:""]},r.id))]})]}),e.jsx(O,{id:"field-manoeuvre",label:"Manoeuvre",value:t.manoeuvre,onChange:r=>o("manoeuvre",r),error:y("manoeuvre"),disabled:s,options:[{label:"Filaire",value:"FILAIRE"},{label:"Radio",value:"RADIO"},{label:"Solaire",value:"SOLAIRE"}]}),t.manoeuvre&&t.manoeuvre!=="SOLAIRE"&&e.jsx(O,{id:"field-sortieCable",label:"Sortie Câble",value:t.sortieCable,onChange:r=>o("sortieCable",r),error:y("sortieCable"),disabled:s,options:[{label:"Gauche",value:"GAUCHE"},{label:"Droite",value:"DROITE"}]}),t.manoeuvre!=="FILAIRE"&&e.jsxs("label",{className:`flex items-center p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 dark:border-slate-700 mt-4 mb-4 ${s?"cursor-not-allowed":""}`,children:[e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.boxDomotique,onChange:r=>o("boxDomotique",r.target.checked),disabled:s}),e.jsx("span",{className:"ml-3 font-medium dark:text-white",children:"Box Domotique"})]}),e.jsxs("div",{className:"my-4",id:"field-coffreADeduireMm",children:[e.jsxs("label",{className:`flex items-center justify-between p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 dark:border-slate-700 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"font-medium dark:text-white",children:"Monobloc ?"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.monobloc,onChange:r=>o("monobloc",r.target.checked),disabled:s})]}),t.monobloc&&e.jsxs("div",{className:"mt-3 bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg",children:[e.jsx(M,{label:"Hauteur Coffre",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.coffreADeduireMm,onChange:r=>o("coffreADeduireMm",parseInt(r)),error:y("coffreADeduireMm"),disabled:s}),e.jsxs("div",{className:"text-right text-sm font-bold text-brand-600",children:["Passage: ",t.hauteurMm&&t.coffreADeduireMm?t.hauteurMm-t.coffreADeduireMm:"-"," mm"]})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-100 dark:border-slate-800",children:[e.jsx(O,{id:"field-couleur",label:"Couleur",value:t.couleur,onChange:r=>o("couleur",r),error:y("couleur"),disabled:s,options:[{label:"Blanc",value:"BLANC"},{label:"Autre",value:"AUTRE"}]}),t.couleur==="AUTRE"&&e.jsx(M,{id:"field-couleurAutre",placeholder:"Préciser...",value:t.couleurAutre,onChange:r=>o("couleurAutre",r),error:y("couleurAutre"),disabled:s})]})]}),se.hasAdvancedOptions(t.type)&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden ${P}`,children:[e.jsxs("button",{onClick:()=>h(!E),className:"w-full flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-800/50 font-medium text-slate-700 dark:text-slate-300",children:[e.jsx("span",{children:"Options Avancées"}),E?e.jsx(Ge,{size:18}):e.jsx(He,{size:18})]}),E&&e.jsxs("div",{className:"p-4 border-t border-slate-200 dark:border-slate-800 space-y-4",children:[(t.type.includes("FENETRE")||t.type.includes("PORTE"))&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Ouverture Extérieure"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.ouvertureExterieure,onChange:r=>o("ouvertureExterieure",r.target.checked),disabled:s})]}),t.type==="FENETRE"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Poignée à  clé"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.poigneeCle,onChange:r=>o("poigneeCle",r.target.checked),disabled:s})]}),e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Pièce d'appui"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.pieceAppui,onChange:r=>o("pieceAppui",r.target.checked),disabled:s})]}),t.pieceAppui&&e.jsx(M,{id:"field-pieceAppuiDescription",label:"Description Pièce d'appui",value:t.pieceAppuiDescription,onChange:r=>o("pieceAppuiDescription",r),placeholder:"Préciser...",disabled:s})]}),t.type==="PORTE_FENETRE"&&e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Poignée à  clé"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.poigneeCle,onChange:r=>o("poigneeCle",r.target.checked),disabled:s})]}),t.type==="PORTE_ENTREE"&&e.jsxs("label",{className:`flex items-center justify-between ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-bold",children:"Tierce / Imposte ?"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.tierceImposte,onChange:r=>o("tierceImposte",r.target.checked),disabled:s})]})]}),t.type==="VOLET_ROULANT"&&e.jsxs("div",{children:[e.jsx(O,{label:"Couple",value:t.coupleMoteur||10,onChange:r=>o("coupleMoteur",r),disabled:s,options:[{label:"10 Nm",value:10},{label:"20 Nm",value:20}]}),e.jsx(O,{label:"Pose",value:t.pose||"RENO",onChange:r=>o("pose",r),disabled:s,options:[{label:"Rénov",value:"RENO"},{label:"Tradi",value:"TRADI"},{label:"Tunnel",value:"TUNNEL"}]})]})]})]}),t.type==="PORTE_ENTREE"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 p-5 rounded-xl border dark:border-slate-800 ${P}`,children:[e.jsx(O,{id:"field-remplissage",label:"Remplissage",value:t.remplissage,onChange:r=>o("remplissage",r),error:y("remplissage"),disabled:s,options:[{label:"Panneau Déco Alu",value:"PANNEAU_DECORATIF_ALU"},{label:"Sandwich",value:"PANNEAU_SANDWICH"},{label:"Vitrée",value:"VITREE"}]}),t.largeurMm>1e3&&e.jsxs("div",{className:"mt-3 pt-3 border-t dark:border-slate-700",children:[e.jsxs("label",{className:`flex items-center justify-between mb-3 ${s?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium",children:"Tierce ?"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.tierce,onChange:r=>o("tierce",r.target.checked),disabled:s})]}),t.tierce&&e.jsx(M,{id:"field-cotePassageMm",label:"Cote Passage (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.cotePassageMm,onChange:r=>o("cotePassageMm",r),error:y("cotePassageMm"),disabled:s})]})]}),e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${P}`,children:[e.jsx(ft,{data:t.dessin,onChange:r=>o("dessin",r),disabled:s}),e.jsxs("div",{className:"mt-6",children:[e.jsx("label",{className:"block text-sm font-medium mb-3 text-slate-700 dark:text-slate-300",children:"Photos"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[(t.photos||[]).map((r,g)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700 group",children:[e.jsx("img",{src:r,className:"w-full h-full object-cover"}),!s&&e.jsx("button",{onClick:()=>o("photos",t.photos.filter((A,d)=>d!==g)),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 shadow-md opacity-80 hover:opacity-100",children:e.jsx(xe,{size:12})})]},g)),!s&&e.jsxs("button",{onClick:()=>{var r;return(r=f.current)==null?void 0:r.click()},className:"aspect-square rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600 flex flex-col items-center justify-center text-slate-400 hover:text-brand-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors",children:[e.jsx(Qe,{size:24}),e.jsx("span",{className:"text-[10px] mt-1",children:"Ajouter"})]}),e.jsx("input",{type:"file",ref:f,accept:"image/*",className:"hidden",onChange:D,disabled:s})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"Notes techniques"}),e.jsx("textarea",{className:`w-full p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-950 dark:text-white h-24 text-sm focus:border-brand-500 outline-none ${s?"opacity-50 cursor-not-allowed":""}`,placeholder:"Contraintes...",value:t.notes||"",onChange:r=>o("notes",r.target.value),disabled:s})]})]})]})]}),c&&e.jsxs("div",{className:"fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-3 rounded-lg shadow-xl flex items-center animate-slide-up",children:[e.jsx(We,{size:20,className:"text-blue-400 mr-2"})," Vitrage G200 activé (Intimité)"]})]})},jt=({chantier:n,onClose:x,onUpdate:i})=>{const[s,t]=N.useState({...n}),[m,b]=N.useState(null),[j,E]=N.useState(!1),h=(a,f="adresse")=>{t(typeof a=="object"?{...s,[f]:a.address,gps:a.gps}:{...s,[f]:a})},c=async()=>{if(!s.client)return alert("Nom requis");if(s.typeContrat==="SOUS_TRAITANCE"&&(!s.clientFinal||!s.adresseFinale))return alert("Client final requis");let a={...s};if(j&&n.quoteFileId&&(await J.deleteFile(n.quoteFileId),a.quoteFileId=null,a.quoteFileName=null,a.quoteFile=null),m){n.quoteFileId&&!j&&await J.deleteFile(n.quoteFileId);const f=W();await J.storeFile(f,m),a.quoteFileId=f,a.quoteFileName=m.name,a.quoteFile=null}if(i(a),x(),s.dateIntervention)try{const f=await $e(s);f&&f!==s.googleEventId&&i({...a,googleEventId:f})}catch(f){console.error("Silent GCal Sync Fail",f)}else if(s.googleEventId)try{ze(s).catch(console.error),i({...a,googleEventId:null})}catch(f){console.error("GCal Delete Fail",f)}};return e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end md:items-center justify-center p-0 md:p-4 animate-fade-in",children:e.jsxs(ut,{className:"w-full max-w-md p-6 shadow-2xl rounded-t-2xl md:rounded-2xl max-h-[95vh] overflow-y-auto animate-slide-up md:animate-fade-in",children:[e.jsxs("div",{className:"flex justify-between items-start mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold dark:text-white",children:"Modifier le dossier"}),e.jsxs("p",{className:"text-xs text-slate-400 mt-1",children:["ID : ",s.id.slice(0,8)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pt,{chantier:s}),e.jsx("button",{onClick:x,className:"p-2 text-slate-400 hover:text-slate-600 bg-slate-50 dark:bg-slate-800 rounded-full transition-colors",children:"✕"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700",children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-500 mb-2 uppercase tracking-wider",children:"Planification"}),e.jsx(M,{label:"Date d'intervention",type:"datetime-local",value:s.dateIntervention||"",onChange:a=>t({...s,dateIntervention:a})}),e.jsx("p",{className:"text-[10px] font-medium text-slate-400 mt-2",children:s.dateIntervention?"✅ Ce dossier passera en PLANNING":"⚠️ Sans date, ce dossier reste en À PLANIFIER"})]}),e.jsx(M,{label:"Nom Client",value:s.client,onChange:a=>t({...s,client:a})}),e.jsx(we,{value:s.adresse,onChange:a=>t(typeof a=="object"?{...s,adresse:a.address,gps:a.gps}:{...s,adresse:a})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(M,{label:"Tél",value:s.telephone,onChange:a=>t({...s,telephone:a}),type:"tel",inputMode:"tel",pattern:"[0-9]*"}),e.jsx(M,{label:"Email",value:s.email,onChange:a=>t({...s,email:a}),type:"email",inputMode:"email"})]}),e.jsx(O,{label:"Contrat",value:s.typeContrat,onChange:a=>t({...s,typeContrat:a}),options:[{label:"Fourniture Seule",value:"FOURNITURE_SEULE"},{label:"Fourniture & Pose",value:"FOURNITURE_ET_POSE"},{label:"Sous-traitance",value:"SOUS_TRAITANCE"}]}),s.typeContrat==="SOUS_TRAITANCE"&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg border border-amber-200 dark:border-amber-800 animate-fade-in",children:[e.jsxs("h3",{className:"text-xs font-bold text-amber-600 dark:text-amber-400 mb-2 uppercase flex items-center",children:[e.jsx(Ae,{size:14,className:"mr-1"})," Client Final"]}),e.jsx(M,{label:"Nom Final",value:s.clientFinal,onChange:a=>t({...s,clientFinal:a})}),e.jsx(we,{value:s.adresseFinale,onChange:a=>h(a,"adresseFinale")})]}),e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700",children:[e.jsx("label",{className:"block text-[10px] font-bold text-slate-500 mb-2 uppercase tracking-wider",children:"Devis PDF"}),!j&&(s.quoteFileId||s.quoteFileName)?e.jsxs("div",{className:"flex items-center justify-between bg-white dark:bg-slate-700 p-2 rounded-lg border border-slate-200 dark:border-slate-600",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx("div",{className:"bg-brand-100 dark:bg-brand-900/30 p-1.5 rounded text-brand-600 dark:text-brand-400",children:e.jsx(X,{size:16})}),e.jsx("span",{className:"text-sm font-medium text-slate-700 dark:text-slate-200 truncate max-w-[150px]",title:s.quoteFileName,children:s.quoteFileName||"Devis.pdf"})]}),e.jsx("button",{onClick:()=>E(!0),className:"p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors",title:"Supprimer / Remplacer",children:e.jsx(K,{size:16})})]}):e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"file",accept:".pdf,application/pdf",className:"block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-brand-50 file:text-brand-700 hover:file:bg-brand-100",onChange:a=>b(a.target.files?a.target.files[0]:null)}),m&&e.jsxs("p",{className:"text-xs text-brand-600 mt-1 flex items-center gap-1",children:[e.jsx(Xe,{size:12})," Prêt à envoyer : ",m.name]}),j&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"Le fichier actuel sera supprimé à l'enregistrement."})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-xs font-bold text-slate-500 mb-1 ml-1",children:"Infos supplémentaires"}),e.jsx("textarea",{className:"w-full p-3 bg-slate-100 dark:bg-slate-800 border-0 rounded-xl outline-none focus:ring-2 focus:ring-brand-500 transition-all text-sm min-h-[80px]",placeholder:"Codes d'accès, instructions particulières...",value:s.notes||"",onChange:a=>t({...s,notes:a.target.value})})]})]}),e.jsxs("div",{className:"flex gap-3 mt-8 pb-4",children:[e.jsx($,{variant:"secondary",onClick:x,className:"flex-1",children:"Annuler"}),e.jsx($,{onClick:c,className:"flex-1",children:"Enregistrer"})]})]})})},Nt="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",vt="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";class kt{constructor(){this.pdfjsLib=null,this.isInitialized=!1}async init(){this.isInitialized||(typeof window.pdfjsLib>"u"&&await this._loadScript(Nt),this.pdfjsLib=window.pdfjsLib,this.pdfjsLib.GlobalWorkerOptions.workerSrc=vt,this.isInitialized=!0)}_loadScript(x){return new Promise((i,s)=>{const t=document.createElement("script");t.src=x,t.onload=i,t.onerror=s,document.head.appendChild(t)})}_generateId(){try{if(typeof crypto<"u"&&typeof crypto.randomUUID=="function")return crypto.randomUUID()}catch{}return`id_${Date.now()}_${Math.random().toString(16).slice(2)}`}async parseQuote(x){await this.init();const i=await x.arrayBuffer(),s=await this.pdfjsLib.getDocument({data:i}).promise;let t="";for(let c=1;c<=s.numPages;c++){const S=(await(await s.getPage(c)).getTextContent()).items.map(k=>({str:k.str,transform:k.transform,x:k.transform[4],y:k.transform[5]}));S.sort((k,L)=>{const D=L.y-k.y;return Math.abs(D)>5?D:k.x-L.x});let o="",C=S.length>0?S[0].y:0;for(const k of S)(Math.abs(k.y-C)>50||Math.abs(k.y-C)>5)&&(o+=`
`),o+=k.str+" ",C=k.y;t+=o+`
`}const m=/(?:Rep[eè]re)\s*(?:[:°\-]|\s|N°|No|N[°o])?\s*0*(\d+)/gi,b=t.split(m),j=b[0]||"",E=this.extractClientInfo(j),h=[];for(let c=1;c<b.length;c+=2){const a=(b[c]||"").trim(),f=b[c+1];if(!a||!f)continue;const S=this._analyzeBlock(a,f);S&&h.push(S)}return{items:h.map(c=>({...c,id:this._generateId()})),meta:{number:E.number||null,client:E.name||null}}}_cleanLabelFromTableLine(x){if(!x)return"";let i=String(x).trim();return i=i.replace(/^\s*\d+\s+/,"").trim(),i=i.replace(/\s+\d{1,6}(?:[\s\.]\d{3})*,\d{2}(?:\s+\d{1,6}(?:[\s\.]\d{3})*,\d{2})?\s*$/,"").trim(),i=i.replace(/\s+\d{3,4}\s*(?:[xX]|\s)\s*\d{3,4}\s*$/,"").trim(),i=i.replace(/\s+\d{3,4}\s*$/,"").trim(),i||String(x).trim()}_findBestLabel(x,i){if(!Array.isArray(x)||x.length===0)return`Repère ${i}`;const s=m=>/déchet|benne|recyclage|main\s*d['’]?oeuvre|mo\b|pose\s+seule|dépose/i.test(m),t=m=>/(porte|fenet|volet|baie|garage|portail|velux|pergola|v[ée]randa|veranda|chassis|châssis)/i.test(m);for(const m of x){const b=m.trim();if(!(b.length<8)&&!s(b)&&t(b))return b}return x[0].trim()||`Repère ${i}`}_analyzeBlock(x,i){const s=i.split(`
`).map(g=>g.trim()).filter(g=>g);let t=0,m=null,b=null,j=null;const E=/^\s*(\d+)\s+(?:.*?\s+)?(\d{3,4})\s+(?:x|X)?\s*(\d{3,4})\s+.*?(\d{1,3}(?:[\s\.]\d{3})*,\d{2})/;for(const g of s){const A=g.match(E);if(A){j=g,m={qty:parseInt(A[1],10),dim1:parseInt(A[2],10),dim2:parseInt(A[3],10),price:A[4]},t+=.35;break}}if(m){let g=m.dim1,A=m.dim2;g<300||g>4e3||A<300||A>4e3?t-=.1:t+=.15;const d=Math.max(g,A),I=Math.min(g,A);d>=2e3&&I<=1600?(g=I,A=d):(g=m.dim1,A=m.dim2),b={width:g,height:A}}else t-=.4;const h=s.join(" ");let c=null;/porte\s+de\s+garage/i.test(h)?c="PORTE_GARAGE":/portail/i.test(h)?c="PORTAIL":/velux/i.test(h)?c="VELUX":/pergola|v[ée]randa|veranda/i.test(h)&&(c="PERGOLA_VERANDA");let a="AUTRE",f=!1;/\bcompos[ée]e?|\bensemble\s+compos[ée]e?|\bch[âa]ssis\s+compos[ée]e?|\bchassis\s+compos[ée]e?|\bensemble\s+compos[ée]e?/i.test(h)?(a="FENETRE",f=!0):/volet|vr|tablier/i.test(h)?(a="VOLET_ROULANT",f=!0):/coulissant|baie/i.test(h)?(a="BAIE_COULISSANTE",f=!0):/porte\s+d['’ ]entr[ée]e|porte\s+entree/i.test(h)?(a="PORTE_ENTREE",f=!0):/porte[- ]?fen[êe]tre|porte\s+fenetre/i.test(h)?(a="PORTE_FENETRE",f=!0):/porte\s+de\s+service/i.test(h)?(a="PORTE_SERVICE",f=!0):/fen[êe]tre|fenetre|chassis|ch[âa]ssis|fixe|soufflet|imposte/i.test(h)?(a="FENETRE",f=!0):/porte/i.test(h)&&(a="AUTRE",f=!0,c||(c="PORTE")),f&&(t+=.2);let o="PVC",C="BLANC";const k=(s[0]||"").trim(),L=/porte/i.test(k)&&/\b(alu|aluminium)\b/i.test(k);a==="PORTE_ENTREE"?(o=L?"ALU":"PVC",L&&(t+=.05)):/\bALU\b|\bALUMINIUM\b/i.test(h)?(o="ALU",t+=.05):/\bPVC\b/i.test(h)?(o="PVC",t+=.05):(!c&&/\bBOIS\b/i.test(h)&&(c="BOIS"),!c&&/\bACIER\b/i.test(h)&&(c="ACIER"));const D=h.match(/Finition\s*:\s*([^:.,\n]+)/i)||h.match(/Coloris\s*:\s*([^:.,\n]+)/i);if(D){const g=D[1].trim();/bicolore/i.test(g)&&/7016/i.test(g)?C="BICOLOR_7016":/blanc/i.test(g)?C="BLANC":/7016/i.test(g)?C="GRIS_7016":C="AUTRE",t+=.1}let y=`Repère ${x}`;j?y=this._cleanLabelFromTableLine(j):y=this._findBestLabel(s,x);const P=/déchet|benne|recyclage|main\s*d['’]?oeuvre|pose\s+seule|dépose/i.test(h);if(!m&&P)return null;const r=t>=.6&&!!b;return{repere:x,type:a,kindHint:c,quantity:m?m.qty:1,width:b?b.width:0,height:b?b.height:0,material:o,color:C,label:y,originalLine:j||s.slice(0,3).join(" "),confidence:parseFloat(t.toFixed(2)),warning:t<.6||!b,isValid:r}}extractClientInfo(x){const i={name:"",address:"",number:""},s=x.match(/(?:Devis|Offre)\s*(?:N[°o.]?)?\s*[:#]?\s*0*(\d{4,6})/i);s&&(i.number=s[1]);const t=x.match(/[a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z]{2,6}/);t&&(i.email=t[0]);const m=x.match(/Client\s*:\s*([^\n]+)/i);return m&&(i.name=m[1].trim()),i}}const wt=new kt,Et=({onClose:n,onImport:x})=>{const[i,s]=N.useState(!1),[t,m]=N.useState([]),[b,j]=N.useState(null),[E,h]=N.useState(null),[c,a]=N.useState(()=>new Set),[f,S]=N.useState(null),[o,C]=N.useState("PARSE"),k=N.useRef(null),L=()=>{s(!1),m([]),j(null),h(null),a(new Set),S(null),k.current&&(k.current.value="")},D=l=>{if(!l)return!1;const p=l.type==="application/pdf",w=typeof l.name=="string"&&l.name.toLowerCase().endsWith(".pdf");return p||w},y=async l=>{const p=l.target.files&&l.target.files[0];if(!p)return;const w=25,F=w*1024*1024;if(!D(p)){S("Le fichier doit être un PDF."),k.current&&(k.current.value="");return}if(p.size>F){S(`PDF trop volumineux (max ${w} MB).`),k.current&&(k.current.value="");return}if(s(!0),S(null),m([]),a(new Set),h(p),o==="STORE"){s(!1);return}try{const v=await wt.parseQuote(p);m(v.items),j(v.meta),a(new Set(v.items.map(R=>R.id)))}catch(v){console.error(v),S("Erreur lors de l'analyse du PDF. Vérifiez qu'il n'est pas protégé.")}finally{s(!1)}},P=l=>{a(p=>{const w=new Set(p);return w.has(l)?w.delete(l):w.add(l),w})},r=()=>{a(l=>{if(t.length===0)return new Set;const p=t.map(F=>F.id);return l.size===p.length?new Set:new Set(p)})},g=(l,p,w)=>{m(F=>F.map(v=>v.id===l?{...v,[p]:w}:v))},A=()=>{if(o==="STORE")x([],E,null);else{const l=t.filter(p=>c.has(p.id));x(l,E,b)}},d=N.useMemo(()=>t.length>0&&c.size===t.length,[t.length,c.size]),I=N.useMemo(()=>E?o==="STORE"?!0:t.length>0&&c.size>0:!1,[E,o,t.length,c.size]);return e.jsx(le,{isOpen:!0,onClose:n,title:"Importer / Stocker un devis",size:"lg",children:e.jsxs("div",{className:"flex flex-col h-[600px]",children:[!E&&e.jsxs("div",{className:"px-6 pt-4 pb-2",children:[e.jsxs("div",{className:"flex gap-4 p-1 bg-slate-100 dark:bg-slate-800 rounded-lg",children:[e.jsx("button",{onClick:()=>C("PARSE"),className:`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all ${o==="PARSE"?"bg-white dark:bg-slate-700 shadow-sm text-brand-600 dark:text-brand-400":"text-slate-500 hover:text-slate-700 dark:hover:text-slate-300"}`,children:"Analyser & Importer"}),e.jsx("button",{onClick:()=>C("STORE"),className:`flex-1 py-2 px-4 rounded-md text-sm font-medium transition-all ${o==="STORE"?"bg-white dark:bg-slate-700 shadow-sm text-brand-600 dark:text-brand-400":"text-slate-500 hover:text-slate-700 dark:hover:text-slate-300"}`,children:"Stocker uniquement"})]}),e.jsx("p",{className:"text-xs text-slate-500 mt-2 px-1",children:o==="PARSE"?"Extrait les menuiseries du PDF pour créer les produits automatiquement.":"Stocke simplement le fichier PDF dans le dossier (Consultable hors-ligne, pas de création de produits)."})]}),!E&&!i&&e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl bg-slate-50 dark:bg-slate-900 m-4",children:[e.jsx("input",{ref:k,type:"file",accept:".pdf,application/pdf",onChange:y,className:"hidden",id:"pdf-upload"}),e.jsxs("label",{htmlFor:"pdf-upload",className:"flex flex-col items-center cursor-pointer p-10",children:[e.jsx("div",{className:"bg-brand-100 dark:bg-brand-900/30 p-4 rounded-full text-brand-600 dark:text-brand-400 mb-4",children:e.jsx(Je,{size:48})}),e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-2",children:"Cliquez pour sélectionner un devis"}),e.jsxs("p",{className:"text-slate-500 text-sm text-center max-w-xs",children:["Formats supportés : PDF uniquement.",e.jsx("br",{}),o==="PARSE"?"Analyse automatique des menuiseries.":"Stockage sécurisé locale."]})]}),f&&e.jsxs("div",{className:"mt-4 flex items-center gap-2 text-red-600 bg-red-50 dark:bg-red-900/20 px-4 py-2 rounded-lg",children:[e.jsx(re,{size:20}),e.jsx("span",{children:f})]})]}),i&&e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center","aria-live":"polite",children:[e.jsx(pe,{size:48}),e.jsx("p",{className:"mt-4 text-slate-600 dark:text-slate-300 font-medium",children:"Analyse du document en cours..."}),e.jsx("p",{className:"text-xs text-slate-400 mt-2",children:"Cela peut prendre quelques secondes."})]}),E&&o==="STORE"&&e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center m-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-sm text-center",children:[e.jsx(X,{size:64,className:"text-brand-500 mx-auto mb-4"}),e.jsx("h3",{className:"text-xl font-bold text-slate-800 dark:text-white mb-1",children:E.name}),e.jsxs("p",{className:"text-slate-500 mb-6",children:[(E.size/1024/1024).toFixed(2)," MB"]}),e.jsx($,{variant:"ghost",size:"sm",onClick:L,children:"Changer de fichier"})]}),e.jsxs("div",{className:"mt-8 text-center max-w-md text-slate-500 text-sm",children:[e.jsx(me,{className:"inline-block text-green-500 mr-2",size:16}),"Le fichier sera stocké localement et lié à ce chantier."]})]}),E&&o==="PARSE"&&t.length>0&&e.jsxs("div",{className:"flex-1 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"flex justify-between items-center px-4 py-3 bg-slate-100 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"text-slate-500",size:20}),e.jsxs("span",{className:"font-bold text-slate-700 dark:text-slate-200",children:[t.length," élément(s) détecté(s)"]})]}),e.jsx($,{variant:"ghost",size:"sm",onClick:L,children:"Changer de fichier"})]}),e.jsx("div",{className:"overflow-y-auto flex-1 p-4",children:e.jsxs("table",{className:"w-full text-sm text-left",children:[e.jsx("thead",{className:"text-xs text-slate-500 uppercase bg-slate-50 dark:bg-slate-900 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 rounded-tl-lg",children:e.jsx(ae,{checked:d,onChange:r})}),e.jsx("th",{className:"px-4 py-3",children:"Qté"}),e.jsx("th",{className:"px-4 py-3",children:"Type"}),e.jsx("th",{className:"px-4 py-3",children:"Dimensions"}),e.jsx("th",{className:"px-4 py-3",children:"Détails"}),e.jsx("th",{className:"px-4 py-3 rounded-tr-lg",children:"Source"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-100 dark:divide-slate-800",children:t.map(l=>{const p=c.has(l.id);return e.jsxs("tr",{className:`hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors ${p?"":"opacity-50"}`,children:[e.jsx("td",{className:"px-4 py-3",children:e.jsx(ae,{checked:p,onChange:()=>P(l.id)})}),e.jsxs("td",{className:"px-4 py-3 font-bold text-brand-600 dark:text-brand-400",children:["x",l.quantity||1]}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("select",{value:l.type,onChange:w=>g(l.id,"type",w.target.value),className:"w-full p-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-sm focus:ring-2 focus:ring-brand-500 outline-none",children:[e.jsx("option",{value:"FENETRE",children:"FENETRE"}),e.jsx("option",{value:"PORTE_FENETRE",children:"PORTE_FENETRE"}),e.jsx("option",{value:"BAIE_COULISSANTE",children:"BAIE_COULISSANTE"}),e.jsx("option",{value:"PORTE_ENTREE",children:"PORTE_ENTREE"}),e.jsx("option",{value:"PORTE_SERVICE",children:"PORTE_SERVICE"}),e.jsx("option",{value:"VOLET_ROULANT",children:"VOLET_ROULANT"}),e.jsx("option",{value:"AUTRE",children:"AUTRE"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("input",{type:"number",value:l.width,onChange:w=>g(l.id,"width",parseInt(w.target.value)||0),className:"w-16 p-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-sm text-center focus:ring-2 focus:ring-brand-500 outline-none"}),e.jsx("span",{className:"text-slate-400",children:"x"}),e.jsx("input",{type:"number",value:l.height,onChange:w=>g(l.id,"height",parseInt(w.target.value)||0),className:"w-16 p-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-sm text-center focus:ring-2 focus:ring-brand-500 outline-none"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("input",{type:"text",value:l.label||"",onChange:w=>g(l.id,"label",w.target.value),placeholder:"Désignation...",className:"w-full p-1 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded text-sm focus:ring-2 focus:ring-brand-500 outline-none"}),e.jsxs("div",{className:"text-xs text-slate-500 flex gap-2",children:[e.jsx("span",{children:l.material}),e.jsx("span",{children:l.color})]})]})}),e.jsxs("td",{className:"px-4 py-3 text-xs text-slate-400 italic max-w-[150px] truncate",title:l.originalLine,children:['"',l.originalLine,'"']})]},l.id||`${l.repere}-${l.originalLine}`)})})]})})]}),e.jsxs("div",{className:"p-4 border-t border-slate-200 dark:border-slate-800 flex justify-end gap-3 bg-white dark:bg-slate-950",children:[e.jsx($,{variant:"ghost",onClick:n,children:"Annuler"}),e.jsx($,{variant:"primary",disabled:!I,onClick:A,icon:me,children:o==="STORE"?"Stocker le fichier":`Importer ${c.size} produit(s)`})]})]})})},Ct=(n,x)=>{switch(n){case"VOLET_ROULANT":return{type:"VOLET_ROULANT",profil:"ALU"};case"BAIE_COULISSANTE":return{type:"BAIE_COULISSANTE",profil:"ALU"};case"PORTE_ENTREE":return{type:"PORTE_ENTREE",profil:"ALU_80"};case"PORTE_FENETRE":return{type:"PORTE_FENETRE",profil:"RENO_40"};case"FENETRE":return{type:"FENETRE",profil:"RENO_40"};case"PORTE_SERVICE":return{type:"PORTE_SERVICE",profil:"RENO_40"};case"AUTRE":return{type:"AUTRE",profil:"AUTRE"};case"PORTE_INTERIEURE":return{type:"PORTE_ENTREE",notes:"Type : Porte Intérieure détectée"};default:return{type:"FENETRE",notes:"Type inconnu, importé comme fenêtre par défaut"}}},yt=({history:n})=>{if(!(n!=null&&n.length))return null;const x=[...n].sort((i,s)=>new Date(s.date)-new Date(i.date));return e.jsxs("div",{className:"mt-8 border-t border-slate-200 dark:border-slate-800 pt-6 animate-fade-in",children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2",children:[e.jsx(at,{size:20,className:"text-slate-400"}),"Historique du dossier"]}),e.jsx("div",{className:"space-y-3",children:x.map((i,s)=>e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border border-slate-100 dark:border-slate-700 text-sm",children:[e.jsxs("div",{className:"flex justify-between text-slate-500 dark:text-slate-400 text-xs mb-1",children:[e.jsx("span",{children:new Date(i.date).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})}),e.jsx("span",{className:"font-medium bg-slate-200 dark:bg-slate-700 px-1.5 rounded",children:i.user||"Système"})]}),e.jsxs("div",{className:"text-slate-800 dark:text-slate-200",children:[e.jsx("span",{className:"font-bold uppercase text-xs mr-2 text-brand-600 dark:text-brand-400",children:i.action==="UNLOCK"?"DÉVERROUILLAGE":i.action}),e.jsx("span",{children:i.reason})]}),i.details&&e.jsxs("div",{className:"mt-1 pl-3 border-l-2 border-slate-300 dark:border-slate-600 italic text-slate-600 dark:text-slate-400 text-xs",children:['"',i.details,'"']})]},s))})]})};async function At(n,x,i,s){var h;const t=(h=window.SARANGE_CONFIG)==null?void 0:h.APPS_SCRIPT_URL,m=15e3;if(!t||t.includes("your-script-id"))return ce.warn("URL Google Apps Script non configurée ou invalide"),{success:!1,error:"Configuration email manquante"};const b={timestamp:new Date().toISOString(),metrage_id:W(),htmlReport:i,chantier:{client:n.client,adresse:n.adresse,telephone:n.telephone||"",email:n.email||"",typeContrat:n.typeContrat},clientFinal:n.typeContrat==="SOUS_TRAITANCE"?{nom:n.clientFinal,adresse:n.adresseFinale}:null,produits:x.map(c=>({numero:c.index,type:c.type,quantite:c.quantity||1,localisation:c.room||"",dimensions:`${c.largeurMm} x ${c.hauteurMm} mm`,matiere:c.matiere||"",profil:c.profil||"",couleur:c.couleur==="AUTRE"?c.couleurAutre:c.couleur||"",vitrage:c.vitrageFlags?Object.entries(c.vitrageFlags).filter(([a,f])=>f).map(([a])=>a==="standard"?"4/20/4":a==="g200"?"G200":a==="feuillete1f"?"Feuilleté 1F":a==="feuillete2f"?"Feuilleté 2F":"").filter(Boolean).join(", "):"",options:ct(c),notes:c.notes||"",isValid:c.isValid})),total_produits:x.reduce((c,a)=>c+(a.quantity||1),0),produits_incomplets:x.filter(c=>!c.isValid).length},j=new AbortController,E=setTimeout(()=>j.abort(),m);try{s==null||s({sendStatus:"SENDING",lastError:null});const c=await fetch(t,{method:"POST",mode:"cors",headers:{"Content-Type":"text/plain"},body:JSON.stringify(b),signal:j.signal});if(clearTimeout(E),!c.ok)throw new Error(`Erreur HTTP: ${c.status}`);const a=await c.json();if(a.success===!0){const f=new Date().toISOString();return s==null||s({sendStatus:"SENT",sentAt:f,lastError:null,dateFinalisation:f}),ce.info("✅ Métrage envoyé avec succès",{metrage_id:b.metrage_id,client:n.client}),{success:!0}}else throw new Error(a.error||"Réponse serveur invalide")}catch(c){clearTimeout(E);let a;return c.name==="AbortError"?a="Connexion trop lente (délai 15s dépassé)":c.message.includes("Failed to fetch")||c.message.includes("NetworkError")?a="Pas de connexion réseau":a=c.message,s==null||s({sendStatus:"ERROR",lastError:a}),ce.error("â Œ Échec envoi métrage",{error:a,client:n.client}),{success:!1,error:a}}}const St=({chantier:n,products:x,incompleteCount:i,onClose:s,onStatusChange:t,onSuccess:m,onError:b})=>{const[j,E]=N.useState({cotes:!1,options:!1}),[h,c]=N.useState(!1),[a,f]=N.useState(!1),S=j.cotes&&j.options,o=async()=>{c(!0);const C=dt(n,x,new Date().toISOString()),k=await At(n,x,C,t);k.success?(c(!1),f(!0),setTimeout(()=>{m==null||m()},1500)):(c(!1),b==null||b(k.error))};return e.jsx(le,{isOpen:!0,onClose:h||a?void 0:s,title:a?"✓ Envoyé !":"Êtes-vous sûr ?",size:"md",children:e.jsxs("div",{className:"relative min-h-[360px] flex flex-col",children:[a&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center animate-fade-in z-10",children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-green-100 dark:bg-green-900/30 rounded-full scale-150 animate-pulse"}),e.jsx("div",{className:"bg-green-500 text-white rounded-full p-6 shadow-xl shadow-green-500/40 relative z-10 animate-bounce",children:e.jsx(me,{size:48,strokeWidth:3})})]}),e.jsx("h3",{className:"text-2xl font-bold text-slate-800 dark:text-white mb-2",children:"Dossier Envoyé !"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-center text-sm",children:"Le métrage a été transmis au bureau"})]}),!a&&e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsx(ae,{checked:j.cotes,onChange:C=>E(k=>({...k,cotes:C})),label:"J'ai vérifié toutes les cotes"}),e.jsx(ae,{checked:j.options,onChange:C=>E(k=>({...k,options:C})),label:"J'ai vérifié les options"})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 mb-4 flex items-start gap-3",children:[e.jsx("div",{className:"bg-red-100 dark:bg-red-900/50 p-2 rounded-lg shrink-0",children:e.jsx(G,{className:"text-red-600 dark:text-red-400",size:20})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-red-700 dark:text-red-300 text-sm",children:"Action irréversible"}),e.jsx("p",{className:"text-red-600 dark:text-red-400 text-xs mt-1 leading-relaxed",children:"Le dossier sera verrouillé après envoi."})]})]}),e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800 rounded-xl p-4 mb-6 border border-slate-100 dark:border-slate-700",children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"Total Produits"}),e.jsx("span",{className:"font-bold text-slate-800 dark:text-white bg-white dark:bg-slate-700 px-2 py-0.5 rounded border border-slate-200 dark:border-slate-600",children:x.reduce((C,k)=>C+(k.quantity||1),0)})]}),i>0&&e.jsxs("div",{className:"flex justify-between text-sm mt-2 pt-2 border-t border-slate-200 dark:border-slate-700",children:[e.jsxs("span",{className:"text-amber-600 dark:text-amber-400 flex items-center gap-2",children:[e.jsx(G,{size:16})," Incomplets"]}),e.jsx("span",{className:"font-bold text-white bg-amber-500 px-2 py-0.5 rounded text-xs",children:i})]})]}),e.jsxs("div",{className:"mt-auto space-y-3",children:[e.jsx($,{onClick:o,disabled:!S||h,className:`w-full py-4 text-base transition-all duration-300 ${S?"translate-y-0 opacity-100":"opacity-80"}`,icon:h?null:Se,children:h?e.jsxs("span",{className:"flex items-center justify-center gap-3",children:[e.jsx(pe,{size:20}),e.jsx("span",{children:"Transmission en cours..."})]}):"Confirmer l'envoi"}),e.jsx($,{onClick:s,variant:"ghost",className:"w-full py-3",disabled:h,children:"Annuler"})]})]})]})})},Tt=({onClose:n,onUnlock:x})=>{const[i,s]=N.useState(""),[t,m]=N.useState(""),{user:b}=be(),j=i&&(i!=="Autre"||t.trim().length>0),E=()=>{j&&x({reason:i,details:i==="Autre"?t:null,user:(b==null?void 0:b.email)||"Inconnu"})};return e.jsx(le,{isOpen:!0,onClose:n,title:"Déverrouiller le dossier",size:"sm",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 p-3 rounded-lg border border-amber-200 dark:border-amber-800 flex gap-3",children:[e.jsx(G,{className:"text-amber-600 shrink-0",size:20}),e.jsx("p",{className:"text-sm text-amber-800 dark:text-amber-200",children:"Cette action sera enregistrée dans l'historique du dossier."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:"Motif du déverrouillage"}),e.jsxs("select",{value:i,onChange:h=>s(h.target.value),className:"w-full p-2.5 bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-brand-500 outline-none transition-all",children:[e.jsx("option",{value:"",disabled:!0,children:"Sélectionnez un motif..."}),e.jsx("option",{value:"Erreur de métrage",children:"Erreur de métrage"}),e.jsx("option",{value:"Changement client",children:"Changement client"}),e.jsx("option",{value:"Ajout oublié",children:"Ajout oublié"}),e.jsx("option",{value:"Autre",children:"Autre"})]})]}),i==="Autre"&&e.jsxs("div",{className:"animate-fade-in",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:"Précisez la raison"}),e.jsx(M,{value:t,onChange:m,placeholder:"Ex: Demande architecte...",autoFocus:!0})]}),e.jsxs("div",{className:"pt-2 flex flex-col gap-2",children:[e.jsx($,{onClick:E,disabled:!j,variant:j?"danger":"secondary",className:"w-full py-3",icon:lt,children:"Déverrouiller"}),e.jsx($,{onClick:n,variant:"ghost",className:"w-full",children:"Annuler"})]})]})})},Ut=()=>{const{state:n,selectChantier:x,deleteProduct:i,saveProduct:s,updateChantier:t,updateChantierDate:m}=be(),[b,j]=N.useState(null),[E,h]=N.useState(!1),[c,a]=N.useState(!1),[f,S]=N.useState(!1),[o,C]=N.useState(null),[k,L]=N.useState(!1),[D,y]=N.useState(null),[P,r]=N.useState(!1),[g,A]=N.useState(null),d=n.chantiers.find(u=>u.id===n.currentChantierId);if(d&&d.deleted)return null;const I=(n.products||[]).filter(u=>u.chantierId===(d==null?void 0:d.id)&&!u.deleted).sort((u,T)=>u.index-T.index),l=(d==null?void 0:d.sendStatus)||"DRAFT",p=l==="SENT",w=l==="SENDING",F=l==="ERROR",v=!d.dateIntervention&&!p,R=ot(d,I),_=()=>{if(p)return;const u=I[I.length-1],T=u?{matiere:u.matiere,profil:u.profil,couleur:u.couleur,couleurAutre:u.couleurAutre,isoMm:u.isoMm}:{};j({id:W(),chantierId:d.id,index:I.length+1,type:"FENETRE",quantity:1,dateCreation:new Date().toISOString(),photos:[],isValid:!1,validationErrors:[],...T})},q=(u,T)=>{u.stopPropagation(),!p&&s({...T,id:W(),index:I.length+1,dateCreation:new Date().toISOString()})},Z=u=>t(d.id,u),Te=()=>{h(!1)},Ie=u=>{h(!1),y({message:`Échec : ${u}`,type:"error"})};V.useEffect(()=>{if(P){const u=setTimeout(()=>r(!1),4e3);return()=>clearTimeout(u)}},[P]),V.useEffect(()=>{d!=null&&d.quoteFileId?J.getFile(d.quoteFileId).then(u=>{u&&A(u)}).catch(console.error):A(null)},[d==null?void 0:d.quoteFileId]);const Re=({reason:u,details:T,user:z})=>{const B={date:new Date().toISOString(),action:"UNLOCK",reason:u,details:T,user:z};t(d.id,{sendStatus:"DRAFT",sentAt:null,lastError:null,history:[...d.history||[],B],updatedAt:new Date().toISOString()}),a(!1),y({message:"Dossier déverrouillé (Action enregistrée)",type:"info"})},Pe=async()=>{confirm("Voulez-vous supprimer le devis lié à ce chantier ? Les produits importés seront conservés mais ne seront plus liés au fichier source.")&&(d.quoteFileId&&await J.deleteFile(d.quoteFileId),t(d.id,{quoteFileId:null,quoteFile:null,quoteFileName:null,referenceDevis:null,updatedAt:new Date().toISOString()}),A(null),y({message:"Lien avec le devis supprimé",type:"info"}))},Fe=async(u,T,z)=>{if((!u||u.length===0)&&!T)return;const B=new Date().toISOString(),ie=I.length+1;let H=null;T&&(H=W(),await J.storeFile(H,T));const Q=(u||[]).map((U,Me)=>{const fe=Ct(U.type,U.subtype);let te="PVC";U.material==="ALU"?te="ALU":U.material==="BOIS"?te="BOIS":U.material==="ACIER"&&(te="ACIER");let oe="BLANC",ge="";return U.color==="GRIS_7016"?oe="GRIS_7016":U.color!=="BLANC"&&U.color!=="Standard"&&(oe="AUTRE",ge=U.color),{id:W(),chantierId:d.id,index:ie+Me,type:fe.type,subtype:U.subtype||"",largeurMm:U.width||0,hauteurMm:U.height||0,quantity:U.quantity||1,matiere:te,profil:fe.profil||"RENO_40",couleur:oe,couleurAutre:ge,description:U.label||"",notes:U.label||"",dateCreation:B,updatedAt:B,isValid:U.isValid,source:"QUOTE",isVerified:!1}}),he={...d,quoteFileId:H||d.quoteFileId,quoteFileName:(T==null?void 0:T.name)||d.quoteFileName,referenceDevis:(z==null?void 0:z.number)||d.referenceDevis,updatedAt:B};delete he.quoteFile,t(d.id,he),Q.forEach(U=>s(U)),H&&A(T),S(!1),y({message:`${Q.length} menuiseries importées avec succès !`,type:"success"})},Le=u=>{let T="";if(u===1?T="step-top":u===2?T=v?"step-planning":"step-top":u===3?T="step-metrage":u===4&&(T="step-envoi"),T){const z=document.getElementById(T);z&&z.scrollIntoView({behavior:"smooth",block:"start"})}};if(!d)return null;if(b)return e.jsx(gt,{product:b,onSave:u=>{const z=u.source==="QUOTE"||b.source==="QUOTE"?{...u,source:"QUOTE",isVerified:!0}:u;s(z),j(null)},onCancel:()=>j(null),isReadOnly:p});const De=I.reduce((u,T)=>u+(T.quantity||1),0),Ue=I.filter(u=>!u.isValid).length,ne=I.filter(u=>u.source==="QUOTE"&&!u.isVerified).length,ee=ne>0;return e.jsxs("div",{className:"flex flex-col h-screen bg-slate-50 dark:bg-slate-950",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-10 shadow-sm safe-top-padding",children:[e.jsxs("div",{className:"px-4 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center flex-1 min-w-0",children:[e.jsx("button",{onClick:()=>x(null),className:"mr-3 p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-200",children:e.jsx(Ye,{size:24})}),e.jsxs("div",{className:"truncate flex-1 cursor-pointer",onClick:()=>!p&&L(!0),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"font-bold text-lg dark:text-white truncate",children:d.client}),p?e.jsx(Y,{size:16,className:"text-green-600"}):e.jsx(Ke,{size:16,className:"text-slate-400"})]}),e.jsxs("div",{className:"text-xs text-slate-500 flex flex-col gap-1 mt-1",children:[e.jsx(nt,{address:d.adresse,gps:d.gps,className:"text-slate-500 hover:text-brand-600"}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsxs("span",{className:"bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded",children:[De," Produit(s)"]}),e.jsxs("span",{children:["• ",d.typeContrat==="FOURNITURE_ET_POSE"?"Pose":d.typeContrat==="SOUS_TRAITANCE"?"Sous-traitance":"Fourn. Seule"]}),d.referenceDevis&&e.jsxs("span",{className:"flex items-center gap-1 bg-brand-50 dark:bg-brand-900/30 text-brand-700 dark:text-brand-300 px-1.5 py-0.5 rounded font-bold border border-brand-100 dark:border-brand-800",children:[e.jsx(X,{size:12})," ",d.referenceDevis]})]})]})]})]}),(d.quoteFileId||g||d.quoteFile)&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx($,{variant:"ghost",size:"sm",className:"bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-bold border border-slate-200 dark:border-slate-700 hover:bg-slate-200",icon:X,onClick:()=>{const u=g||d.quoteFile;if(u){const T=URL.createObjectURL(u);C(T)}else y({message:"Fichier non disponible localement",type:"warning"})},children:e.jsx("span",{className:"hidden sm:inline",children:"Voir le Devis"})}),!p&&e.jsx($,{variant:"ghost",size:"sm",className:"text-red-500 hover:text-red-700 hover:bg-red-50 dark:hover:bg-red-900/20",icon:K,onClick:Pe})]})]}),e.jsx(ht,{currentStep:R,onStepClick:Le})]}),p&&e.jsxs(Ee,{variant:"success",icon:Y,action:"Modifier",onAction:()=>a(!0),children:["Dossier verrouillé le ",new Date(d.sentAt).toLocaleDateString("fr-FR")," à  ",new Date(d.sentAt).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})]}),F&&e.jsxs(Ee,{variant:"error",icon:re,children:["Échec de l'envoi : ",d.lastError]}),e.jsxs("div",{className:`flex-1 overflow-y-auto p-4 max-w-5xl mx-auto w-full scroll-smooth ${p?"pb-24":ee?"pb-48":"pb-32"}`,children:[e.jsx("div",{id:"step-top"}),v&&e.jsx("div",{id:"step-planning",className:"mb-6 bg-white dark:bg-slate-900 rounded-xl p-6 shadow-lg border-2 border-brand-500 animate-fade-in",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:items-start gap-4 text-center sm:text-left",children:[e.jsx("div",{className:"bg-brand-100 dark:bg-brand-900/30 p-3 rounded-full text-brand-600 dark:text-brand-400 shrink-0",children:e.jsx(ue,{size:32})}),e.jsxs("div",{className:"flex-1 w-full",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-1",children:"Ce dossier n'est pas planifié !"}),e.jsx("p",{className:"text-slate-500 text-sm mb-4",children:"Sélectionnez la date d'intervention pour passer à l'étape suivante."}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("input",{type:"datetime-local",className:"flex-1 p-3 rounded-lg border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 dark:text-white focus:border-brand-500 outline-none font-bold text-slate-700 transition-colors",id:`date-picker-${d.id}`}),e.jsx($,{variant:"primary",className:"font-bold uppercase w-full sm:w-auto",onClick:()=>{const u=document.getElementById(`date-picker-${d.id}`),T=u==null?void 0:u.value;if(!T)return alert("Veuillez sélectionner une date !");m(d.id,T)},children:"Valider"})]})]})]})}),d.dateIntervention&&!p&&e.jsxs("div",{id:"step-planning",className:"mb-6 bg-green-50 dark:bg-green-900/20 rounded-xl p-4 border border-green-200 dark:border-green-800 flex flex-col sm:flex-row items-center justify-between gap-4 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"bg-green-100 dark:bg-green-800 p-2 rounded-full text-green-700 dark:text-green-300",children:e.jsx(ue,{size:24})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-bold text-green-800 dark:text-green-200 uppercase tracking-wide",children:"Intervention planifiée"}),e.jsxs("p",{className:"text-lg font-bold text-slate-800 dark:text-white flex flex-col sm:flex-row sm:items-center gap-2",children:[new Date(d.dateIntervention).toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",hour:"2-digit",minute:"2-digit"}),d.googleEventId?e.jsxs("span",{className:"bg-white/80 dark:bg-green-800/50 px-2 py-0.5 rounded-full text-xs flex items-center gap-1 border border-green-200 dark:border-green-700 w-fit",children:[e.jsx("img",{src:"https://www.gstatic.com/images/branding/product/1x/calendar_2020q4_48dp.png",alt:"GCal",className:"w-3 h-3"}),"Synchronisé"]}):e.jsxs("button",{onClick:u=>{u.stopPropagation(),m(d.id,d.dateIntervention)},className:"bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 px-2 py-0.5 rounded-full text-xs flex items-center gap-1 animate-pulse border border-orange-200 dark:border-orange-800 hover:bg-orange-200 transition-colors w-fit",children:[e.jsx(G,{size:12}),"Non Synchronisé (Forcer)"]})]})]})]}),e.jsx($,{variant:"danger",icon:Ze,onClick:()=>{confirm("Confirmer l'annulation du rendez-vous ? Le dossier repassera en 'À Planifier'.")&&(m(d.id,null),y({message:"Rendez-vous annulé",type:"info"}))},children:"Annuler le RDV"})]}),d.typeContrat==="SOUS_TRAITANCE"&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 mb-4 flex items-start",children:[e.jsx(Ae,{className:"text-amber-600 mt-1 mr-3 shrink-0",size:20}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-bold text-amber-800 dark:text-amber-200 uppercase",children:"Client Final"}),e.jsx("div",{className:"font-medium text-amber-900 dark:text-amber-100",children:e.jsxs("div",{className:"text-sm text-amber-800 dark:text-amber-300 flex items-center",children:[e.jsx("a",{href:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(d.adresseFinale)}`,target:"_blank",rel:"noopener noreferrer",className:"p-1 -ml-1 mr-1 rounded-full hover:bg-amber-100 dark:hover:bg-amber-800 text-amber-600 dark:text-amber-400 transition-colors",title:"Ouvrir dans Maps",children:e.jsx(et,{size:12})}),d.adresseFinale]})})]})]}),e.jsxs("div",{id:"step-metrage",className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[I.map(u=>{const T=u.source==="QUOTE",z=T&&!u.isVerified,B=T&&u.isVerified,ie=z?"bg-amber-50 dark:bg-amber-900/20":"bg-white dark:bg-slate-900",H=z?"border-l-amber-500":u.type.includes("FENETRE")?"border-l-orange-500":u.type.includes("PORTE")?"border-l-green-500":"border-l-brand-500";return e.jsxs("div",{onClick:()=>j(u),className:`${ie} ${H} rounded-xl p-4 shadow-sm border-l-4 cursor-pointer hover:shadow-md transition-all relative group border-t border-r border-b border-slate-200 dark:border-slate-800 ${p?"opacity-75":""}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("span",{className:"font-bold text-lg dark:text-white",children:["#",String(u.index).padStart(2,"0")]}),e.jsxs("div",{className:"flex items-center gap-2",children:[z&&e.jsxs("span",{className:"bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300 text-[10px] font-bold px-1.5 py-0.5 rounded uppercase animate-pulse flex items-center gap-1 border border-amber-200 dark:border-amber-800",children:[e.jsx(G,{size:10})," Cotes Devis"]}),B&&e.jsxs("span",{className:"bg-green-100 text-green-700 dark:bg-green-900/40 dark:text-green-300 text-[10px] font-bold px-1.5 py-0.5 rounded uppercase flex items-center gap-1 border border-green-200 dark:border-green-800",children:[e.jsx(tt,{size:10})," Cotes Validées"]}),u.quantity>1&&e.jsxs("span",{className:"bg-brand-100 text-brand-700 dark:bg-brand-900 dark:text-brand-300 text-xs font-bold px-2 py-1 rounded-full",children:["x",u.quantity]})]})]}),e.jsx("div",{className:"text-slate-800 dark:text-slate-200 font-medium mb-1",children:u.type}),e.jsx("div",{className:"text-sm text-slate-500 mb-2",children:e.jsxs("span",{children:[u.largeurMm," x ",u.hauteurMm," mm ",u.room&&`• ${u.room}`]})}),!u.isValid&&e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-300 px-2 py-1 rounded text-xs inline-flex items-center mb-2",children:[e.jsx(re,{size:12,className:"mr-1"})," Incomplet"]}),!p&&e.jsxs("div",{className:"flex justify-end gap-3 mt-2 pt-3 border-t border-slate-100 dark:border-slate-800",children:[e.jsx("button",{onClick:Q=>q(Q,u),className:"text-slate-400 hover:text-brand-600 p-1",children:e.jsx(st,{size:18})}),e.jsx("button",{onClick:Q=>{Q.stopPropagation(),confirm("Supprimer ?")&&i(u.id)},className:"text-slate-400 hover:text-red-600 p-1",children:e.jsx(K,{size:18})})]})]},u.id)}),!p&&e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("button",{onClick:_,className:"flex-1 min-h-[120px] border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 hover:border-brand-400 transition-colors",children:[e.jsx("div",{className:"bg-slate-100 dark:bg-slate-800 p-4 rounded-full mb-2",children:e.jsx(rt,{size:24})}),e.jsx("span",{className:"font-medium",children:"Ajouter Manuellement"})]}),e.jsxs("button",{onClick:()=>S(!0),className:"h-[60px] border border-slate-200 dark:border-slate-700 rounded-xl flex items-center justify-center gap-2 text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors",children:[e.jsx(X,{size:20}),e.jsx("span",{className:"font-medium text-sm",children:"Importer Devis (PDF)"})]})]})]}),e.jsx(yt,{history:d.history}),e.jsx("div",{id:"step-envoi"})]}),!p&&e.jsxs("div",{className:"fixed bottom-0 left-0 right-0 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-t border-slate-200 dark:border-slate-800 p-4 safe-pb z-40 shadow-2xl",children:[P&&ee&&e.jsxs("div",{className:"mb-4 flex flex-col items-center animate-bounce-short",children:[e.jsxs("div",{className:"bg-amber-100 dark:bg-amber-900/40 text-amber-800 dark:text-amber-200 px-4 py-1.5 rounded-full flex items-center gap-2 border border-amber-200 dark:border-amber-800 shadow-sm transition-all",children:[e.jsx(G,{size:16}),e.jsxs("span",{className:"text-sm font-bold",children:[ne," cote",ne>1?"s":""," devis à vérifier"]})]}),e.jsx("p",{className:"text-[10px] uppercase tracking-widest text-slate-400 mt-2 font-bold",children:"Action requise avant envoi"})]}),e.jsx($,{onClick:()=>{ee?r(!0):h(!0)},disabled:w,className:`w-full py-4 text-base font-bold transition-all duration-300 shadow-lg ${ee&&P?"ring-2 ring-amber-500":"bg-brand-600 hover:bg-brand-700 active:scale-[0.98]"}`,icon:w?null:Se,children:w?e.jsxs("span",{className:"flex items-center justify-center gap-3",children:[e.jsx(pe,{size:20}),"Transmission..."]}):"ENVOYER AU BUREAU"})]}),p&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-green-50 dark:bg-green-900/20 border-t border-green-200 dark:border-green-800 p-4 safe-pb z-40",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-700 dark:text-green-300",children:[e.jsx(Y,{size:16}),e.jsxs("span",{className:"text-sm font-medium",children:["Dossier verrouillé le ",new Date(d.sentAt).toLocaleDateString("fr-FR")]})]})}),E&&e.jsx(St,{chantier:d,products:I,incompleteCount:Ue,onClose:()=>h(!1),onStatusChange:Z,onSuccess:Te,onError:Ie}),c&&e.jsx(Tt,{onClose:()=>a(!1),onUnlock:Re}),f&&e.jsx(Et,{onClose:()=>S(!1),onImport:Fe}),k&&e.jsx(jt,{chantier:d,onClose:()=>L(!1),onUpdate:u=>t(d.id,u)}),o&&e.jsx(le,{isOpen:!0,onClose:()=>{URL.revokeObjectURL(o),C(null)},title:`Devis - ${d.referenceDevis||d.client}`,size:"6xl",children:e.jsxs("div",{className:"flex flex-col h-[85vh]",children:[e.jsx("div",{className:"flex justify-end p-2 border-b dark:border-slate-800",children:e.jsx($,{variant:"ghost",size:"sm",icon:Ce,onClick:()=>window.open(o,"_blank"),className:"text-brand-600 dark:text-brand-400 font-bold",children:"Ouvrir dans un nouvel onglet"})}),e.jsx("div",{className:"flex-1 w-full bg-slate-100 dark:bg-slate-800 rounded-b-lg overflow-auto",style:{WebkitOverflowScrolling:"touch"},children:e.jsx("iframe",{src:o,className:"w-full h-full border-0",title:"Aperçu du Devis"})})]})}),D&&e.jsx(_e,{message:D.message,type:D.type,onClose:()=>y(null)})]})};export{Ut as ChantierDetailView};
