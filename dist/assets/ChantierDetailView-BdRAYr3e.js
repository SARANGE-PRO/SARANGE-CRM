import{c as Y,j as e,u as te,B as L,m as oe,S as se,T as de}from"./index-CvXp101_.js";import{R,r as b,P as q,U as K,T as W,M as Q,S as Z,d as ie,X as J,e as ce,L as V,f as ue,c as re,A as B,g as xe,h as be,i as me,D as he,C as ae,j as pe,k as ge,l as fe,m as je,n as ke,o as Ne,p as ve,q as le,s as we}from"./vendor-D0DKGMpp.js";import{S as D,I as F,a as Ee,E as Ce,M as ne}from"./DashboardView-CZvemcSc.js";import{S as O}from"./StatusBanner-DsRVUt_Y.js";import{V as H,c as ye,g as X,a as Te,L as G,b as Ae}from"./utils-_q_rbrWh.js";import"./Card-DYqkvist.js";const ee=({label:c,checked:j,onChange:x,disabled:r})=>R.createElement("label",{className:Y("flex items-center gap-3 cursor-pointer group",r&&"opacity-50 cursor-not-allowed")},R.createElement("div",{className:Y("w-5 h-5 rounded border flex items-center justify-center transition-all",j?"bg-brand-600 border-brand-600 text-white":"bg-white border-slate-300 group-hover:border-brand-400")},j&&R.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round",className:"w-3.5 h-3.5"},R.createElement("polyline",{points:"20 6 9 17 4 12"}))),R.createElement("input",{type:"checkbox",className:"hidden",checked:j,onChange:t=>!r&&x(t.target.checked),disabled:r}),R.createElement("span",{className:"text-sm text-slate-700 dark:text-slate-300 select-none"},c)),Se=({data:c,onChange:j,disabled:x=!1})=>{const r=b.useRef(null),t=b.useRef(null),[v,f]=b.useState((c==null?void 0:c.lines)||[]),[C,y]=b.useState(!1),[A,d]=b.useState(!1),[i,w]=b.useState("free"),[E,n]=b.useState(null),[l,h]=b.useState(null),U=350,k=250;b.useEffect(()=>{j({lines:v,width:U,height:k})},[v]);const p=(o,N=1,M=0,P=0)=>{if(!o)return;const u=o.getContext("2d");if(u.clearRect(0,0,o.width,o.height),u.save(),u.translate(M,P),u.scale(N,N),u.fillStyle="white",u.fillRect(0,0,U,k),u.lineCap="round",u.lineJoin="round",u.lineWidth=3,u.strokeStyle="#2563EB",v.forEach(a=>{if(!(a.length<1)){u.beginPath(),u.moveTo(a[0].x,a[0].y);for(let m=1;m<a.length;m++)u.lineTo(a[m].x,a[m].y);u.stroke()}}),C&&E&&l){if(u.strokeStyle="#93C5FD",u.beginPath(),i!=="free"){if(i==="line")u.moveTo(E.x,E.y),u.lineTo(l.x,l.y);else if(i==="rect"){const a=l.x-E.x,m=l.y-E.y;u.rect(E.x,E.y,a,m)}}u.stroke()}u.restore()};b.useEffect(()=>{p(r.current)},[v,C,l,i]);const[S,s]=b.useState({s:1,x:0,y:0});b.useEffect(()=>{if(!A||!t.current)return;const o=t.current;o.width=window.innerWidth,o.height=window.innerHeight;const N=Math.min(o.width/U,o.height/k)*.95,M=(o.width-U*N)/2,P=(o.height-k*N)/2;s({s:N,x:M,y:P}),p(o,N,M,P)},[A,v,C,l]);const g=(o,N=1,M=0,P=0)=>{const u=o.target.getBoundingClientRect(),a=o.touches?o.touches[0]:o;return{x:(a.clientX-u.left-M)/N,y:(a.clientY-u.top-P)/N}},T=(o,N)=>{if(x)return;o.cancelable&&o.preventDefault(),N==="fs"?t.current:r.current;const{s:M,x:P,y:u}=N==="fs"?S:{s:1,x:0,y:0},a=g(o,M,P,u);y(!0),n(a),h(a),i==="free"&&f(m=>[...m,[a]])},I=(o,N)=>{if(x||!C)return;o.cancelable&&o.preventDefault();const{s:M,x:P,y:u}=N==="fs"?S:{s:1,x:0,y:0},a=g(o,M,P,u);h(a),i==="free"&&f(m=>{const z=[...m],_=z[z.length-1];return _&&(z[z.length-1]=[..._,a]),z})},$=()=>{if(C){if(y(!1),E&&l){if(i==="line")f(o=>[...o,[E,l]]);else if(i==="rect"){const o=E,N=l,M={x:N.x,y:o.y},P={x:o.x,y:N.y};f(u=>[...u,[o,M,N,P,o]])}}n(null),h(null)}};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 relative group ${x?"opacity-70":""}`,children:[e.jsxs("div",{className:"flex flex-col gap-2 mb-2",children:[e.jsxs("div",{className:"flex justify-between items-center text-xs text-slate-500 uppercase font-bold tracking-wide",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(q,{size:14,className:"mr-1"})," Croquis ",e.jsx("span",{className:"ml-2 text-brand-600 dark:text-brand-400 font-bold",children:"— VUE INTÉRIEUR"})]}),!x&&e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>f(o=>o.slice(0,-1)),className:"p-1 hover:bg-slate-200 dark:hover:bg-slate-700 rounded text-slate-600 dark:text-slate-400",title:"Annuler",children:e.jsx(K,{size:16})}),e.jsx("button",{onClick:()=>confirm("Effacer tout ?")&&f([]),className:"p-1 hover:bg-red-100 dark:hover:bg-red-900/30 rounded text-red-500",title:"Effacer",children:e.jsx(W,{size:16})})]})]}),!x&&e.jsxs("div",{className:"flex gap-2 border-b border-slate-200 dark:border-slate-700 pb-2",children:[e.jsxs("button",{onClick:()=>w("free"),className:`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${i==="free"?"bg-brand-600 text-white shadow-sm":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700"}`,children:[e.jsx(q,{size:14})," Crayon"]}),e.jsxs("button",{onClick:()=>w("line"),className:`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${i==="line"?"bg-brand-600 text-white shadow-sm":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700"}`,children:[e.jsx(Q,{size:14})," Ligne"]}),e.jsxs("button",{onClick:()=>w("rect"),className:`flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-bold transition-colors ${i==="rect"?"bg-brand-600 text-white shadow-sm":"bg-white dark:bg-slate-800 text-slate-600 dark:text-slate-300 border border-slate-200 dark:border-slate-700"}`,children:[e.jsx(Z,{size:14})," Rect"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("canvas",{ref:r,width:U,height:k,className:`w-full h-48 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded touch-none shadow-inner ${x?"cursor-not-allowed":"cursor-crosshair"}`,onMouseDown:o=>T(o,"sm"),onMouseMove:o=>I(o,"sm"),onMouseUp:$,onMouseLeave:$,onTouchStart:o=>T(o,"sm"),onTouchMove:o=>I(o,"sm"),onTouchEnd:$}),!x&&e.jsx("button",{onClick:()=>d(!0),className:"absolute top-2 right-2 p-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur rounded-full shadow border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:text-brand-600",children:e.jsx(ie,{size:20})})]})]}),A&&!x&&e.jsxs("div",{className:"fixed inset-0 z-[60] bg-slate-950 flex items-center justify-center touch-none",children:[e.jsx("canvas",{ref:t,className:"block cursor-crosshair",onMouseDown:o=>T(o,"fs"),onMouseMove:o=>I(o,"fs"),onMouseUp:$,onMouseLeave:$,onTouchStart:o=>T(o,"fs"),onTouchMove:o=>I(o,"fs"),onTouchEnd:$}),e.jsxs("div",{className:"absolute top-4 left-4 flex gap-2 bg-slate-800/90 backdrop-blur p-2 rounded-lg border border-slate-700 shadow-xl",children:[e.jsx("button",{onClick:()=>w("free"),className:`p-3 rounded-md ${i==="free"?"bg-brand-600 text-white":"text-slate-400 hover:bg-slate-700"}`,children:e.jsx(q,{size:24})}),e.jsx("button",{onClick:()=>w("line"),className:`p-3 rounded-md ${i==="line"?"bg-brand-600 text-white":"text-slate-400 hover:bg-slate-700"}`,children:e.jsx(Q,{size:24})}),e.jsx("button",{onClick:()=>w("rect"),className:`p-3 rounded-md ${i==="rect"?"bg-brand-600 text-white":"text-slate-400 hover:bg-slate-700"}`,children:e.jsx(Z,{size:24})})]}),e.jsx("div",{className:"absolute top-4 right-4",children:e.jsx("button",{onClick:()=>d(!1),className:"p-3 bg-red-600 text-white rounded-full shadow-lg hover:bg-red-500",children:e.jsx(J,{size:24})})}),e.jsxs("div",{className:"absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-4 bg-slate-800/90 backdrop-blur p-2 rounded-full border border-slate-700 shadow-xl",children:[e.jsxs("button",{onClick:()=>f(o=>o.slice(0,-1)),className:"px-6 py-3 bg-slate-700 text-white rounded-full font-bold hover:bg-slate-600 flex items-center",children:[e.jsx(K,{size:20,className:"mr-2"})," Annuler"]}),e.jsxs("button",{onClick:()=>confirm("Tout effacer ?")&&f([]),className:"px-6 py-3 bg-red-900/50 text-red-200 rounded-full font-bold hover:bg-red-900/70 flex items-center",children:[e.jsx(W,{size:20,className:"mr-2"})," Effacer"]}),e.jsxs("button",{onClick:()=>d(!1),className:"px-8 py-3 bg-green-600 text-white rounded-full font-bold hover:bg-green-500 flex items-center",children:[e.jsx(ce,{size:20,className:"mr-2"})," OK"]})]})]})]})},Ie=({product:c,onSave:j,onCancel:x,isReadOnly:r=!1})=>{const[t,v]=b.useState(c),[f,C]=b.useState([]),[y,A]=b.useState(!1),[d,i]=b.useState(!1),w=b.useRef(null),{state:E}=te(),n=(s,g)=>{r||v(T=>({...T,[s]:g}))},l=(s,g,T)=>{r||v(I=>({...I,[s]:{...I[s]||{},[g]:T}}))},h=s=>{var g;r||(n("room",s),/sdb|salle\s?de\s?bain|toilette|wc|douche/i.test(s.toLowerCase())&&["FENETRE","BAIE_COULISSANTE"].includes(t.type)&&!((g=t.vitrageFlags)!=null&&g.g200)&&(v(T=>({...T,vitrageFlags:{...T.vitrageFlags,standard:!0,g200:!0}})),i(!0),setTimeout(()=>i(!1),3e3)))};b.useEffect(()=>{t.type==="FENETRE"&&t.hauteurMm>2200&&v(s=>({...s,oscilloBattant:!1}))},[t.hauteurMm]);const U=()=>{if(r)return;const s=H.validateProduct(t);if(!s.isValid){C(s.errors),setTimeout(()=>{const g=document.getElementById(`field-${s.errors[0]}`);g&&g.scrollIntoView({behavior:"smooth",block:"center"})},100);return}j({...t,isValid:!0,validationErrors:[]})},k=async s=>{if(!r&&s.target.files&&s.target.files[0]){const g=await ye(s.target.files[0]);n("photos",[...t.photos||[],g])}},p=s=>f.includes(s),S=r?"opacity-60 cursor-not-allowed bg-slate-100 dark:bg-slate-800":"";return e.jsxs("div",{className:"fixed inset-0 bg-slate-50 dark:bg-slate-950 z-50 flex flex-col h-full animate-fade-in",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 pb-3 pt-3 safe-top-padding flex justify-between items-center shadow-sm shrink-0",children:[e.jsx("button",{onClick:x,className:"p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800",children:e.jsx(J,{size:24,className:"text-slate-500"})}),e.jsxs("div",{className:"text-center",children:[e.jsxs("h2",{className:"font-bold dark:text-white",children:["Produit #",String(t.index).padStart(2,"0")]}),r&&e.jsxs("span",{className:"text-xs text-green-600 font-medium flex items-center justify-center gap-1",children:[e.jsx(V,{size:12})," Consultation"]})]}),r?e.jsx("div",{className:"w-[76px]"}):e.jsx(L,{onClick:U,className:"px-5 py-2 rounded-full",icon:ue,children:"Valider"})]}),r&&e.jsx("div",{className:"bg-green-50 dark:bg-green-900/20 border-b border-green-200 dark:border-green-800 px-4 py-2 text-center",children:e.jsxs("span",{className:"text-sm text-green-700 dark:text-green-300 font-medium flex items-center justify-center gap-2",children:[e.jsx(V,{size:14})," Dossier verrouillé — consultation seule"]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 pb-20 max-w-3xl mx-auto w-full",children:[f.length>0&&e.jsxs("div",{className:"mb-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-900/50 text-red-700 dark:text-red-300 p-3 rounded-lg flex items-center",children:[e.jsx(re,{size:20,className:"mr-2"}),e.jsx("span",{children:"Champs manquants"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${S}`,children:[e.jsx(D,{label:"Type",value:t.type,onChange:s=>n("type",s),disabled:r,options:[{label:"Fenêtre",value:"FENETRE"},{label:"Porte-fenêtre",value:"PORTE_FENETRE"},{label:"Coulissant",value:"BAIE_COULISSANTE"},{label:"Porte Entrée",value:"PORTE_ENTREE"},{label:"Porte Service",value:"PORTE_SERVICE"},{label:"Volet",value:"VOLET_ROULANT"},{label:"Autre",value:"AUTRE"}]}),e.jsxs("div",{className:"flex items-center justify-between bg-slate-50 dark:bg-slate-800 p-3 rounded-lg mb-4 border border-slate-100 dark:border-slate-700",children:[e.jsx("span",{className:"font-medium text-slate-700 dark:text-slate-300",children:"Quantité"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{className:`w-8 h-8 rounded-full bg-white dark:bg-slate-700 shadow text-brand-600 font-bold ${r?"opacity-50 cursor-not-allowed":""}`,onClick:()=>n("quantity",Math.max(1,(t.quantity||1)-1)),disabled:r,children:"-"}),e.jsx("span",{className:"font-bold text-xl w-6 text-center dark:text-white",children:t.quantity||1}),e.jsx("button",{className:`w-8 h-8 rounded-full bg-white dark:bg-slate-700 shadow text-brand-600 font-bold ${r?"opacity-50 cursor-not-allowed":""}`,onClick:()=>n("quantity",(t.quantity||1)+1),disabled:r,children:"+"})]})]}),e.jsx(F,{label:"Localisation",value:t.room,onChange:h,placeholder:"Ex: Cuisine",disabled:r}),t.type==="AUTRE"&&e.jsx(F,{id:"field-description",label:"Description",value:t.description,onChange:s=>n("description",s),error:p("description"),disabled:r}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(F,{id:"field-largeurMm",label:"Largeur (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.largeurMm,onChange:s=>n("largeurMm",parseInt(s)),error:p("largeurMm"),disabled:r}),e.jsx(F,{id:"field-hauteurMm",label:"Hauteur (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.hauteurMm,onChange:s=>n("hauteurMm",parseInt(s)),error:p("hauteurMm"),disabled:r})]}),(H.isMeasureSuspicious(t.largeurMm,t.monobloc)||H.isMeasureSuspicious(t.hauteurMm,t.monobloc))&&e.jsxs("div",{className:"text-orange-500 text-xs flex items-center mt-[-10px] mb-4",children:[e.jsx(B,{size:12,className:"mr-1"})," Attention: Cotes <300mm"]})]}),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE","PORTE_ENTREE","PORTE_SERVICE"].includes(t.type)&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${S}`,children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider",children:"Caractéristiques"}),e.jsx(D,{id:"field-matiere",label:"Matière",value:t.matiere,onChange:s=>n("matiere",s),error:p("matiere"),disabled:r,options:[{label:"PVC",value:"PVC"},{label:"Alu",value:"ALU"}]}),t.matiere&&e.jsx(D,{id:"field-profil",label:"Profil",value:t.profil,onChange:s=>n("profil",s),error:p("profil"),disabled:r,options:t.matiere==="PVC"?[{label:"Réno 40",value:"RENO_40"},{label:"Réno 60",value:"RENO_60"},{label:"Neuf",value:"NEUF"},{label:"ISO",value:"ISO"},{label:"Autre",value:"AUTRE"}]:[{label:"Réno",value:"RENO"},{label:"Neuf",value:"NEUF"},{label:"Autre",value:"AUTRE"}]}),t.profil==="ISO"&&e.jsx(F,{id:"field-isoMm",label:"Aile ISO (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.isoMm,onChange:s=>n("isoMm",parseInt(s)),error:p("isoMm"),disabled:r}),t.profil==="AUTRE"&&e.jsx(F,{id:"field-profilAutre",label:"Profil personnalisé",placeholder:"Préciser le profil...",value:t.profilAutre,onChange:s=>n("profilAutre",s),error:p("profilAutre"),disabled:r}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-slate-100 dark:border-slate-800",children:[e.jsx(D,{id:"field-couleur",label:"Couleur",value:t.couleur,onChange:s=>n("couleur",s),error:p("couleur"),disabled:r,options:t.matiere==="PVC"?[{label:"Blanc",value:"BLANC"},{label:"Bicolor 7016",value:"BICOLOR_7016"},{label:"Autre",value:"AUTRE"}]:[{label:"Blanc",value:"BLANC"},{label:"Gris 7016",value:"GRIS_7016"},{label:"Autre",value:"AUTRE"}]}),t.couleur==="AUTRE"&&e.jsx(F,{id:"field-couleurAutre",placeholder:"Préciser...",value:t.couleurAutre,onChange:s=>n("couleurAutre",s),error:p("couleurAutre"),disabled:r})]})]}),(t.type==="FENETRE"||t.type==="PORTE_FENETRE"||t.type==="BAIE_COULISSANTE")&&e.jsxs("div",{id:"field-vitrageFlags",className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border ${p("vitrageFlags")?"border-red-500 ring-1 ring-red-500":"border-slate-200 dark:border-slate-800"} ${S}`,children:[e.jsxs("h3",{className:`text-xs font-bold uppercase mb-3 tracking-wider ${p("vitrageFlags")?"text-red-500":"text-slate-400"}`,children:["Vitrage ",p("vitrageFlags")&&"*"]}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:[["standard","4/20/4"],["g200","G200"],["feuillete1f","Feuilleté 1F"],["feuillete2f","Feuilleté 2F"]].map(([s,g])=>{var T,I;return e.jsxs("label",{className:`flex items-center p-3 rounded-lg border transition-all ${r?"cursor-not-allowed":"cursor-pointer"} ${(T=t.vitrageFlags)!=null&&T[s]?"bg-brand-50 border-brand-500 text-brand-700 dark:bg-brand-900/30":"border-slate-200 dark:border-slate-700 dark:text-white"}`,children:[e.jsx("input",{type:"checkbox",className:"w-5 h-5 rounded text-brand-600 focus:ring-brand-500",checked:!!((I=t.vitrageFlags)!=null&&I[s]),onChange:$=>l("vitrageFlags",s,$.target.checked),disabled:r}),e.jsx("span",{className:"ml-2 text-sm font-medium",children:g})]},s)})})]}),t.type==="FENETRE"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 space-y-4 ${S}`,children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider",children:"Options"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${r?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Oscillo-Battant"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.oscilloBattant,onChange:s=>n("oscilloBattant",s.target.checked),disabled:r||t.hauteurMm>2200})]}),e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${r?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Grille Ventil."}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.grilleVentilation,onChange:s=>n("grilleVentilation",s.target.checked),disabled:r})]})]}),e.jsxs("div",{className:"pt-2",children:[e.jsx("label",{className:"text-sm dark:text-slate-300 font-medium mb-2 block",children:"Hauteur Poignée"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>n("poigneeHauteur","CENTREE"),disabled:r,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${r?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur!=="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Centrée"}),e.jsx("button",{onClick:()=>n("poigneeHauteur","AUTRE"),disabled:r,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${r?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur==="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Autre"})]}),t.poigneeHauteur==="AUTRE"&&e.jsx("input",{type:"number",inputMode:"numeric",pattern:"[0-9]*",className:`mt-2 w-full p-3 border rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-700 ${r?"opacity-50 cursor-not-allowed":""}`,placeholder:"mm",value:t.poigneeHauteurMm||"",onChange:s=>n("poigneeHauteurMm",parseInt(s.target.value)),disabled:r})]})]}),t.type==="PORTE_FENETRE"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 space-y-4 ${S}`,children:[e.jsx("h3",{className:"text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider",children:"Options Porte-fenêtre"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${r?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Grille Ventil."}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.grilleVentilation,onChange:s=>n("grilleVentilation",s.target.checked),disabled:r})]}),e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${r?"cursor-not-allowed":""}`,children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Serrure"}),t.matiere==="PVC"&&e.jsx("span",{className:"text-xs text-slate-400",children:"(gros profil)"})]}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.serrure,onChange:s=>n("serrure",s.target.checked),disabled:r})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${r?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Seuil PMR"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.seuilPMR,onChange:s=>n("seuilPMR",s.target.checked),disabled:r})]}),e.jsxs("label",{className:`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${r?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium text-sm",children:"Soubassement"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.soubassement,onChange:s=>n("soubassement",s.target.checked),disabled:r})]})]}),t.soubassement&&e.jsx(F,{id:"field-soubassementHauteurMm",label:"Hauteur Soubassement (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.soubassementHauteurMm,onChange:s=>n("soubassementHauteurMm",parseInt(s)),placeholder:"Ex: 400",disabled:r}),e.jsxs("div",{className:"pt-2",children:[e.jsx("label",{className:"text-sm dark:text-slate-300 font-medium mb-2 block",children:"Hauteur Poignée"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>n("poigneeHauteur","CENTREE"),disabled:r,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${r?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur!=="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Centrée"}),e.jsx("button",{onClick:()=>n("poigneeHauteur","AUTRE"),disabled:r,className:`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${r?"opacity-50 cursor-not-allowed":""} ${t.poigneeHauteur==="AUTRE"?"bg-brand-600 text-white border-brand-600":"bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700"}`,children:"Autre"})]}),t.poigneeHauteur==="AUTRE"&&e.jsx("input",{type:"number",inputMode:"numeric",pattern:"[0-9]*",className:`mt-2 w-full p-3 border rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-700 ${r?"opacity-50 cursor-not-allowed":""}`,placeholder:"mm",value:t.poigneeHauteurMm||"",onChange:s=>n("poigneeHauteurMm",parseInt(s.target.value)),disabled:r})]})]}),t.type==="VOLET_ROULANT"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${S}`,children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300",children:"Lier à "}),e.jsxs("select",{className:`w-full p-3 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 dark:text-white ${r?"opacity-50 cursor-not-allowed":""}`,value:t.lieAProduitId||"",onChange:s=>n("lieAProduitId",s.target.value),disabled:r,children:[e.jsx("option",{value:"",children:"-- Indépendant --"}),E.products.filter(s=>["FENETRE","BAIE_COULISSANTE"].includes(s.type)).map(s=>e.jsxs("option",{value:s.id,children:["#",s.index," ",s.type]},s.id))]})]}),e.jsx(D,{id:"field-manoeuvre",label:"Manoeuvre",value:t.manoeuvre,onChange:s=>n("manoeuvre",s),error:p("manoeuvre"),disabled:r,options:[{label:"Filaire",value:"FILAIRE"},{label:"Radio",value:"RADIO"},{label:"Solaire",value:"SOLAIRE"}]}),t.manoeuvre&&t.manoeuvre!=="SOLAIRE"&&e.jsx(D,{id:"field-sortieCable",label:"Sortie Câble",value:t.sortieCable,onChange:s=>n("sortieCable",s),error:p("sortieCable"),disabled:r,options:[{label:"Gauche",value:"GAUCHE"},{label:"Droite",value:"DROITE"}]}),t.manoeuvre!=="FILAIRE"&&e.jsxs("label",{className:`flex items-center p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 dark:border-slate-700 mt-4 mb-4 ${r?"cursor-not-allowed":""}`,children:[e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.boxDomotique,onChange:s=>n("boxDomotique",s.target.checked),disabled:r}),e.jsx("span",{className:"ml-3 font-medium dark:text-white",children:"Box Domotique"})]}),e.jsxs("div",{className:"my-4",id:"field-coffreADeduireMm",children:[e.jsxs("label",{className:`flex items-center justify-between p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 dark:border-slate-700 ${r?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"font-medium dark:text-white",children:"Monobloc ?"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.monobloc,onChange:s=>n("monobloc",s.target.checked),disabled:r})]}),t.monobloc&&e.jsxs("div",{className:"mt-3 bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg",children:[e.jsx(F,{label:"Hauteur Coffre",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.coffreADeduireMm,onChange:s=>n("coffreADeduireMm",parseInt(s)),error:p("coffreADeduireMm"),disabled:r}),e.jsxs("div",{className:"text-right text-sm font-bold text-brand-600",children:["Passage: ",t.hauteurMm&&t.coffreADeduireMm?t.hauteurMm-t.coffreADeduireMm:"-"," mm"]})]})]})]}),H.hasAdvancedOptions(t.type)&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden ${S}`,children:[e.jsxs("button",{onClick:()=>A(!y),className:"w-full flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-800/50 font-medium text-slate-700 dark:text-slate-300",children:[e.jsx("span",{children:"Options Avancées"}),y?e.jsx(xe,{size:18}):e.jsx(be,{size:18})]}),y&&e.jsxs("div",{className:"p-4 border-t border-slate-200 dark:border-slate-800 space-y-4",children:[(t.type.includes("FENETRE")||t.type.includes("PORTE"))&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:`flex items-center justify-between ${r?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Ouverture Extérieure"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.ouvertureExterieure,onChange:s=>n("ouvertureExterieure",s.target.checked),disabled:r})]}),t.type==="FENETRE"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{className:`flex items-center justify-between ${r?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Poignée à  clé"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.poigneeCle,onChange:s=>n("poigneeCle",s.target.checked),disabled:r})]}),e.jsxs("label",{className:`flex items-center justify-between ${r?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Pièce d'appui"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.pieceAppui,onChange:s=>n("pieceAppui",s.target.checked),disabled:r})]}),t.pieceAppui&&e.jsx(F,{id:"field-pieceAppuiDescription",label:"Description Pièce d'appui",value:t.pieceAppuiDescription,onChange:s=>n("pieceAppuiDescription",s),placeholder:"Préciser...",disabled:r})]}),t.type==="PORTE_FENETRE"&&e.jsxs("label",{className:`flex items-center justify-between ${r?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white",children:"Poignée à  clé"}),e.jsx("input",{type:"checkbox",className:"w-5 h-5 accent-brand-600",checked:!!t.poigneeCle,onChange:s=>n("poigneeCle",s.target.checked),disabled:r})]}),t.type==="PORTE_ENTREE"&&e.jsxs("label",{className:`flex items-center justify-between ${r?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-bold",children:"Tierce / Imposte ?"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.tierceImposte,onChange:s=>n("tierceImposte",s.target.checked),disabled:r})]})]}),t.type==="VOLET_ROULANT"&&e.jsxs("div",{children:[e.jsx(D,{label:"Couple",value:t.coupleMoteur||10,onChange:s=>n("coupleMoteur",s),disabled:r,options:[{label:"10 Nm",value:10},{label:"20 Nm",value:20}]}),e.jsx(D,{label:"Pose",value:t.pose||"RENO",onChange:s=>n("pose",s),disabled:r,options:[{label:"Rénov",value:"RENO"},{label:"Tradi",value:"TRADI"},{label:"Tunnel",value:"TUNNEL"}]})]})]})]}),t.type==="PORTE_ENTREE"&&e.jsxs("div",{className:`bg-white dark:bg-slate-900 p-5 rounded-xl border dark:border-slate-800 ${S}`,children:[e.jsx(D,{id:"field-remplissage",label:"Remplissage",value:t.remplissage,onChange:s=>n("remplissage",s),error:p("remplissage"),disabled:r,options:[{label:"Panneau Déco Alu",value:"PANNEAU_DECORATIF_ALU"},{label:"Sandwich",value:"PANNEAU_SANDWICH"},{label:"Vitrée",value:"VITREE"}]}),t.largeurMm>1e3&&e.jsxs("div",{className:"mt-3 pt-3 border-t dark:border-slate-700",children:[e.jsxs("label",{className:`flex items-center justify-between mb-3 ${r?"cursor-not-allowed":""}`,children:[e.jsx("span",{className:"dark:text-white font-medium",children:"Tierce ?"}),e.jsx("input",{type:"checkbox",className:"w-6 h-6 accent-brand-600",checked:!!t.tierce,onChange:s=>n("tierce",s.target.checked),disabled:r})]}),t.tierce&&e.jsx(F,{id:"field-cotePassageMm",label:"Cote Passage (mm)",type:"number",inputMode:"decimal",step:"any",pattern:"[0-9]*",value:t.cotePassageMm,onChange:s=>n("cotePassageMm",s),error:p("cotePassageMm"),disabled:r})]})]}),e.jsxs("div",{className:`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${S}`,children:[e.jsx(Se,{data:t.dessin,onChange:s=>n("dessin",s),disabled:r}),e.jsxs("div",{className:"mt-6",children:[e.jsx("label",{className:"block text-sm font-medium mb-3 text-slate-700 dark:text-slate-300",children:"Photos"}),e.jsxs("div",{className:"grid grid-cols-4 gap-2",children:[(t.photos||[]).map((s,g)=>e.jsxs("div",{className:"relative aspect-square rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700 group",children:[e.jsx("img",{src:s,className:"w-full h-full object-cover"}),!r&&e.jsx("button",{onClick:()=>n("photos",t.photos.filter((T,I)=>I!==g)),className:"absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 shadow-md opacity-80 hover:opacity-100",children:e.jsx(J,{size:12})})]},g)),!r&&e.jsxs("button",{onClick:()=>{var s;return(s=w.current)==null?void 0:s.click()},className:"aspect-square rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600 flex flex-col items-center justify-center text-slate-400 hover:text-brand-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors",children:[e.jsx(me,{size:24}),e.jsx("span",{className:"text-[10px] mt-1",children:"Ajouter"})]}),e.jsx("input",{type:"file",ref:w,accept:"image/*",className:"hidden",onChange:k,disabled:r})]})]}),e.jsxs("div",{className:"mt-4",children:[e.jsx("label",{className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2",children:"Notes techniques"}),e.jsx("textarea",{className:`w-full p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-950 dark:text-white h-24 text-sm focus:border-brand-500 outline-none ${r?"opacity-50 cursor-not-allowed":""}`,placeholder:"Contraintes...",value:t.notes||"",onChange:s=>n("notes",s.target.value),disabled:r})]})]})]})]}),d&&e.jsxs("div",{className:"fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-3 rounded-lg shadow-xl flex items-center animate-slide-up",children:[e.jsx(he,{size:20,className:"text-blue-400 mr-2"})," Vitrage G200 activé (Intimité)"]})]})},Me=({currentStep:c})=>{const j=[{id:1,label:"Création"},{id:2,label:"Planification"},{id:3,label:"Métrage"},{id:4,label:"Envoyé"}];return e.jsx("div",{className:"w-full bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 p-4",children:e.jsxs("div",{className:"flex items-center justify-between relative max-w-3xl mx-auto",children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 w-full h-1 bg-slate-100 dark:bg-slate-800 -z-0 rounded-full"}),e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 h-1 bg-brand-600 transition-all duration-500 -z-0 rounded-full",style:{width:`${(c-1)/(j.length-1)*100}%`}}),j.map(x=>{const r=x.id<c,t=x.id===c;return e.jsxs("div",{className:"relative z-10 flex flex-col items-center group cursor-default",children:[e.jsx("div",{className:`w-8 h-8 rounded-full flex items-center justify-center border-2 transition-all duration-300 ${r?"bg-brand-600 border-brand-600 text-white":t?"bg-white dark:bg-slate-900 border-brand-600 text-brand-600 scale-110 shadow-lg":"bg-white dark:bg-slate-900 border-slate-200 dark:border-slate-700 text-slate-300"}`,children:r?e.jsx(ae,{size:16}):t?e.jsx(pe,{size:16,className:"animate-spin-slow"}):e.jsx("span",{className:"text-xs font-bold",children:x.id})}),e.jsx("span",{className:`absolute top-full mt-2 text-xs font-bold whitespace-nowrap transition-colors duration-300 ${t?"text-brand-600 dark:text-brand-400":r?"text-slate-700 dark:text-slate-300":"text-slate-400 dark:text-slate-600"}`,children:x.label})]},x.id)})]})})};async function Pe(c,j,x,r){var A;const t=(A=window.SARANGE_CONFIG)==null?void 0:A.APPS_SCRIPT_URL,v=15e3;if(!t)return G.warn("URL Google Apps Script non configurée"),{success:!1,error:"Configuration manquante"};const f={timestamp:new Date().toISOString(),metrage_id:X(),htmlReport:x,chantier:{client:c.client,adresse:c.adresse,telephone:c.telephone||"",email:c.email||"",typeContrat:c.typeContrat},clientFinal:c.typeContrat==="SOUS_TRAITANCE"?{nom:c.clientFinal,adresse:c.adresseFinale}:null,produits:j.map(d=>({numero:d.index,type:d.type,quantite:d.quantity||1,localisation:d.room||"",dimensions:`${d.largeurMm} x ${d.hauteurMm} mm`,matiere:d.matiere||"",profil:d.profil||"",couleur:d.couleur==="AUTRE"?d.couleurAutre:d.couleur||"",vitrage:d.vitrageFlags?Object.entries(d.vitrageFlags).filter(([i,w])=>w).map(([i])=>i==="standard"?"4/20/4":i==="g200"?"G200":i==="feuillete1f"?"Feuilleté 1F":i==="feuillete2f"?"Feuilleté 2F":"").filter(Boolean).join(", "):"",options:Ae(d),notes:d.notes||"",isValid:d.isValid})),total_produits:j.reduce((d,i)=>d+(i.quantity||1),0),produits_incomplets:j.filter(d=>!d.isValid).length},C=new AbortController,y=setTimeout(()=>C.abort(),v);try{r==null||r({sendStatus:"SENDING",lastError:null});const d=await fetch(t,{method:"POST",mode:"cors",headers:{"Content-Type":"text/plain"},body:JSON.stringify(f),signal:C.signal});if(clearTimeout(y),!d.ok)throw new Error(`Erreur HTTP: ${d.status}`);const i=await d.json();if(i.success===!0){const w=new Date().toISOString();return r==null||r({sendStatus:"SENT",sentAt:w,lastError:null,dateFinalisation:w}),G.info("✅ Métrage envoyé avec succès",{metrage_id:f.metrage_id,client:c.client}),{success:!0}}else throw new Error(i.error||"Réponse serveur invalide")}catch(d){clearTimeout(y);let i;return d.name==="AbortError"?i="Connexion trop lente (délai 15s dépassé)":d.message.includes("Failed to fetch")||d.message.includes("NetworkError")?i="Pas de connexion réseau":i=d.message,r==null||r({sendStatus:"ERROR",lastError:i}),G.error("â Œ Échec envoi métrage",{error:i,client:c.client}),{success:!1,error:i}}}const Fe=({chantier:c,products:j,incompleteCount:x,onClose:r,onStatusChange:t,onSuccess:v,onError:f})=>{const[C,y]=b.useState({cotes:!1,options:!1}),[A,d]=b.useState(!1),[i,w]=b.useState(!1),E=C.cotes&&C.options,n=async()=>{d(!0);const l=Te(c,j,new Date().toISOString()),h=await Pe(c,j,l,t);h.success?(d(!1),w(!0),setTimeout(()=>{v==null||v()},1500)):(d(!1),f==null||f(h.error))};return e.jsx(ne,{isOpen:!0,onClose:A||i?void 0:r,title:i?"✓ Envoyé !":"Êtes-vous sûr ?",size:"md",children:e.jsxs("div",{className:"relative min-h-[360px] flex flex-col",children:[i&&e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center animate-fade-in z-10",children:[e.jsxs("div",{className:"relative mb-6",children:[e.jsx("div",{className:"absolute inset-0 bg-green-100 dark:bg-green-900/30 rounded-full scale-150 animate-pulse"}),e.jsx("div",{className:"bg-green-500 text-white rounded-full p-6 shadow-xl shadow-green-500/40 relative z-10 animate-bounce",children:e.jsx(ae,{size:48,strokeWidth:3})})]}),e.jsx("h3",{className:"text-2xl font-bold text-slate-800 dark:text-white mb-2",children:"Dossier Envoyé !"}),e.jsx("p",{className:"text-slate-500 dark:text-slate-400 text-center text-sm",children:"Le métrage a été transmis au bureau"})]}),!i&&e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"space-y-3 mb-6",children:[e.jsx(ee,{checked:C.cotes,onChange:l=>y(h=>({...h,cotes:l})),label:"J'ai vérifié toutes les cotes"}),e.jsx(ee,{checked:C.options,onChange:l=>y(h=>({...h,options:l})),label:"J'ai vérifié les options"})]}),e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 mb-4 flex items-start gap-3",children:[e.jsx("div",{className:"bg-red-100 dark:bg-red-900/50 p-2 rounded-lg shrink-0",children:e.jsx(B,{className:"text-red-600 dark:text-red-400",size:20})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold text-red-700 dark:text-red-300 text-sm",children:"Action irréversible"}),e.jsx("p",{className:"text-red-600 dark:text-red-400 text-xs mt-1 leading-relaxed",children:"Le dossier sera verrouillé après envoi."})]})]}),e.jsxs("div",{className:"bg-slate-50 dark:bg-slate-800 rounded-xl p-4 mb-6 border border-slate-100 dark:border-slate-700",children:[e.jsxs("div",{className:"flex justify-between text-sm mb-2",children:[e.jsx("span",{className:"text-slate-600 dark:text-slate-400",children:"Total Produits"}),e.jsx("span",{className:"font-bold text-slate-800 dark:text-white bg-white dark:bg-slate-700 px-2 py-0.5 rounded border border-slate-200 dark:border-slate-600",children:j.reduce((l,h)=>l+(h.quantity||1),0)})]}),x>0&&e.jsxs("div",{className:"flex justify-between text-sm mt-2 pt-2 border-t border-slate-200 dark:border-slate-700",children:[e.jsxs("span",{className:"text-amber-600 dark:text-amber-400 flex items-center gap-2",children:[e.jsx(B,{size:16})," Incomplets"]}),e.jsx("span",{className:"font-bold text-white bg-amber-500 px-2 py-0.5 rounded text-xs",children:x})]})]}),e.jsxs("div",{className:"mt-auto space-y-3",children:[e.jsx(L,{onClick:n,disabled:!E||A,className:`w-full py-4 text-base transition-all duration-300 ${E?"translate-y-0 opacity-100":"opacity-80"}`,icon:A?null:le,children:A?e.jsxs("span",{className:"flex items-center justify-center gap-3",children:[e.jsx(se,{size:20}),e.jsx("span",{children:"Transmission en cours..."})]}):"Confirmer l'envoi"}),e.jsx(L,{onClick:r,variant:"ghost",className:"w-full py-3",disabled:A,children:"Annuler"})]})]})]})})},Ue=({onClose:c,onUnlock:j})=>{const[x,r]=b.useState(""),t=x.toUpperCase()==="MODIFIER";return e.jsxs(ne,{isOpen:!0,onClose:c,title:"Déverrouiller le dossier",size:"sm",children:[e.jsxs("p",{className:"text-slate-600 dark:text-slate-400 mb-4 text-sm",children:["Pour modifier un dossier déjà  envoyé, saisissez ",e.jsx("strong",{className:"text-slate-800 dark:text-white",children:"MODIFIER"})," ci-dessous."]}),e.jsx(F,{value:x,onChange:r,placeholder:"Tapez MODIFIER",className:"mb-6"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(L,{onClick:j,disabled:!t,variant:t?"danger":"secondary",className:"w-full py-4",icon:we,children:"Déverrouiller"}),e.jsx(L,{onClick:c,variant:"ghost",className:"w-full",children:"Annuler"})]})]})},Ve=()=>{const{state:c,selectChantier:j,deleteProduct:x,saveProduct:r,updateChantier:t}=te(),[v,f]=b.useState(null),[C,y]=b.useState(!1),[A,d]=b.useState(!1),[i,w]=b.useState(!1),[E,n]=b.useState(null),l=c.chantiers.find(a=>a.id===c.currentChantierId);if(l&&l.deleted)return null;const h=(c.products||[]).filter(a=>a.chantierId===(l==null?void 0:l.id)&&!a.deleted).sort((a,m)=>a.index-m.index),U=(l==null?void 0:l.sendStatus)||"DRAFT",k=U==="SENT",p=U==="SENDING",S=U==="ERROR",s=!l.dateIntervention&&!k;let g=1;l.dateIntervention&&(g=2),l.dateIntervention&&h.length>0&&(g=3),k&&(g=4);const T=()=>{if(k)return;const a=h[h.length-1],m=a?{matiere:a.matiere,profil:a.profil,couleur:a.couleur,couleurAutre:a.couleurAutre,isoMm:a.isoMm}:{};f({id:X(),chantierId:l.id,index:h.length+1,type:"FENETRE",quantity:1,dateCreation:new Date().toISOString(),photos:[],isValid:!1,validationErrors:[],...m})},I=(a,m)=>{a.stopPropagation(),!k&&r({...m,id:X(),index:h.length+1,dateCreation:new Date().toISOString()})},$=a=>t(l.id,a),o=()=>{y(!1)},N=a=>{y(!1),n({message:`Échec : ${a}`,type:"error"})},M=()=>{t(l.id,{sendStatus:"DRAFT",sentAt:null,lastError:null}),d(!1),n({message:"Dossier déverrouillé",type:"info"})};if(!l)return null;if(v)return e.jsx(Ie,{product:v,onSave:a=>{r(a),f(null)},onCancel:()=>f(null),isReadOnly:k});const P=h.reduce((a,m)=>a+(m.quantity||1),0),u=h.filter(a=>!a.isValid).length;return e.jsxs("div",{className:"flex flex-col h-screen bg-slate-50 dark:bg-slate-950",children:[e.jsxs("div",{className:"bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-10 shadow-sm safe-top-padding",children:[e.jsx("div",{className:"px-4 py-3 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center flex-1 min-w-0",children:[e.jsx("button",{onClick:()=>j(null),className:"mr-3 p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-200",children:e.jsx(ge,{size:24})}),e.jsxs("div",{className:"truncate flex-1 cursor-pointer",onClick:()=>!k&&w(!0),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h2",{className:"font-bold text-lg dark:text-white truncate",children:l.client}),k?e.jsx(V,{size:16,className:"text-green-600"}):e.jsx(fe,{size:16,className:"text-slate-400"})]}),e.jsxs("div",{className:"text-xs text-slate-500 flex flex-col gap-1 mt-1",children:[e.jsx(Ee,{address:l.adresse,gps:l.gps,className:"text-slate-500 hover:text-brand-600"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded",children:[P," Produit(s)"]}),e.jsxs("span",{children:["• ",l.typeContrat==="FOURNITURE_ET_POSE"?"Pose":l.typeContrat==="SOUS_TRAITANCE"?"Sous-traitance":"Fourn. Seule"]})]})]})]})]})}),e.jsx(Me,{currentStep:g})]}),k&&e.jsxs(O,{variant:"success",icon:V,action:"Modifier",onAction:()=>d(!0),children:["Dossier verrouillé le ",new Date(l.sentAt).toLocaleDateString("fr-FR")," à  ",new Date(l.sentAt).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})]}),S&&e.jsxs(O,{variant:"error",icon:re,children:["Échec de l'envoi : ",l.lastError]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 max-w-5xl mx-auto w-full pb-32",children:[s&&e.jsx("div",{className:"mb-6 bg-white dark:bg-slate-900 rounded-xl p-6 shadow-lg border-2 border-brand-500 animate-fade-in",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"bg-brand-100 dark:bg-brand-900/30 p-3 rounded-full text-brand-600 dark:text-brand-400 shrink-0",children:e.jsx(je,{size:32})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-lg font-bold text-slate-800 dark:text-white mb-1",children:"Ce dossier n'est pas planifié !"}),e.jsx("p",{className:"text-slate-500 text-sm mb-4",children:"Sélectionnez la date d'intervention pour passer à l'étape suivante."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"datetime-local",className:"flex-1 p-3 rounded-lg border-2 border-slate-200 dark:border-slate-700 dark:bg-slate-800 dark:text-white focus:border-brand-500 outline-none font-bold text-slate-700 transition-colors",onChange:a=>{},id:`date-picker-${l.id}`}),e.jsx(L,{variant:"primary",className:"font-bold uppercase",onClick:async()=>{const a=document.getElementById(`date-picker-${l.id}`),m=a==null?void 0:a.value;if(!m)return alert("Veuillez sélectionner une date !");t(l.id,{dateIntervention:m});try{const z={...l,dateIntervention:m},_=await oe(z);_&&t(l.id,{googleEventId:_})}catch(z){console.error(z)}},children:"Valider"})]})]})]})}),l.typeContrat==="SOUS_TRAITANCE"&&e.jsxs("div",{className:"bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 mb-4 flex items-start",children:[e.jsx(ke,{className:"text-amber-600 mt-1 mr-3 shrink-0",size:20}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-bold text-amber-800 dark:text-amber-200 uppercase",children:"Client Final"}),e.jsx("div",{className:"font-medium text-amber-900 dark:text-amber-100",children:l.clientFinal}),e.jsxs("a",{href:`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l.adresseFinale)}`,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-amber-800 dark:text-amber-300 hover:underline flex items-center",children:[e.jsx(MapPin,{size:12,className:"mr-1"}),l.adresseFinale]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[h.map(a=>e.jsxs("div",{onClick:()=>f(a),className:`bg-white dark:bg-slate-900 rounded-xl p-4 shadow-sm border-l-[6px] cursor-pointer hover:shadow-md transition-all relative group ${a.type.includes("FENETRE")?"border-l-orange-500":a.type.includes("PORTE")?"border-l-green-500":"border-l-orange-500"} border-t border-r border-b border-slate-200 dark:border-slate-800 ${k?"opacity-75":""}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("span",{className:"font-bold text-lg dark:text-white",children:["#",String(a.index).padStart(2,"0")]}),a.quantity>1&&e.jsxs("span",{className:"bg-brand-100 text-brand-700 dark:bg-brand-900 dark:text-brand-300 text-xs font-bold px-2 py-1 rounded-full",children:["x",a.quantity]})]}),e.jsx("div",{className:"text-slate-800 dark:text-slate-200 font-medium mb-1",children:a.type}),e.jsxs("div",{className:"text-sm text-slate-500 mb-3",children:[a.largeurMm," x ",a.hauteurMm," mm ",a.room&&`• ${a.room}`]}),!a.isValid&&e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-300 px-2 py-1 rounded text-xs inline-flex items-center mb-2",children:[e.jsx(B,{size:12,className:"mr-1"})," Incomplet"]}),!k&&e.jsxs("div",{className:"flex justify-end gap-3 mt-2 pt-3 border-t border-slate-100 dark:border-slate-800",children:[e.jsx("button",{onClick:m=>I(m,a),className:"text-slate-400 hover:text-brand-600 p-1",children:e.jsx(Ne,{size:18})}),e.jsx("button",{onClick:m=>{m.stopPropagation(),confirm("Supprimer ?")&&x(a.id)},className:"text-slate-400 hover:text-red-600 p-1",children:e.jsx(W,{size:18})})]})]},a.id)),!k&&e.jsxs("button",{onClick:T,className:"min-h-[160px] border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 hover:border-brand-400 transition-colors",children:[e.jsx("div",{className:"bg-slate-100 dark:bg-slate-800 p-4 rounded-full mb-2",children:e.jsx(ve,{size:24})}),e.jsx("span",{className:"font-medium",children:"Ajouter"})]})]})]}),!k&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 p-4 safe-pb z-40 shadow-lg",children:e.jsx(L,{onClick:()=>y(!0),disabled:p,className:"w-full py-4 text-base font-bold",icon:p?null:le,children:p?e.jsxs("span",{className:"flex items-center justify-center gap-3",children:[e.jsx(se,{size:20}),"Transmission en cours..."]}):"ENVOYER AU BUREAU"})}),k&&e.jsx("div",{className:"fixed bottom-0 left-0 right-0 bg-green-50 dark:bg-green-900/20 border-t border-green-200 dark:border-green-800 p-4 safe-pb z-40",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-700 dark:text-green-300",children:[e.jsx(V,{size:16}),e.jsxs("span",{className:"text-sm font-medium",children:["Dossier verrouillé le ",new Date(l.sentAt).toLocaleDateString("fr-FR")]})]})}),C&&e.jsx(Fe,{chantier:l,products:h,incompleteCount:u,onClose:()=>y(!1),onStatusChange:$,onSuccess:o,onError:N}),A&&e.jsx(Ue,{onClose:()=>d(!1),onUnlock:M}),i&&e.jsx(Ce,{chantier:l,onClose:()=>w(!1),onUpdate:a=>t(l.id,a)}),E&&e.jsx(de,{message:E.message,type:E.type,onClose:()=>n(null)})]})};export{Ve as ChantierDetailView};
