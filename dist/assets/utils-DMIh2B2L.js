const m={logs:[],add(e,i,r){const o={ts:new Date().toISOString(),level:e,msg:i,data:r};this.logs.push(o),(console[e]?console[e]:console.log)(`[Sarange] ${i}`,r||""),this.logs.length>1e3&&this.logs.shift()},info(e,i){this.add("info",e,i)},warn(e,i){this.add("warn",e,i)},error(e,i){this.add("error",e,i)},getBlob(){return new Blob([JSON.stringify(this.logs,null,2)],{type:"application/json"})}},y="SarangeDB_V2",v=1,O={db:null,async init(){return m.info("Connexion DB..."),new Promise((e,i)=>{const r=setTimeout(()=>i(new Error("Timeout connexion DB")),3e3);try{const o=indexedDB.open(y,v);o.onerror=n=>{clearTimeout(r),i(n.target.error)},o.onsuccess=n=>{clearTimeout(r),this.db=n.target.result,m.info("DB Connect√©e"),e(this.db)},o.onupgradeneeded=n=>{m.info("Migration DB...");const a=n.target.result;a.objectStoreNames.contains("data")||a.createObjectStore("data",{keyPath:"key"})},o.onblocked=()=>m.warn("DB bloqu√©e (autre onglet ?)")}catch(o){clearTimeout(r),i(o)}})},async get(e){return this.db||await this.init(),new Promise((i,r)=>{try{const o=this.db.transaction("data","readonly").objectStore("data").get(e);o.onsuccess=()=>i(o.result?o.result.value:null),o.onerror=()=>r(o.error)}catch(o){r(o)}})},async set(e,i){return this.db||await this.init(),new Promise((r,o)=>{try{const n=this.db.transaction("data","readwrite").objectStore("data").put({key:e,value:i});n.onsuccess=()=>r(),n.onerror=()=>o(n.error)}catch(n){o(n)}})}},A=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const i=Math.random()*16|0;return(e==="x"?i:i&3|8).toString(16)}),M=e=>new Promise(i=>{const r=new FileReader;r.readAsDataURL(e),r.onload=o=>{const n=new Image;n.src=o.target.result,n.onload=()=>{const a=document.createElement("canvas"),c=a.getContext("2d"),u=Math.min(1,1200/n.width);a.width=n.width*u,a.height=n.height*u,c.drawImage(n,0,0,a.width,a.height),i(a.toDataURL("image/jpeg",.6))}}}),E={isMeasureSuspicious:(e,i)=>i?!1:e!==void 0&&e>0&&e<300,hasAdvancedOptions:e=>["FENETRE","PORTE_FENETRE","VOLET_ROULANT","PORTE_ENTREE"].includes(e),validateProduct:e=>{const i=[];if(e.type!=="AUTRE"?(e.largeurMm||i.push("largeurMm"),!e.hauteurMm&&!e.monobloc&&i.push("hauteurMm")):e.description||i.push("description"),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE","PORTE_ENTREE","PORTE_SERVICE"].includes(e.type)){if(e.matiere||i.push("matiere"),e.profil||i.push("profil"),e.couleur||i.push("couleur"),e.couleur==="AUTRE"&&!e.couleurAutre&&i.push("couleurAutre"),e.profil==="ISO"&&!e.isoMm&&i.push("isoMm"),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE"].includes(e.type)){const r=e.vitrageFlags||{};Object.values(r).some(o=>o===!0)||i.push("vitrageFlags")}e.type==="PORTE_ENTREE"&&(e.remplissage||i.push("remplissage"))}return e.type==="VOLET_ROULANT"&&(e.manoeuvre||i.push("manoeuvre"),(e.manoeuvre==="FILAIRE"||e.manoeuvre==="RADIO")&&!e.sortieCable&&e.manoeuvre!=="SOLAIRE"&&i.push("sortieCable"),e.monobloc&&!e.coffreADeduireMm&&i.push("coffreADeduireMm")),{isValid:i.length===0,errors:i}}},w=e=>{const i=[];return e.oscilloBattant&&i.push("Oscillo-battant"),e.grilleVentilation&&i.push("Grille ventilation"),e.poigneeCle&&i.push("Poign√©e √† cl√©"),e.ouvertureExterieure&&i.push("Ouverture ext√©rieure"),e.tierceImposte&&i.push("Tierce/Imposte"),e.tierce&&i.push(`Tierce (passage ${e.cotePassageMm}mm)`),e.monobloc&&i.push(`Monobloc (coffre ${e.coffreADeduireMm}mm)`),e.boxDomotique&&i.push("Box domotique"),e.manoeuvre&&i.push(`Man≈ìuvre ${e.manoeuvre}`),e.sortieCable&&i.push(`Sortie c√¢ble ${e.sortieCable}`),e.coupleMoteur&&i.push(`Couple ${e.coupleMoteur}Nm`),e.pose&&i.push(`Pose ${e.pose}`),e.poigneeHauteur==="AUTRE"&&e.poigneeHauteurMm&&i.push(`Poign√©e ${e.poigneeHauteurMm}mm`),i.join(", ")},S=(e=[],i=[])=>{const r=new Map;return e.forEach(o=>{r.set(o.id,o)}),i.forEach(o=>{const n=r.get(o.id);if(!n)r.set(o.id,o);else{const a=new Date(o.updatedAt||0).getTime(),c=new Date(n.updatedAt||0).getTime();a>c&&r.set(o.id,o)}}),Array.from(r.values())},$=e=>{if(!e||!e.lines||e.lines.length===0)return"";let i="";return e.lines.forEach(r=>{if(r.length<2)return;let o=`M ${r[0].x} ${r[0].y}`;for(let n=1;n<r.length;n++)o+=` L ${r[n].x} ${r[n].y}`;i+=`<path d="${o}" stroke="#2563EB" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>`}),`<svg width="100%" height="100%" viewBox="0 0 350 250" preserveAspectRatio="xMidYMid meet">${i}</svg>`},I=(e,i,r)=>{const o=new Date(r),n=o.toLocaleDateString("fr-FR"),a=o.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),c="@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');@page{margin:15mm}body{font-family:'Inter',sans-serif;max-width:1000px;margin:0 auto;padding:20px;color:#1e293b;line-height:1.4}.header{display:flex;justify-content:space-between;border-bottom:3px solid #2563EB;padding-bottom:20px;margin-bottom:30px}.client-box{background:#f8fafc;padding:20px;border-radius:8px;flex:1;margin-right:20px;border:1px solid #e2e8f0}.meta-box{flex:0 0 300px;text-align:right}.stat-badge{display:inline-block;padding:5px 12px;border-radius:20px;font-weight:bold;font-size:0.9em;margin-bottom:5px}.product-card{border:1px solid #cbd5e1;border-radius:8px;margin-bottom:20px;overflow:hidden;page-break-inside:avoid;box-shadow:0 2px 4px rgba(0,0,0,0.05)}.product-header{background:#f1f5f9;padding:12px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #cbd5e1;font-weight:700;color:#334155}.product-body{display:grid;grid-template-columns:60% 40%}.specs{padding:15px;font-size:0.9em}.visuals{padding:15px;background:#fcfcfc;border-left:1px solid #e2e8f0;display:flex;flex-direction:column;align-items:center;justify-content:center}table.spec-table{width:100%;border-collapse:collapse}table.spec-table td{padding:4px 0;vertical-align:top}.label{color:#64748b;font-weight:600;width:140px}.value{color:#0f172a;font-weight:500}.drawing-container{border:1px dashed #cbd5e1;width:100%;height:160px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;border-radius:4px}.photo-row{display:flex;gap:5px;flex-wrap:wrap;justify-content:center}.photo-img{width:80px;height:80px;object-fit:cover;border-radius:4px;border:1px solid #eee}.alert-text{color:#d97706;font-weight:bold}.notes-box{margin-top:10px;padding:10px;background:#fffbeb;border:1px solid #fcd34d;border-radius:4px;color:#92400e;font-style:italic}.final-client-box{background:#fffbeb;padding:15px;border:1px solid #fcd34d;border-radius:8px;margin-bottom:30px}@media print{body{padding:0;margin:0}}";let u="",g="";e.typeContrat==="FOURNITURE_ET_POSE"?(u="#dcfce7;color:#166534",g="FOURNITURE ET POSE"):e.typeContrat==="SOUS_TRAITANCE"?(u="#fef3c7;color:#92400e",g="SOUS-TRAITANCE"):(u="#dbeafe;color:#1e40af",g="FOURNITURE SEULE");let h=`<!DOCTYPE html><html><head><meta charset="utf-8"><title>Relev√© ${e.client}</title><style>${c}</style></head><body onload="window.print()"><div class="header"><div class="client-box"><h1 style="margin:0 0 10px 0;color:#2563EB;">${e.client}</h1><div>üìç ${e.adresse}</div><div>üìû ${e.telephone} ${e.email?` ‚Ä¢ ‚úâÔ∏è ${e.email}`:""}</div></div><div class="meta-box"><div class="stat-badge" style="background:${u}">${g}</div><br><strong>Date:</strong> ${n} √† ${a}<br><strong>Produits:</strong> ${i.reduce((t,f)=>t+(f.quantity||1),0)}<br></div></div>${e.typeContrat==="SOUS_TRAITANCE"?`<div class="final-client-box"><strong>üë∑ CLIENT FINAL (CHANTIER) :</strong> ${e.clientFinal} - ${e.adresseFinale}</div>`:""}`;return i.forEach(t=>{var b;let f="";const s=(d,l)=>{l!=null&&l!==!1&&l!==""&&(f+=`<tr><td class="label">${d}</td><td class="value">${l===!0?"OUI":l}</td></tr>`)};t.room&&s("Localisation",`<strong>${t.room}</strong>`),s("Quantit√©",`<strong>x ${t.quantity||1}</strong>`);let x=`<strong>L ${t.largeurMm} x H ${t.hauteurMm} mm</strong>`;if(t.monobloc&&t.coffreADeduireMm&&t.hauteurMm&&(x+=`<br><span style="font-size:0.9em;color:#64748b">Passage = <strong>${t.hauteurMm-t.coffreADeduireMm} mm</strong> (Coffre ${t.coffreADeduireMm})</span>`),s("Dimensions",x),(E.isMeasureSuspicious(t.largeurMm,t.monobloc)||E.isMeasureSuspicious(t.hauteurMm,t.monobloc))&&(f+='<tr><td class="label">‚ö†Ô∏è Attention</td><td class="value alert-text">Cote < 300mm</td></tr>'),["FENETRE","PORTE_FENETRE","BAIE_COULISSANTE","PORTE_ENTREE","PORTE_SERVICE"].includes(t.type)){if(s("Mati√®re",t.matiere),s("Profil",`${t.profil} ${t.profil==="ISO"?`(${t.isoMm}mm)`:""}`),s("Couleur",`${t.couleur} ${t.couleurAutre||""}`),t.vitrageFlags){const d=t.vitrageFlags,l=[];d.standard&&l.push("4/20/4"),d.g200&&l.push("G200"),d.feuillete1f&&l.push("Feuillet√© (1F)"),d.feuillete2f&&l.push("Feuillet√© (2F)"),l.length&&s("Vitrage",l.join(", "))}(t.type==="FENETRE"||t.type==="PORTE_FENETRE")&&(s("Oscillo-Battant",t.oscilloBattant),s("Grille Vent.",t.grilleVentilation),t.poigneeHauteur==="AUTRE"&&t.poigneeHauteurMm&&s("Hauteur Poign√©e",`${t.poigneeHauteurMm} mm`),s("Poign√©e Cl√©",t.poigneeCle),s("Ouv. Ext.",t.ouvertureExterieure),t.type==="FENETRE"&&t.pieceAppuiDescription&&s("Pi√®ce Appui",t.pieceAppuiDescription),t.type==="PORTE_FENETRE"&&(s("Soubassement",t.soubassement?`${t.soubassementHauteurMm}mm`:!1),s("Serrure",t.serrure),s("Seuil PMR",t.seuilPMR))),t.type==="PORTE_ENTREE"&&(s("Remplissage",t.remplissage==="PANNEAU_DECORATIF_ALU"?"Panneau D√©co Alu":t.remplissage),s("Seuil PMR","OUI"),t.tierceImposte&&s("Tierce/Imposte","OUI"),t.tierce&&s("Tierce",`Passage: ${t.cotePassageMm}mm`),s("Ouv. Ext.",t.ouvertureExterieure)),t.type==="PORTE_SERVICE"&&s("Seuil PMR","OUI")}t.type==="VOLET_ROULANT"&&(s("Manoeuvre",t.manoeuvre),t.sortieCable&&s("Sortie C√¢ble",t.sortieCable),t.manoeuvre!=="FILAIRE"&&t.boxDomotique&&s("Box Domo","OUI"),t.coupleMoteur&&s("Couple",`${t.coupleMoteur}Nm`),t.pose&&s("Pose",t.pose),t.monobloc&&s("Monobloc",`OUI (Coffre: ${t.coffreADeduireMm}mm)`),t.lieAProduitId&&s("Li√© √†",`#${((b=i.find(d=>d.id===t.lieAProduitId))==null?void 0:b.index)||"?"}`)),t.type==="AUTRE"&&s("Description",t.description);const p=t.dessin&&t.dessin.lines.length>0?`<div class="drawing-container">${$(t.dessin)}</div>`:"",T=t.photos&&t.photos.length>0?`<div class="photo-row">${t.photos.map(d=>`<img src="${d}" class="photo-img"/>`).join("")}</div>`:"",R=t.notes?`<div class="notes-box">Note: ${t.notes}</div>`:"";h+=`<div class="product-card" style="${t.isValid?"":"border-color:#ef4444;border-width:2px"}"><div class="product-header"><span>#${String(t.index).padStart(2,"0")} - ${t.type}</span>${t.isValid?"":'<span style="color:#ef4444">‚ö†Ô∏è INCOMPLET</span>'}</div><div class="product-body"><div class="specs"><table class="spec-table">${f}</table>${R}</div><div class="visuals">${p}${T}</div></div></div>`}),h+="</body></html>",h};export{O as D,m as L,E as V,I as a,w as b,M as c,A as g,S as m};
