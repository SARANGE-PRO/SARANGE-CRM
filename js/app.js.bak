import React, { useState, useEffect, useRef, useMemo, createContext, useContext, useCallback } from 'https://esm.sh/react@18.2.0';
import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
import { Plus, Trash2, Save, ArrowLeft, FileText, Check, AlertTriangle, PenTool, X, ChevronDown, ChevronUp, Share, Printer, CheckCircle, Download, Eye, Clock, MessageCircle, MapPin, Copy, Camera, Image as ImageIcon, Moon, Sun, LayoutDashboard, Search, Settings, AlertCircle, Mail, Maximize, Droplets, Edit, UserCheck, Lock, Unlock, Send, Phone } from 'https://esm.sh/lucide-react@0.263.1';


import { DB, Logger } from "./js/db.js";
import { generateUUID, compressImage, ValidationService, buildOptionsString } from "./js/utils.js";
import { generateSVG, generateReportHTML } from "./js/reports.js";
import { Button, Input, SelectToggle, Card, Modal, StatusBanner, Toast, Checkbox, Spinner } from "./js/ui.js";


const AddressInput = ({ value, onChange }) => {
  const [s, setS] = useState([]), [o, setO] = useState(false), r = useRef(null), d = useRef(null);
  useEffect(() => { const h = e => { if (r.current && !r.current.contains(e.target)) setO(false) }; document.addEventListener("mousedown", h); return () => document.removeEventListener("mousedown", h) }, []);
  const fA = async q => { try { const res = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(q)}&limit=5`); if (res.ok) { const j = await res.json(); setS(j.features || []); setO(true) } } catch { } };
  const h = (e) => { const v = e.target.value; onChange(v); if (d.current) clearTimeout(d.current); if (v.length > 3) d.current = setTimeout(() => fA(v), 300); else setO(false) };
  const g = () => {
    if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') { alert("Connexion non sÃ©curisÃ©e : Localisation indisponible."); return }
    if (navigator.geolocation) navigator.geolocation.getCurrentPosition(async p => { try { const rs = await fetch(`https://api-adresse.data.gouv.fr/reverse/?lon=${p.coords.longitude}&lat=${p.coords.latitude}`); const j = await rs.json(); if (j.features?.length) onChange(j.features[0].properties.label) } catch { } }, e => alert("Erreur GPS."))
  };
  return <div className="relative mb-4" ref={r}><label className="block text-sm font-medium mb-1.5 text-slate-700 dark:text-slate-300">Adresse</label><div className="relative"><input className="w-full p-3 pl-10 border border-slate-200 dark:border-slate-700 rounded-lg outline-none focus:border-brand-500 dark:bg-slate-900 dark:text-white" placeholder="Adresse..." value={value} onChange={h} /><MapPin size={18} className="absolute left-3 top-3.5 text-slate-400" /><button onClick={g} className="absolute right-2 top-2 p-1.5 text-brand-600 hover:bg-brand-50 rounded"><MapPin size={18} /></button></div>{o && s.length > 0 && <ul className="suggestions-list">{s.map(i => <li key={i.properties.id} onClick={() => { onChange(i.properties.label); setO(false) }} className="p-3 border-b dark:border-slate-700 hover:bg-brand-50 dark:hover:bg-slate-800 cursor-pointer flex flex-col group"><span className="font-medium text-sm text-slate-800 dark:text-slate-200">{i.properties.name}</span><span className="text-xs text-slate-500">{i.properties.postcode} {i.properties.city}</span></li>)}</ul>}</div>;
};

const DrawingCanvas = ({ data, onChange, disabled = false }) => {
  const r = useRef(null), fsR = useRef(null), [l, setL] = useState(data?.lines || []), [iD, setID] = useState(false), [isFS, setIsFS] = useState(false);
  const BW = 350, BH = 250;
  useEffect(() => { onChange({ lines: l, width: BW, height: BH }) }, [l]);
  const rnd = (cvs, sc = 1, ox = 0, oy = 0) => { if (!cvs) return; const c = cvs.getContext('2d'); c.clearRect(0, 0, cvs.width, cvs.height); c.save(); c.translate(ox, oy); c.scale(sc, sc); c.fillStyle = "white"; c.fillRect(0, 0, BW, BH); c.lineCap = 'round'; c.lineJoin = 'round'; c.lineWidth = 3; c.strokeStyle = '#2563EB'; l.forEach(x => { if (x.length < 1) return; c.beginPath(); c.moveTo(x[0].x, x[0].y); for (let i = 1; i < x.length; i++)c.lineTo(x[i].x, x[i].y); c.stroke() }); c.restore() };
  useEffect(() => { rnd(r.current) }, [l]);
  const [fL, setFL] = useState({ s: 1, x: 0, y: 0 });
  useEffect(() => { if (!isFS || !fsR.current) return; const c = fsR.current; c.width = window.innerWidth; c.height = window.innerHeight; const s = Math.min(c.width / BW, c.height / BH) * 0.95, x = (c.width - BW * s) / 2, y = (c.height - BH * s) / 2; setFL({ s, x, y }); rnd(c, s, x, y) }, [isFS, l]);
  const gP = (e, sc = 1, ox = 0, oy = 0) => { const rect = e.target.getBoundingClientRect(), t = e.touches ? e.touches[0] : e; return { x: (t.clientX - rect.left - ox) / sc, y: (t.clientY - rect.top - oy) / sc } };
  const st = (e, m) => { if (disabled) return; if (e.cancelable) e.preventDefault(); setID(true); const cv = m === 'fs' ? fsR.current : r.current, { s, x, y } = m === 'fs' ? fL : { s: 1, x: 0, y: 0 }; setL(p => [...p, [gP(e, s, x, y)]]) };
  const mv = (e, m) => { if (disabled || !iD) return; if (e.cancelable) e.preventDefault(); const cv = m === 'fs' ? fsR.current : r.current, { s, x, y } = m === 'fs' ? fL : { s: 1, x: 0, y: 0 }; const pt = gP(e, s, x, y); setL(p => { const n = [...p]; n[n.length - 1] = [...n[n.length - 1], pt]; return n }) };
  return <><div className={`bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-lg p-3 relative group ${disabled ? 'opacity-70' : ''}`}><div className="flex justify-between mb-2 text-xs text-slate-500 uppercase font-bold tracking-wide"><span className="flex items-center"><PenTool size={14} className="mr-1" /> Croquis <span className="ml-2 text-brand-600 dark:text-brand-400 font-bold">â€” VUE INTÃ‰RIEUR</span> {disabled && '(lecture seule)'}</span>{!disabled && <div className="flex gap-2"><button onClick={() => setL(p => p.slice(0, -1))} className="hover:text-brand-600">Annuler</button><button onClick={() => confirm("Effacer ?") && setL([])} className="text-red-500 hover:text-red-700">Effacer</button></div>}</div><div className="relative"><canvas ref={r} width={BW} height={BH} className={`w-full h-48 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-600 rounded touch-none shadow-inner ${disabled ? 'cursor-not-allowed' : 'cursor-crosshair'}`} onMouseDown={e => st(e, 'sm')} onMouseMove={e => mv(e, 'sm')} onMouseUp={() => setID(false)} onMouseLeave={() => setID(false)} onTouchStart={e => st(e, 'sm')} onTouchMove={e => mv(e, 'sm')} onTouchEnd={() => setID(false)} />{!disabled && <button onClick={() => setIsFS(true)} className="absolute top-2 right-2 p-2 bg-white/80 dark:bg-slate-800/80 backdrop-blur rounded-full shadow border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300"><Maximize size={20} /></button>}</div></div>{isFS && !disabled && <div className="fixed inset-0 z-50 bg-slate-950 flex items-center justify-center touch-none"><canvas ref={fsR} className="block cursor-crosshair" onMouseDown={e => st(e, 'fs')} onMouseMove={e => mv(e, 'fs')} onMouseUp={() => setID(false)} onMouseLeave={() => setID(false)} onTouchStart={e => st(e, 'fs')} onTouchMove={e => mv(e, 'fs')} onTouchEnd={() => setID(false)} /><div className="absolute top-4 right-4"><button onClick={() => setIsFS(false)} className="p-3 bg-red-600 text-white rounded-full shadow-lg"><X size={24} /></button></div><div className="absolute bottom-8 left-1/2 -translate-x-1/2 flex gap-4 bg-slate-800/90 backdrop-blur p-2 rounded-full border border-slate-700"><button onClick={() => setL(p => p.slice(0, -1))} className="px-6 py-2 bg-slate-700 text-white rounded-full font-bold">Annuler</button><button onClick={() => confirm("Tout effacer ?") && setL([])} className="px-6 py-2 bg-red-900/50 text-red-200 rounded-full font-bold">Effacer</button><button onClick={() => setIsFS(false)} className="px-6 py-2 bg-green-600 text-white rounded-full font-bold flex items-center"><Check size={18} className="mr-2" /> OK</button></div></div>}</>;
};

/* --- BOOT SCREEN COMPONENT --- */
const BootScreen = ({ step, error, onRetry }) => {
  const [showLogs, setShowLogs] = useState(false);
  return (
    <div className="flex flex-col items-center justify-center h-screen bg-slate-50 dark:bg-slate-900 absolute inset-0 z-50 p-4">
      <div className="text-4xl mb-6 animate-bounce">ðŸ—ï¸</div>
      <h1 className="text-2xl font-bold text-slate-800 dark:text-white mb-2">Sarange Pro</h1>

      {error ? (
        <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-6 rounded-xl max-w-sm w-full text-center animate-fade-in">
          <AlertCircle size={48} className="mx-auto text-red-500 mb-4" />
          <h3 className="font-bold text-lg text-red-700 dark:text-red-300 mb-2">Erreur de dÃ©marrage</h3>
          <p className="text-sm text-red-600 dark:text-red-400 mb-6">{error.message}</p>
          <div className="space-y-3">
            <Button onClick={onRetry} variant="primary" className="w-full">RÃ©essayer</Button>
            <div className="flex gap-2">
              <Button onClick={() => setShowLogs(!showLogs)} variant="secondary" className="flex-1 text-xs">Logs</Button>
              <Button onClick={() => { const u = URL.createObjectURL(Logger.getBlob()); window.open(u) }} variant="secondary" className="flex-1 text-xs">Download</Button>
            </div>
          </div>
        </div>
      ) : (
        <div className="w-64">
          <div className="flex justify-between text-xs font-bold text-slate-500 mb-2 uppercase tracking-wide">
            <span>Chargement...</span>
            <span>{step}</span>
          </div>
          <div className="h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
            <div className="h-full bg-brand-600 animate-pulse w-full origin-left-right"></div>
          </div>
        </div>
      )}

      {showLogs && (<div className="mt-8 w-full max-w-lg bg-black text-green-400 font-mono text-xs p-4 rounded h-48 overflow-auto border border-slate-700 shadow-2xl">{Logger.logs.map((l, i) => <div key={i}><span className="opacity-50">[{l.ts.split('T')[1].split('.')[0]}]</span> <span className={l.level === 'error' ? 'text-red-400' : l.level === 'warn' ? 'text-amber-400' : ''}>{l.msg}</span></div>)}</div>)}
    </div>
  );
};

const App = () => {
  const [st, setSt] = useState({ chantiers: [], products: [], currentChantierId: null });
  const [boot, setBoot] = useState({ loading: true, step: 'Init', error: null });
  const [view, setView] = useState('list');
  const [dark, setDark] = useState(false);

  const runBoot = async () => {
    try {
      setBoot({ loading: true, step: 'DB', error: null });
      await DB.init();

      setBoot(b => ({ ...b, step: 'Migration' }));
      const old = localStorage.getItem('sarange_db_v3');
      if (old) {
        try {
          Logger.info("Migration depuis LocalStorage...");
          const d = JSON.parse(old);
          await DB.set('sarange_root', d);
          localStorage.removeItem('sarange_db_v3');
          Logger.info("Migration OK");
        } catch (e) { Logger.error("Erreur Migration", e) }
      }

      setBoot(b => ({ ...b, step: 'DonnÃ©es' }));
      const data = await DB.get('sarange_root');
      if (data) setSt(data);

      Logger.info("App Ready");
      setBoot({ loading: false, step: 'Ready', error: null });
    } catch (e) {
      console.error(e);
      Logger.error("Boot Failed", e);
      setBoot({ loading: true, step: 'Erreur', error: e }); // Keep loading true to show BootScreen
    }
  };

  useEffect(() => { runBoot() }, []);

  // Auto-save logic
  const saveTimeout = useRef(null);
  useEffect(() => {
    if (boot.loading) return;
    if (saveTimeout.current) clearTimeout(saveTimeout.current);
    saveTimeout.current = setTimeout(() => {
      DB.set('sarange_root', st).catch(e => Logger.error("AutoSave Fail", e));
    }, 1000);
  }, [st, boot.loading]);

  useEffect(() => {
    if (dark) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
  }, [dark]);

  const act = {
    addChantier: c => setSt(s => ({ ...s, chantiers: [{ ...c, id: generateUUID() }, ...s.chantiers] })),
    updateChantier: (id, d) => setSt(s => ({ ...s, chantiers: s.chantiers.map(x => x.id === id ? { ...x, ...d } : x) })),
    deleteChantier: id => setSt(s => ({ ...s, chantiers: s.chantiers.filter(x => x.id !== id), products: s.products.filter(x => x.chantierId !== id) })),
    selectChantier: id => setSt(s => ({ ...s, currentChantierId: id })),
    saveProduct: p => setSt(s => { const ex = s.products.find(x => x.id === p.id); return { ...s, products: ex ? s.products.map(x => x.id === p.id ? { ...p, dateMaj: new Date().toISOString() } : x) : [...s.products, p] } }),
    deleteProduct: id => setSt(s => ({ ...s, products: s.products.filter(x => x.id !== id) })),
    duplicateChantier: id => { const c = st.chantiers.find(x => x.id === id); if (!c) return; const nId = generateUUID(), nC = { ...c, id: nId, client: c.client + " (Copie)", date: new Date().toISOString(), dateFinalisation: null, sendStatus: 'DRAFT', sentAt: null, lastError: null }, cP = st.products.filter(p => p.chantierId === id).map(p => ({ ...p, id: generateUUID(), chantierId: nId })); setSt(s => ({ ...s, chantiers: [nC, ...s.chantiers], products: [...s.products, ...cP] })) }
  };

  if (boot.loading) return <BootScreen step={boot.step} error={boot.error} onRetry={runBoot} />;

  return <AppContext.Provider value={{ state: st, ...act }}><div className="min-h-screen flex flex-col safe-pb">{!st.currentChantierId ? <DashboardView onNew={() => setView('new')} viewMode={view} setViewMode={setView} isDark={dark} toggleDark={() => setDark(!dark)} /> : <ChantierDetailView />}</div></AppContext.Provider>;
};
const AppContext = createContext(null); const useApp = () => useContext(AppContext);

const DashboardView = ({ onNew, isDark, toggleDark }) => {
  const { state, selectChantier, deleteChantier, duplicateChantier } = useApp();
  const [s, setS] = useState('');
  const [m, setM] = useState(false);
  const [filter, setFilter] = useState('all'); // 'all', 'draft', 'sent'

  // Compteurs
  const countAll = state.chantiers.length;
  const countDraft = state.chantiers.filter(c => !c.sendStatus || c.sendStatus === 'DRAFT' || c.sendStatus === 'ERROR').length;
  const countSent = state.chantiers.filter(c => c.sendStatus === 'SENT').length;

  // Filtrage combinÃ© (recherche + filtre statut)
  const filt = state.chantiers
    .filter(c => c.client.toLowerCase().includes(s.toLowerCase()) || c.adresse.toLowerCase().includes(s.toLowerCase()))
    .filter(c => {
      if (filter === 'draft') return !c.sendStatus || c.sendStatus === 'DRAFT' || c.sendStatus === 'ERROR';
      if (filter === 'sent') return c.sendStatus === 'SENT';
      return true; // 'all'
    });

  // Helper pour afficher le badge de statut
  const StatusBadge = ({ chantier }) => {
    const status = chantier.sendStatus || 'DRAFT';
    if (status === 'SENT') {
      const d = chantier.sentAt ? new Date(chantier.sentAt) : null;
      const dateStr = d ? `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}` : '';
      return <div className="flex flex-col items-center gap-0.5"><CheckCircle size={20} className="text-green-500" /><span className="text-[10px] font-bold text-green-600 dark:text-green-400">{dateStr}</span></div>;
    }
    if (status === 'ERROR') return <div className="flex flex-col items-center gap-0.5"><AlertCircle size={20} className="text-red-500" /><span className="text-[10px] font-bold text-red-600 dark:text-red-400">Erreur</span></div>;
    return <Clock size={20} className="text-orange-400" />;
  };

  // Tile cliquable
  const FilterTile = ({ active, onClick, count, label, colorClass }) => (
    <button
      onClick={onClick}
      className={`p-4 rounded-xl border transition-all text-left ${colorClass} ${active ? 'ring-2 ring-offset-2 ring-brand-500' : 'hover:scale-[1.02]'}`}
    >
      <div className="text-2xl font-bold">{count}</div>
      <div className="text-xs font-medium">{label}</div>
    </button>
  );

  return (
    <>
      <header className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 sticky top-0 z-20 px-4 pb-3 safe-top-padding">
        <div className="flex justify-between items-center mb-4 max-w-5xl mx-auto">
          <div className="flex items-center gap-2">
            <div className="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold">S</div>
            <h1 className="text-xl font-bold tracking-tight">Sarange<span className="text-brand-600">Pro</span></h1>
          </div>
          <button onClick={toggleDark} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-600 dark:text-slate-300">
            {isDark ? <Sun size={20} /> : <Moon size={20} />}
          </button>
        </div>
        <div className="max-w-5xl mx-auto relative">
          <Search className="absolute left-3 top-3 text-slate-400" size={20} />
          <input className="w-full pl-10 p-2.5 bg-slate-100 dark:bg-slate-800 border-0 rounded-xl outline-none focus:ring-2 focus:ring-brand-500 dark:text-white transition-all" placeholder="Rechercher..." value={s} onChange={e => setS(e.target.value)} />
        </div>
      </header>
      <main className="flex-1 p-4 max-w-5xl mx-auto w-full">
        {/* Filtres cliquables */}
        <div className="grid grid-cols-3 gap-3 mb-6">
          <FilterTile
            active={filter === 'all'}
            onClick={() => setFilter('all')}
            count={countAll}
            label="Dossiers"
            colorClass="bg-blue-50 dark:bg-blue-900/20 border-blue-100 dark:border-blue-800/30 text-blue-600 dark:text-blue-400"
          />
          <FilterTile
            active={filter === 'draft'}
            onClick={() => setFilter('draft')}
            count={countDraft}
            label="En cours"
            colorClass="bg-orange-50 dark:bg-orange-900/20 border-orange-100 dark:border-orange-900/30 text-orange-600 dark:text-orange-400"
          />
          <FilterTile
            active={filter === 'sent'}
            onClick={() => setFilter('sent')}
            count={countSent}
            label="EnvoyÃ©s"
            colorClass="bg-green-50 dark:bg-green-900/20 border-green-100 dark:border-green-900/30 text-green-600 dark:text-green-400"
          />
        </div>

        <div className="flex justify-between items-center mb-4">
          <h2 className="font-bold text-slate-700 dark:text-slate-300">
            {filter === 'all' ? 'Tous les dossiers' : filter === 'draft' ? 'Dossiers en cours' : 'Dossiers envoyÃ©s'}
          </h2>
          <Button onClick={() => setM(true)} icon={Plus} className="py-2 text-sm shadow-sm">Nouveau</Button>
        </div>

        <div className="space-y-3">
          {filt.length === 0 && (
            <div className="text-center py-12 text-slate-400">
              <span className="text-4xl">ðŸ“‚</span>
              <p className="mt-2">Aucun dossier {filter !== 'all' ? 'dans cette catÃ©gorie' : ''}</p>
            </div>
          )}
          {filt.map(c => (
            <div
              key={c.id}
              onClick={() => selectChantier(c.id)}
              className={`group bg-white dark:bg-slate-900 p-4 rounded-xl border ${c.sendStatus === 'SENT' ? 'border-green-400 dark:border-green-600' : c.sendStatus === 'ERROR' ? 'border-red-400 dark:border-red-600' : c.typeContrat === 'SOUS_TRAITANCE' ? 'border-amber-400 dark:border-amber-600' : 'border-slate-200 dark:border-slate-800'} shadow-sm active:scale-[0.99] transition-all cursor-pointer hover:border-brand-400 dark:hover:border-brand-600 relative overflow-hidden`}
            >
              <div className="flex justify-between items-start">
                <div>
                  <h3 className="font-bold text-lg dark:text-white group-hover:text-brand-600 transition-colors">{c.client}</h3>
                  <p className="text-sm text-slate-500 flex items-center mt-1"><MapPin size={14} className="mr-1" /> {c.adresse}</p>
                  {(c.telephone || c.email) && (
                    <div className="flex flex-wrap gap-3 mt-2 text-xs text-slate-500">
                      {c.telephone && (
                        <a href={`tel:${c.telephone}`} onClick={e => e.stopPropagation()} className="flex items-center hover:text-brand-600">
                          <Phone size={12} className="mr-1" /> {c.telephone}
                        </a>
                      )}
                      {c.email && (
                        <a href={`mailto:${c.email}`} onClick={e => e.stopPropagation()} className="flex items-center hover:text-brand-600">
                          <Mail size={12} className="mr-1" /> {c.email}
                        </a>
                      )}
                    </div>
                  )}
                  {c.typeContrat === 'SOUS_TRAITANCE' && (
                    <div className="mt-2 text-xs bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-200 px-2 py-1 rounded inline-flex items-center">
                      <UserCheck size={12} className="mr-1" /> Client Final : {c.clientFinal}
                    </div>
                  )}
                </div>
                <StatusBadge chantier={c} />
              </div>
              <div className="mt-4 flex justify-between items-center border-t border-slate-100 dark:border-slate-800 pt-3">
                <span className="text-xs font-mono text-slate-400">{new Date(c.date).toLocaleDateString()}</span>
                <div className="flex gap-3">
                  <button onClick={(e) => { e.stopPropagation(); duplicateChantier(c.id) }} className="text-slate-400 hover:text-brand-500"><Copy size={18} /></button>
                  <button onClick={(e) => { e.stopPropagation(); if (confirm('Supprimer ?')) deleteChantier(c.id) }} className="text-slate-400 hover:text-red-500"><Trash2 size={18} /></button>
                </div>
              </div>
            </div>
          ))}
        </div>
      </main>
      {m && <NewChantierModal onClose={() => setM(false)} />}
    </>
  );
};

const NewChantierModal = ({ onClose }) => {
  const { addChantier } = useApp(), [f, setF] = useState({ client: '', adresse: '', typeContrat: 'FOURNITURE_SEULE', telephone: '', email: '', clientFinal: '', adresseFinale: '' });
  const sub = () => { if (!f.client) return alert('Nom requis'); if (f.typeContrat === 'SOUS_TRAITANCE' && (!f.clientFinal || !f.adresseFinale)) return alert('Client final requis'); addChantier({ ...f, date: new Date().toISOString() }); onClose() };
  return <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end md:items-center justify-center p-4 animate-fade-in"><Card className="w-full max-w-md p-6 shadow-2xl"><h2 className="text-xl font-bold mb-6 dark:text-white">Nouveau Dossier</h2><Input label="Nom Client" value={f.client} onChange={v => setF({ ...f, client: v })} placeholder="Ex: Entreprise BTP" /><AddressInput value={f.adresse} onChange={v => setF({ ...f, adresse: v })} /><div className="grid grid-cols-2 gap-4"><Input label="TÃ©l" value={f.telephone} onChange={v => setF({ ...f, telephone: v })} type="tel" inputMode="tel" pattern="[0-9]*" /><Input label="Email" value={f.email} onChange={v => setF({ ...f, email: v })} type="email" inputMode="email" /></div><SelectToggle label="Contrat" value={f.typeContrat} onChange={v => setF({ ...f, typeContrat: v })} options={[{ label: 'Fourniture Seule', value: 'FOURNITURE_SEULE' }, { label: 'Fourniture & Pose', value: 'FOURNITURE_ET_POSE' }, { label: 'Sous-traitance', value: 'SOUS_TRAITANCE' }]} />{f.typeContrat === 'SOUS_TRAITANCE' && <div className="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700 mb-4 animate-fade-in"><h3 className="text-sm font-bold text-slate-500 mb-2 uppercase flex items-center"><UserCheck size={14} className="mr-1" /> Client Final</h3><Input label="Nom Final" value={f.clientFinal} onChange={v => setF({ ...f, clientFinal: v })} placeholder="Ex: Mme Michu" /><AddressInput value={f.adresseFinale} onChange={v => setF({ ...f, adresseFinale: v })} /></div>}<div className="flex gap-3 mt-6"><Button variant="secondary" onClick={onClose} className="flex-1">Annuler</Button><Button onClick={sub} className="flex-1">CrÃ©er</Button></div></Card></div>;
};

const EditChantierModal = ({ chantier, onClose, onUpdate }) => {
  const [f, setF] = useState({ ...chantier });
  const sub = () => { if (!f.client) return alert('Nom requis'); if (f.typeContrat === 'SOUS_TRAITANCE' && (!f.clientFinal || !f.adresseFinale)) return alert('Client final requis'); onUpdate(f); onClose() };
  return <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end md:items-center justify-center p-4 animate-fade-in"><Card className="w-full max-w-md p-6 shadow-2xl"><h2 className="text-xl font-bold mb-6 dark:text-white">Modifier</h2><Input label="Nom Client" value={f.client} onChange={v => setF({ ...f, client: v })} /><AddressInput value={f.adresse} onChange={v => setF({ ...f, adresse: v })} /><div className="grid grid-cols-2 gap-4"><Input label="TÃ©l" value={f.telephone} onChange={v => setF({ ...f, telephone: v })} type="tel" inputMode="tel" pattern="[0-9]*" /><Input label="Email" value={f.email} onChange={v => setF({ ...f, email: v })} type="email" inputMode="email" /></div><SelectToggle label="Contrat" value={f.typeContrat} onChange={v => setF({ ...f, typeContrat: v })} options={[{ label: 'Fourniture Seule', value: 'FOURNITURE_SEULE' }, { label: 'Fourniture & Pose', value: 'FOURNITURE_ET_POSE' }, { label: 'Sous-traitance', value: 'SOUS_TRAITANCE' }]} />{f.typeContrat === 'SOUS_TRAITANCE' && <div className="bg-slate-50 dark:bg-slate-800 p-3 rounded-lg border border-slate-200 dark:border-slate-700 mb-4 animate-fade-in"><h3 className="text-sm font-bold text-slate-500 mb-2 uppercase flex items-center"><UserCheck size={14} className="mr-1" /> Client Final</h3><Input label="Nom Final" value={f.clientFinal} onChange={v => setF({ ...f, clientFinal: v })} /><AddressInput value={f.adresseFinale} onChange={v => setF({ ...f, adresseFinale: v })} /></div>}<div className="flex gap-3 mt-6"><Button variant="secondary" onClick={onClose} className="flex-1">Annuler</Button><Button onClick={sub} className="flex-1">Enregistrer</Button></div></Card></div>;
};

const ChantierDetailView = () => {
  const { state, selectChantier, deleteProduct, saveProduct, updateChantier } = useApp();
  const [edt, setEdt] = useState(null);
  const [showConfirm, setShowConfirm] = useState(false);
  const [showUnlock, setShowUnlock] = useState(false);
  const [ied, setIed] = useState(false);
  const [toast, setToast] = useState(null);

  const ch = state.chantiers.find(c => c.id === state.currentChantierId);
  const prds = state.products.filter(p => p.chantierId === ch?.id).sort((a, b) => a.index - b.index);

  // Ã‰tat du chantier (fallback DRAFT pour anciens chantiers)
  const sendStatus = ch?.sendStatus || 'DRAFT';
  const isLocked = sendStatus === 'SENT';
  const isSending = sendStatus === 'SENDING';
  const hasError = sendStatus === 'ERROR';

  const addP = () => {
    if (isLocked) return;
    const l = prds[prds.length - 1];
    const d = l ? { matiere: l.matiere, profil: l.profil, couleur: l.couleur, couleurAutre: l.couleurAutre, isoMm: l.isoMm } : {};
    setEdt({ id: generateUUID(), chantierId: ch.id, index: prds.length + 1, type: 'FENETRE', quantity: 1, dateCreation: new Date().toISOString(), photos: [], isValid: false, validationErrors: [], ...d });
  };

  const dup = (e, p) => {
    e.stopPropagation();
    if (isLocked) return;
    saveProduct({ ...p, id: generateUUID(), index: prds.length + 1, dateCreation: new Date().toISOString() });
  };

  const handleStatusChange = (updates) => updateChantier(ch.id, updates);

  const handleSendSuccess = () => {
    setShowConfirm(false);
    // Toast supprimÃ© car l'animation de succÃ¨s dans la modal suffit
  };

  const handleSendError = (error) => {
    setShowConfirm(false);
    setToast({ message: `Ã‰chec : ${error}`, type: 'error' });
  };

  const handleUnlock = () => {
    updateChantier(ch.id, { sendStatus: 'DRAFT', sentAt: null, lastError: null });
    setShowUnlock(false);
    setToast({ message: 'Dossier dÃ©verrouillÃ©', type: 'info' });
  };

  if (!ch) return null;
  if (edt) return <ProductEditor product={edt} onSave={p => { saveProduct(p); setEdt(null) }} onCancel={() => setEdt(null)} isReadOnly={isLocked} />;

  const tot = prds.reduce((a, p) => a + (p.quantity || 1), 0);
  const incompleteCount = prds.filter(p => !p.isValid).length;

  return (
    <div className="flex flex-col h-screen bg-slate-50 dark:bg-slate-950">
      {/* Header */}
      <div className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 pb-3 pt-3 safe-top-padding flex items-center justify-between sticky top-0 z-10 shadow-sm">
        <div className="flex items-center flex-1 min-w-0">
          <button onClick={() => selectChantier(null)} className="mr-3 p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-500 dark:text-slate-200"><ArrowLeft size={24} /></button>
          <div className="truncate flex-1 cursor-pointer" onClick={() => !isLocked && setIed(true)}>
            <div className="flex items-center gap-2">
              <h2 className="font-bold text-lg dark:text-white truncate">{ch.client}</h2>
              {isLocked ? <Lock size={16} className="text-green-600" /> : <Edit size={16} className="text-slate-400" />}
            </div>
            <div className="text-xs text-slate-500 flex items-center gap-2">
              <span className="bg-slate-100 dark:bg-slate-800 px-1.5 py-0.5 rounded">{tot} Produit(s)</span>
              <span>â€¢ {ch.typeContrat === 'FOURNITURE_ET_POSE' ? 'Pose' : ch.typeContrat === 'SOUS_TRAITANCE' ? 'Sous-traitance' : 'Fourn. Seule'}</span>
            </div>
          </div>
        </div>
      </div>

      {/* Status Banners */}
      {isLocked && <StatusBanner variant="success" icon={Lock} action="Modifier" onAction={() => setShowUnlock(true)}>Dossier verrouillÃ© le {new Date(ch.sentAt).toLocaleDateString('fr-FR')} Ã  {new Date(ch.sentAt).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' })}</StatusBanner>}
      {hasError && <StatusBanner variant="error" icon={AlertCircle}>Ã‰chec de l'envoi : {ch.lastError}</StatusBanner>}

      {/* Main Content */}
      <div className="flex-1 overflow-y-auto p-4 max-w-5xl mx-auto w-full pb-32">
        {ch.typeContrat === 'SOUS_TRAITANCE' && <div className="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-3 mb-4 flex items-start"><UserCheck className="text-amber-600 mt-1 mr-3 shrink-0" size={20} /><div><div className="text-xs font-bold text-amber-800 dark:text-amber-200 uppercase">Client Final</div><div className="font-medium text-amber-900 dark:text-amber-100">{ch.clientFinal}</div><div className="text-sm text-amber-800 dark:text-amber-300">{ch.adresseFinale}</div></div></div>}

        {/* Product Cards */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {prds.map(p => (
            <div key={p.id} onClick={() => setEdt(p)} className={`bg-white dark:bg-slate-900 rounded-xl p-4 shadow-sm border-l-[6px] cursor-pointer hover:shadow-md transition-all relative group ${p.type.includes('FENETRE') ? 'border-l-orange-500' : p.type.includes('PORTE') ? 'border-l-green-500' : 'border-l-orange-500'} border-t border-r border-b border-slate-200 dark:border-slate-800 ${isLocked ? 'opacity-75' : ''}`}>
              <div className="flex justify-between items-start mb-2">
                <span className="font-bold text-lg dark:text-white">#{String(p.index).padStart(2, '0')}</span>
                {p.quantity > 1 && <span className="bg-brand-100 text-brand-700 dark:bg-brand-900 dark:text-brand-300 text-xs font-bold px-2 py-1 rounded-full">x{p.quantity}</span>}
              </div>
              <div className="text-slate-800 dark:text-slate-200 font-medium mb-1">{p.type}</div>
              <div className="text-sm text-slate-500 mb-3">{p.largeurMm} x {p.hauteurMm} mm {p.room && `â€¢ ${p.room}`}</div>
              {!p.isValid && <div className="bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-300 px-2 py-1 rounded text-xs inline-flex items-center mb-2"><AlertTriangle size={12} className="mr-1" /> Incomplet</div>}
              {!isLocked && <div className="flex justify-end gap-3 mt-2 pt-3 border-t border-slate-100 dark:border-slate-800"><button onClick={e => dup(e, p)} className="text-slate-400 hover:text-brand-600 p-1"><Copy size={18} /></button><button onClick={e => { e.stopPropagation(); if (confirm('Supprimer ?')) deleteProduct(p.id) }} className="text-slate-400 hover:text-red-600 p-1"><Trash2 size={18} /></button></div>}
            </div>
          ))}
          {!isLocked && <button onClick={addP} className="min-h-[160px] border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-xl flex flex-col items-center justify-center text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-900 hover:border-brand-400 transition-colors"><div className="bg-slate-100 dark:bg-slate-800 p-4 rounded-full mb-2"><Plus size={24} /></div><span className="font-medium">Ajouter</span></button>}
        </div>
      </div>

      {/* Sticky Footer - Action Button */}
      {!isLocked && (
        <div className="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 p-4 safe-pb z-40 shadow-lg">
          <Button onClick={() => setShowConfirm(true)} disabled={isSending} className="w-full py-4 text-base font-bold" icon={isSending ? null : Send}>
            {isSending ? <span className="flex items-center justify-center gap-3"><Spinner size={20} />Transmission en cours...</span> : 'ENVOYER AU BUREAU'}
          </Button>
        </div>
      )}

      {/* Locked Footer */}
      {isLocked && (
        <div className="fixed bottom-0 left-0 right-0 bg-green-50 dark:bg-green-900/20 border-t border-green-200 dark:border-green-800 p-4 safe-pb z-40">
          <div className="flex items-center justify-center gap-2 text-green-700 dark:text-green-300">
            <Lock size={16} /><span className="text-sm font-medium">Dossier verrouillÃ© le {new Date(ch.sentAt).toLocaleDateString('fr-FR')}</span>
          </div>
        </div>
      )}

      {/* Modals */}
      {showConfirm && <ConfirmSendModal chantier={ch} products={prds} incompleteCount={incompleteCount} onClose={() => setShowConfirm(false)} onStatusChange={handleStatusChange} onSuccess={handleSendSuccess} onError={handleSendError} />}
      {showUnlock && <UnlockModal onClose={() => setShowUnlock(false)} onUnlock={handleUnlock} />}
      {ied && <EditChantierModal chantier={ch} onClose={() => setIed(false)} onUpdate={d => updateChantier(ch.id, d)} />}

      {/* Toast */}
      {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
    </div>
  );
};

const ProductEditor = ({ product: init, onSave, onCancel, isReadOnly = false }) => {
  const [p, setP] = useState(init), [err, setErr] = useState([]), [adv, setAdv] = useState(false), [stG200, setStG200] = useState(false), fRef = useRef(null), { state } = useApp();

  // Disable updates if readOnly
  const up = (k, v) => { if (isReadOnly) return; setP(x => ({ ...x, [k]: v })); };
  const upN = (par, k, v) => { if (isReadOnly) return; setP(x => ({ ...x, [par]: { ...(x[par] || {}), [k]: v } })); };

  const hRm = v => { if (isReadOnly) return; up('room', v); if (/sdb|salle\s?de\s?bain|toilette|wc|douche/i.test(v.toLowerCase()) && ['FENETRE', 'BAIE_COULISSANTE'].includes(p.type) && !p.vitrageFlags?.g200) { setP(prev => ({ ...prev, vitrageFlags: { ...prev.vitrageFlags, standard: true, g200: true } })); setStG200(true); setTimeout(() => setStG200(false), 3000) } };
  useEffect(() => { if (p.type === 'FENETRE' && p.hauteurMm > 2200) setP(x => ({ ...x, oscilloBattant: false })) }, [p.hauteurMm]);
  const sv = () => { if (isReadOnly) return; const c = ValidationService.validateProduct(p); if (!c.isValid) { setErr(c.errors); setTimeout(() => { const el = document.getElementById(`field-${c.errors[0]}`); if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' }) }, 100); return } onSave({ ...p, isValid: true, validationErrors: [] }) };
  const hPh = async e => { if (isReadOnly) return; if (e.target.files && e.target.files[0]) { const c = await compressImage(e.target.files[0]); up('photos', [...(p.photos || []), c]) } };
  const isE = f => err.includes(f);

  const lockedInput = isReadOnly ? 'opacity-60 cursor-not-allowed bg-slate-100 dark:bg-slate-800' : '';

  return (
    <div className="fixed inset-0 bg-slate-50 dark:bg-slate-950 z-50 flex flex-col h-full animate-fade-in">
      {/* Header */}
      <div className="bg-white dark:bg-slate-900 border-b border-slate-200 dark:border-slate-800 px-4 pb-3 pt-3 safe-top-padding flex justify-between items-center shadow-sm shrink-0">
        <button onClick={onCancel} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800">
          <X size={24} className="text-slate-500" />
        </button>
        <div className="text-center">
          <h2 className="font-bold dark:text-white">Produit #{String(p.index).padStart(2, '0')}</h2>
          {isReadOnly && <span className="text-xs text-green-600 font-medium flex items-center justify-center gap-1"><Lock size={12} /> Consultation</span>}
        </div>
        {isReadOnly ? (
          <div className="w-[76px]" /> /* Same width as Save button for centering */
        ) : (
          <Button onClick={sv} className="px-5 py-2 rounded-full" icon={Save}>Valider</Button>
        )}
      </div>

      {/* Read-only banner */}
      {isReadOnly && (
        <div className="bg-green-50 dark:bg-green-900/20 border-b border-green-200 dark:border-green-800 px-4 py-2 text-center">
          <span className="text-sm text-green-700 dark:text-green-300 font-medium flex items-center justify-center gap-2">
            <Lock size={14} /> Dossier verrouillÃ© â€” consultation seule
          </span>
        </div>
      )}

      <div className="flex-1 overflow-y-auto p-4 pb-20 max-w-3xl mx-auto w-full">
        {err.length > 0 && <div className="mb-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-900/50 text-red-700 dark:text-red-300 p-3 rounded-lg flex items-center"><AlertCircle size={20} className="mr-2" /><span>Champs manquants</span></div>}

        <div className="space-y-4">
          {/* Type & Quantity */}
          <div className={`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${lockedInput}`}>
            <SelectToggle label="Type" value={p.type} onChange={v => up('type', v)} disabled={isReadOnly} options={[{ label: 'FenÃªtre', value: 'FENETRE' }, { label: 'Porte-fenÃªtre', value: 'PORTE_FENETRE' }, { label: 'Coulissant', value: 'BAIE_COULISSANTE' }, { label: 'Porte EntrÃ©e', value: 'PORTE_ENTREE' }, { label: 'Porte Service', value: 'PORTE_SERVICE' }, { label: 'Volet', value: 'VOLET_ROULANT' }, { label: 'Autre', value: 'AUTRE' }]} />
            <div className="flex items-center justify-between bg-slate-50 dark:bg-slate-800 p-3 rounded-lg mb-4 border border-slate-100 dark:border-slate-700">
              <span className="font-medium text-slate-700 dark:text-slate-300">QuantitÃ©</span>
              <div className="flex items-center gap-4">
                <button className={`w-8 h-8 rounded-full bg-white dark:bg-slate-700 shadow text-brand-600 font-bold ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''}`} onClick={() => up('quantity', Math.max(1, (p.quantity || 1) - 1))} disabled={isReadOnly}>-</button>
                <span className="font-bold text-xl w-6 text-center dark:text-white">{p.quantity || 1}</span>
                <button className={`w-8 h-8 rounded-full bg-white dark:bg-slate-700 shadow text-brand-600 font-bold ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''}`} onClick={() => up('quantity', (p.quantity || 1) + 1)} disabled={isReadOnly}>+</button>
              </div>
            </div>
            <Input label="Localisation" value={p.room} onChange={hRm} placeholder="Ex: Cuisine" disabled={isReadOnly} />
            {p.type === 'AUTRE' && <Input id="field-description" label="Description" value={p.description} onChange={v => up('description', v)} error={isE('description')} disabled={isReadOnly} />}
            <div className="grid grid-cols-2 gap-4">
              <Input id="field-largeurMm" label="Largeur (mm)" type="number" inputMode="numeric" pattern="[0-9]*" value={p.largeurMm} onChange={v => up('largeurMm', parseInt(v))} error={isE('largeurMm')} disabled={isReadOnly} />
              <Input id="field-hauteurMm" label="Hauteur (mm)" type="number" inputMode="numeric" pattern="[0-9]*" value={p.hauteurMm} onChange={v => up('hauteurMm', parseInt(v))} error={isE('hauteurMm')} disabled={isReadOnly} />
            </div>
            {(ValidationService.isMeasureSuspicious(p.largeurMm, p.monobloc) || ValidationService.isMeasureSuspicious(p.hauteurMm, p.monobloc)) && <div className="text-orange-500 text-xs flex items-center mt-[-10px] mb-4"><AlertTriangle size={12} className="mr-1" /> Attention: Cotes &lt;300mm</div>}
          </div>

          {/* CaractÃ©ristiques */}
          {['FENETRE', 'PORTE_FENETRE', 'BAIE_COULISSANTE', 'PORTE_ENTREE', 'PORTE_SERVICE'].includes(p.type) && (
            <div className={`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${lockedInput}`}>
              <h3 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">CaractÃ©ristiques</h3>
              <SelectToggle id="field-matiere" label="MatiÃ¨re" value={p.matiere} onChange={v => up('matiere', v)} error={isE('matiere')} disabled={isReadOnly} options={[{ label: 'PVC', value: 'PVC' }, { label: 'Alu', value: 'ALU' }]} />
              {p.matiere && <SelectToggle id="field-profil" label="Profil" value={p.profil} onChange={v => up('profil', v)} error={isE('profil')} disabled={isReadOnly} options={p.matiere === 'PVC' ? [{ label: 'RÃ©no 40', value: 'RENO_40' }, { label: 'RÃ©no 60', value: 'RENO_60' }, { label: 'Neuf', value: 'NEUF' }, { label: 'ISO', value: 'ISO' }, { label: 'Autre', value: 'AUTRE' }] : [{ label: 'RÃ©no', value: 'RENO' }, { label: 'Neuf', value: 'NEUF' }, { label: 'Autre', value: 'AUTRE' }]} />}
              {p.profil === 'ISO' && <Input id="field-isoMm" label="Aile ISO (mm)" type="number" inputMode="numeric" pattern="[0-9]*" value={p.isoMm} onChange={v => up('isoMm', parseInt(v))} error={isE('isoMm')} disabled={isReadOnly} />}
              {p.profil === 'AUTRE' && <Input id="field-profilAutre" label="Profil personnalisÃ©" placeholder="PrÃ©ciser le profil..." value={p.profilAutre} onChange={v => up('profilAutre', v)} error={isE('profilAutre')} disabled={isReadOnly} />}
              <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-800">
                <SelectToggle id="field-couleur" label="Couleur" value={p.couleur} onChange={v => up('couleur', v)} error={isE('couleur')} disabled={isReadOnly} options={p.matiere === 'PVC' ? [{ label: 'Blanc', value: 'BLANC' }, { label: 'Bicolor 7016', value: 'BICOLOR_7016' }, { label: 'Autre', value: 'AUTRE' }] : [{ label: 'Blanc', value: 'BLANC' }, { label: 'Gris 7016', value: 'GRIS_7016' }, { label: 'Autre', value: 'AUTRE' }]} />
                {p.couleur === 'AUTRE' && <Input id="field-couleurAutre" placeholder="PrÃ©ciser..." value={p.couleurAutre} onChange={v => up('couleurAutre', v)} error={isE('couleurAutre')} disabled={isReadOnly} />}
              </div>
            </div>
          )}

          {/* Vitrage */}
          {(p.type === 'FENETRE' || p.type === 'PORTE_FENETRE' || p.type === 'BAIE_COULISSANTE') && (
            <div id="field-vitrageFlags" className={`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border ${isE('vitrageFlags') ? 'border-red-500 ring-1 ring-red-500' : 'border-slate-200 dark:border-slate-800'} ${lockedInput}`}>
              <h3 className={`text-xs font-bold uppercase mb-3 tracking-wider ${isE('vitrageFlags') ? 'text-red-500' : 'text-slate-400'}`}>Vitrage {isE('vitrageFlags') && '*'}</h3>
              <div className="grid grid-cols-2 gap-3">
                {[['standard', '4/20/4'], ['g200', 'G200'], ['feuillete1f', 'FeuilletÃ© 1F'], ['feuillete2f', 'FeuilletÃ© 2F']].map(([k, l]) => (
                  <label key={k} className={`flex items-center p-3 rounded-lg border transition-all ${isReadOnly ? 'cursor-not-allowed' : 'cursor-pointer'} ${p.vitrageFlags?.[k] ? 'bg-brand-50 border-brand-500 text-brand-700 dark:bg-brand-900/30' : 'border-slate-200 dark:border-slate-700 dark:text-white'}`}>
                    <input type="checkbox" className="w-5 h-5 rounded text-brand-600 focus:ring-brand-500" checked={!!p.vitrageFlags?.[k]} onChange={e => upN('vitrageFlags', k, e.target.checked)} disabled={isReadOnly} />
                    <span className="ml-2 text-sm font-medium">{l}</span>
                  </label>
                ))}
              </div>
            </div>
          )}

          {/* FenÃªtre Options */}
          {p.type === 'FENETRE' && (
            <div className={`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 space-y-4 ${lockedInput}`}>
              <h3 className="text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">Options</h3>
              <div className="flex items-center gap-4">
                <label className={`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                  <span className="dark:text-white font-medium text-sm">Oscillo-Battant</span>
                  <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.oscilloBattant} onChange={e => up('oscilloBattant', e.target.checked)} disabled={isReadOnly || p.hauteurMm > 2200} />
                </label>
                <label className={`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                  <span className="dark:text-white font-medium text-sm">Grille Ventil.</span>
                  <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.grilleVentilation} onChange={e => up('grilleVentilation', e.target.checked)} disabled={isReadOnly} />
                </label>
              </div>
              <div className="pt-2">
                <label className="text-sm dark:text-slate-300 font-medium mb-2 block">Hauteur PoignÃ©e</label>
                <div className="flex gap-2">
                  <button onClick={() => up('poigneeHauteur', 'CENTREE')} disabled={isReadOnly} className={`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''} ${p.poigneeHauteur !== 'AUTRE' ? 'bg-brand-600 text-white border-brand-600' : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700'}`}>CentrÃ©e</button>
                  <button onClick={() => up('poigneeHauteur', 'AUTRE')} disabled={isReadOnly} className={`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''} ${p.poigneeHauteur === 'AUTRE' ? 'bg-brand-600 text-white border-brand-600' : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700'}`}>Autre</button>
                </div>
                {p.poigneeHauteur === 'AUTRE' && <input type="number" inputMode="numeric" pattern="[0-9]*" className={`mt-2 w-full p-3 border rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-700 ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''}`} placeholder="mm" value={p.poigneeHauteurMm || ''} onChange={e => up('poigneeHauteurMm', parseInt(e.target.value))} disabled={isReadOnly} />}
              </div>
            </div>
          )}

          {/* Porte-fenÃªtre Options */}
          {p.type === 'PORTE_FENETRE' && (
            <div className={`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 space-y-4 ${lockedInput}`}>
              <h3 className="text-xs font-bold text-slate-400 uppercase mb-2 tracking-wider">Options Porte-fenÃªtre</h3>
              <div className="flex items-center gap-4">
                <label className={`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                  <span className="dark:text-white font-medium text-sm">Grille Ventil.</span>
                  <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.grilleVentilation} onChange={e => up('grilleVentilation', e.target.checked)} disabled={isReadOnly} />
                </label>
                <label className={`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                  <div className="flex flex-col">
                    <span className="dark:text-white font-medium text-sm">Serrure</span>
                    {p.matiere === 'PVC' && <span className="text-xs text-slate-400">(gros profil)</span>}
                  </div>
                  <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.serrure} onChange={e => up('serrure', e.target.checked)} disabled={isReadOnly} />
                </label>
              </div>
              <div className="flex items-center gap-4">
                <label className={`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                  <span className="dark:text-white font-medium text-sm">Seuil PMR</span>
                  <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.seuilPMR} onChange={e => up('seuilPMR', e.target.checked)} disabled={isReadOnly} />
                </label>
                <label className={`flex-1 flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-800 rounded-lg border border-slate-100 dark:border-slate-700 ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                  <span className="dark:text-white font-medium text-sm">Soubassement</span>
                  <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.soubassement} onChange={e => up('soubassement', e.target.checked)} disabled={isReadOnly} />
                </label>
              </div>
              {p.soubassement && <Input id="field-soubassementHauteurMm" label="Hauteur Soubassement (mm)" type="number" inputMode="numeric" pattern="[0-9]*" value={p.soubassementHauteurMm} onChange={v => up('soubassementHauteurMm', parseInt(v))} placeholder="Ex: 400" disabled={isReadOnly} />}
              <div className="pt-2">
                <label className="text-sm dark:text-slate-300 font-medium mb-2 block">Hauteur PoignÃ©e</label>
                <div className="flex gap-2">
                  <button onClick={() => up('poigneeHauteur', 'CENTREE')} disabled={isReadOnly} className={`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''} ${p.poigneeHauteur !== 'AUTRE' ? 'bg-brand-600 text-white border-brand-600' : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700'}`}>CentrÃ©e</button>
                  <button onClick={() => up('poigneeHauteur', 'AUTRE')} disabled={isReadOnly} className={`flex-1 py-2 px-3 rounded-lg border text-sm font-medium ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''} ${p.poigneeHauteur === 'AUTRE' ? 'bg-brand-600 text-white border-brand-600' : 'bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700'}`}>Autre</button>
                </div>
                {p.poigneeHauteur === 'AUTRE' && <input type="number" inputMode="numeric" pattern="[0-9]*" className={`mt-2 w-full p-3 border rounded-lg dark:bg-slate-900 dark:text-white dark:border-slate-700 ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''}`} placeholder="mm" value={p.poigneeHauteurMm || ''} onChange={e => up('poigneeHauteurMm', parseInt(e.target.value))} disabled={isReadOnly} />}
              </div>
            </div>
          )}

          {/* Volet Roulant */}
          {p.type === 'VOLET_ROULANT' && (
            <div className={`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${lockedInput}`}>
              <div className="mb-4">
                <label className="block text-sm font-medium mb-2 text-slate-700 dark:text-slate-300">Lier Ã </label>
                <select className={`w-full p-3 rounded-lg bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 dark:text-white ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''}`} value={p.lieAProduitId || ''} onChange={e => up('lieAProduitId', e.target.value)} disabled={isReadOnly}>
                  <option value="">-- IndÃ©pendant --</option>
                  {state.products.filter(x => ['FENETRE', 'BAIE_COULISSANTE'].includes(x.type)).map(x => <option key={x.id} value={x.id}>#{x.index} {x.type}</option>)}
                </select>
              </div>
              <SelectToggle id="field-manoeuvre" label="Manoeuvre" value={p.manoeuvre} onChange={v => up('manoeuvre', v)} error={isE('manoeuvre')} disabled={isReadOnly} options={[{ label: 'Filaire', value: 'FILAIRE' }, { label: 'Radio', value: 'RADIO' }, { label: 'Solaire', value: 'SOLAIRE' }]} />
              {p.manoeuvre && p.manoeuvre !== 'SOLAIRE' && <SelectToggle id="field-sortieCable" label="Sortie CÃ¢ble" value={p.sortieCable} onChange={v => up('sortieCable', v)} error={isE('sortieCable')} disabled={isReadOnly} options={[{ label: 'Gauche', value: 'GAUCHE' }, { label: 'Droite', value: 'DROITE' }]} />}
              {p.manoeuvre !== 'FILAIRE' && (
                <label className={`flex items-center p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 dark:border-slate-700 mt-4 mb-4 ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                  <input type="checkbox" className="w-5 h-5 accent-brand-600" checked={!!p.boxDomotique} onChange={e => up('boxDomotique', e.target.checked)} disabled={isReadOnly} />
                  <span className="ml-3 font-medium dark:text-white">Box Domotique</span>
                </label>
              )}
              <div className="my-4" id="field-coffreADeduireMm">
                <label className={`flex items-center justify-between p-3 border rounded-lg bg-slate-50 dark:bg-slate-800 dark:border-slate-700 ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                  <span className="font-medium dark:text-white">Monobloc ?</span>
                  <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.monobloc} onChange={e => up('monobloc', e.target.checked)} disabled={isReadOnly} />
                </label>
                {p.monobloc && (
                  <div className="mt-3 bg-blue-50 dark:bg-blue-900/20 p-3 rounded-lg">
                    <Input label="Hauteur Coffre" type="number" inputMode="numeric" pattern="[0-9]*" value={p.coffreADeduireMm} onChange={v => up('coffreADeduireMm', parseInt(v))} error={isE('coffreADeduireMm')} disabled={isReadOnly} />
                    <div className="text-right text-sm font-bold text-brand-600">Passage: {p.hauteurMm && p.coffreADeduireMm ? p.hauteurMm - p.coffreADeduireMm : '-'} mm</div>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Options AvancÃ©es */}
          {ValidationService.hasAdvancedOptions(p.type) && (
            <div className={`bg-white dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-800 overflow-hidden ${lockedInput}`}>
              <button onClick={() => setAdv(!adv)} className="w-full flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-800/50 font-medium text-slate-700 dark:text-slate-300">
                <span>Options AvancÃ©es</span>
                {adv ? <ChevronUp size={18} /> : <ChevronDown size={18} />}
              </button>
              {adv && (
                <div className="p-4 border-t border-slate-200 dark:border-slate-800 space-y-4">
                  {(p.type.includes('FENETRE') || p.type.includes('PORTE')) && (
                    <div className="space-y-3">
                      <label className={`flex items-center justify-between ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                        <span className="dark:text-white">Ouverture ExtÃ©rieure</span>
                        <input type="checkbox" className="w-5 h-5 accent-brand-600" checked={!!p.ouvertureExterieure} onChange={e => up('ouvertureExterieure', e.target.checked)} disabled={isReadOnly} />
                      </label>
                      {p.type === 'FENETRE' && (
                        <>
                          <label className={`flex items-center justify-between ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                            <span className="dark:text-white">PoignÃ©e Ã  clÃ©</span>
                            <input type="checkbox" className="w-5 h-5 accent-brand-600" checked={!!p.poigneeCle} onChange={e => up('poigneeCle', e.target.checked)} disabled={isReadOnly} />
                          </label>
                          <label className={`flex items-center justify-between ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                            <span className="dark:text-white">PiÃ¨ce d'appui</span>
                            <input type="checkbox" className="w-5 h-5 accent-brand-600" checked={!!p.pieceAppui} onChange={e => up('pieceAppui', e.target.checked)} disabled={isReadOnly} />
                          </label>
                          {p.pieceAppui && <Input id="field-pieceAppuiDescription" label="Description PiÃ¨ce d'appui" value={p.pieceAppuiDescription} onChange={v => up('pieceAppuiDescription', v)} placeholder="PrÃ©ciser..." disabled={isReadOnly} />}
                        </>
                      )}
                      {p.type === 'PORTE_FENETRE' && (
                        <label className={`flex items-center justify-between ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                          <span className="dark:text-white">PoignÃ©e Ã  clÃ©</span>
                          <input type="checkbox" className="w-5 h-5 accent-brand-600" checked={!!p.poigneeCle} onChange={e => up('poigneeCle', e.target.checked)} disabled={isReadOnly} />
                        </label>
                      )}
                      {p.type === 'PORTE_ENTREE' && (
                        <label className={`flex items-center justify-between ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                          <span className="dark:text-white font-bold">Tierce / Imposte ?</span>
                          <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.tierceImposte} onChange={e => up('tierceImposte', e.target.checked)} disabled={isReadOnly} />
                        </label>
                      )}
                    </div>
                  )}
                  {p.type === 'VOLET_ROULANT' && (
                    <div>
                      <SelectToggle label="Couple" value={p.coupleMoteur || 10} onChange={v => up('coupleMoteur', v)} disabled={isReadOnly} options={[{ label: '10 Nm', value: 10 }, { label: '20 Nm', value: 20 }]} />
                      <SelectToggle label="Pose" value={p.pose || 'RENO'} onChange={v => up('pose', v)} disabled={isReadOnly} options={[{ label: 'RÃ©nov', value: 'RENO' }, { label: 'Tradi', value: 'TRADI' }, { label: 'Tunnel', value: 'TUNNEL' }]} />
                    </div>
                  )}
                </div>
              )}
            </div>
          )}

          {/* Porte EntrÃ©e */}
          {p.type === 'PORTE_ENTREE' && (
            <div className={`bg-white dark:bg-slate-900 p-5 rounded-xl border dark:border-slate-800 ${lockedInput}`}>
              <SelectToggle id="field-remplissage" label="Remplissage" value={p.remplissage} onChange={v => up('remplissage', v)} error={isE('remplissage')} disabled={isReadOnly} options={[{ label: 'Panneau DÃ©co Alu', value: 'PANNEAU_DECORATIF_ALU' }, { label: 'Sandwich', value: 'PANNEAU_SANDWICH' }, { label: 'VitrÃ©e', value: 'VITREE' }]} />
              {p.largeurMm > 1000 && (
                <div className="mt-3 pt-3 border-t dark:border-slate-700">
                  <label className={`flex items-center justify-between mb-3 ${isReadOnly ? 'cursor-not-allowed' : ''}`}>
                    <span className="dark:text-white font-medium">Tierce ?</span>
                    <input type="checkbox" className="w-6 h-6 accent-brand-600" checked={!!p.tierce} onChange={e => up('tierce', e.target.checked)} disabled={isReadOnly} />
                  </label>
                  {p.tierce && <Input id="field-cotePassageMm" label="Cote Passage (mm)" type="number" inputMode="numeric" pattern="[0-9]*" value={p.cotePassageMm} onChange={v => up('cotePassageMm', v)} error={isE('cotePassageMm')} disabled={isReadOnly} />}
                </div>
              )}
            </div>
          )}

          {/* Drawing & Photos */}
          <div className={`bg-white dark:bg-slate-900 rounded-xl p-5 shadow-sm border border-slate-200 dark:border-slate-800 ${lockedInput}`}>
            <DrawingCanvas data={p.dessin} onChange={d => up('dessin', d)} disabled={isReadOnly} />
            <div className="mt-6">
              <label className="block text-sm font-medium mb-3 text-slate-700 dark:text-slate-300">Photos</label>
              <div className="grid grid-cols-4 gap-2">
                {(p.photos || []).map((src, i) => (
                  <div key={i} className="relative aspect-square rounded-lg overflow-hidden border border-slate-200 dark:border-slate-700 group">
                    <img src={src} className="w-full h-full object-cover" />
                    {!isReadOnly && <button onClick={() => up('photos', p.photos.filter((_, idx) => idx !== i))} className="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 shadow-md opacity-80 hover:opacity-100"><X size={12} /></button>}
                  </div>
                ))}
                {!isReadOnly && (
                  <button onClick={() => fRef.current?.click()} className="aspect-square rounded-lg border-2 border-dashed border-slate-300 dark:border-slate-600 flex flex-col items-center justify-center text-slate-400 hover:text-brand-500 hover:bg-slate-50 dark:hover:bg-slate-800 transition-colors">
                    <Camera size={24} /><span className="text-[10px] mt-1">Ajouter</span>
                  </button>
                )}
                <input type="file" ref={fRef} accept="image/*" className="hidden" onChange={hPh} disabled={isReadOnly} />
              </div>
            </div>
            <div className="mt-4">
              <label className="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Notes techniques</label>
              <textarea className={`w-full p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-950 dark:text-white h-24 text-sm focus:border-brand-500 outline-none ${isReadOnly ? 'opacity-50 cursor-not-allowed' : ''}`} placeholder="Contraintes..." value={p.notes || ''} onChange={e => up('notes', e.target.value)} disabled={isReadOnly} />
            </div>
          </div>
        </div>
      </div>

      {/* G200 Toast */}
      {stG200 && <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-3 rounded-lg shadow-xl flex items-center animate-slide-up"><Droplets size={20} className="text-blue-400 mr-2" /> Vitrage G200 activé (Intimité)</div>}


    </div>
  );
};

/**
 * Envoie les donnÃ©es de mÃ©trage vers Google Sheets via Apps Script
 * Version robuste avec timeout et gestion d'erreurs
 * @param {Object} chantier - Le chantier
 * @param {Array} products - Liste des produits
 * @param {string} htmlReport - HTML complet du rapport
 * @param {Function} onStatusChange - Callback pour mettre Ã  jour le status
 * @returns {Promise<{success: boolean, error?: string}>}
 */
async function sendToGoogleSheets(chantier, products, htmlReport, onStatusChange) {
  const APPS_SCRIPT_URL = window.SARANGE_CONFIG?.APPS_SCRIPT_URL;
  const TIMEOUT_MS = 15000; // 15 secondes

  if (!APPS_SCRIPT_URL) {
    Logger.warn("URL Google Apps Script non configurÃ©e");
    return { success: false, error: "Configuration manquante" };
  }

  // PrÃ©parer le payload
  const payload = {
    timestamp: new Date().toISOString(),
    metrage_id: generateUUID(),
    htmlReport: htmlReport,
    chantier: {
      client: chantier.client,
      adresse: chantier.adresse,
      telephone: chantier.telephone || '',
      email: chantier.email || '',
      typeContrat: chantier.typeContrat
    },
    clientFinal: chantier.typeContrat === 'SOUS_TRAITANCE' ? {
      nom: chantier.clientFinal,
      adresse: chantier.adresseFinale
    } : null,
    produits: products.map(p => ({
      numero: p.index,
      type: p.type,
      quantite: p.quantity || 1,
      localisation: p.room || '',
      dimensions: `${p.largeurMm} x ${p.hauteurMm} mm`,
      matiere: p.matiere || '',
      profil: p.profil || '',
      couleur: p.couleur === 'AUTRE' ? p.couleurAutre : (p.couleur || ''),
      vitrage: p.vitrageFlags ? Object.entries(p.vitrageFlags)
        .filter(([k, v]) => v)
        .map(([k]) => {
          if (k === 'standard') return '4/20/4';
          if (k === 'g200') return 'G200';
          if (k === 'feuillete1f') return 'FeuilletÃ© 1F';
          if (k === 'feuillete2f') return 'FeuilletÃ© 2F';
          return '';
        })
        .filter(Boolean)
        .join(', ') : '',
      options: buildOptionsString(p),
      notes: p.notes || '',
      isValid: p.isValid
    })),
    total_produits: products.reduce((a, b) => a + (b.quantity || 1), 0),
    produits_incomplets: products.filter(p => !p.isValid).length
  };

  // Setup timeout avec AbortController
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);

  try {
    // Passer en SENDING
    onStatusChange?.({ sendStatus: 'SENDING', lastError: null });

    const response = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      mode: 'cors',
      headers: { 'Content-Type': 'text/plain' }, // Ã‰vite preflight CORS sur GAS
      body: JSON.stringify(payload),
      signal: controller.signal
    });

    clearTimeout(timeoutId);

    // VÃ©rifier le status HTTP
    if (!response.ok) {
      throw new Error(`Erreur HTTP: ${response.status}`);
    }

    // Parser la rÃ©ponse JSON
    const data = await response.json();

    if (data.success === true) {
      // SUCCÃˆS â†’ Verrouillage
      const sentAt = new Date().toISOString();
      onStatusChange?.({
        sendStatus: 'SENT',
        sentAt: sentAt,
        lastError: null,
        dateFinalisation: sentAt
      });
      Logger.info("âœ… MÃ©trage envoyÃ© avec succÃ¨s", { metrage_id: payload.metrage_id, client: chantier.client });
      return { success: true };
    } else {
      throw new Error(data.error || "RÃ©ponse serveur invalide");
    }

  } catch (error) {
    clearTimeout(timeoutId);

    // DÃ©terminer le message d'erreur
    let errorMessage;
    if (error.name === 'AbortError') {
      errorMessage = "Connexion trop lente (dÃ©lai 15s dÃ©passÃ©)";
    } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
      errorMessage = "Pas de connexion rÃ©seau";
    } else {
      errorMessage = error.message;
    }

    // Passer en ERROR
    onStatusChange?.({ sendStatus: 'ERROR', lastError: errorMessage });
    Logger.error("âŒ Ã‰chec envoi mÃ©trage", { error: errorMessage, client: chantier.client });

    return { success: false, error: errorMessage };
  }
}

/**
 * Modal de confirmation avant envoi
 * Checklist de vÃ©rification + Alerte verrouillage
 */
const ConfirmSendModal = ({ chantier, products, incompleteCount, onClose, onStatusChange, onSuccess, onError }) => {
  const [checks, setChecks] = useState({ cotes: false, options: false });
  const [isSending, setIsSending] = useState(false);
  const [isSuccess, setIsSuccess] = useState(false);
  const allChecked = checks.cotes && checks.options;

  const handleSend = async () => {
    setIsSending(true);
    const htmlReport = generateReportHTML(chantier, products, new Date().toISOString());
    const result = await sendToGoogleSheets(chantier, products, htmlReport, onStatusChange);

    if (result.success) {
      setIsSending(false);
      setIsSuccess(true);

      // Animation de succÃ¨s visible pendant 1.5s avant de fermer
      setTimeout(() => {
        onSuccess?.();
      }, 1500);
    } else {
      setIsSending(false);
      onError?.(result.error);
    }
  };

  return (
    <Modal isOpen={true} onClose={isSending || isSuccess ? undefined : onClose} title={isSuccess ? "âœ“ EnvoyÃ© !" : "ÃŠtes-vous sÃ»r ?"} size="md">

      {/* Container avec hauteur minimum pour Ã©viter les sauts d'interface */}
      <div className="relative min-h-[360px] flex flex-col">

        {/* VUE SUCCÃˆS - Animation overlay */}
        {isSuccess && (
          <div className="absolute inset-0 flex flex-col items-center justify-center animate-fade-in z-10">
            <div className="relative mb-6">
              {/* Background pulsant */}
              <div className="absolute inset-0 bg-green-100 dark:bg-green-900/30 rounded-full scale-150 animate-pulse"></div>
              {/* IcÃ´ne centrale avec bounce */}
              <div className="bg-green-500 text-white rounded-full p-6 shadow-xl shadow-green-500/40 relative z-10 animate-bounce">
                <CheckCircle size={48} strokeWidth={3} />
              </div>
            </div>
            <h3 className="text-2xl font-bold text-slate-800 dark:text-white mb-2">Dossier EnvoyÃ© !</h3>
            <p className="text-slate-500 dark:text-slate-400 text-center text-sm">
              Le mÃ©trage a Ã©tÃ© transmis au bureau
            </p>
          </div>
        )}

        {/* VUE FORMULAIRE */}
        {!isSuccess && (
          <div className="flex flex-col h-full">
            {/* Checklist */}
            <div className="space-y-3 mb-6">
              <Checkbox checked={checks.cotes} onChange={v => setChecks(c => ({ ...c, cotes: v }))} label="J'ai vÃ©rifiÃ© toutes les cotes" />
              <Checkbox checked={checks.options} onChange={v => setChecks(c => ({ ...c, options: v }))} label="J'ai vÃ©rifiÃ© les options" />
            </div>

            {/* Alerte verrouillage */}
            <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 mb-4 flex items-start gap-3">
              <div className="bg-red-100 dark:bg-red-900/50 p-2 rounded-lg shrink-0">
                <AlertTriangle className="text-red-600 dark:text-red-400" size={20} />
              </div>
              <div>
                <p className="font-bold text-red-700 dark:text-red-300 text-sm">Action irrÃ©versible</p>
                <p className="text-red-600 dark:text-red-400 text-xs mt-1 leading-relaxed">
                  Le dossier sera verrouillÃ© aprÃ¨s envoi.
                </p>
              </div>
            </div>

            {/* RÃ©sumÃ© */}
            <div className="bg-slate-50 dark:bg-slate-800 rounded-xl p-4 mb-6 border border-slate-100 dark:border-slate-700">
              <div className="flex justify-between text-sm mb-2">
                <span className="text-slate-600 dark:text-slate-400">Total Produits</span>
                <span className="font-bold text-slate-800 dark:text-white bg-white dark:bg-slate-700 px-2 py-0.5 rounded border border-slate-200 dark:border-slate-600">
                  {products.reduce((a, p) => a + (p.quantity || 1), 0)}
                </span>
              </div>
              {incompleteCount > 0 && (
                <div className="flex justify-between text-sm mt-2 pt-2 border-t border-slate-200 dark:border-slate-700">
                  <span className="text-amber-600 dark:text-amber-400 flex items-center gap-2">
                    <AlertTriangle size={16} /> Incomplets
                  </span>
                  <span className="font-bold text-white bg-amber-500 px-2 py-0.5 rounded text-xs">
                    {incompleteCount}
                  </span>
                </div>
              )}
            </div>

            {/* Actions */}
            <div className="mt-auto space-y-3">
              <Button
                onClick={handleSend}
                disabled={!allChecked || isSending}
                className={`w-full py-4 text-base transition-all duration-300 ${allChecked ? 'translate-y-0 opacity-100' : 'opacity-80'}`}
                icon={isSending ? null : Send}
              >
                {isSending ? (
                  <span className="flex items-center justify-center gap-3">
                    <Spinner size={20} />
                    <span>Transmission en cours...</span>
                  </span>
                ) : "Confirmer l'envoi"}
              </Button>

              <Button onClick={onClose} variant="ghost" className="w-full py-3" disabled={isSending}>
                Annuler
              </Button>
            </div>
          </div>
        )}
      </div>
    </Modal>
  );
};

/**
 * Modal de dÃ©verrouillage sÃ©curisÃ©
 * L'utilisateur doit saisir "MODIFIER" pour dÃ©verrouiller
 */
const UnlockModal = ({ onClose, onUnlock }) => {
  const [input, setInput] = useState('');
  const isValid = input.toUpperCase() === 'MODIFIER';

  return (
    <Modal isOpen={true} onClose={onClose} title="DÃ©verrouiller le dossier" size="sm">
      <p className="text-slate-600 dark:text-slate-400 mb-4 text-sm">
        Pour modifier un dossier dÃ©jÃ  envoyÃ©, saisissez <strong className="text-slate-800 dark:text-white">MODIFIER</strong> ci-dessous.
      </p>
      <Input value={input} onChange={setInput} placeholder="Tapez MODIFIER" className="mb-6" />
      <div className="space-y-3">
        <Button onClick={onUnlock} disabled={!isValid} variant={isValid ? 'danger' : 'secondary'} className="w-full py-4" icon={Unlock}>DÃ©verrouiller</Button>
        <Button onClick={onClose} variant="ghost" className="w-full">Annuler</Button>
      </div>
    </Modal>
  );
};

const root = createRoot(document.getElementById('root')); root.render(<App />);
if ('serviceWorker' in navigator) navigator.serviceWorker.register('./service-worker.js').catch(() => { });


